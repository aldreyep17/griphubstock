<!DOCTYPE html>
<html lang="en" class="dark">
	<!-- Default to dark theme, JS will manage this class -->
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Griphub Inventory Management</title>
		<link rel="icon" type="image/png" href="https://i.imgur.com/SSbdOdP.png" />
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap"
			rel="stylesheet"
		/>
		<style>
						        body { font-family: 'Inter', sans-serif; }
						        .font-mono { font-family: 'Roboto Mono', monospace; } /* Custom mono for better rendering */
						        ::-webkit-scrollbar {
						            width: 6px;
						            height: 6px;
						        }
						        ::-webkit-scrollbar-track { background: #f1f5f9; }
						        .dark ::-webkit-scrollbar-track { background: #1f2937; }
						        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
						        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
						        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
						        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
						        input[type='number']::-webkit-inner-spin-button,
						        input[type='number']::-webkit-outer-spin-button {
						            -webkit-appearance: none;
						            margin: 0;
						        }
						        input[type='number'] { -moz-appearance: textfield; }

						        /* A4 Preview Styling */
						        .preview-container {
						            width: 100%;
						            padding-top: 141.42%; /* A4 Aspect Ratio (297/210) */
						            position: relative;
						        }
						        .preview-container .preview-a4 {
						            position: absolute;
						            top: 0;
						            left: 0;
						            transform: scale(var(--preview-scale, 1));
						            transform-origin: top left;
						        }
						        .preview-a4 {
						            width: 210mm;
						            height: 297mm;
						            padding: 14mm;
						            box-shadow: 0 0 10px rgba(0,0,0,0.5);
						            background: white;
						            color: #111827;
						            position: relative;
						            overflow: hidden;
						            box-sizing: border-box; /* Ensures padding is included in width/height */
						        }
						        .watermark-container {
						            position: absolute;
						            top: 0;
						            left: 0;
						            width: 100%;
						            height: 100%;
						            display: flex;
						            justify-content: center;
						            align-items: center;
						            z-index: 10;
						            pointer-events: none;
						        }
						        .watermark {
						            transform: rotate(-45deg);
						            font-size: 120px;
						            font-weight: bold;
						            color: rgba(59, 130, 246, 0.1);
						            padding: 50px 40px;
						            border-radius: 10px;
						            letter-spacing: 5px;
						            text-align: center;
						            white-space: nowrap;
						        }
						        @media print {
			    body, html {
			        background: #fff !important;
			        color: #000 !important;
			        margin: 0;
			        padding: 0;
			    }

			    /* 1. Sembunyikan container utama aplikasi web saat mencetak */
			    body > #root {
			        display: none !important;
			    }

			    /* 2. Tampilkan container khusus untuk mencetak */
			    body > #print-root {
			        display: block !important;
			    }

			    /* 3. Atur area cetak untuk mengisi halaman */
			    .print-area {
			        position: absolute;
			        top: 0;
			        left: 0;
			        width: 100%;
			        height: 100%;
			        margin: 0;
			        padding: 0;
			        visibility: visible !important;
			    }

			    /* 4. Pastikan semua elemen di dalam area cetak terlihat */
			    .print-area * {
			        visibility: visible !important;
			    }

			    /* 5. Atur gaya spesifik untuk preview A4 saat dicetak */
			    .print-area .preview-a4 {
			        box-shadow: none !important;
			        transform: scale(1) !important;
			        margin: 0 !important;
			        padding: 14mm !important; /* Pertahankan padding internal invoice */
			        width: 210mm;
			        height: 297mm;
			        page-break-inside: avoid;
			        overflow: hidden;
			        box-sizing: border-box;
			    }
			}
						        #qr-reader video {
						    width: 100%;
						    height: 100%;
						    object-fit: cover;
						}
						.no-scrollbar::-webkit-scrollbar {
						    display: none; /* Untuk Chrome, Safari, dan Opera */
						}
						.no-scrollbar {
						    -ms-overflow-style: none;  /* Untuk IE dan Edge */
						    scrollbar-width: none;  /* Untuk Firefox */
						}
		</style>
		<script>
			tailwind.config = {
				darkMode: "class",
				theme: {
					extend: {
						fontFamily: {
							sans: ["Inter", "sans-serif"],
							mono: [
								"Roboto Mono",
								"ui-monospace",
								"SFMono-Regular",
								"Menlo",
								"Monaco",
								"Consolas",
								"Liberation Mono",
								"Courier New",
								"monospace",
							],
						},
					},
				},
			};
		</script>
	</head>
	<body
		class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300"
	>
		<div id="root"></div>
		<div id="print-root"></div>

		<script src="https://unpkg.com/react@17/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
		<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
			import {
				getAuth,
				onAuthStateChanged,
				GoogleAuthProvider,
				signInWithPopup,
				signOut,
			} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
			import {
				getFirestore,
				collection,
				addDoc,
				onSnapshot,
				doc,
				updateDoc,
				query,
				setDoc,
				deleteDoc,
				where,
				getDocs,
				Timestamp,
				orderBy,
				writeBatch,
				limit,
				startAfter,
				getDoc,
				deleteField,
			} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
			window.firebase = {
				initializeApp,
				getAuth,
				onAuthStateChanged,
				GoogleAuthProvider,
				signInWithPopup,
				signOut,
				getFirestore,
				collection,
				addDoc,
				onSnapshot,
				doc,
				updateDoc,
				query,
				setDoc,
				deleteDoc,
				where,
				getDocs,
				Timestamp,
				orderBy,
				writeBatch,
				limit,
				startAfter,
				getDoc,
				deleteField, // <-- Tambahkan deleteField di sini
			};
		</script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
		<script
			src="https://unpkg.com/html5-qrcode"
			type="text/javascript"
		></script>

		<script type="text/babel">
			// --- React Code Starts Here ---
			const { useState, useEffect, useMemo, useRef, useCallback, useLayoutEffect } = React;

			const useMediaQuery = (query) => {
				const [matches, setMatches] = useState(false);
				useEffect(() => {
					const media = window.matchMedia(query);
					if (media.matches !== matches) {
						setMatches(media.matches);
					}
					const listener = () => setMatches(media.matches);
					window.addEventListener("resize", listener);
					return () => window.removeEventListener("resize", listener);
				}, [matches, query]);
				return matches;
			};

			// --- Firebase Configuration ---
			const firebaseConfig = {
				// Your Firebase config is secure and has been retained.
				apiKey: "AIzaSyADsec0BmVk5NeV5BCZIhNt7f6re9Og5hk",
				authDomain: "griphub-stock.firebaseapp.com",
				projectId: "griphub-stock",
				storageBucket: "griphub-stock.firebasestorage.app",
				messagingSenderId: "704654191502",
				appId: "1:704654191502:web:54db4f7167866ea0fa12df",
				measurementId: "G-Q5N08D310B",
			};
			const appId =
				typeof __app_id !== "undefined" ? __app_id : firebaseConfig.appId;

			// --- Firebase Initialization ---
			const OWNER_USER_ID = "In0ALPiF22OhaRt6PFXuMHdTCOi1";
			const EMPLOYEE_PASSWORD = "griphubkeren";
			let app, auth, db;
			if (firebaseConfig.apiKey && window.firebase) {
				app = window.firebase.initializeApp(firebaseConfig);
				auth = window.firebase.getAuth(app);
				db = window.firebase.getFirestore(app);
			} else {
				console.error("Firebase config is missing or has not been replaced.");
			}
			
			const generateInvoiceCanvas = async (invoiceData) => {
				const container = document.getElementById("print-root");
				if (!container) throw new Error("Print container not found.");

				const tempContainer = document.createElement("div");
				tempContainer.style.position = "absolute";
				tempContainer.style.left = "-9999px";
				document.body.appendChild(tempContainer);

				const PrintComponent = () => (
					<div className="print-area">
						<InvoiceTemplate invoiceData={invoiceData} />
					</div>
				);

				return new Promise((resolve, reject) => {
					ReactDOM.render(<PrintComponent />, tempContainer, () => {
						// --- PERUBAHAN DI SINI ---
						// Tambahkan jeda singkat untuk memastikan QR code sudah dirender sepenuhnya
						setTimeout(async () => {
							try {
								const a4Element = tempContainer.querySelector(".preview-a4");
								if (!a4Element) throw new Error("A4 preview element not found.");

								// Pastikan semua gambar (termasuk QR code yang mungkin berupa img) sudah dimuat
								const images = a4Element.getElementsByTagName('img');
								const promises = Array.from(images).map(img => {
									if (!img.complete) {
										return new Promise(res => {
											img.onload = res;
											img.onerror = res;
										});
									}
									return Promise.resolve();
								});
								await Promise.all(promises);
								
								const canvas = await html2canvas(a4Element, {
									scale: 3,
									useCORS: true,
									logging: true,
									allowTaint: true,
								});
								resolve(canvas);
							} catch (error) {
								reject(error);
							} finally {
								ReactDOM.unmountComponentAtNode(tempContainer);
								document.body.removeChild(tempContainer);
							}
						}, 500); // Jeda 500ms
					});
				});
			};


			// --- Helper Functions & Constants ---
			const formatRupiahDisplay = (number) => {
				if (isNaN(number) || number === null) return "Rp 0";
				return new Intl.NumberFormat("id-ID", {
					style: "currency",
					currency: "IDR",
					minimumFractionDigits: 0,
					// --- PERUBAHAN DI SINI: Tambahkan baris ini ---
					maximumFractionDigits: 0,
				}).format(number);
			};

			const parseStorage = (storageStr) => {
				if (!storageStr) return 0;
				const str = storageStr.toLowerCase().replace(/\s/g, "");
				const num = parseInt(str, 10);
				if (isNaN(num)) return 0;
				if (str.includes("tb")) {
					return num * 1024; // Convert TB to GB
				}
				return num; 
			};

			const smartSearch = (targetText, searchText) => {
				if (!searchText || !searchText.trim()) {
					return true;
				}
				const lowerTarget = targetText?.toString().toLowerCase() || "";
				const lowerSearch = searchText.toLowerCase();
				const keywords = lowerSearch.split(" ").filter((k) => k);
				return keywords.every((keyword) => lowerTarget.includes(keyword));
			};

			const savePhoneMasterData = async (userId, newModelKey, modelDetails) => {
				if (!userId || !db || !newModelKey || !modelDetails) return;

				const phoneDataRef = window.firebase.doc(
					db,
					"artifacts",
					appId,
					"users",
					userId,
					"phone_data",
					"master_list",
				);

				try {
					// Menggunakan updateDoc untuk menambahkan/memperbarui satu field tanpa menimpa seluruh dokumen
					await window.firebase.updateDoc(phoneDataRef, {
						[`models.${newModelKey}`]: {
							storage: modelDetails.storage || [],
							colors: modelDetails.colors || [],
							ram: modelDetails.ram || [],
							colorImages: {}, // Default ke objek kosong
						},
					});

					await addLog(userId, {
						message: `Created new phone data for model: "${newModelKey}" from inventory input.`,
						type: "CREATE_PHONE_DATA",
					});
					console.log(`Successfully saved master data for ${newModelKey}`);
				} catch (error) {
					console.error("Failed to save new phone master data:", error);
					// Melempar error agar bisa ditangkap oleh fungsi pemanggil jika diperlukan
					throw error;
				}
			};

			const formatNumberInput = (value) => {
				if (!value) return "";
				const numberValue = parseInt(
					value.toString().replace(/[^0-9]/g, ""),
					10,
				);
				if (isNaN(numberValue)) return "";
				return numberValue.toLocaleString("id-ID");
			};

			const parseFormattedNumber = (value) => {
				if (!value) return 0;
				return parseInt(value.toString().replace(/[^0-9]/g, ""), 10) || 0;
			};

			const formatDate = (date, includeTime = true) => {
				if (!date) return "N/A";
				const d = date.toDate ? date.toDate() : new Date(date);
				if (isNaN(d.getTime())) return "N/A";
				const options = { month: "short", day: "2-digit", year: "numeric" };
				if (includeTime) {
					options.hour = "2-digit";
					options.minute = "2-digit";
					options.hour12 = false;
				}
				return d.toLocaleString("en-US", options).replace(",", "");
			};

			const timestampToDateTimeLocal = (timestamp) => {
				if (!timestamp) return "";
				const date = timestamp.toDate
					? timestamp.toDate()
					: new Date(timestamp);
				if (isNaN(date.getTime())) return "";
				const ten = (i) => (i < 10 ? "0" : "") + i;
				return `${date.getFullYear()}-${ten(date.getMonth() + 1)}-${ten(date.getDate())}T${ten(date.getHours())}:${ten(date.getMinutes())}`;
			};

			const formatPhoneNumberDisplay = (phone) => {
				if (!phone) return "";
				let cleaned = phone.toString().replace(/\D/g, "");
				if (cleaned.startsWith("62")) {
					return "0" + cleaned.substring(2);
				}
				return cleaned;
			};

			const logoBase64 = "https://i.imgur.com/SSbdOdP.png";

			const addLog = async (userId, logData) => {
				if (!OWNER_USER_ID || !db) return; 
				const logCollectionRef = window.firebase.collection(
					db,
					"artifacts",
					appId,
					"users",
					OWNER_USER_ID,
					"logs",
				);

				try {
					const finalLogData = {
						...logData,
						actor: userId, 
						timestamp: window.firebase.Timestamp.fromDate(new Date()),
					};

					await window.firebase.addDoc(logCollectionRef, finalLogData);

					if (Math.random() < 0.1) {
						const LOG_LIMIT = 50; 
						const q = window.firebase.query(
							logCollectionRef,
							window.firebase.orderBy("timestamp", "desc"),
						);

						const snapshot = await window.firebase.getDocs(q);

						if (snapshot.size > LOG_LIMIT) {
							const batch = window.firebase.writeBatch(db);
							const docsToDelete = snapshot.docs.slice(LOG_LIMIT);

							docsToDelete.forEach((doc) => {
								batch.delete(doc.ref);
							});

							await batch.commit();
							console.log(
								`Log cleanup: Deleted ${docsToDelete.length} oldest logs.`,
							);
						}
					}
				} catch (error) {
					console.error(
						"Error in addLog function (either adding or cleaning up):",
						error,
					);
				}
			};

			const generateBillMessage = (invoiceData) => {
				const {
					customerName,
					invoiceNumber,
					items,
					otherCosts,
					costDescription,
					otherCostsList,
					discount,
				total,
					amountPaid,
				} = invoiceData;

				const groupedItems = Object.values(
					items.reduce((acc, item) => {
						const key = item.phoneModel
							? [item.phoneModel, item.storage, item.ram, item.color]
									.filter(Boolean)
									.join(" ")
							: item.itemName;

							if (!acc[key]) {
								acc[key] = {
									name: key,
									quantity: 0,
									subTotal: 0,
									unitPrice: item.soldPrice,
								};
							}

						acc[key].quantity += item.quantity || 1;
						acc[key].subTotal += item.soldPrice * (item.quantity || 1);
						return acc;
					}, {}),
				);

				let message = `Halo ${customerName},
`;
				message += `Berikut adalah tagihan untuk pesanan Anda:

`;
				message += `*Nomor Order: ${invoiceNumber}*

`;
				message += `*Detail Item:*
`;

				groupedItems.forEach((group) => {
					message += `${group.name}
`;
					message += `Qty: ${group.quantity}, @${formatRupiahDisplay(
						group.unitPrice,
					)}
`;
					message += `Subtotal: ${formatRupiahDisplay(group.subTotal)}
`;
					message += `
`;
				});

				let hasExtraCosts = false;
				if (discount > 0) {
					message += `*Diskon:* -${formatRupiahDisplay(discount)}
`;
					hasExtraCosts = true;
				}

				if (otherCostsList && otherCostsList.length > 0) {
					otherCostsList.forEach((cost) => {
						if (cost.buyerAmount > 0) {
							message += `*${cost.description}:* ${formatRupiahDisplay(
								cost.buyerAmount,
							)}
`;
							hasExtraCosts = true;
						}
					});
				} else if (otherCosts > 0) {
					message += `*${ 
						costDescription || "Biaya Lainnya"
					}:* ${formatRupiahDisplay(otherCosts)}
`;
					hasExtraCosts = true;
				}

				if (hasExtraCosts) {
					message += `
`;
				}

				message += `*TOTAL: ${formatRupiahDisplay(total)}*
`;

				if (amountPaid && amountPaid > 0) {
					const balance = total - amountPaid;

					message += `
------------------------------------
`;
					message += `
`;
					message += `Terbayar: ${formatRupiahDisplay(amountPaid)}
`;
					if (balance > 0) {
						message += `*Kurang: ${formatRupiahDisplay(balance)}*
`;
					}
				}

				message += `
------------------------------------
`;
				message += `Silakan lakukan pembayaran ke:
`;
				message += `*BCA 5271489375*
`;
				message += `a.n. Aldrey Eka Putra

`;
				message += `Terima kasih!`;

				return message;
			};

			const CameraIcon = () => (
				<svg
					xmlns="http://www.w3.org/2000/svg"
					className="h-5 w-5"
					viewBox="0 0 20 20"
					fill="currentColor"
				>
					<path
						fillRule="evenodd"
						d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z"
						clipRule="evenodd"
					/>
				</svg>
			);

			const DEFAULT_ZOOM_LEVEL = 2.0;

			function BarcodeScanner({ onScanSuccess, onClose }) {
				const scannerRef = useRef(null);
				const html5QrCodeRef = useRef(null);
				const videoTrackRef = useRef(null);

				const [zoom, setZoom] = useState(DEFAULT_ZOOM_LEVEL);
				const [maxZoom, setMaxZoom] = useState(1);
				const [isZoomSupported, setIsZoomSupported] = useState(false);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				useEffect(() => {
					let isComponentActive = true;

					if (!scannerRef.current || typeof Html5Qrcode === "undefined") return;

					const html5QrCode = new Html5Qrcode(scannerRef.current.id);
					html5QrCodeRef.current = html5QrCode;

					const qrCodeSuccessCallback = (decodedText, decodedResult) => {
						onScanSuccess(decodedText);
					};

					const config = {
						fps: 25,
						qrbox: { width: 300, height: 50 },
						rememberLastUsedCamera: true,
						videoConstraints: {
							width: { ideal: 1920 },
							height: { ideal: 1080 },
							facingMode: "environment",
						},
					};

					const startScanner = async () => {
						try {
							if (!isComponentActive) return;
							await html5QrCode.start(
								{ facingMode: "environment" },
								config,
								qrCodeSuccessCallback,
								(errorMessage) => {},
							);

							const videoElement = document
								.getElementById("qr-reader")
								?.querySelector("video");
							if (videoElement?.srcObject) {
								const track = videoElement.srcObject.getVideoTracks()[0];
								videoTrackRef.current = track;
								const capabilities = track.getCapabilities();

								if (capabilities.zoom) {
									setIsZoomSupported(true);
									const currentMaxZoom = capabilities.zoom.max;
									setMaxZoom(currentMaxZoom);
									const targetZoom = Math.min(
										DEFAULT_ZOOM_LEVEL,
										currentMaxZoom,
									);

									track
										.applyConstraints({ advanced: [{ zoom: targetZoom }] })
										.then(() => {
											if (isComponentActive) setZoom(targetZoom);
										})
										.catch((err) =>
											console.error("Gagal menerapkan zoom default:", err),
										);
								}
							}
						} catch (err) {
							if (isComponentActive) {
								console.error("Tidak bisa memulai scanner.", err);
								alert("Gagal memulai kamera. Mohon periksa izin akses kamera.");
								onClose();
							}
						}
					};

					startScanner();

					return () => {
						isComponentActive = false;
						if (html5QrCodeRef.current?.isScanning) {
							html5QrCodeRef.current
								.stop()
								.catch((err) =>
									console.error(
										"Gagal menghentikan scanner saat cleanup.",
										err,
									),
								);
						}
					};
				}, []);

				const handleZoomChange = (newZoom) => {
					if (videoTrackRef.current && isZoomSupported) {
						const clampedZoom = Math.max(1, Math.min(newZoom, maxZoom));
						videoTrackRef.current
							.applyConstraints({ advanced: [{ zoom: clampedZoom }] })
							.then(() => setZoom(clampedZoom))
							.catch((err) => console.error("Gagal menerapkan zoom:", err));
					}
					else {
						const videoElement = document
							.getElementById("qr-reader")
							?.querySelector("video");
						if (videoElement) {
							const clampedZoom = Math.max(1, Math.min(newZoom, 5));
							setZoom(clampedZoom);
							videoElement.style.transform = `scale(${clampedZoom})`;
							videoElement.style.transformOrigin = "center center";

							if (maxZoom <= 1) setMaxZoom(5);
						}
					}
				};
				const handleZoomIn = () => handleZoomChange(zoom + 0.5);
				const handleZoomOut = () => handleZoomChange(zoom - 0.5);

				return (
					<div className="fixed inset-0 bg-black bg-opacity-90 flex flex-col justify-center items-center z-[10000] p-4">
						<div className="relative bg-black rounded-2xl shadow-xl w-full max-w-sm md:w-[360px] md:h-[640px] flex flex-col overflow-hidden">
							<div
								id="qr-reader"
								ref={scannerRef}
								className="w-full flex-grow bg-gray-800"
							></div>
							<button
								onClick={onClose}
								className="absolute top-4 right-4 bg-white/80 text-black rounded-full h-8 w-8 flex items-center justify-center font-bold text-lg hover:bg-white z-10"
							>
								×
							</button>

							<div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex items-center bg-black/50 rounded-full p-2 space-x-4">
								<button
									onClick={handleZoomOut}
									disabled={zoom <= 1}
									className="text-white text-2xl font-bold w-10 h-10 rounded-full flex items-center justify-center bg-white/20 hover:bg-white/30 disabled:opacity-50 disabled:cursor-not-allowed"
								>
									-
								</button>
								<span className="text-white font-semibold w-16 text-center">
									{zoom.toFixed(1)}x
								</span>
								<button
									onClick={handleZoomIn}
									disabled={zoom >= maxZoom}
									className="text-white text-2xl font-bold w-10 h-10 rounded-full flex items-center justify-center bg-white/20 hover:bg-white/30 disabled:opacity-50 disabled:cursor-not-allowed"
								>
									+
								</button>
							</div>
						</div>
						<p className="text-white mt-4 text-center">
							Arahkan kamera ke barcode
						</p>
					</div>
				);
			}
			
						const PlusIcon = () => (
				<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
					<path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" />
				</svg>
			);

			function AddOrderModal({ isOpen, onClose, invoices, onSelect }) {
				const [searchTerm, setSearchTerm] = useState('');

				const filteredInvoices = useMemo(() => {
					if (!searchTerm) return invoices;
					const lowercasedTerm = searchTerm.toLowerCase();
					return invoices.filter(invoice =>
						invoice.id.toLowerCase().includes(lowercasedTerm) ||
						invoice.purchaseAccount.toLowerCase().includes(lowercasedTerm) ||
						invoice.summary.toLowerCase().includes(lowercasedTerm)
					);
				}, [invoices, searchTerm]);
				
				if (!isOpen) return null;

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10001] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg flex flex-col max-h-[80vh]">
							<div className="flex justify-between items-center mb-4 flex-shrink-0">
								<h3 className="text-xl font-bold">Tambahkan Order Lain</h3>
								<button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
							</div>
							<input
								type="text"
								value={searchTerm}
								onChange={(e) => setSearchTerm(e.target.value)}
								placeholder="Cari Order ID, Akun, atau Item..."
								className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border mb-4 flex-shrink-0"
							/>
							<div className="flex-grow overflow-y-auto no-scrollbar pr-2">
								{filteredInvoices.length > 0 ? (
									<div className="space-y-3">
										{filteredInvoices.map((invoice) => (
											<button
												key={invoice.id}
												onClick={() => onSelect(invoice.id)}
												className="w-full text-left p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50 transition"
											>
												<p className="font-bold text-lg">{`${invoice.id} - ${invoice.purchaseAccount}`}</p>
												<p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{invoice.summary}</p>
											</button>
										))}
									</div>
								) : (
									<p className="text-center text-gray-500 py-8">Tidak ada order lain yang tersedia.</p>
								)}
							</div>
						</div>
					</div>
				);
			}

															function DeliveryUpdatePage({
	ownerUserId,
	isModalMode = false,
	onClose = () => {},
	phoneData: propPhoneData,
}) {
	const [view, setView] = useState("list");
	const [loading, setLoading] = useState(true);
	const [error, setError] = useState("");
	const [internalPhoneData, setInternalPhoneData] = useState(propPhoneData || null);
	const [phoneDataLoading, setPhoneDataLoading] = useState(!propPhoneData);
	const [allIncompleteInvoices, setAllIncompleteInvoices] = useState([]);
	const [searchTerm, setSearchTerm] = useState("");

	const [processingItems, setProcessingItems] = useState([]);
	const [activeInvoiceIds, setActiveInvoiceIds] = useState([]);
	
	const [imeiValues, setImeiValues] = useState({});
	const [pendingColorChanges, setPendingColorChanges] = useState({});
	const [additionalCost, setAdditionalCost] = useState(0);
	const [addToUnpaidHpp, setAddToUnpaidHpp] = useState(false);
	const [isSaving, setIsSaving] = useState(false);

	const [isColorModalOpen, setIsColorModalOpen] = useState(false);
	const [itemToChangeColor, setItemToChangeColor] = useState(null);
	const [isScannerOpen, setIsScannerOpen] = useState(false);
	const [scannerTarget, setScannerTarget] = useState({ stockId: null });

	const [isAddOrderModalOpen, setIsAddOrderModalOpen] = useState(false);


	useEffect(() => {
		if (propPhoneData) {
			setInternalPhoneData(propPhoneData);
			setPhoneDataLoading(false);
		} else {
			const phoneDataRef = window.firebase.doc(db, "artifacts", appId, "users", ownerUserId, "phone_data", "master_list");
			const fetchPhoneData = async () => {
				try {
					const docSnap = await window.firebase.getDoc(phoneDataRef);
					if (docSnap.exists()) setInternalPhoneData(docSnap.data().models);
					else setError("Konfigurasi data HP tidak ditemukan.");
				} catch (err) {
					setError("Gagal memuat konfigurasi data HP.");
				} finally {
					setPhoneDataLoading(false);
				}
			};
			fetchPhoneData();
		}
	}, [propPhoneData, ownerUserId]);

	const handleLogout = async () => {
		if (!auth) return;
		try {
			await window.firebase.signOut(auth);
			window.location.reload();
		} catch (error) {
			alert("Gagal logout.");
		}
	};

	const fetchIncompleteInvoices = useCallback(async () => {
		setLoading(true);
		setError("");
		try {
			const stockCollectionRef = window.firebase.collection(db, "artifacts", appId, "users", ownerUserId, "stock");
			const q = window.firebase.query(stockCollectionRef, window.firebase.where("imei", "==", ""), window.firebase.where("availability", "in", ["On Delivery", "Available"]));
			const querySnapshot = await window.firebase.getDocs(q);

			const invoicesMap = new Map();
			querySnapshot.docs.forEach((doc) => {
				const item = { id: doc.id, ...doc.data() };
				if (item.invoice) {
					if (!invoicesMap.has(item.invoice)) {
						invoicesMap.set(item.invoice, { id: item.invoice, purchaseAccount: item.purchaseAccount || "N/A", items: [] });
					}
					invoicesMap.get(item.invoice).items.push(item);
				}
			});

			const incompleteList = Array.from(invoicesMap.values()).map((invoice) => {
				const itemCounts = invoice.items.reduce((acc, item) => {
					const key = [item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join(" ");
					acc[key] = (acc[key] || 0) + 1;
					return acc;
				}, {});
				const summary = Object.entries(itemCounts).map(([desc, count]) => `${count}x ${desc}`).join(", ");
				return { ...invoice, summary };
			}).sort((a, b) => a.id.localeCompare(b.id));

			setAllIncompleteInvoices(incompleteList);
		} catch (err) {
			setError("Gagal memuat daftar order.");
		} finally {
			setLoading(false);
		}
	}, [ownerUserId]);

	useEffect(() => { fetchIncompleteInvoices(); }, [fetchIncompleteInvoices]);

	const filteredInvoicesForList = useMemo(() => {
		if (!searchTerm) return allIncompleteInvoices;
		const lowercasedTerm = searchTerm.toLowerCase();
		return allIncompleteInvoices.filter(invoice => 
			invoice.id.toLowerCase().includes(lowercasedTerm) || 
			invoice.purchaseAccount.toLowerCase().includes(lowercasedTerm) || 
			invoice.summary.toLowerCase().includes(lowercasedTerm)
		);
	}, [searchTerm, allIncompleteInvoices]);

	const handleStartProcessing = (invoice) => {
		setImeiValues({});
		setPendingColorChanges({});
		setAdditionalCost(0);
		setAddToUnpaidHpp(false);
		setActiveInvoiceIds([invoice.id]);
		setProcessingItems(invoice.items.sort((a, b) => (a.creationTimestamp?.toMillis() || 0) - (b.creationTimestamp?.toMillis() || 0)));
		setView('processing');
	};
	
	const handleAddAnotherOrder = (invoiceId) => {
		if (!invoiceId || activeInvoiceIds.includes(invoiceId)) return;
		const invoiceToAdd = allIncompleteInvoices.find(inv => inv.id === invoiceId);
		if (invoiceToAdd) {
			setActiveInvoiceIds(prev => [...prev, invoiceId]);
			setProcessingItems(prev => {
				const combined = [...prev, ...invoiceToAdd.items];
				combined.sort((a, b) => (a.creationTimestamp?.toMillis() || 0) - (b.creationTimestamp?.toMillis() || 0));
				return combined;
			});
		}
	};
	
	const handleRemoveOrder = (invoiceIdToRemove) => {
		const newActiveIds = activeInvoiceIds.filter(id => id !== invoiceIdToRemove);
		const newProcessingItems = processingItems.filter(item => item.invoice !== invoiceIdToRemove);

		if (newProcessingItems.length === 0) {
			handleCancelProcessing();
		} else {
			setActiveInvoiceIds(newActiveIds);
			setProcessingItems(newProcessingItems);
		}
	};

	const handleCancelProcessing = () => {
		setView('list');
		setProcessingItems([]);
		setActiveInvoiceIds([]);
	};

	const handleImeiChange = (stockId, value) => setImeiValues((prev) => ({...prev, [stockId]: value }));
	const handleScanSuccess = (scannedText) => {
		if (scannerTarget.stockId) {
			handleImeiChange(scannerTarget.stockId, scannedText);
			setIsScannerOpen(false);
		}
	};
	const handleColorChange = (newColor) => {
		if (itemToChangeColor) {
			setPendingColorChanges(prev => ({...prev, [itemToChangeColor.id]: newColor }));
			setIsColorModalOpen(false);
		}
	};

			const handleSave = async () => {
		setIsSaving(true);
		const batch = window.firebase.writeBatch(db);
		const currentTime = window.firebase.Timestamp.fromDate(new Date());

		const itemsWithNewImei = processingItems.filter(item => imeiValues[item.id]?.trim());
		const costPerItem = itemsWithNewImei.length > 0 ? additionalCost / itemsWithNewImei.length : 0;
		const logsToCreate = [];
		const allChangedStockIds = new Set([...Object.keys(imeiValues).filter(id => imeiValues[id]?.trim()), ...Object.keys(pendingColorChanges)]);

		for (const stockId of allChangedStockIds) {
			const originalItem = processingItems.find(item => item.id === stockId);
			if (!originalItem) continue;

			const updatePayload = {};
			const changes = [];
			const hasImeiUpdate = imeiValues[stockId]?.trim();
			const hasColorUpdate = pendingColorChanges[stockId];

			if (hasImeiUpdate) {
				updatePayload.imei = imeiValues[stockId].trim();
				updatePayload.availability = "Available";
				updatePayload.deliveryDate = currentTime;
				changes.push(`IMEI set to "${updatePayload.imei}"`);
			}
			if (hasColorUpdate) {
				updatePayload.color = pendingColorChanges[stockId];
				changes.push(`Color from "${originalItem.color}" to "${updatePayload.color}"`);
			}
			
			if (hasImeiUpdate) {
				const price = originalItem.price || 0;
				const discount = originalItem.discount || 0;
				const priceAfterDiscount = price - (price * (discount / 100));

				// --- PERBAIKAN KALKULASI DIMULAI DI SINI ---
				// 1. Hitung total biaya tambahan yang baru dengan mengakumulasi biaya sebelumnya.
				const newTotalAdditionalCost = (originalItem.additionalCost || 0) + costPerItem;
				// 2. Hitung HPP baru berdasarkan harga setelah diskon + TOTAL biaya tambahan.
				const newHpp = priceAfterDiscount + newTotalAdditionalCost;

				// 3. Siapkan data untuk diupdate dengan nilai yang sudah benar.
				updatePayload.hpp = newHpp;
				updatePayload.additionalCost = newTotalAdditionalCost;
				
				changes.push(`Additional Cost updated to "${formatRupiahDisplay(newTotalAdditionalCost)}"`);
				changes.push(`HPP updated to "${formatRupiahDisplay(newHpp)}"`);

				if (addToUnpaidHpp) {
					// Jika dicentang, total terutang (unpaidHpp) adalah HPP penuh.
					updatePayload.unpaidHpp = newHpp;
					changes.push(`Unpaid HPP set to HPP value: "${formatRupiahDisplay(newHpp)}"`);
				} else {
					// Jika tidak, total terutang hanya harga pokok beli setelah diskon.
					updatePayload.unpaidHpp = priceAfterDiscount;
					changes.push(`Unpaid HPP set to Price value: "${formatRupiahDisplay(priceAfterDiscount)}"`);
				}
				// --- AKHIR DARI BLOK PERBAIKAN ---
			}

			const docRef = window.firebase.doc(db, "artifacts", appId, "users", ownerUserId, "stock", stockId);
			batch.update(docRef, updatePayload);
			const itemIdentifier = [originalItem.phoneModel, originalItem.storage, originalItem.color].filter(Boolean).join(" ");
			logsToCreate.push({
				message: `Updated item in Order ID ${originalItem.invoice} (${itemIdentifier}): ${changes.join("; ")}.`,
				type: isModalMode ? "ADMIN_DELIVERY_UPDATE" : "EMPLOYEE_DELIVERY_UPDATE",
				context: { docId: stockId, previousData: originalItem },
			});
		}
		
		try {
			await batch.commit();
			for (const log of logsToCreate) await addLog(ownerUserId, log);
			alert(`Berhasil menyimpan perubahan!`);
			fetchIncompleteInvoices();
			handleCancelProcessing();
		} catch (err) {
			alert("Gagal menyimpan data.");
		} finally {
			setIsSaving(false);
		}
	};

	
	const isAnyChangePending = useMemo(() => Object.values(imeiValues).some(v => v?.trim()) || Object.keys(pendingColorChanges).length > 0, [imeiValues, pendingColorChanges]);
	
	const ColorChangeModal = ({ item, onClose, onSave, phoneData }) => {
		const [newColor, setNewColor] = useState(item.color);
		const availableColors = phoneData?.[item.phoneModel]?.colors || [];

		return (
			<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10001] p-4">
				<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
					<h3 className="text-lg font-bold mb-4">Ganti Warna untuk {item.phoneModel}</h3>
					<p className="text-sm text-gray-500 dark:text-gray-400 mb-1">Warna Saat Ini: <span className="font-semibold">{item.color}</span></p>
					<select value={newColor} onChange={(e) => setNewColor(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 mb-6">
						{availableColors.map((color) => (<option key={color} value={color}>{color}</option>))}
					</select>
					<div className="flex justify-end space-x-4">
						<button onClick={onClose} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Batal</button>
						<button onClick={() => onSave(newColor)} disabled={newColor === item.color} className="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:opacity-50">Ganti Warna</button>
					</div>
				</div>
			</div>
		);
	};

	return (
		<div className={isModalMode ? "" : "min-h-screen flex items-center justify-center p-4"}>
			<AddOrderModal
				isOpen={isAddOrderModalOpen}
				onClose={() => setIsAddOrderModalOpen(false)}
				invoices={allIncompleteInvoices.filter(inv => !activeInvoiceIds.includes(inv.id))}
				onSelect={(invoiceId) => {
					handleAddAnotherOrder(invoiceId);
					setIsAddOrderModalOpen(false);
				}}
			/>

			{isScannerOpen && <BarcodeScanner onScanSuccess={handleScanSuccess} onClose={() => setIsScannerOpen(false)} />}
			{isColorModalOpen && itemToChangeColor && <ColorChangeModal item={itemToChangeColor} onClose={() => setIsColorModalOpen(false)} onSave={handleColorChange} phoneData={internalPhoneData} />}
			<div className="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8 flex flex-col max-h-[90vh]">
				<div className="text-center mb-8 flex-shrink-0">
					<img src={logoBase64} alt="Griphub Logo" className="h-20 w-20 mx-auto mb-4" />
					<h1 className="text-3xl font-bold text-gray-900 dark:text-white">Update IMEI Barang Datang</h1>
					<p className="text-gray-500 dark:text-gray-400 mt-2">
						{view === 'list' ? 'Pilih Order untuk memulai.' : 'Isi IMEI dan tambahkan order lain jika perlu.'}
					</p>
				</div>
				<div className="flex-grow overflow-y-auto no-scrollbar">
					{view === 'list' && (
						<>
							<div className="mb-6"><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Cari Order ID..." className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border" /></div>
							{loading ? ( <div className="text-center text-gray-500">Memuat...</div> ) : (
								<div className="space-y-3">
									{filteredInvoicesForList.map((invoice) => (
										<button key={invoice.id} onClick={() => handleStartProcessing(invoice)} className="w-full text-left p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/50">
											<p className="font-bold text-lg">{`${invoice.id} - ${invoice.purchaseAccount}`}</p>
											<p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{invoice.summary}</p>
										</button>
									))}
								</div>
							)}
						</>
					)}
					{view === 'processing' && (
						<div className="space-y-6">
							{activeInvoiceIds.map(invoiceId => {
								const itemsForThisInvoice = processingItems.filter(item => item.invoice === invoiceId);
								const invoiceInfo = allIncompleteInvoices.find(inv => inv.id === invoiceId);
								return (
									<div key={invoiceId} className="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg">
										<div className="flex justify-between items-center border-b border-gray-300 dark:border-gray-600 pb-2 mb-3">
											<h3 className="font-bold text-lg">{`${invoiceId} - ${invoiceInfo?.purchaseAccount}`}</h3>
											<button onClick={() => handleRemoveOrder(invoiceId)} className="text-red-500 hover:text-red-700 text-2xl font-bold">&times;</button>
										</div>
										<div className="space-y-4">
											{itemsForThisInvoice.map(item => {
												const displayColor = pendingColorChanges[item.id] || item.color;
												return (
													// --- PERUBAHAN DI SINI: Hapus class styling dari div ini ---
													<div key={item.id}>
														<div className="flex justify-between items-center mb-2">
															<p className="font-semibold text-sm">{[item.phoneModel, item.storage, displayColor].filter(Boolean).join(" ")}</p>
															<button type="button" onClick={() => { setItemToChangeColor(item); setIsColorModalOpen(true); }} className="text-xs bg-gray-500 hover:bg-gray-600 text-white font-semibold py-1 px-2 rounded">Ganti Warna</button>
														</div>
														<div className="flex items-stretch gap-2">
															<input type="text" value={imeiValues[item.id] || ""} onChange={(e) => handleImeiChange(item.id, e.target.value)} placeholder="Ketik atau Scan IMEI" className="flex-grow p-2 bg-gray-100 dark:bg-gray-700 rounded-l-md border"/>
															<button type="button" onClick={() => { setScannerTarget({ stockId: item.id }); setIsScannerOpen(true); }} className="p-3 bg-gray-600 text-white hover:bg-gray-700 rounded-r-md"><CameraIcon /></button>
														</div>
													</div>
												);
											})}
										</div>
									</div>
								);
							})}
							
							<div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
								<button
									type="button"
									onClick={() => setIsAddOrderModalOpen(true)}
									className="w-full flex items-center justify-center gap-2 p-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
									disabled={allIncompleteInvoices.filter(inv => !activeInvoiceIds.includes(inv.id)).length === 0}
								>
									<PlusIcon />
									Tambahkan Order ID Lain
								</button>
							</div>

							<div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
								<div>
									<label className="block text-sm font-medium mb-1">Biaya Tambahan Global (Opsional)</label>
									<input type="text" inputMode="numeric" value={formatNumberInput(additionalCost || "")} onChange={(e) => setAdditionalCost(parseFormattedNumber(e.target.value))} placeholder="Dibagi rata ke item yang diinput IMEI" className="w-full p-2 bg-white dark:bg-gray-800 rounded-md border"/>
								</div>
								<div className="flex items-center gap-3">
									<input id="unpaid-hpp-checkbox" type="checkbox" checked={addToUnpaidHpp} onChange={(e) => setAddToUnpaidHpp(e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-blue-600"/>
									<label htmlFor="unpaid-hpp-checkbox" className="text-sm font-medium">Tambahkan ongkos ke unpaid HPP?</label>
								</div>
							</div>
						</div>
					)}
				</div>
				<div className="pt-6 mt-2 flex-shrink-0">
					{view === 'processing' ? (
						<div className="flex gap-4">
							<button onClick={handleCancelProcessing} className="w-full bg-gray-500 text-white font-semibold py-3 rounded-lg hover:bg-gray-600 transition">Batal</button>
							<button onClick={handleSave} disabled={isSaving || !isAnyChangePending} className="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition disabled:opacity-50">
								{isSaving ? "Menyimpan..." : "Simpan Perubahan"}
							</button>
						</div>
					) : (
						!isModalMode &&
						<button type="button" onClick={handleLogout} className="w-full bg-red-600 text-white font-semibold py-2.5 rounded-lg hover:bg-red-700 transition">Logout</button>
					)}
					{isModalMode && view === 'list' && (
						<button type="button" onClick={onClose} className="w-full bg-gray-500 text-white font-semibold py-2.5 rounded-lg hover:bg-gray-600 transition mt-4">Tutup</button>
					)}
				</div>
			</div>
		</div>
	);
}

			function InvoiceTemplate({ invoiceData }) {
				const qrCodeRef = useRef(null);

				useEffect(() => {
					const paymentStatus = invoiceData.paymentStatus || "Lunas";
					const invoiceId = invoiceData.id;
					const qrCodeContainer = qrCodeRef.current;

					if (qrCodeContainer) {
						qrCodeContainer.innerHTML = '';
						if (paymentStatus.toUpperCase() === 'LUNAS' && invoiceId) {
							const validationUrl = `https://griphub.biz.id/validation.html?invoice=${invoiceId}`;
							new QRCode(qrCodeContainer, {
								text: validationUrl,
								width: 96,
								height: 96,
								colorDark: "#000000",
								colorLight: "#ffffff",
								correctLevel: QRCode.CorrectLevel.H
							});
						}
					}
				}, [invoiceData]);

				const subTotal =
					invoiceData.subTotal ??
					invoiceData.items.reduce((acc, i) => acc + (i.soldPrice || 0), 0);
				const discount = invoiceData.discount || 0;

				const otherCosts = invoiceData.otherCostsList
					? invoiceData.otherCostsList.reduce(
							(acc, cost) => acc + (cost.buyerAmount || 0),
							0,
						)
					: invoiceData.otherCosts || 0;

				const total = invoiceData.total ?? subTotal - discount + otherCosts;
				const paymentStatus = invoiceData.paymentStatus || "Lunas";

				const amountPaid =
					invoiceData.amountPaid ?? (paymentStatus === "Lunas" ? total : 0);
				const balanceDue = total - amountPaid;

				const groupedItems = useMemo(() => {
					return Object.values(
						invoiceData.items.reduce((acc, item) => {
							const key = item.phoneModel
								? [item.phoneModel, item.storage, item.ram, item.color]
										.filter(Boolean)
										.join(" ")
								: item.itemName;
							if (!acc[key]) {
								acc[key] = {
									phoneModel: item.phoneModel || item.itemName,
									storage: item.storage || "",
									ram: item.ram || "",
									color: item.color || "",
									soldPrice: item.soldPrice,
									imeis: [],
									quantity: 0,
									totalAmount: 0,
								};
							}
							if (item.imei) acc[key].imeis.push(item.imei);
							if (item.serialNumbers)
								acc[key].imeis.push(...item.serialNumbers);
							acc[key].quantity += item.quantity || 1;
							acc[key].totalAmount += item.soldPrice * (item.quantity || 1);
							return acc;
						}, {}),
					);
				}, [invoiceData.items]);

				return (
					<div className="preview-a4">
						{paymentStatus && (
							<div className="watermark-container">
								<div className="watermark">{paymentStatus.toUpperCase()}</div>
							</div>
						)}
						<div className="relative z-20 text-gray-800 text-sm pb-40">
							<div className="flex justify-between items-start mb-10">
								<img
									src={logoBase64}
									alt="Griphub Logo"
									crossOrigin="anonymous"
									referrerPolicy="no-referrer"
									className="h-20 w-20"
								/>
								<div className="text-right">
									<h4 className="text-4xl font-bold mb-0">INVOICE</h4>
									<p className="text-sm mt-1">#{invoiceData.invoiceNumber}</p>
								</div>
							</div>
							<div className="flex justify-between mb-8 text-xs">
								<div>
									<p className="font-bold">Griphub Ponsel</p>
									<p>NIB 2805240102495</p>
									<p>Jl. Rawabelong Raya No.12</p>
									<p>Palmerah, Jakarta Barat 11480</p>
								</div>
								<table className="text-right">
									<tbody>
										<tr>
											<td className="font-bold pr-2">Date:</td>
											<td className="text-left">
												{formatDate(invoiceData.date, true)}
											</td>
										</tr>
										<tr>
											<td className="font-bold pr-2">Payment Terms:</td>
											<td className="text-left">{invoiceData.paymentTerms}</td>
										</tr>
										<tr>
											<td className="font-bold pr-2">Balance Due:</td>
											<td className="font-bold text-left">
												{formatRupiahDisplay(balanceDue)}
											</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div className="mb-6 text-sm">
								<p className="font-bold">Bill To:</p>
								<p>{invoiceData.customerName}</p>
								<p>{formatPhoneNumberDisplay(invoiceData.customerPhone)}</p>
							</div>
							<table className="w-full text-left text-xs border-collapse border border-gray-400">
								<thead className="bg-black text-white">
									<tr>
										<th className="pb-3 pl-2 font-bold border border-gray-500">
											Item
										</th>
										<th className="pb-3 pl-2 pr-2 font-bold text-center align-middle leading-tight border border-gray-500">
											Qty
										</th>
										<th className="pb-3 pl-2 pr-2 font-bold text-center align-middle leading-tight border border-gray-500">
											Rate
										</th>
										<th className="pb-3 pl-2 pr-2 font-bold text-center align-middle leading-tight border border-gray-500">
											Amount
										</th>
									</tr>
								</thead>
								<tbody>
									{groupedItems.map((group, idx) => (
										<tr key={idx}>
											<td className="pb-3 pl-2 align-top text-left border border-gray-300">
												{[
													group.phoneModel,
													group.storage,
													group.ram,
													group.color,
												]
													.filter(Boolean)
													.join(" ")}
												{group.imeis.length > 0 && (
													<div className="mt-1.5 text-gray-600 font-mono text-xs break-words">
														{group.imeis.join(", ")}
													</div>
												)}
											</td>
											<td className="pl-2 pr-2 pb-2 align-top text-center border border-gray-300">
												{group.quantity}
											</td>
											<td className="pl-2 pr-2 pb-2 align-top text-center border border-gray-300">
												{formatRupiahDisplay(group.soldPrice)}
											</td>
											<td className="pl-2 pr-2 pb-2 align-top text-center border border-gray-300">
												{formatRupiahDisplay(group.totalAmount)}
											</td>
										</tr>
									))}
								</tbody>
							</table>
							<div className="flex justify-between mt-8 text-xs">
								<div>
									<p className="font-bold">Notes:</p>
									<div>
										{(
											invoiceData.notes || "Kontak Griphub Ponsel : 08995071749"
										)
											.split("\n")
											.filter((line) => line.trim() !== "")
											.map((line, index) => (
												<div key={index}>{line}</div>
											))}
									</div>
									<p className="font-bold mt-2">Warranty:</p>
									<p>Garansi Resmi Indonesia 1 Tahun</p>
								</div>
								<div className="w-2/5">
									<div className="flex justify-between pb-1">
										<span>Subtotal:</span>
										<span>{formatRupiahDisplay(subTotal)}</span>
									</div>
									{discount > 0 && (
										<div className="flex justify-between">
											<span>Discount:</span>
											<span className={discount > 0 ? "text-red-600" : ""}>
												- {formatRupiahDisplay(discount)}
											</span>
										</div>
									)}

									{/* --- PERUBAHAN DI SINI --- */}
									{invoiceData.otherCostsList &&
									invoiceData.otherCostsList.length > 0 ? (
										invoiceData.otherCostsList.map((cost, index) => {
											const isFreeForBuyer =
												(cost.buyerAmount === 0 || !cost.buyerAmount) &&
												cost.sellerAmount > 0;

											if (cost.buyerAmount > 0 || isFreeForBuyer) {
												return (
													<div key={index} className="flex justify-between">
														<span>{cost.description}:</span>
														{isFreeForBuyer ? (
															<span className="font-bold text-green-600">
																FREE
															</span>
														) : (
															<span>
																{formatRupiahDisplay(cost.buyerAmount)}
															</span>
														)}
													</div>
												);
											}
											return null;
										})
									) : invoiceData.otherCosts > 0 ? (
										<div className="flex justify-between">
											<span>
												{invoiceData.costDescription || "Biaya Lainnya"}:
											</span>
											<span>{formatRupiahDisplay(invoiceData.otherCosts)}</span>
										</div>
									) : null}
									{/* --- AKHIR PERUBAHAN --- */}

									<div className="flex justify-between mt-1 pt-1 border-t font-bold text-sm">
										<span>Total:</span>
										<span>{formatRupiahDisplay(total)}</span>
									</div>
									{/* --- PAYMENT DETAILS --- */}
									{amountPaid > 0 && (
										<div className="flex justify-between mt-1 text-green-600">
											<span>Pembayaran Diterima:</span>
											<span>- {formatRupiahDisplay(amountPaid)}</span>
										</div>
									)}
									{balanceDue > 0 && (
    <div className="flex justify-between mt-2 pt-2 border-t-2 border-dashed text-red-600">
        <span>Sisa Tagihan:</span>
        <span>{formatRupiahDisplay(balanceDue)}</span>
    </div>
)}
									{/* --- END OF PAYMENT DETAILS --- */}
									<div className="flex justify-end mt-10">
										<div ref={qrCodeRef} className="w-24 h-24"></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				);
			}

						function App() {
				const [user, setUser] = useState(null);
				const [loading, setLoading] = useState(true);
				const [accessLevel, setAccessLevel] = useState("none"); // 'none', 'admin', 'employee'
				const [theme, setTheme] = useState(
					() => localStorage.getItem("theme") || "dark",
				);

                // --- PERUBAHAN UTAMA DI SINI ---
				// Hook ini sekarang akan mengelola tema berdasarkan halaman yang aktif.
				useEffect(() => {
					const root = window.document.documentElement;

					// Jika pengguna berada di Landing Page (belum login)
					if (accessLevel === 'none') {
						// Hapus kelas 'dark' untuk memaksa mode terang.
						root.classList.remove('dark');
						// Hapus kelas 'light' untuk kembali ke default browser jika ada
						root.classList.remove('light'); 
					} 
					// Jika pengguna berada di dalam panel Admin atau Karyawan
					else {
						// Gunakan logika tema seperti sebelumnya (bisa light/dark).
						const isDark = theme === "dark";
						root.classList.remove(isDark ? "light" : "dark");
						root.classList.add(theme);
						localStorage.setItem("theme", theme);
					}
				}, [theme, accessLevel]); // Tambahkan `accessLevel` sebagai dependency

				const toggleTheme = useCallback(() => {
					setTheme((prevTheme) => (prevTheme === "dark" ? "light" : "dark"));
				}, []);

				useEffect(() => {
					if (OWNER_USER_ID === "GANTI_DENGAN_USER_ID_ANDA") {
						console.error(
							"PENTING: User ID Pemilik belum diatur di dalam kode. Fitur karyawan tidak akan berfungsi.",
						);
					}
				}, []);

				useEffect(() => {
					if (!auth) return;
					const unsubscribe = window.firebase.onAuthStateChanged(
						auth,
						(currentUser) => {
							setUser(currentUser);
							if (currentUser) {
								setAccessLevel("admin");
							}
							setLoading(false);
						},
					);
					return () => unsubscribe();
				}, []);

				if (loading || !auth || !db)
					return (
						<div className="flex items-center justify-center h-screen">
							<div className="text-2xl">Initializing...</div>
						</div>
					);

				if (accessLevel === "admin" && user) {
					return (
						<InventoryApp user={user} theme={theme} toggleTheme={toggleTheme} />
					);
				}
				if (accessLevel === "employee") {
					return (
						<div className="min-h-screen flex items-center justify-center p-4">
							<DeliveryUpdatePage ownerUserId={OWNER_USER_ID} />
						</div>
					);
				}
				// LandingPage sekarang akan selalu ditampilkan dengan latar belakang terang.
				return <LandingPage setAccessLevel={setAccessLevel} />;
			}

						function LoginModal({ onClose, setAccessLevel }) {
				const [view, setView] = useState("main");
				const [password, setPassword] = useState("");
				const [error, setError] = useState("");

				const handleGoogleLogin = async () => {
					const provider = new window.firebase.GoogleAuthProvider();
					try {
						await window.firebase.signInWithPopup(auth, provider);
						// onAuthStateChanged in App component will handle the rest
					} catch (error) {
						console.error("Error during Google sign-in:", error);
						setError("Gagal login dengan Google.");
					}
				};

				const handleEmployeeLogin = (e) => {
					e.preventDefault();
					if (OWNER_USER_ID === "GANTI_DENGAN_USER_ID_ANDA") {
						setError("Fitur karyawan belum diaktifkan oleh admin.");
						return;
					}
					if (password === EMPLOYEE_PASSWORD) {
						setAccessLevel("employee");
					} else {
						setError("Password salah.");
						setPassword("");
					}
				};

				const modalRef = useRef(null);

				useEffect(() => {
					const handleClickOutside = (event) => {
						if (modalRef.current && !modalRef.current.contains(event.target)) {
							onClose();
						}
					};
					document.addEventListener("mousedown", handleClickOutside);
					return () => {
						document.removeEventListener("mousedown", handleClickOutside);
					};
				}, [onClose]);

				const mainView = (
					<div className="space-y-4">
						<button onClick={handleGoogleLogin} className="w-full flex items-center justify-center bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-200 transition">
							<svg className="w-6 h-6 mr-3" viewBox="0 0 48 48">
								<path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path>
							</svg>
							Login sebagai Admin
						</button>
						<button onClick={() => setView("employee")} className="w-full flex items-center justify-center bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition">
							<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-3" viewBox="0 0 20 20" fill="currentColor">
								<path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
							</svg>
							Akses Karyawan
						</button>
					</div>
				);

				const employeeView = (
					<form onSubmit={handleEmployeeLogin} className="space-y-4">
						<input type="password" value={password} onChange={(e) => { setPassword(e.target.value); setError(""); }} placeholder="Password Karyawan" className="w-full p-3 text-center bg-gray-200 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none" />
						<button type="submit" className="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">Masuk</button>
						<button type="button" onClick={() => { setView("main"); setError(""); }} className="w-full text-center text-xs text-gray-500 dark:text-gray-400 hover:underline pt-1">
							&larr; Kembali
						</button>
					</form>
				);

				return (
					<div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[10000]">
						<div ref={modalRef} className="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-sm relative">
							<button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
							<div className="text-center mb-6">
								<h2 className="text-2xl font-bold">{view === 'main' ? 'Login ke Griphub' : 'Akses Karyawan'}</h2>
								<p className="text-gray-500 dark:text-gray-400 mt-1">{view === 'main' ? 'Pilih jenis akun Anda.' : 'Masukkan password.'}</p>
							</div>
							{error && <p className="text-red-500 text-center mb-4 text-sm font-semibold">{error}</p>}
							{view === 'main' ? mainView : employeeView}
						</div>
					</div>
				);
			}

											function LandingPage({ setAccessLevel }) {
				const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
				
				const [availableStock, setAvailableStock] = useState([]);
				const [listingPrices, setListingPrices] = useState({});
				const [phoneDataModels, setPhoneDataModels] = useState({});

				const [loading, setLoading] = useState(true);
				const [error, setError] = useState("");
				const [searchTerm, setSearchTerm] = useState("");
				const [sortBy, setSortBy] = useState("name-asc");
				
				useEffect(() => {
					if (!OWNER_USER_ID || !db) {
						setError("Konfigurasi aplikasi belum lengkap.");
						setLoading(false);
						return;
					}

					const phoneDataRef = window.firebase.doc(db, "artifacts", appId, "users", OWNER_USER_ID, "phone_data", "master_list");
					const unsubscribePhoneData = window.firebase.onSnapshot(phoneDataRef, (doc) => {
						if (doc.exists()) {
							setPhoneDataModels(doc.data().models || {});
						}
					}, (err) => {
						console.error("Error fetching phone data:", err);
						setError("Gagal memuat data model HP.");
					});

					const pricesRef = window.firebase.doc(db, "artifacts", appId, "users", OWNER_USER_ID, "settings", "listing_prices");
					const unsubscribePrices = window.firebase.onSnapshot(pricesRef, (doc) => {
						if (doc.exists()) {
							setListingPrices(doc.data().prices || {});
						}
					}, (err) => {
						console.error("Error fetching listing prices:", err);
						setError("Gagal memuat data harga.");
					});

					const stockQuery = window.firebase.query(
						window.firebase.collection(db, "artifacts", appId, "users", OWNER_USER_ID, "stock"),
						window.firebase.where("availability", "==", "Available")
					);
					const unsubscribeStock = window.firebase.onSnapshot(stockQuery, (querySnapshot) => {
						const stockData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
						setAvailableStock(stockData);
						setLoading(false); 
					}, (err) => {
						console.error("Error fetching stock data:", err);
						setError("Gagal memuat data stok.");
						setLoading(false);
					});

					return () => {
						unsubscribePhoneData();
						unsubscribePrices();
						unsubscribeStock();
					};
				}, []);

				const groupedStock = useMemo(() => {
					if (availableStock.length === 0) return [];
					
					const stockMap = new Map();
					availableStock.forEach(item => {
						const key = [item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join("-");
						if (!stockMap.has(key)) {
							const priceKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
                            const imageUrl = phoneDataModels[item.phoneModel]?.colorImages?.[item.color] || item.imageUrl || null;
							
							stockMap.set(key, {
								model: item.phoneModel,
								storage: item.storage,
								ram: item.ram,
								color: item.color,
								count: 0,
								price: listingPrices[priceKey] || 0,
								imageUrl: imageUrl,
							});
						}
						stockMap.get(key).count += 1;
					});
					return Array.from(stockMap.values());
				}, [availableStock, listingPrices, phoneDataModels]);
				
				const filteredAndSortedStock = useMemo(() => {
					let result = groupedStock.filter(item => {
						const searchableString = [item.model, item.storage, item.ram, item.color].filter(Boolean).join(" ");
						return smartSearch(searchableString, searchTerm);
					});

					result.sort((a, b) => {
						switch (sortBy) {
							case "price-asc": return a.price - b.price;
							case "price-desc": return b.price - a.price;
							case "name-desc": return b.model.localeCompare(a.model);
							case "name-asc": default: return a.model.localeCompare(b.model);
						}
					});
					return result;
				}, [groupedStock, searchTerm, sortBy]);


				return (
					<div className="bg-slate-50 dark:bg-gray-950 min-h-screen">
						{isLoginModalOpen && <LoginModal onClose={() => setIsLoginModalOpen(false)} setAccessLevel={setAccessLevel} />}
						
						<header className="fixed top-0 left-0 right-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-800">
							<div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
								<div className="flex justify-between items-center h-16">
									<div className="flex items-center gap-3">
										<img src={logoBase64} alt="Griphub Logo" className="h-12 w-12" />
										<span className="font-bold text-lg text-gray-800 dark:text-white">Griphub Ponsel</span>
									</div>
									<button 
										onClick={() => setIsLoginModalOpen(true)}
										className="bg-blue-600 text-white font-semibold py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors flex items-center justify-center p-2 sm:px-4"
                                        title="Admin / Karyawan"
									>
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
                                        </svg>
										<span className="hidden sm:inline sm:ml-2">Admin / Karyawan</span>
									</button>
								</div>
							</div>
						</header>

						<main>
							{/* --- HERO SECTION YANG DIMODIFIKASI --- */}
							<section className="bg-white dark:bg-gray-900 pt-32 lg:pt-40 overflow-hidden">
								<div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                                    <div className="lg:grid lg:grid-cols-12 lg:gap-8 items-center">
                                        <div className="text-center lg:text-left lg:col-span-6">
                                            <h1 className="text-5xl md:text-6xl xl:text-7xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-400">
                                                iPhone 17 Pro
                                            </h1>
                                            <p className="mt-6 text-lg md:text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto lg:mx-0">
                                                Nantikan di Griphub Ponsel segera!
                                            </p>
                                        </div>
                                        <div className="mt-12 lg:mt-0 lg:col-span-6 lg:relative h-80 lg:h-[450px]">
                                            <div className="w-full h-full lg:absolute lg:bottom-0 lg:right-0">
                                                {/* --- Ganti URL di bawah ini dengan URL gambar Anda --- */}
                                                <img 
                                                    src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjoxSZ_zVR32bGpbIFmBG0rFrqs72Q2JAlXBbylopZH7oECfeuoTdaWwCJixEdtem_As0aF5o44UQ1gP9meLIStp2wQBYGqEtX4aELQNPUfqgcJ60bbRZE97VMVws3SHvL3XsxomSWzYp5cBvpnn3EaZIjU04VQVXSFzcPxnvtv4uvLRTAeBX2MW3wLAGBK/s320/saASFFTRE%20copy.png" /* Placeholder URL, ganti ini */
                                                    alt="Showcase Gadget" 
                                                    className="w-auto h-full mx-auto object-contain [filter:drop-shadow(0_10px_15px_rgba(0,0,0,0.15))]" 
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
							</section>

							{/* Section Fitur */}
							<section className="bg-slate-100 dark:bg-gray-800 py-16">
								<div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
								<div className="flex flex-col items-center">
										<div className="flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 dark:bg-blue-900/50 mb-4">
											<svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
												<path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
											</svg>
										</div>
										<h3 className="text-xl font-bold text-gray-900 dark:text-white">Garansi Resmi</h3>
										<p className="mt-2 text-gray-500 dark:text-gray-400">Semua produk baru bergaransi resmi Indonesia.</p>
									</div>	
									<div className="flex flex-col items-center">
										<div className="flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 dark:bg-blue-900/50 mb-4">
											<svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
												<path strokeLinecap="round" strokeLinejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
											</svg>
										</div>
										<h3 className="text-xl font-bold text-gray-900 dark:text-white">Stok Terlengkap</h3>
										<p className="mt-2 text-gray-500 dark:text-gray-400">Dari entry-level hingga flagship terbaru.</p>
									</div>
									
									<div className="flex flex-col items-center">
										<div className="flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 dark:bg-blue-900/50 mb-4">
											<svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
												<path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
												<path strokeLinecap="round" strokeLinejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1zM3 11h10M16 8l4 4m0 0l-4 4m4-4H9" />
											</svg>
										</div>
										<h3 className="text-xl font-bold text-gray-900 dark:text-white">Siap Diantar</h3>
										<p className="mt-2 text-gray-500 dark:text-gray-400">Pengiriman cepat, siap diantar ke seluruh area Jakarta.</p>
									</div>
								</div>
							</section>

							<section id="stock-list" className="py-16 sm:py-24">
								{/* Konten Showcase lainnya tetap sama */}
                                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
									<div className="mb-12 text-center">
										<h2 className="text-3xl sm:text-4xl font-bold tracking-tight text-gray-900 dark:text-white">
											Ready Stock
										</h2>
										<p className="mt-4 text-lg text-gray-500 dark:text-gray-400">
											Temukan pilihan terbaik yang tersedia saat ini.
										</p>
									</div>

									<div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
										<input
											type="text"
											placeholder="Cari model, memori, atau warna..."
											value={searchTerm}
											onChange={e => setSearchTerm(e.target.value)}
											className="w-full p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500"
										/>
										<select
											value={sortBy}
											onChange={e => setSortBy(e.target.value)}
											className="w-full p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500"
										>
											<option value="name-asc">Nama (A-Z)</option>
											<option value="name-desc">Nama (Z-A)</option>
											<option value="price-asc">Harga (Termurah)</option>
											<option value="price-desc">Harga (Termahal)</option>
										</select>
									</div>

									{loading ? (
										<div className="text-center py-20 text-gray-500 dark:text-gray-400">Memuat stok...</div>
									) : error ? (
										<div className="text-center py-20 text-red-500">{error}</div>
									) : filteredAndSortedStock.length > 0 ? (
										<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
											{filteredAndSortedStock.map(item => {
												const key = `${item.model}-${item.storage}-${item.ram}-${item.color}`;
												return (
													<div key={key} className="bg-white dark:bg-gray-800/80 rounded-xl shadow-md p-4 flex flex-col justify-between border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
														<div className="flex flex-col h-full">
															<div className="aspect-square w-full bg-gray-100 dark:bg-gray-700 rounded-lg mb-4 flex items-center justify-center overflow-hidden">
																{item.imageUrl ? (
																	<img src={item.imageUrl} alt={`${item.model} ${item.color}`} className="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
																) : (
																	<svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-gray-300 dark:text-gray-500" viewBox="0 0 20 20" fill="currentColor">
																		<path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clipRule="evenodd" />
																	</svg>
																)}
															</div>
															<div className="flex-grow flex flex-col">
																<h3 className="font-bold text-lg text-gray-800 dark:text-white flex-grow">
																	{[item.model, item.storage, item.ram].filter(Boolean).join(" ")}
																</h3>
																<p className="text-sm text-gray-500 dark:text-gray-400 mt-1">{item.color}</p>
															</div>
                                                            <div className="mt-5 pt-3 border-t border-gray-200 dark:border-gray-700">
                                                                <p className="text-xl font-extrabold text-blue-600 dark:text-blue-400">{formatRupiahDisplay(item.price)}</p>
                                                                <p className="mt-1 text-xs font-semibold text-green-600 dark:text-green-400">{item.count} Unit Tersedia</p>
                                                            </div>
														</div>
													</div>
												);
											})}
										</div>
									) : (
										<div className="text-center py-20 text-gray-500 dark:text-gray-400">Tidak ada stok yang cocok dengan pencarian Anda.</div>
									)}
								</div>
							</section>
						</main>
						
						<footer className="bg-gray-100 dark:bg-gray-900">
							<div className="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500 dark:text-gray-400">
								&copy; {new Date().getFullYear()} Griphub Ponsel. All Rights Reserved.
							</div>
						</footer>
					</div>
				);
			}

			function ThemeToggleButton({ theme, toggleTheme }) {
				return (
					<button
						onClick={toggleTheme}
						className="p-2 rounded-full text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700/50 hover:bg-gray-300 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-blue-500 transition-colors"
						aria-label="Toggle dark mode"
					>
						{theme === "dark" ? (
							<svg
								xmlns="http://www.w3.org/2000/svg"
								className="h-6 w-6 text-yellow-400"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
								strokeWidth={2}
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
								/>
							</svg>
						) : (
							<svg
								xmlns="http://www.w3.org/2000/svg"
								className="h-6 w-6 text-gray-700"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
								strokeWidth={2}
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
								/>
							</svg>
						)}
					</button>
				);
			}

			function InventoryApp({ user, theme, toggleTheme }) {
				const [page, setPage] = useState(
					() => localStorage.getItem("lastOpenedPage") || "stock",
				);
				const [stock, setStock] = useState([]);
				const [invoices, setInvoices] = useState([]);
				const [customers, setCustomers] = useState([]);
				const [phoneData, setPhoneData] = useState(null);
				const [cards, setCards] = useState([]);
				const [isInventoryModalOpen, setInventoryModalOpen] = useState(false);
				const [isSalesInvoiceModalOpen, setSalesInvoiceModalOpen] =
					useState(false);
				const [isCsvModalOpen, setIsCsvModalOpen] = useState(false);
				const [invoiceToEdit, setInvoiceToEdit] = useState(null);
				const [isImeiInputModalOpen, setIsImeiInputModalOpen] = useState(false);

				useEffect(() => {
					localStorage.setItem("lastOpenedPage", page);
				}, [page]);

				// --- PERUBAHAN DI SINI: Tambahkan useEffect untuk mengelola scroll ---
				useEffect(() => {
					const body = document.body;
					if (isImeiInputModalOpen) {
						body.classList.add("overflow-hidden");
					} else {
						body.classList.remove("overflow-hidden");
					}
					// Cleanup function untuk memastikan class dihapus saat komponen unmount
					return () => {
						body.classList.remove("overflow-hidden");
					};
				}, [isImeiInputModalOpen]);
				// --- AKHIR PERUBAHAN ---

				useEffect(() => {
					if (!user.uid || !db) return;
					const settingsDocRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						user.uid,
						"settings",
						"card_list",
					);
					const unsubscribe = window.firebase.onSnapshot(
						settingsDocRef,
						(docSnap) => {
							if (docSnap.exists() && docSnap.data().list) {
								setCards(docSnap.data().list.sort());
							} else {
								setCards([]);
							}
						},
						(error) => {
							console.error("Error fetching card list:", error);
						},
					);
					return () => unsubscribe();
				}, [user.uid]);

				// GANTI useEffect untuk phoneData dengan yang ini.
				useEffect(() => {
					if (!user.uid || !db) return;

					const phoneDataRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						user.uid,
						"phone_data",
						"master_list",
					);

					// Fungsi untuk memastikan dokumen ada, jika tidak, buat dokumen kosong.
					const ensureDocumentExists = async () => {
						const docSnap = await window.firebase.getDoc(phoneDataRef);
						if (!docSnap.exists()) {
							// Jika dokumen "master_list" benar-benar tidak ada, buat sekali saja
							// dengan objek 'models' yang kosong. Ini hanya terjadi untuk pengguna baru.
							console.log(
								"Phone data document not found. Creating a new empty one.",
							);
							await window.firebase.setDoc(phoneDataRef, { models: {} });
						}
					};

					// Fungsi utama untuk memuat dan mendengarkan perubahan
					const setupListener = async () => {
						await ensureDocumentExists();

						// Sekarang kita bisa dengan aman memasang listener
						const unsubscribe = window.firebase.onSnapshot(
							phoneDataRef,
							(doc) => {
								if (doc.exists()) {
									// Selalu ambil data dari 'models', atau default ke objek kosong jika tidak ada
									setPhoneData(doc.data().models || {});
									console.log("Phone data loaded/updated from Firestore.");
								} else {
									// Kasus ini seharusnya tidak terjadi lagi setelah ensureDocumentExists
									console.error(
										"Phone data document was deleted unexpectedly. Setting to empty.",
									);
									setPhoneData({});
								}
							},
							(error) => {
								console.error(
									"Critical error fetching phone data from Firestore. The app might not function correctly.",
									error,
								);
								setPhoneData({}); // Set ke kosong jika ada error
							},
						);
						return unsubscribe;
					};

					const unsubscribePromise = setupListener();

					// Cleanup function
					return () => {
						unsubscribePromise.then((unsubscribe) => {
							if (unsubscribe) {
								unsubscribe();
							}
						});
					};
				}, [user.uid]);

				useEffect(() => {
					if (!user.uid || !db) return;
					const stockCollectionRef = window.firebase.collection(
						db,
						"artifacts",
						appId,
						"users",
						user.uid,
						"stock",
					);
					const q = window.firebase.query(stockCollectionRef);
					const unsubscribe = window.firebase.onSnapshot(
						q,
						(snapshot) => {
							const stockData = snapshot.docs.map((doc) => ({
								id: doc.id,
								...doc.data(),
							}));
							const sortedData = stockData.sort((a, b) => {
								const timeA = a.creationTimestamp || a.deliveryDate;
								const timeB = b.creationTimestamp || b.deliveryDate;

								// Handle null dates
								if (!timeB && !timeA) return 0;
								if (!timeB) return -1;
								if (!timeA) return 1;

								// Prioritas 1: Urutkan berdasarkan tanggal (terbaru di atas)
								const dateComparison =
									timeB.toDate().getTime() - timeA.toDate().getTime();

								if (dateComparison !== 0) {
									return dateComparison;
								} else {
									// Prioritas 2: Jika tanggal sama, urutkan berdasarkan nama model (A-Z)
									const modelA = a.phoneModel || "";
									const modelB = b.phoneModel || "";
									return modelA.localeCompare(modelB);
								}
							});
							setStock(sortedData);
						},
						(error) => {
							console.error("Error fetching stock:", error);
						},
					);
					return () => unsubscribe();
				}, [user.uid]);

				useEffect(() => {
					if (!user.uid || !db) return;
					const invoicesCollectionRef = window.firebase.collection(
						db,
						"artifacts",
						appId,
						"users",
						user.uid,
						"invoices",
					);
					const q = window.firebase.query(
						invoicesCollectionRef,
						window.firebase.orderBy("date", "desc"),
					);
					const unsubscribe = window.firebase.onSnapshot(
						q,
						(snapshot) => {
							const invoicesData = snapshot.docs.map((doc) => ({
								id: doc.id,
								...doc.data(),
							}));
							setInvoices(invoicesData);
						},
						(error) => {
							console.error("Error fetching invoices:", error);
						},
					);
					return () => unsubscribe();
				}, [user.uid]);

				useEffect(() => {
					if (!user.uid || !db) return;
					const customersCollectionRef = window.firebase.collection(
						db,
						"artifacts",
						appId,
						"users",
						user.uid,
						"customers",
					);
					const unsubscribe = window.firebase.onSnapshot(
						customersCollectionRef,
						(snapshot) => {
							const customersData = snapshot.docs.map((doc) => ({
								id: doc.id,
								...doc.data(),
							}));
							setCustomers(customersData);
						},
						(error) => {
							console.error("Error fetching customers:", error);
						},
					);
					return () => unsubscribe();
				}, [user.uid]);

				const uniqueSuggestions = useMemo(() => {
					const suggestions = {
						suppliers: new Set(),
						purchasers: new Set(),
						purchaseAccounts: new Set(),
						invoices: new Set(),
						customers: new Set(),
						paymentTerms: new Set(),
					};
					stock.forEach((item) => {
						if (item.supplier) suggestions.suppliers.add(item.supplier);
						if (item.purchaser) suggestions.purchasers.add(item.purchaser);
						if (item.purchaseAccount)
							suggestions.purchaseAccounts.add(item.purchaseAccount);
						if (item.invoice) suggestions.invoices.add(item.invoice);
						if (item.customer) suggestions.customers.add(item.customer);
					});
					invoices.forEach((inv) => {
						if (inv.customerName) suggestions.customers.add(inv.customerName);
						if (inv.paymentTerms)
							suggestions.paymentTerms.add(inv.paymentTerms);
					});
					return {
						suppliers: [...suggestions.suppliers].sort(),
						purchasers: [...suggestions.purchasers].sort(),
						purchaseAccounts: [...suggestions.purchaseAccounts].sort(),
						invoices: [...suggestions.invoices].sort(),
						customers: [...suggestions.customers].sort(),
						paymentTerms: [...suggestions.paymentTerms].sort(),
					};
				}, [stock, invoices]);

				if (!phoneData) {
					return (
						<div className="flex items-center justify-center h-screen">
							<div className="text-2xl">Loading data...</div>
						</div>
					);
				}

				const exportStockToCSV = (csvStartDate, csvEndDate) => {
					let dataToExport = stock;
					if (csvStartDate && csvEndDate) {
						const start = new Date(csvStartDate).getTime();
						const end = new Date(csvEndDate).setHours(23, 59, 59, 999);
						dataToExport = dataToExport.filter((item) => {
							const itemDate = item.deliveryDate
								? item.deliveryDate.toDate().getTime()
								: 0;
							return itemDate >= start && itemDate <= end;
						});
					}
					if (dataToExport.length === 0) {
						alert("No data available for the selected criteria.");
						return;
					}
					const headers = [
						"Phone Model",
						"Storage",
						"RAM",
						"Color",
						"IMEI",
						"Delivery Date",
						"Price",
						"Discount",
						"HPP",
						"Supplier",
						"Purchaser",
						"Purchase Account",
						"Card Used",
						"Paid Status",
						"Availability",
						"Sold Date",
						"Sold Price",
						"Profit",
						"Customer",
						"Notes",
						"Invoice",
					];
					const csvRows = [headers.join(",")];
					for (const item of dataToExport) {
						const values = [
							item.phoneModel,
							item.storage,
							item.ram || "",
							item.color,
							item.imei,
							formatDate(item.deliveryDate, true),
							item.price || 0,
							item.discount || 0,
							item.hpp || 0,
							item.supplier,
							item.purchaser,
							item.purchaseAccount,
							item.cardUsed || "",
							item.paidStatus,
							item.availability,
							item.soldDate ? formatDate(item.soldDate, true) : "N/A",
							item.soldPrice || 0,
							item.profit || 0,
							`"${(item.customer || "").replace(/"/g, '""')}"`,
							`"${(item.notes || "").replace(/"/g, '""')}"`,
							item.invoice,
						];
						csvRows.push(values.join(","));
					}
					const csvString = csvRows.join("\n");
					const blob = new Blob([csvString], { type: "text/csv" });
					const url = URL.createObjectURL(blob);
					const a = document.createElement("a");
					a.setAttribute("hidden", "");
					a.setAttribute("href", url);
					a.setAttribute("download", "stock_export.csv");
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
				};

				const handleOpenSalesInvoice = (invoice = null) => {
					setInvoiceToEdit(invoice);
					setSalesInvoiceModalOpen(true);
				};

				const handleCloseSalesInvoice = () => {
					setSalesInvoiceModalOpen(false);
					setInvoiceToEdit(null);
				};

				return (
					<div className="min-h-screen font-sans">
						<Header setPage={setPage} user={user} currentPage={page} />

						{isInventoryModalOpen && (
							<InventoryInputModal
								closeModal={() => setInventoryModalOpen(false)}
								userId={user.uid}
								phoneData={phoneData}
								uniqueSuggestions={uniqueSuggestions}
								cards={cards}
							/>
						)}
						{isSalesInvoiceModalOpen && (
							<SalesInvoiceModal
								stock={stock}
								closeModal={handleCloseSalesInvoice}
								userId={user.uid}
								uniqueSuggestions={uniqueSuggestions}
								invoiceToEdit={invoiceToEdit}
								customers={customers}
							/>
						)}
						{isCsvModalOpen && (
							<CsvExportModal
								isOpen={isCsvModalOpen}
								closeModal={() => setIsCsvModalOpen(false)}
								onExport={exportStockToCSV}
							/>
						)}

						<main className="p-4 sm:p-6 lg:p-8 pb-36 md:pb-20 lg:pb-8">
							{isImeiInputModalOpen && (
								<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[9999] p-4">
									<DeliveryUpdatePage
										ownerUserId={OWNER_USER_ID}
										isModalMode={true}
										onClose={() => setIsImeiInputModalOpen(false)}
										phoneData={phoneData}
									/>
								</div>
							)}
							{page === "invoices" && (
								<InvoiceListPage
									userId={user.uid}
									onEdit={handleOpenSalesInvoice}
								/>
							)}
							{page === "reports" && (
								<FinancialReportPage
									userId={user.uid}
									stockData={stock}
									invoicesData={invoices}
								/>
							)}
							{page === "balance_sheet" && (
								<BalanceSheetPage
									userId={user.uid}
									stockData={stock}
									invoicesData={invoices}
								/>
							)}
							{page === "data" && (
								<PhoneDataManagementPage
									userId={user.uid}
									phoneData={phoneData}
									setPhoneData={setPhoneData}
									onOpenCsvModal={() => setIsCsvModalOpen(true)}
								/>
							)}
							{page === "logs" && <LogPage userId={OWNER_USER_ID} />}
							{page === "stock" && (
								<StockListPage
									userId={user.uid}
									stockData={stock}
									phoneData={phoneData}
									theme={theme}
									toggleTheme={toggleTheme}
									uniqueSuggestions={uniqueSuggestions}
									customers={customers}
									openImeiModal={() => setIsImeiInputModalOpen(true)}
									cards={cards}
								/>
							)}
						</main>

						{/* ===== PERUBAHAN DI SINI: Tombol CSV dihapus ===== */}
						<div className="fixed bottom-20 lg:bottom-6 right-6 flex flex-col items-center gap-4 z-40">
							<button
								onClick={() => setInventoryModalOpen(true)}
								className="bg-blue-600 hover:bg-blue-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform"
								title="Input Inventory"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-7 w-7"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth="2"
										d="M12 6v6m0 0v6m0-6h6m-6 0H6"
									/>
								</svg>
							</button>
							<button
								onClick={() => handleOpenSalesInvoice(null)}
								className="bg-green-600 hover:bg-green-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform"
								title="Create Sales Invoice"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-7 w-7"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth="2"
										d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
									/>
								</svg>
							</button>
						</div>
						{/* ===== AKHIR PERUBAHAN ===== */}

						<BottomNavBar currentPage={page} setPage={setPage} />
					</div>
				);
			}

			function Header({ setPage, user, currentPage }) {
				const [isMenuOpen, setIsMenuOpen] = useState(false);
				const handleLogout = async () => {
					try {
						await window.firebase.signOut(auth);
						window.location.reload(); // Tambahkan baris ini
					} catch (error) {
						console.error("Error signing out:", error);
					}
				};
				const NavButton = ({ pageName, children }) => {
					const isActive = currentPage === pageName;
					const activeClasses =
						"bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white";
					const inactiveClasses =
						"text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white";
					return (
						<button
							onClick={() => {
								setPage(pageName);
								setIsMenuOpen(false);
							}}
							className={`w-full text-left px-3 py-2 rounded-md text-sm font-medium transition whitespace-nowrap ${isActive ? activeClasses : inactiveClasses}`}
						>
							{children}
						</button>
					);
				};
				return (
					<header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-[998]">
						<div className="mx-auto px-4 sm:px-6 lg:px-8">
							<div className="flex items-center justify-between h-20 flex-wrap">
								<div className="flex items-center space-x-4">
									<img
										src={logoBase64}
										alt="Griphub Logo"
										className="h-12 w-12"
									/>
									<h1 className="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">
										Griphub Inventory
									</h1>
								</div>
								<nav className="hidden lg:flex items-center space-x-2">
									<NavButton pageName="stock">Stock List</NavButton>
									<NavButton pageName="invoices">Invoice List</NavButton>
									<NavButton pageName="reports">Financial Report</NavButton>
									<NavButton pageName="balance_sheet">Balance Sheet</NavButton>
									<NavButton pageName="data">Manage Data</NavButton>
									<NavButton pageName="logs">Activity Log</NavButton>
								</nav>
								<div className="flex items-center gap-4">
									<div className="hidden sm:flex items-center gap-3">
										<img
											src={user.photoURL}
											alt={user.displayName}
											className="h-10 w-10 rounded-full"
										/>
										<span className="text-gray-800 dark:text-white text-sm font-medium hidden xl:block">
											{user.displayName}
										</span>
									</div>
									<button
										onClick={handleLogout}
										className="flex items-center bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-lg text-sm transition"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											className="h-5 w-5"
											viewBox="0 0 20 20"
											fill="currentColor"
										>
											<path
												fillRule="evenodd"
												d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
												clipRule="evenodd"
											/>
										</svg>
										<span className="hidden sm:inline sm:ml-2">Logout</span>
									</button>
									<div className="lg:hidden">
										<button
											onClick={() => setIsMenuOpen(!isMenuOpen)}
											className="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white focus:outline-none"
										>
											<svg
												className="h-6 w-6"
												fill="none"
												viewBox="0 0 24 24"
												stroke="currentColor"
											>
												{isMenuOpen ? (
													<path
														strokeLinecap="round"
														strokeLinejoin="round"
														strokeWidth="2"
														d="M6 18L18 6M6 6l12 12"
													/>
												) : (
													<path
														strokeLinecap="round"
														strokeLinejoin="round"
														strokeWidth="2"
														d="M4 6h16M4 12h16M4 18h16"
													/>
												)}
											</svg>
										</button>
									</div>
								</div>
							</div>
							{isMenuOpen && (
								<div className="lg:hidden absolute left-0 w-full bg-white dark:bg-gray-800 z-50 shadow-lg">
									<div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
										<NavButton pageName="stock">Stock List</NavButton>
										<NavButton pageName="invoices">Invoice List</NavButton>
										<NavButton pageName="reports">Financial Report</NavButton>
										<NavButton pageName="balance_sheet">
											Balance Sheet
										</NavButton>
										<NavButton pageName="data">Manage Data</NavButton>
										<NavButton pageName="logs">Activity Log</NavButton>
									</div>
								</div>
							)}
						</div>
					</header>
				);
			}

			// FIND and REPLACE the BottomNavBar function with this new version
			function BottomNavBar({ currentPage, setPage }) {
				const NavItem = ({ pageName, icon, label }) => {
					const isActive = currentPage === pageName;
					return (
						<button
							onClick={() => setPage(pageName)}
							className={`flex flex-col items-center justify-center w-full pt-2 pb-1 transition-colors duration-200 ${isActive ? "text-blue-500 dark:text-blue-400" : "text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white"}`}
						>
							{icon(isActive)}
							<span
								className={`text-xs mt-1 ${isActive ? "font-bold" : "font-normal"}`}
							>
								{label}
							</span>
						</button>
					);
				};
				return (
					// --- CHANGE grid-cols-5 to grid-cols-6 ---
					<div className="lg:hidden fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-gray-800 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] z-50 grid grid-cols-6 justify-around items-center px-1">
						<NavItem
							pageName="stock"
							label="Stock"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth={2}
										d="M4 6h16M4 10h16M4 14h16M4 18h16"
									/>
								</svg>
							)}
						/>
						<NavItem
							pageName="invoices"
							label="Invoices"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth="2"
										d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
									/>
								</svg>
							)}
						/>
						<NavItem
							pageName="reports"
							label="Reports"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth={2}
										d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
									/>
								</svg>
							)}
						/>
						{/* --- ADD THIS NEW NavItem --- */}
						<NavItem
							pageName="balance_sheet"
							label="Neraca"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
									strokeWidth="2"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"
									/>
								</svg>
							)}
						/>
						{/* --- END OF NEW NavItem --- */}
						<NavItem
							pageName="data"
							label="Data"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth={2}
										d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
									/>
								</svg>
							)}
						/>
						<NavItem
							pageName="logs"
							label="Logs"
							icon={(isActive) => (
								<svg
									xmlns="http://www.w3.org/2000/svg"
									className="h-6 w-6"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
								>
									<path
										strokeLinecap="round"
										strokeLinejoin="round"
										strokeWidth={2}
										d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
									/>
								</svg>
							)}
						/>
					</div>
				);
			}

			function CsvExportModal({ isOpen, closeModal, onExport }) {
				const [startDate, setStartDate] = useState("");
				const [endDate, setEndDate] = useState("");
				if (!isOpen) return null;

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				const handleExportClick = () => {
					onExport(startDate, endDate);
					closeModal();
				};
				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-gray-200 dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
							<h3 className="text-2xl font-bold mb-6">Export Stock to CSV</h3>
							<p className="text-gray-600 dark:text-gray-400 mb-4">
								Select a date range to export. Leave blank to export all data.
							</p>
							<div className="space-y-4">
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										Start Date
									</label>
									<input
										type="date"
										value={startDate}
										onChange={(e) => setStartDate(e.target.value)}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										End Date
									</label>
									<input
										type="date"
										value={endDate}
										onChange={(e) => setEndDate(e.target.value)}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
							</div>
							<div className="flex justify-end space-x-4 pt-6 mt-2 border-t border-gray-300 dark:border-gray-700">
								<button
									type="button"
									onClick={closeModal}
									className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
								>
									Cancel
								</button>
								<button
									onClick={handleExportClick}
									className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition"
								>
									Export CSV
								</button>
							</div>
						</div>
					</div>
				);
			}

			function DateRangePickerPopover({
				isOpen,
				onClose,
				onApply,
				currentRange,
				positionRef,
			}) {
				const popoverRef = useRef(null);
				const [calendarView, setCalendarView] = useState("days"); // 'days', 'months', 'years'

				const getInitialDate = () => {
					const initial = currentRange?.start
						? new Date(currentRange.start)
						: new Date();
					initial.setDate(1);
					return initial;
				};
				const [displayDate, setDisplayDate] = useState(getInitialDate);
				const [selection, setSelection] = useState({
					start: currentRange?.start ? new Date(currentRange.start) : null,
					end: currentRange?.end ? new Date(currentRange.end) : null,
				});
				const [hoverDate, setHoverDate] = useState(null);

				useEffect(() => {
					const handleClickOutside = (event) => {
						if (
							popoverRef.current &&
							!popoverRef.current.contains(event.target) &&
							positionRef.current &&
							!positionRef.current.contains(event.target)
						) {
							onClose();
						}
					};
					document.addEventListener("mousedown", handleClickOutside);
					return () =>
						document.removeEventListener("mousedown", handleClickOutside);
				}, [onClose, positionRef]);

				if (!isOpen) return null;

				const formatDateForInput = (date) => {
					if (!date) return null;
					const d = new Date(date);
					const year = d.getFullYear();
					const month = (d.getMonth() + 1).toString().padStart(2, "0");
					const day = d.getDate().toString().padStart(2, "0");
					return `${year}-${month}-${day}`;
				};

				const handleApply = () => {
					onApply({
						start: formatDateForInput(selection.start),
						end: formatDateForInput(selection.end),
					});
					onClose();
				};

				const handleClear = () => {
					onApply({ start: null, end: null });
					setSelection({ start: null, end: null });
					onClose();
				};

				const handlePrev = () => {
					setDisplayDate((prev) => {
						const newDate = new Date(prev);
						if (calendarView === "days") newDate.setMonth(prev.getMonth() - 1);
						else if (calendarView === "months")
							newDate.setFullYear(prev.getFullYear() - 1);
						else if (calendarView === "years")
							newDate.setFullYear(prev.getFullYear() - 12);
						return newDate;
					});
				};

				const handleNext = () => {
					setDisplayDate((prev) => {
						const newDate = new Date(prev);
						if (calendarView === "days") newDate.setMonth(prev.getMonth() + 1);
						else if (calendarView === "months")
							newDate.setFullYear(prev.getFullYear() + 1);
						else if (calendarView === "years")
							newDate.setFullYear(prev.getFullYear() + 12);
						return newDate;
					});
				};

				const handleDayClick = (day) => {
					const date = new Date(
						displayDate.getFullYear(),
						displayDate.getMonth(),
						day,
					);

					if (!selection.start || (selection.start && selection.end)) {
						setSelection({ start: date, end: null });
					} else {
						if (date < selection.start) {
							setSelection({ start: date, end: selection.start });
						} else {
							setSelection({ ...selection, end: date });
						}
					}
				};

				const handleHeaderClick = () => {
					if (calendarView === "days") setCalendarView("months");
					else if (calendarView === "months") setCalendarView("years");
				};

				const getHeaderLabel = () => {
					if (calendarView === "days")
						return displayDate.toLocaleString("default", {
							month: "long",
							year: "numeric",
						});
					if (calendarView === "months") return displayDate.getFullYear();
					const year = displayDate.getFullYear();
					const startYear = Math.floor(year / 12) * 12;
					return `${startYear} - ${startYear + 11}`;
				};

				const renderDayView = () => {
					const year = displayDate.getFullYear();
					const month = displayDate.getMonth();
					const firstDay = new Date(year, month, 1).getDay();
					const daysInMonth = new Date(year, month + 1, 0).getDate();
					const daysOfWeek = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
					let days = [];
					for (let i = 0; i < firstDay; i++) {
						days.push(<div key={`empty-${i}`} className="w-9 h-9"></div>);
					}
					for (let day = 1; day <= daysInMonth; day++) {
						const date = new Date(year, month, day);
						const isToday = date.toDateString() === new Date().toDateString();
						const isStart =
							selection.start &&
							date.toDateString() === selection.start.toDateString();
						const isEnd =
							selection.end &&
							date.toDateString() === selection.end.toDateString();
						let inRange = false;
						if (selection.start && selection.end) {
							inRange = date > selection.start && date < selection.end;
						} else if (selection.start && hoverDate) {
							const start =
								selection.start < hoverDate ? selection.start : hoverDate;
							const end =
								selection.start < hoverDate ? hoverDate : selection.start;
							inRange = date > start && date < end;
						}
						const classes = [
							"w-9 h-9 flex items-center justify-center rounded-full cursor-pointer transition-colors duration-150",
							isToday ? "font-bold border border-blue-500" : "font-normal",
							isStart || isEnd
								? "bg-blue-600 text-white"
								: inRange
									? "bg-blue-200 dark:bg-blue-800 rounded-none"
									: "hover:bg-gray-200 dark:hover:bg-gray-600",
							isStart && isEnd ? "" : isStart ? "rounded-r-none" : "",
							isStart && isEnd ? "" : isEnd ? "rounded-l-none" : "",
						].join(" ");
						days.push(
							<div
								key={day}
								className={`flex justify-center items-center ${inRange ? "bg-blue-200 dark:bg-blue-800" : ""}`}
							>
								<button
									onClick={() => handleDayClick(day)}
									onMouseEnter={() => setHoverDate(date)}
									onMouseLeave={() => setHoverDate(null)}
									className={classes}
								>
									{day}
								</button>
							</div>,
						);
					}
					return (
						<>
							<div className="grid grid-cols-7 gap-y-1 text-center text-xs text-gray-500 dark:text-gray-400 mb-2">
								{daysOfWeek.map((day) => (
									<div key={day}>{day}</div>
								))}
							</div>
							<div className="grid grid-cols-7 gap-y-1 text-sm">{days}</div>
						</>
					);
				};

				const renderMonthView = () => {
					const months = Array.from({ length: 12 }, (_, i) =>
						new Date(0, i).toLocaleString("default", { month: "short" }),
					);
					return (
						<div className="grid grid-cols-4 gap-2">
							{months.map((month, index) => (
								<button
									key={month}
									onClick={() => {
										setDisplayDate(
											(prev) => new Date(prev.getFullYear(), index, 1),
										);
										setCalendarView("days");
									}}
									className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-sm"
								>
									{month}
								</button>
							))}
						</div>
					);
				};

				const renderYearView = () => {
					const year = displayDate.getFullYear();
					const startYear = Math.floor(year / 12) * 12;
					const years = Array.from({ length: 12 }, (_, i) => startYear + i);
					return (
						<div className="grid grid-cols-4 gap-2">
							{years.map((y) => (
								<button
									key={y}
									onClick={() => {
										setDisplayDate((prev) => new Date(y, prev.getMonth(), 1));
										setCalendarView("months");
									}}
									className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-sm"
								>
									{y}
								</button>
							))}
						</div>
					);
				};

				return (
					<div
						ref={popoverRef}
						className="absolute top-full mt-2 right-0 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl p-4 z-30 w-72"
					>
						<div className="flex justify-between items-center mb-3">
							<button
								type="button"
								onClick={handlePrev}
								className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"
							>
								&lt;
							</button>
							<button
								type="button"
								onClick={handleHeaderClick}
								className="font-semibold text-sm hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded-md"
							>
								{getHeaderLabel()}
							</button>
							<button
								type="button"
								onClick={handleNext}
								className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"
							>
								&gt;
							</button>
						</div>

						{calendarView === "days" && renderDayView()}
						{calendarView === "months" && renderMonthView()}
						{calendarView === "years" && renderYearView()}

						<div className="flex justify-between mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
							<button
								onClick={handleClear}
								className="px-4 py-1.5 rounded-md bg-gray-500 hover:bg-gray-600 text-white text-sm transition"
							>
								Clear
							</button>
							<button
								onClick={handleApply}
								disabled={!selection.start || !selection.end}
								className="px-4 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm transition disabled:bg-blue-400 dark:disabled:bg-blue-800 disabled:cursor-not-allowed"
							>
								Apply
							</button>
						</div>
					</div>
				);
			}

			function DateFilterModal({
				isOpen,
				onClose,
				currentFilters,
				onApplyFilters,
			}) {
				if (!isOpen) return null;

				const TABS = [
					{ key: "orderDate", label: "Order Date" },
					{ key: "deliveryDate", label: "Delivery Date" },
					{ key: "soldDate", label: "Sold Date" },
				];

				const [localFilters, setLocalFilters] = useState(currentFilters);
				const [activeTab, setActiveTab] = useState("orderDate");
				const [calendarView, setCalendarView] = useState("days"); // 'days', 'months', 'years'
				const [hoverDate, setHoverDate] = useState(null);

				const getInitialDate = () => {
					const initial = currentFilters[activeTab]?.start
						? new Date(currentFilters[activeTab].start)
						: new Date();
					initial.setDate(1);
					return initial;
				};
				const [displayDate, setDisplayDate] = useState(getInitialDate);

				useEffect(() => {
					setDisplayDate(getInitialDate());
					setCalendarView("days");
				}, [activeTab, currentFilters]);

				const handleApply = () => {
					onApplyFilters(localFilters);
					onClose();
				};

				const handleClearAll = () => {
					const clearedFilters = {
						orderDate: { start: null, end: null },
						deliveryDate: { start: null, end: null },
						soldDate: { start: null, end: null },
					};
					setLocalFilters(clearedFilters);
					onApplyFilters(clearedFilters);
					onClose();
				};

				const handleDayClick = (day) => {
					const date = new Date(
						displayDate.getFullYear(),
						displayDate.getMonth(),
						day,
					);
					const currentSelection = localFilters[activeTab];

					if (
						!currentSelection.start ||
						(currentSelection.start && currentSelection.end)
					) {
						setLocalFilters((prev) => ({
							...prev,
							[activeTab]: { start: date, end: null },
						}));
					} else {
						if (date < currentSelection.start) {
							setLocalFilters((prev) => ({
								...prev,
								[activeTab]: { start: date, end: currentSelection.start },
							}));
						} else {
							setLocalFilters((prev) => ({
								...prev,
								[activeTab]: { ...currentSelection, end: date },
							}));
						}
					}
				};

				const handlePrev = () => {
					setDisplayDate((prev) => {
						const newDate = new Date(prev);
						if (calendarView === "days") newDate.setMonth(prev.getMonth() - 1);
						else if (calendarView === "months")
							newDate.setFullYear(prev.getFullYear() - 1);
						else if (calendarView === "years")
							newDate.setFullYear(prev.getFullYear() - 12);
						return newDate;
					});
				};

				const handleNext = () => {
					setDisplayDate((prev) => {
						const newDate = new Date(prev);
						if (calendarView === "days") newDate.setMonth(prev.getMonth() + 1);
						else if (calendarView === "months")
							newDate.setFullYear(prev.getFullYear() + 1);
						else if (calendarView === "years")
							newDate.setFullYear(prev.getFullYear() + 12);
						return newDate;
					});
				};

				const handleHeaderClick = () => {
					if (calendarView === "days") setCalendarView("months");
					else if (calendarView === "months") setCalendarView("years");
				};

				const getHeaderLabel = () => {
					if (calendarView === "days")
						return displayDate.toLocaleString("default", {
							month: "long",
							year: "numeric",
						});
					if (calendarView === "months") return displayDate.getFullYear();
					const year = displayDate.getFullYear();
					const startYear = Math.floor(year / 12) * 12;
					return `${startYear} - ${startYear + 11}`;
				};

				const renderDayView = () => {
					const year = displayDate.getFullYear();
					const month = displayDate.getMonth();
					const firstDay = new Date(year, month, 1).getDay();
					const daysInMonth = new Date(year, month + 1, 0).getDate();
					const daysOfWeek = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];

					const selection = localFilters[activeTab];

					let days = [];
					for (let i = 0; i < firstDay; i++) {
						days.push(<div key={`empty-${i}`} className="w-10 h-10"></div>);
					}

					for (let day = 1; day <= daysInMonth; day++) {
						const date = new Date(year, month, day);
						const isToday = date.toDateString() === new Date().toDateString();
						const isStart =
							selection.start &&
							date.toDateString() === selection.start.toDateString();
						const isEnd =
							selection.end &&
							date.toDateString() === selection.end.toDateString();

						let inRange = false;
						if (selection.start && selection.end) {
							inRange = date > selection.start && date < selection.end;
						} else if (selection.start && hoverDate) {
							const start =
								selection.start < hoverDate ? selection.start : hoverDate;
							const end =
								selection.start < hoverDate ? hoverDate : selection.start;
							inRange = date > start && date < end;
						}

						const classes = [
							"w-10 h-10 flex items-center justify-center rounded-full cursor-pointer transition-colors duration-150 text-sm",
							isToday ? "font-bold border border-blue-500" : "font-normal",
							isStart || isEnd
								? "bg-blue-600 text-white"
								: inRange
									? "bg-blue-200 dark:bg-blue-800 rounded-none"
									: "hover:bg-gray-200 dark:hover:bg-gray-600",
							isStart && isEnd ? "" : isStart ? "rounded-r-none" : "",
							isStart && isEnd ? "" : isEnd ? "rounded-l-none" : "",
						].join(" ");

						days.push(
							<div
								key={day}
								className={`flex justify-center items-center ${inRange ? "bg-blue-200 dark:bg-blue-800" : ""}`}
							>
								<button
									onClick={() => handleDayClick(day)}
									onMouseEnter={() => setHoverDate(date)}
									onMouseLeave={() => setHoverDate(null)}
									className={classes}
								>
									{day}
								</button>
							</div>,
						);
					}
					return (
						<>
							<div className="grid grid-cols-7 gap-y-1 text-center text-xs text-gray-500 dark:text-gray-400 mb-2">
								{daysOfWeek.map((day) => (
									<div key={day}>{day}</div>
								))}
							</div>
							<div className="grid grid-cols-7 gap-y-1">{days}</div>
						</>
					);
				};

				const renderMonthView = () => {
					const months = Array.from({ length: 12 }, (_, i) =>
						new Date(0, i).toLocaleString("default", { month: "short" }),
					);
					return (
						<div className="grid grid-cols-4 gap-2">
							{months.map((month, index) => (
								<button
									key={month}
									onClick={() => {
										setDisplayDate(
											(prev) => new Date(prev.getFullYear(), index, 1),
										);
										setCalendarView("days");
									}}
									className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-sm"
								>
									{month}
								</button>
							))}
						</div>
					);
				};

				const renderYearView = () => {
					const year = displayDate.getFullYear();
					const startYear = Math.floor(year / 12) * 12;
					const years = Array.from({ length: 12 }, (_, i) => startYear + i);
					return (
						<div className="grid grid-cols-4 gap-2">
							{years.map((y) => (
								<button
									key={y}
									onClick={() => {
										setDisplayDate((prev) => new Date(y, prev.getMonth(), 1));
										setCalendarView("months");
									}}
									className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-sm"
								>
									{y}
								</button>
							))}
						</div>
					);
				};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[1000] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-md">
							<h3 className="text-2xl font-bold mb-4">Filter by Date</h3>

							<div className="flex space-x-2 bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
								{TABS.map((tab) => {
									const isFilterActive = localFilters[tab.key]?.start;
									return (
										<button
											key={tab.key}
											onClick={() => setActiveTab(tab.key)}
											className={`w-full text-center px-3 py-1.5 text-sm font-semibold rounded-md transition relative ${activeTab === tab.key ? "bg-white dark:bg-gray-900 shadow" : "text-gray-600 dark:text-gray-300"}`}
										>
											{tab.label}
											{isFilterActive && (
												<span className="absolute top-1 right-1 h-2 w-2 rounded-full bg-blue-500"></span>
											)}
										</button>
									);
								})}
							</div>

							<div className="mt-4">
								<div className="flex justify-between items-center mb-3">
									<button
										type="button"
										onClick={handlePrev}
										className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"
									>
										&lt;
									</button>
									<button
										type="button"
										onClick={handleHeaderClick}
										className="font-semibold text-base hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded-md"
									>
										{getHeaderLabel()}
									</button>
									<button
										type="button"
										onClick={handleNext}
										className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"
									>
										&gt;
									</button>
								</div>

								{calendarView === "days" && renderDayView()}
								{calendarView === "months" && renderMonthView()}
								{calendarView === "years" && renderYearView()}
							</div>

							<div className="flex flex-col sm:flex-row sm:items-center gap-3 pt-6 mt-4 border-t border-gray-300 dark:border-gray-700">
								<button
									type="button"
									onClick={handleClearAll}
									className="w-full sm:w-auto sm:mr-auto px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white transition order-3 sm:order-1"
								>
									Clear All
								</button>
								<button
									type="button"
									onClick={onClose}
									className="w-full sm:w-auto px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition order-2 sm:order-2"
								>
									Cancel
								</button>
								<button
									onClick={handleApply}
									className="w-full sm:w-auto px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition order-1 sm:order-3"
								>
									Apply Filters
								</button>
							</div>
						</div>
					</div>
				);
			}

			function MultiSelectDropdown({
				options,
				selectedOptions,
				onSelectionChange,
				label,
			}) {
				const [isOpen, setIsOpen] = useState(false);
				const [searchTerm, setSearchTerm] = useState("");
				const dropdownRef = useRef(null);
				const searchInputRef = useRef(null);
				// --- PERUBAHAN 1: Tambahkan hook untuk mendeteksi layar desktop ---
				// Kita anggap layar desktop memiliki lebar minimum 1024px (breakpoint 'lg' tailwind).
				const isDesktop = useMediaQuery("(min-width: 1024px)");

				const filteredOptions = useMemo(() => {
					if (!searchTerm) return options;
					return options.filter((option) =>
						option.toLowerCase().includes(searchTerm.toLowerCase()),
					);
				}, [options, searchTerm]);

				const handleToggleOption = (option) => {
					const newSelection = new Set(selectedOptions);
					if (newSelection.has(option)) {
						newSelection.delete(option);
					} else {
						newSelection.add(option);
					}
					onSelectionChange(newSelection);
				};

				useEffect(() => {
					const handleClickOutside = (event) => {
						if (
							dropdownRef.current &&
							!dropdownRef.current.contains(event.target)
						) {
							setIsOpen(false);
						}
					};
					document.addEventListener("mousedown", handleClickOutside);
					return () =>
						document.removeEventListener("mousedown", handleClickOutside);
				}, [dropdownRef]);

				// --- PERUBAHAN 2: Modifikasi useEffect untuk auto-focus ---
				useEffect(() => {
					// Hanya jalankan auto-focus jika dropdown terbuka DAN layarnya adalah desktop.
					if (isOpen && isDesktop) {
						setTimeout(() => searchInputRef.current?.focus(), 100);
					} else if (!isOpen) {
						// Selalu reset search term saat dropdown ditutup, di perangkat apa pun.
						setSearchTerm("");
					}
				}, [isOpen, isDesktop]); // Tambahkan `isDesktop` sebagai dependency

				const getButtonLabel = () => {
					if (selectedOptions.size === 0) return label;
					if (selectedOptions.size === 1) return [...selectedOptions][0];
					return `${selectedOptions.size} selected`;
				};

				return (
					<div ref={dropdownRef} className="relative">
						<button
							type="button"
							onClick={() => setIsOpen(!isOpen)}
							className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md border border-gray-300 dark:border-gray-600 flex justify-between items-center text-left h-full"
						>
							<span className="truncate">{getButtonLabel()}</span>
							<svg
								className={`w-4 h-4 ml-2 transform transition-transform ${isOpen ? "rotate-180" : ""}`}
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
								xmlns="http://www.w3.org/2000/svg"
							>
								<path
									strokeLinecap="round"
									strokeLinejoin="round"
									strokeWidth="2"
									d="M19 9l-7 7-7-7"
								></path>
							</svg>
						</button>
						{isOpen && (
							<div className="absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 shadow-lg rounded-md border border-gray-300 dark:border-gray-600 flex flex-col">
								<div className="p-2 border-b border-gray-200 dark:border-gray-600">
									<input
										ref={searchInputRef}
										type="text"
										placeholder="Search..."
										value={searchTerm}
										onChange={(e) => setSearchTerm(e.target.value)}
										className="w-full px-2 py-1 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-300 dark:border-gray-500 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none"
									/>
								</div>
								<div className="max-h-52 overflow-y-auto">
									{filteredOptions.length > 0 ? (
										filteredOptions.map((option) => (
											<label
												key={option}
												className="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
											>
												<input
													type="checkbox"
													className="form-checkbox h-4 w-4 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-blue-600 rounded focus:ring-blue-500"
													checked={selectedOptions.has(option)}
													onChange={() => handleToggleOption(option)}
												/>
												<span className="text-sm">{option}</span>
											</label>
										))
									) : (
										<div className="px-3 py-2 text-sm text-gray-500">
											No results found.
										</div>
									)}
								</div>
							</div>
						)}
					</div>
				);
			}

			function BulkEditModal({
				closeModal,
				userId,
				selectedItemIds,
				stockData,
				onUpdateSuccess,
			}) {
				const [fieldToUpdate, setFieldToUpdate] = useState("paidStatus");
				const [newValue, setNewValue] = useState("");
				const [displayValue, setDisplayValue] = useState("");
				const [isSubmitting, setIsSubmitting] = useState(false);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				const editableFields = {
					paidStatus: {
						label: "Paid Status",
						type: "select",
						options: ["Paid", "Unpaid"],
					},
					availability: {
						label: "Availability",
						type: "select",
						options: [
							"Available",
							"On Delivery",
							"SOLD",
							"Refund in process",
							"Refunded",
						],
					},
					imei: { label: "IMEI", type: "text" },
					price: { label: "Price (IDR)", type: "price" },
					discount: { label: "Discount (%)", type: "number" },
					supplier: { label: "Supplier", type: "text" },
					purchaser: { label: "Purchaser", type: "text" },
					purchaseAccount: { label: "Purchase Account", type: "text" },
					notes: { label: "Notes", type: "textarea" },
				};

				const handleValueChange = (e) => {
					const { value } = e.target;
					const fieldType = editableFields[fieldToUpdate].type;
					if (fieldType === "price") {
						setDisplayValue(formatNumberInput(value));
						setNewValue(parseFormattedNumber(value));
					} else if (fieldType === "number") {
						setDisplayValue(value);
						setNewValue(parseFloat(value) || 0);
					} else {
						setNewValue(value);
					}
				};

				const handleFieldChange = (e) => {
					const newField = e.target.value;
					setFieldToUpdate(newField);
					const fieldInfo = editableFields[newField];
					if (fieldInfo.type === "select") {
						setNewValue(fieldInfo.options[0]);
					} else {
						setNewValue("");
						setDisplayValue("");
					}
				};

				useEffect(() => {
					handleFieldChange({ target: { value: "paidStatus" } });
				}, []);

				const handleSubmit = async (e) => {
					e.preventDefault();
					if (isSubmitting || selectedItemIds.size === 0) return;

					if (fieldToUpdate === "imei" && selectedItemIds.size > 1) {
						alert(
							"IMEI can only be edited for one item at a time. Please select only one item to change its IMEI.",
						);
						return;
					}

					const fieldInfo = editableFields[fieldToUpdate];
					if (
						fieldInfo.type !== "select" &&
						(newValue === "" || newValue === null)
					) {
						alert("Value cannot be empty.");
						return;
					}
					setIsSubmitting(true);

					const itemsToUpdate = stockData.filter((item) =>
						selectedItemIds.has(item.id),
					);
					const previousItemsState = itemsToUpdate.map((item) => ({
						docId: item.id,
						previousData: {
							[fieldToUpdate]: item[fieldToUpdate],
							hpp: item.hpp,
						},
					}));

					const batch = window.firebase.writeBatch(db);

					for (const item of itemsToUpdate) {
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
							item.id,
						);
						let updateData = {};

						if (fieldToUpdate === "price") {
							const newPrice = newValue;
							const discount = item.discount || 0;
							updateData.price = newPrice;
							updateData.hpp = newPrice - newPrice * (discount / 100);
						} else if (fieldToUpdate === "discount") {
							const newDiscount = newValue;
							const price = item.price || 0;
							updateData.discount = newDiscount;
							updateData.hpp = price - price * (newDiscount / 100);
						} else {
							updateData[fieldToUpdate] = newValue;
							if (fieldToUpdate === "availability" && newValue === "SOLD") {
								updateData.soldDate = window.firebase.Timestamp.fromDate(
									new Date(),
								);
							} else if (
								fieldToUpdate === "availability" &&
								(newValue === "Available" || newValue === "On Delivery")
							) {
								updateData.soldDate = null;
							}
						}
						batch.update(docRef, updateData);
					}

					try {
						await batch.commit();
						const logMessage = `Bulk updated ${itemsToUpdate.length} items: set ${fieldToUpdate} to "${newValue}"`;
						await addLog(userId, {
							message: logMessage,
							type: "BULK_EDIT_STOCK",
							context: {
								items: previousItemsState,
								updatedField: { [fieldToUpdate]: newValue },
							},
						});
						alert(`${itemsToUpdate.length} items updated successfully.`);
						onUpdateSuccess();
					} catch (error) {
						console.error("Error during bulk update: ", error);
						alert("Failed to update items.");
					} finally {
						setIsSubmitting(false);
					}
				};

				const renderValueInput = () => {
					const field = editableFields[fieldToUpdate];
					switch (field.type) {
						case "select":
							return (
								<select
									value={newValue}
									onChange={(e) => setNewValue(e.target.value)}
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
								>
									{field.options.map((opt) => (
										<option key={opt} value={opt}>
											{opt}
										</option>
									))}
								</select>
							);
						case "textarea":
							return (
								<textarea
									value={newValue}
									onChange={(e) => setNewValue(e.target.value)}
									placeholder="Enter new value"
									rows="3"
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
								></textarea>
							);
						case "price":
							return (
								<input
									type="text"
									value={displayValue}
									onChange={handleValueChange}
									placeholder="Enter new price"
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
								/>
							);
						case "number":
							return (
								<input
									type="number"
									value={displayValue}
									onChange={handleValueChange}
									placeholder="Enter new value"
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
								/>
							);
						default:
							return (
								<input
									type="text"
									value={newValue}
									onChange={(e) => setNewValue(e.target.value)}
									placeholder="Enter new value"
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
								/>
							);
					}
				};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
							<h3 className="text-2xl font-bold mb-6">Bulk Update Items</h3>
							<p className="text-gray-600 dark:text-gray-400 mb-4">
								{selectedItemIds.size} items selected.
							</p>
							<form onSubmit={handleSubmit} className="space-y-4">
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										Field to Update
									</label>
									<select
										value={fieldToUpdate}
										onChange={handleFieldChange}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									>
										{Object.entries(editableFields).map(([key, { label }]) => (
											<option key={key} value={key}>
												{label}
											</option>
										))}
									</select>
								</div>
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										New Value
									</label>
									{renderValueInput()}
								</div>
								<div className="flex justify-end space-x-4 pt-4">
									<button
										type="button"
										onClick={closeModal}
										className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
									>
										Cancel
									</button>
									<button
										type="submit"
										disabled={isSubmitting}
										className="px-6 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition disabled:bg-purple-800 disabled:cursor-not-allowed"
									>
										{isSubmitting ? "Updating..." : "Update Selected Items"}
									</button>
								</div>
							</form>
						</div>
					</div>
				);
			}

			function StockListPage({
				userId,
				stockData,
				phoneData,
				theme,
				toggleTheme,
				uniqueSuggestions,
				customers,
				openImeiModal,
				cards,
			}) {
				const [editingItem, setEditingItem] = useState(null);
				const [itemToDelete, setItemToDelete] = useState(null);
				const [viewingItem, setViewingItem] = useState(null);
				const [viewMode, setViewMode] = useState(
					() => localStorage.getItem("stockViewMode") || "card",
				);
				const [isMobileFilterExpanded, setIsMobileFilterExpanded] =
					useState(false);
				const [isDateFilterModalOpen, setIsDateFilterModalOpen] =
					useState(false);

				const [isInitialFilterLoad, setIsInitialFilterLoad] = useState(true);
				const debounceTimeoutRef = useRef(null);

				useEffect(() => {
					const body = document.body;
					if (isDateFilterModalOpen) {
						body.classList.add("overflow-hidden");
					} else {
						body.classList.remove("overflow-hidden");
					}
					return () => {
						body.classList.remove("overflow-hidden");
					};
				}, [isDateFilterModalOpen]);

				useEffect(() => {
					localStorage.setItem("stockViewMode", viewMode);
				}, [viewMode]);

				const initialFilters = {
					model: new Set(),
					color: new Set(),
					availability: new Set(),
					paidStatus: new Set(),
					searchTerm: "",
					orderDate: { start: null, end: null },
					deliveryDate: { start: null, end: null },
					soldDate: { start: null, end: null },
				};

				const [filters, setFilters] = useState(initialFilters);

				useEffect(() => {
					if (!userId || !db) return;

					const loadFilters = async () => {
						const filterDocRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"stockListFilters",
						);
						try {
							const docSnap = await window.firebase.getDoc(filterDocRef);
							if (docSnap.exists()) {
								const savedFilters = docSnap.data();
								setFilters({
									...initialFilters,
									...savedFilters,
									model: new Set(savedFilters.model || []),
									color: new Set(savedFilters.color || []),
									availability: new Set(savedFilters.availability || []),
									paidStatus: new Set(savedFilters.paidStatus || []),
								});
							}
						} catch (error) {
							console.error("Gagal memuat filter dari Firestore:", error);
						} finally {
							setIsInitialFilterLoad(false);
						}
					};

					loadFilters();
				}, [userId]);

				useEffect(() => {
					if (isInitialFilterLoad || !userId || !db) {
						return;
					}

					if (debounceTimeoutRef.current) {
						clearTimeout(debounceTimeoutRef.current);
					}

					debounceTimeoutRef.current = setTimeout(async () => {
						const filterDocRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"stockListFilters",
						);

						const filtersToSave = {
							...filters,
							model: Array.from(filters.model),
							color: Array.from(filters.color),
							availability: Array.from(filters.availability),
							paidStatus: Array.from(filters.paidStatus),
						};

						try {
							await window.firebase.setDoc(filterDocRef, filtersToSave);
						} catch (error) {
							console.error("Gagal menyimpan filter ke Firestore:", error);
						}
					}, 500);

					return () => {
						if (debounceTimeoutRef.current) {
							clearTimeout(debounceTimeoutRef.current);
						}
					};
				}, [filters, userId, isInitialFilterLoad]);

				const [bulkEditMode, setBulkEditMode] = useState(false);
				const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);
				const [selectedItemIds, setSelectedItemIds] = useState(new Set());

				const areDateFiltersActive = useMemo(
					() =>
						filters.orderDate.start ||
						filters.deliveryDate.start ||
						filters.soldDate.start,
					[filters.orderDate, filters.deliveryDate, filters.soldDate],
				);

				const areFiltersActive = useMemo(
					() =>
						filters.model.size > 0 ||
						filters.color.size > 0 ||
						filters.availability.size > 0 ||
						filters.paidStatus.size > 0 ||
						filters.searchTerm !== "" ||
						areDateFiltersActive,
					[filters, areDateFiltersActive],
				);

				const StockDetailModal = ({ item, onClose }) => {
					useEffect(() => {
						document.body.classList.add("overflow-hidden");
						return () => {
							document.body.classList.remove("overflow-hidden");
						};
					}, []);
					return (
						<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
							<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
								<div className="flex justify-between items-center mb-4">
									<h3 className="text-xl font-bold">
										{[item.phoneModel, item.storage, item.ram, item.color]
											.filter(Boolean)
											.join(" ")}
									</h3>
									<button
										onClick={onClose}
										className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl font-bold"
									>
										×
									</button>
								</div>
								<div className="space-y-3 text-sm">
									{Object.entries({
										IMEI: item.imei,
										Availability: item.availability,
										"Paid Status": item.paidStatus,
										Price: formatRupiahDisplay(item.price),
										Discount: `${item.discount || 0}%`,
										"Additional Cost": formatRupiahDisplay(item.additionalCost),
										HPP: formatRupiahDisplay(item.hpp),
										"Sold Price": formatRupiahDisplay(item.soldPrice),
										Profit: formatRupiahDisplay(item.profit),
										"Order Date": formatDate(item.creationTimestamp),
										"Delivery Date": formatDate(item.deliveryDate),
										"Sold Date": formatDate(item.soldDate),
										Supplier: item.supplier,
										Purchaser: item.purchaser,
										"Purchase Acc": item.purchaseAccount,
										"Card Used": item.cardUsed,
										Customer: item.customer,
										Invoice: item.invoice,
										Notes: item.notes,
									}).map(([label, value]) =>
										value ? (
											<div
												key={label}
												className="grid grid-cols-3 gap-4 border-b border-gray-200 dark:border-gray-700 py-2"
											>
												<dt className="font-medium text-gray-500 dark:text-gray-400">
													{label}
												</dt>
												<dd className="col-span-2 text-gray-900 dark:text-white break-words">
													{value}
												</dd>
											</div>
										) : null,
									)}
								</div>
								<div className="flex justify-end mt-6">
									<button
										onClick={onClose}
										className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
									>
										Close
									</button>
								</div>
							</div>
						</div>
					);
				};

								const StockItemCard = ({
					item,
					onEdit,
					onDelete,
					onViewDetails,
					isBulkMode,
					isSelected,
					onSelectItem,
					phoneData,
				}) => {
					const getAvailabilityClass = (availability) => {
						switch (availability) {
							case "SOLD":
								return "bg-yellow-200 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300";
							case "On Delivery":
								return "bg-orange-200 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300";
							case "Refund in process":
								return "bg-red-200 text-red-800 dark:bg-red-900/50 dark:text-red-300";
							case "Refunded":
								return "bg-purple-200 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300";
							case "Available":
							default:
								return "bg-blue-200 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300";
						}
					};
                    
                    // --- PERBAIKAN DI SINI ---
                    // Cek master data dulu, kalau tidak ada, cek field imageUrl di item itu sendiri
					const imageUrl =
						phoneData?.[item.phoneModel]?.colorImages?.[item.color] || item.imageUrl;

					return (
						<div
							className={`bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 flex flex-col gap-3 transition-colors ${isSelected ? "bg-purple-100 dark:bg-purple-900/40" : ""}`}
						>
							<div className="flex justify-between items-stretch gap-4">
								<div
									className={`flex-grow min-w-0 ${isBulkMode ? "pl-8" : ""} relative flex flex-col`}
								>
									{isBulkMode && (
										<input
											type="checkbox"
											className="absolute top-0 -left-1 form-checkbox h-5 w-5 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-purple-600 rounded focus:ring-purple-500"
											checked={isSelected}
											onChange={onSelectItem}
										/>
									)}
									<div className="flex-grow">
										<h3 className="font-bold text-lg text-gray-900 dark:text-white">
											{[item.phoneModel, item.storage, item.ram, item.color]
												.filter(Boolean)
												.join(" ")}
										</h3>
										<p className="font-mono text-sm text-gray-500 dark:text-gray-400 mt-1">
											{item.imei || "No IMEI"}
										</p>
										<div className="grid grid-cols-2 gap-x-4 gap-y-2 mt-4 text-sm">
											<div>
												<div className="text-gray-500 dark:text-gray-400">
													HPP
												</div>
												<div className="font-semibold text-yellow-600 dark:text-yellow-400">
													{formatRupiahDisplay(item.hpp)}
												</div>
											</div>
											<div>
												<div className="text-gray-500 dark:text-gray-400">
													Payment
												</div>
												<div
													className={`font-semibold ${item.paidStatus === "Paid" ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400"}`}
												>
													{item.paidStatus}
												</div>
											</div>
										</div>
									</div>

									{(item.invoice || item.purchaser) && (
										<div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs">
											<span className="text-gray-500 dark:text-gray-400">
												{item.invoice && "Invoice: "}
											</span>
											<span className="font-medium text-gray-700 dark:text-gray-300">
												{item.invoice && item.invoice}
												{item.invoice && item.purchaser && " / "}
												{item.purchaser && item.purchaser}
											</span>
										</div>
									)}
								</div>

								<div className="flex-shrink-0 flex flex-col items-end gap-2">
									<span
										className={`px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full whitespace-nowrap ${getAvailabilityClass(item.availability)}`}
									>
										{item.availability}
									</span>
									{imageUrl && (
										<div className="w-24 flex-grow rounded-md overflow-hidden">
											<img
												src={imageUrl}
												alt={[item.phoneModel, item.color].join(" ")}
												className="w-full h-full object-contain"
											/>
										</div>
									)}
								</div>
							</div>

							<div className="border-t border-gray-200 dark:border-gray-700 pt-3 flex justify-between items-center">
								<button
									onClick={onViewDetails}
									className="text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline"
								>
									View Details
								</button>
								<div className="flex items-center gap-3">
									<button
										onClick={onEdit}
										className="text-yellow-500 dark:text-yellow-400 hover:text-yellow-700 dark:hover:text-yellow-300"
										title="Edit"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											className="h-5 w-5"
											viewBox="0 0 20 20"
											fill="currentColor"
										>
											<path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
											<path
												fillRule="evenodd"
												d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
												clipRule="evenodd"
											/>
										</svg>
									</button>
									<button
										onClick={onDelete}
										className="text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400"
										title="Delete"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											className="h-5 w-5"
											viewBox="0 0 20 20"
											fill="currentColor"
										>
											<path
												fillRule="evenodd"
												d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
												clipRule="evenodd"
											/>
										</svg>
									</button>
								</div>
							</div>
						</div>
					);
				};

				const handleClearFilters = () => {
					setFilters(initialFilters);
				};

				const handleDelete = async () => {
					if (!itemToDelete || !userId) return;
					try {
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
							itemToDelete.id,
						);
						await window.firebase.deleteDoc(docRef);
						const { phoneModel, storage, color, ram, imei, invoice } =
							itemToDelete;
						const details = [phoneModel, storage, ram, color]
							.filter(Boolean)
							.join(" ");
						await addLog(userId, {
							message: `Deleted from list ${details} (IMEI: ${imei || ""}) with Order ID : ${invoice || "N/A"}`,
							type: "DELETE_STOCK",
							context: { docId: itemToDelete.id, deletedData: itemToDelete },
						});
						setItemToDelete(null);
					} catch (error) {
						console.error("Error deleting document:", error);
					}
				};

				const baseFilteredData = useMemo(() => {
					return stockData.filter((item) => {
						const searchableString = [
							item.phoneModel,
							item.storage,
							item.ram,
							item.color,
							item.imei,
							item.supplier,
							item.purchaseAccount,
							item.cardUsed,
							item.purchaser,
							item.invoice,
							item.customer,
							item.notes,
						]
							.filter(Boolean)
							.join(" ");
						const searchMatch = smartSearch(
							searchableString,
							filters.searchTerm,
						);

						const createDateMatcher = (dateFilter, itemDate) => {
							if (!dateFilter.start && !dateFilter.end) return true;
							if (!itemDate || !itemDate.toDate) return false;
							const iDate = itemDate.toDate().getTime();
							const start = dateFilter.start
								? new Date(dateFilter.start).setHours(0, 0, 0, 0)
								: 0;
							const end = dateFilter.end
								? new Date(dateFilter.end).setHours(23, 59, 59, 999)
								: Infinity;
							return iDate >= start && iDate <= end;
						};

						const orderDateMatch = createDateMatcher(
							filters.orderDate,
							item.creationTimestamp,
						);
						const deliveryDateMatch = createDateMatcher(
							filters.deliveryDate,
							item.deliveryDate,
						);
						const soldDateMatch = createDateMatcher(
							filters.soldDate,
							item.soldDate,
						);

						return (
							searchMatch &&
							orderDateMatch &&
							deliveryDateMatch &&
							soldDateMatch
						);
					});
				}, [
					stockData,
					filters.searchTerm,
					filters.orderDate,
					filters.deliveryDate,
					filters.soldDate,
				]);

				const dynamicFilterOptions = useMemo(() => {
					const getOptions = (data, targetKey, otherFilters) => {
						const filteredData = data.filter((item) => {
							return Object.entries(otherFilters).every(([key, valueSet]) => {
								return valueSet.size === 0 || valueSet.has(item[key]);
							});
						});
						return [
							...new Set(
								filteredData.map((item) => item[targetKey]).filter(Boolean),
							),
						].sort();
					};

					const modelOptions = getOptions(baseFilteredData, "phoneModel", {
						color: filters.color,
						availability: filters.availability,
						paidStatus: filters.paidStatus,
					});

					const colorOptions = getOptions(baseFilteredData, "color", {
						phoneModel: filters.model,
						availability: filters.availability,
						paidStatus: filters.paidStatus,
					});

					const availabilityOptions = getOptions(
						baseFilteredData,
						"availability",
						{
							phoneModel: filters.model,
							color: filters.color,
							paidStatus: filters.paidStatus,
						},
					);

					const paidStatusOptions = getOptions(baseFilteredData, "paidStatus", {
						phoneModel: filters.model,
						color: filters.color,
						availability: filters.availability,
					});

					return {
						modelOptions,
						colorOptions,
						availabilityOptions,
						paidStatusOptions,
					};
				}, [
					baseFilteredData,
					filters.model,
					filters.color,
					filters.availability,
					filters.paidStatus,
				]);

				const handleModelSelectionChange = (newSelection) => {
					setFilters((f) => ({ ...f, model: newSelection, color: new Set() }));
				};

				const filteredStock = useMemo(() => {
					return baseFilteredData.filter((item) => {
						const modelMatch =
							filters.model.size === 0
								? true
								: filters.model.has(item.phoneModel);
						const colorMatch =
							filters.color.size === 0 ? true : filters.color.has(item.color);
						const availabilityMatch =
							filters.availability.size === 0
								? true
								: filters.availability.has(item.availability);
						const paidStatusMatch =
							filters.paidStatus.size === 0
								? true
								: filters.paidStatus.has(item.paidStatus);

						return (
							modelMatch && colorMatch && availabilityMatch && paidStatusMatch
						);
					});
				}, [
					baseFilteredData,
					filters.model,
					filters.color,
					filters.availability,
					filters.paidStatus,
				]);

				const filteredTotals = useMemo(
					() =>
						filteredStock.reduce(
							(acc, item) => {
								acc.hpp += item.hpp || 0;
								acc.profit += item.profit || 0;
								return acc;
							},
							{ hpp: 0, profit: 0 },
						),
					[filteredStock],
				);
				const toggleBulkEditMode = () => {
					setBulkEditMode(!bulkEditMode);
					setSelectedItemIds(new Set());
				};
				const handleSelectItem = (itemId) => {
					setSelectedItemIds((prev) => {
						const newSet = new Set(prev);
						if (newSet.has(itemId)) {
							newSet.delete(itemId);
						} else {
							newSet.add(itemId);
						}
						return newSet;
					});
				};
				const handleSelectAll = () => {
					if (selectedItemIds.size === filteredStock.length) {
						setSelectedItemIds(new Set());
					} else {
						setSelectedItemIds(new Set(filteredStock.map((item) => item.id)));
					}
				};
				const handleBulkMarkAsPaid = async () => {
					if (selectedItemIds.size === 0) {
						alert("No items selected.");
						return;
					}
					const itemsToUpdate = stockData.filter((item) =>
						selectedItemIds.has(item.id),
					);
					const previousItemsState = itemsToUpdate.map((item) => ({
						docId: item.id,
						previousData: { paidStatus: item.paidStatus },
					}));
					const batch = window.firebase.writeBatch(db);
					selectedItemIds.forEach((id) => {
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
							id,
						);
						batch.update(docRef, { paidStatus: "Paid" });
					});
					try {
						await batch.commit();
						let imeiString = itemsToUpdate
							.map((item) => item.imei)
							.filter(Boolean)
							.join(", ");
						if (imeiString.length > 150) {
							imeiString =
								itemsToUpdate
									.slice(0, 5)
									.map((i) => i.imei)
									.join(", ") + `... and ${itemsToUpdate.length - 5} more`;
						}
						const logMessage = `Bulk marked ${selectedItemIds.size} items as Paid${imeiString ? ` (IMEIs: ${imeiString})` : ""}.`;
						await addLog(userId, {
							message: logMessage,
							type: "BULK_EDIT_STOCK",
							context: {
								items: previousItemsState,
								updatedField: { paidStatus: "Paid" },
							},
						});
						alert(`${selectedItemIds.size} items marked as Paid.`);
						toggleBulkEditMode();
					} catch (error) {
						console.error("Error updating documents in batch: ", error);
						alert("Failed to update items.");
					}
				};

				const tableHeaders = [
					"Phone Model",
					"IMEI",
					"Order Date",
					"Delivery Date",
					"Actions",
					"Price",
					"Discount",
					"Additional Cost",
					"HPP",
					"Invoice",
					"Supplier",
					"Purchaser",
					"Purchase Account",
					"Card Used",
					"Paid Status",
					"Availability",
					"Sold Date",
					"Sold Price",
					"Profit",
					"Customer",
					"Notes",
				];

				return (
					<div>
						{isDateFilterModalOpen && (
							<DateFilterModal
								isOpen={isDateFilterModalOpen}
								onClose={() => setIsDateFilterModalOpen(false)}
								currentFilters={{
									orderDate: filters.orderDate,
									deliveryDate: filters.deliveryDate,
									soldDate: filters.soldDate,
								}}
								onApplyFilters={(newDateFilters) => {
									setFilters((f) => ({ ...f, ...newDateFilters }));
								}}
							/>
						)}

						<div className="flex flex-wrap justify-between items-center mb-6 gap-4">
							<div className="flex items-center gap-3">
								<h2 className="text-3xl font-bold">Stock List</h2>
								<button
									onClick={() => setIsDateFilterModalOpen(true)}
									className="p-2 rounded-full text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700/50 hover:bg-gray-300 dark:hover:bg-gray-700 relative"
									title="Filter by Date"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										className="h-6 w-6"
										fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor"
										strokeWidth={2}
									>
										<path
											strokeLinecap="round"
											strokeLinejoin="round"
											d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
										/>
									</svg>
									{areDateFiltersActive && (
										<span className="absolute top-0 right-0 h-2.5 w-2.5 rounded-full bg-blue-500 border-2 border-gray-200 dark:border-gray-700/50"></span>
									)}
								</button>
							</div>

							<div className="flex items-center gap-4">
								<div className="flex bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
									<button
										onClick={() => setViewMode("card")}
										className={`p-2 rounded-md transition ${viewMode === "card" ? "bg-white dark:bg-gray-900 shadow" : ""}`}
										title="Card View"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											className="h-5 w-5"
											viewBox="0 0 20 20"
											fill="currentColor"
										>
											<path
												d="M2 4a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V4zm2 2v3h12V6H4zm0 5h12v5H4v-5z"
												clipRule="evenodd"
											/>
										</svg>
									</button>
									<button
										onClick={() => setViewMode("table")}
										className={`p-2 rounded-md transition ${viewMode === "table" ? "bg-white dark:bg-gray-900 shadow" : ""}`}
										title="Table View"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											className="h-5 w-5"
											viewBox="0 0 20 20"
											fill="currentColor"
										>
											<path
												fillRule="evenodd"
												d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h5v2H5a1 1 0 01-1-1zm7 1h4a1 1 0 001-1v-1h-5v2zm0-4h5V8h-5v2zM4 8h5v2H4V8z"
												clipRule="evenodd"
											/>
										</svg>
									</button>
								</div>
								<ThemeToggleButton theme={theme} toggleTheme={toggleTheme} />
								<button
									onClick={openImeiModal}
									className="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-105 flex-grow sm:flex-grow-0 sm:w-auto"
								>
									Input IMEI
								</button>
								<button
									onClick={toggleBulkEditMode}
									className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-105 flex-grow sm:flex-grow-0 sm:w-auto"
								>
									{bulkEditMode ? "Cancel" : "Bulk Edit"}
								</button>
							</div>
						</div>

						<div className="bg-white dark:bg-gray-800 p-4 rounded-lg mb-6 shadow-md">
							<div className="grid grid-cols-2 lg:flex lg:items-end gap-4">
								<div className="col-span-2 lg:flex-grow">
									<label
										htmlFor="stock-search"
										className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1"
									>
										Search
									</label>
									<input
										id="stock-search"
										type="text"
										placeholder="Search anything..."
										value={filters.searchTerm}
										onChange={(e) =>
											setFilters((f) => ({ ...f, searchTerm: e.target.value }))
										}
										className="bg-gray-100 dark:bg-gray-700 p-2 rounded-md border border-gray-300 dark:border-gray-600 w-full"
									/>
									<div className="flex justify-between items-center mt-3 lg:hidden">
										<button
											onClick={() =>
												setIsMobileFilterExpanded(!isMobileFilterExpanded)
											}
											className="text-sm text-blue-600 dark:text-blue-400 hover:underline font-semibold"
										>
											{isMobileFilterExpanded ? "Hide Filters" : "Show Filters"}
										</button>
										{areFiltersActive && (
											<button
												onClick={handleClearFilters}
												className="text-xs text-blue-600 dark:text-blue-400 hover:underline font-semibold"
											>
												Clear All Filters
											</button>
										)}
									</div>
								</div>
								<div
									className={`${isMobileFilterExpanded ? "grid" : "hidden"} col-span-2 grid-cols-2 gap-4 mt-0 lg:mt-0 lg:flex lg:items-end lg:gap-4`}
								>
									<div className="lg:w-44">
										<label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
											Model
										</label>
										<MultiSelectDropdown
											label="All Models"
											options={dynamicFilterOptions.modelOptions}
											selectedOptions={filters.model}
											onSelectionChange={handleModelSelectionChange}
										/>
									</div>
									<div className="lg:w-44">
										<label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
											Color
										</label>
										<MultiSelectDropdown
											label="All Colors"
											options={dynamicFilterOptions.colorOptions}
											selectedOptions={filters.color}
											onSelectionChange={(newSelection) =>
												setFilters((f) => ({ ...f, color: newSelection }))
											}
										/>
									</div>
									<div className="lg:w-44">
										<label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
											Availability
										</label>
										<MultiSelectDropdown
											label="All Availability"
											options={dynamicFilterOptions.availabilityOptions}
											selectedOptions={filters.availability}
											onSelectionChange={(newSelection) =>
												setFilters((f) => ({
													...f,
													availability: newSelection,
												}))
											}
										/>
									</div>
									<div className="lg:w-44">
										<label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
											Payment
										</label>
										<MultiSelectDropdown
											label="All Status"
											options={dynamicFilterOptions.paidStatusOptions}
											selectedOptions={filters.paidStatus}
											onSelectionChange={(newSelection) =>
												setFilters((f) => ({ ...f, paidStatus: newSelection }))
											}
										/>
									</div>
								</div>
								<div className="hidden lg:block flex-shrink-0">
									{areFiltersActive && (
										<button
											onClick={handleClearFilters}
											className="w-full h-full bg-gray-600 hover:bg-gray-700 text-white font-semibold p-2.5 rounded-md transition text-sm"
										>
											Clear
										</button>
									)}
								</div>
							</div>
						</div>

						{editingItem && (
							<EditStockModal
								item={editingItem}
								closeModal={() => setEditingItem(null)}
								userId={userId}
								phoneData={phoneData}
								uniqueSuggestions={uniqueSuggestions}
								customers={customers}
								cards={cards}
							/>
						)}
						{itemToDelete && (
							<ConfirmDeleteModal
								title="Delete Stock Item"
								onConfirm={handleDelete}
								onCancel={() => setItemToDelete(null)}
								item={itemToDelete}
							/>
						)}
						{isBulkEditModalOpen && (
							<BulkEditModal
								closeModal={() => setIsBulkEditModalOpen(false)}
								userId={userId}
								selectedItemIds={selectedItemIds}
								stockData={stockData}
								onUpdateSuccess={() => {
									setIsBulkEditModalOpen(false);
									toggleBulkEditMode();
								}}
							/>
						)}
						{viewingItem && (
							<StockDetailModal
								item={viewingItem}
								onClose={() => setViewingItem(null)}
							/>
						)}

						<div>
							{viewMode === "card" && (
								<div className="no-scrollbar max-h-[calc(100vh-250px)] overflow-y-auto grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
									{filteredStock.map((item) => (
										<StockItemCard
											key={item.id}
											item={item}
											phoneData={phoneData}
											onEdit={() => setEditingItem(item)}
											onDelete={() => setItemToDelete(item)}
											onViewDetails={() => setViewingItem(item)}
											isBulkMode={bulkEditMode}
											isSelected={selectedItemIds.has(item.id)}
											onSelectItem={() => handleSelectItem(item.id)}
										/>
									))}
								</div>
							)}
							{viewMode === "table" && (
								<div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-auto max-h-[calc(100vh-400px)]">
									<table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
										<thead className="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10">
											<tr>
												{bulkEditMode && (
													<th className="px-3 py-3">
														<input
															type="checkbox"
															className="form-checkbox h-5 w-5 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-purple-600 rounded focus:ring-purple-500"
															onChange={handleSelectAll}
															checked={
																selectedItemIds.size === filteredStock.length &&
																filteredStock.length > 0
															}
														/>
													</th>
												)}
												<th
													scope="col"
													className="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
												>
													No
												</th>
												{tableHeaders.map((h) => (
													<th
														key={h}
														scope="col"
														className="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
													>
														{h}
													</th>
												))}
											</tr>
										</thead>
										<tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
											{filteredStock.map((item, index) => (
												<tr
													key={item.id}
													className={`${selectedItemIds.has(item.id) ? "bg-purple-100 dark:bg-purple-900/50" : ""} hover:bg-gray-50 dark:hover:bg-gray-700 transition`}
												>
													{bulkEditMode && (
														<td className="px-3 py-2">
															<input
																type="checkbox"
																className="form-checkbox h-5 w-5 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-purple-600 rounded focus:ring-purple-500"
																checked={selectedItemIds.has(item.id)}
																onChange={() => handleSelectItem(item.id)}
															/>
														</td>
													)}
													<td className="px-3 py-2 whitespace-nowrap text-sm text-center">
														{index + 1}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm font-semibold">
														{[
															item.phoneModel,
															item.storage,
															item.ram,
															item.color,
														]
															.filter(Boolean)
															.join(" ")}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm font-mono">
														{item.imei}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatDate(item.creationTimestamp, true)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatDate(
															item.availability === "On Delivery"
																? null
																: item.deliveryDate,
														)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														<div className="flex items-center gap-3">
															<button
																onClick={() => setEditingItem(item)}
																className="text-yellow-500 dark:text-yellow-400 hover:text-yellow-700 dark:hover:text-yellow-300"
																title="Edit"
															>
																<svg
																	xmlns="http://www.w3.org/2000/svg"
																	className="h-5 w-5"
																	viewBox="0 0 20 20"
																	fill="currentColor"
																>
																	<path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
																	<path
																		fillRule="evenodd"
																		d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
																		clipRule="evenodd"
																	/>
																</svg>
															</button>
															<button
																onClick={() => setItemToDelete(item)}
																className="text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400"
																title="Delete"
															>
																<svg
																	xmlns="http://www.w3.org/2000/svg"
																	className="h-5 w-5"
																	viewBox="0 0 20 20"
																	fill="currentColor"
																>
																	<path
																		fillRule="evenodd"
																		d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
																		clipRule="evenodd"
																	/>
																</svg>
															</button>
														</div>
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatRupiahDisplay(item.price)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.discount}%
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatRupiahDisplay(item.additionalCost || 0)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatRupiahDisplay(item.hpp)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.invoice}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.supplier}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.purchaser}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.purchaseAccount}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.cardUsed}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														<span
															className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.paidStatus === "Paid" ? "bg-green-200 text-green-800" : "bg-red-200 text-red-800"}`}
														>
															{item.paidStatus}
														</span>
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														<span
															className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.availability === "SOLD" ? "bg-yellow-200 text-yellow-800" : item.availability === "On Delivery" ? "bg-orange-200 text-orange-800" : item.availability === "Refund in process" ? "bg-red-200 text-red-800" : item.availability === "Refunded" ? "bg-purple-200 text-purple-800" : "bg-blue-200 text-blue-800"}`}
														>
															{item.availability}
														</span>
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatDate(item.soldDate)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{formatRupiahDisplay(item.soldPrice)}
													</td>
													<td
														className={`px-3 py-2 whitespace-nowrap text-sm font-bold ${item.profit < 0 ? "text-red-600 dark:text-red-400" : "text-green-600 dark:text-green-400"}`}
													>
														{formatRupiahDisplay(item.profit)}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.customer}
													</td>
													<td className="px-3 py-2 whitespace-nowrap text-sm">
														{item.notes}
													</td>
												</tr>
											))}
										</tbody>
									</table>
								</div>
							)}
						</div>
						{filteredStock.length > 0 && (
							<div className="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
								<h3 className="text-lg font-bold mb-3 text-gray-900 dark:text-white">
									Filtered Data Summary
								</h3>
								<div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
									<div className="flex justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
										<span className="font-semibold text-gray-800 dark:text-gray-200">
											Total HPP:
										</span>
										<span className="font-bold text-yellow-600 dark:text-yellow-400">
											{formatRupiahDisplay(filteredTotals.hpp)}
										</span>
									</div>
									<div className="flex justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-md">
										<span className="font-semibold text-gray-800 dark:text-gray-200">
											Total Profit:
										</span>
										<span
											className={`font-bold ${filteredTotals.profit < 0 ? "text-red-600 dark:text-red-400" : "text-green-600 dark:text-green-400"}`}
										>
											{formatRupiahDisplay(filteredTotals.profit)}
										</span>
									</div>
								</div>
							</div>
						)}
						{bulkEditMode && selectedItemIds.size > 0 && (
							<div className="fixed bottom-16 lg:bottom-4 left-0 right-0 bg-gray-200 dark:bg-gray-700 p-4 shadow-lg z-30 flex justify-center items-center gap-4">
								<span className="text-gray-900 dark:text-white">
									{selectedItemIds.size} item(s) selected
								</span>
								<button
									onClick={handleBulkMarkAsPaid}
									className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg"
								>
									Mark as Paid
								</button>
								<button
									onClick={() => setIsBulkEditModalOpen(true)}
									className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"
								>
									Update Field...
								</button>
							</div>
						)}
					</div>
				);
			}

			function CardManagementModal({ userId, onClose }) {
				const [cards, setCards] = useState([]);
				const [newCard, setNewCard] = useState("");
				const [isLoading, setIsLoading] = useState(true);
				const [isSaving, setIsSaving] = useState(false);
				const settingsDocRef = useMemo(
					() =>
						window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"card_list",
						),
					[userId],
				);

				// <-- TAMBAHAN 1: Buat ref untuk melacak status mounted
				const isMounted = useRef(true);

				// <-- TAMBAHAN 2: Gunakan useEffect untuk mengubah status saat unmount
				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					// Set ref ke true saat komponen pertama kali render
					isMounted.current = true;

					// Return sebuah cleanup function yang akan berjalan saat komponen unmount
					return () => {
						document.body.classList.remove("overflow-hidden");
						isMounted.current = false;
					};
				}, []); // Array kosong berarti efek ini hanya berjalan saat mount dan unmount

				useEffect(() => {
					const fetchCards = async () => {
						try {
							const docSnap = await window.firebase.getDoc(settingsDocRef);
							if (
								isMounted.current &&
								docSnap.exists() &&
								docSnap.data().list
							) {
								setCards(docSnap.data().list);
							}
						} catch (error) {
							console.error("Error fetching cards:", error);
						} finally {
							if (isMounted.current) {
								setIsLoading(false);
							}
						}
					};
					fetchCards();
				}, [settingsDocRef]);

				const handleAddCard = () => {
					const trimmedCard = newCard.trim();
					if (trimmedCard && !cards.includes(trimmedCard)) {
						setCards((prev) => [...prev, trimmedCard].sort());
						setNewCard("");
					}
				};

				const handleDeleteCard = (cardToDelete) => {
					setCards((prev) => prev.filter((card) => card !== cardToDelete));
				};

				const handleSave = async () => {
					setIsSaving(true);
					try {
						await window.firebase.setDoc(settingsDocRef, { list: cards });
						await addLog(userId, {
							message: `Updated card list.`,
							type: "EDIT_CARD_LIST",
						});
						alert("Card list saved successfully!");
						onClose(); // Ini akan memicu unmount
					} catch (error) {
						console.error("Error saving card list:", error);
						alert("Failed to save card list.");
						// Jika ada error, komponen mungkin masih mounted, jadi kita bisa set isSaving
						if (isMounted.current) {
							setIsSaving(false);
						}
					}
					// finally block dihapus karena state update setelah onClose menyebabkan warning
				};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[9999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
							<h3 className="text-2xl font-bold mb-6">Manage Cards</h3>
							{isLoading ? (
								<div className="text-center">Loading...</div>
							) : (
								<React.Fragment>
									<div className="space-y-3 max-h-60 overflow-y-auto mb-4 pr-2">
										{cards.length > 0 ? (
											cards.map((card) => (
												<div
													key={card}
													className="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md"
												>
													<span className="font-medium">{card}</span>
													<button
														onClick={() => handleDeleteCard(card)}
														className="text-red-500 hover:text-red-700 text-xl font-bold"
													>
														×
													</button>
												</div>
											))
										) : (
											<p className="text-gray-500 text-center">
												No cards added yet.
											</p>
										)}
									</div>
									<div className="flex gap-2 mb-6">
										<input
											type="text"
											value={newCard}
											onChange={(e) => setNewCard(e.target.value)}
											placeholder="Add new card name"
											className="flex-grow p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
										/>
										<button
											onClick={handleAddCard}
											className="px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700"
										>
											Add
										</button>
									</div>
									<div className="flex justify-end space-x-4">
										<button
											onClick={onClose}
											disabled={isSaving}
											className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
										>
											Cancel
										</button>
										<button
											onClick={handleSave}
											disabled={isSaving}
											className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition"
										>
											{isSaving ? "Saving..." : "Save & Close"}
										</button>
									</div>
								</React.Fragment>
							)}
						</div>
					</div>
				);
			}
			function SaveNewModelConfirmationModal({ models, onConfirm, onSkip }) {
				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10000] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
							<h3 className="text-xl font-bold mb-4">Save New Model Data?</h3>
							<p className="text-gray-600 dark:text-gray-300 mb-4">
								You've entered new models that don't exist in your master data:
							</p>
							<div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-md mb-6 max-h-40 overflow-y-auto">
								<ul className="list-disc list-inside space-y-1">
									{models.map((model) => (
										<li key={model.name} className="font-semibold">
											{model.name}
										</li>
									))}
								</ul>
							</div>
							<p className="text-gray-600 dark:text-gray-300 mb-6">
								Do you want to save them to "Manage Data" for future use?
							</p>
							<div className="flex justify-end space-x-4">
								<button
									onClick={onSkip}
									className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
								>
									No, Just Add Inventory
								</button>
								<button
									onClick={onConfirm}
									className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition"
								>
									Yes, Save and Add
								</button>
							</div>
						</div>
					</div>
				);
			}

						function InventoryInputModal({
				closeModal,
				userId,
				phoneData,
				uniqueSuggestions,
				cards,
			}) {
				const createInitialModelGroup = useCallback(
					() => ({
						key: Date.now(),
						phoneModel: "",
						manualPhoneModel: "",
						storage: "",
						color: "",
						ram: "",
						price: 0,
						discount: "",
						priceDisplay: "",
						additionalCost: 0,
						additionalCostDisplay: "",
						isManual: false,
						isIndividualColorMode: false,
						imeiColorList: [{ imei: "", color: "" }],
						bulkImei: "",
					}),
					[],
				);

				const [commonData, setCommonData] = useState({
					invoice: "",
					supplier: "",
					purchaser: "",
					purchaseAccount: "",
					paidStatus: "Unpaid",
					notes: "",
					cardUsed: "",
				});
				const [itemGroups, setItemGroups] = useState([
					createInitialModelGroup(),
				]);
				const [isSubmitting, setIsSubmitting] = useState(false);
				const [isScannerOpen, setIsScannerOpen] = useState(false);
				const [scannerTarget, setScannerTarget] = useState(null);

				const [newModelsToConfirm, setNewModelsToConfirm] = useState([]);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				// --- PERUBAHAN UTAMA ADA DI FUNGSI INI ---
				const proceedWithSubmission = async () => {
					if (!db || isSubmitting) return;
					setIsSubmitting(true);
				
					// 1. Pisahkan nomor invoice berdasarkan koma
					const invoiceNumbers = commonData.invoice
						.split(',')
						.map(inv => inv.trim())
						.filter(Boolean); // Menghapus entri kosong jika ada koma di akhir
				
					if (invoiceNumbers.length === 0) {
						alert("Please enter at least one valid Invoice Number.");
						setIsSubmitting(false);
						return;
					}
				
					let allItemsToSubmit = [];
					const currentTime = window.firebase.Timestamp.fromDate(new Date());
				
					// 2. Lakukan loop untuk setiap nomor invoice
					for (const invoiceNumber of invoiceNumbers) {
						// 3. Lakukan loop untuk setiap grup item (seperti sebelumnya)
						for (const group of itemGroups) {
							const phoneModel = group.isManual
								? group.manualPhoneModel
								: group.phoneModel;
							if (!phoneModel) continue;
				
							const price = group.price || 0;
							const discount = parseFloat(group.discount) || 0;
							const additionalCost = group.additionalCost || 0;
							const hpp = price - price * (discount / 100) + additionalCost;
				
							// 4. Buat item dasar dengan nomor invoice saat ini
							const baseItem = {
								...commonData,
								invoice: invoiceNumber, // Gunakan nomor invoice dari loop
								cardUsed:
									commonData.purchaser.toUpperCase() === "SENDIRI"
										? commonData.cardUsed
										: "",
								phoneModel,
								storage: group.storage,
								color: group.color,
								ram: group.ram,
								price: price,
								discount: discount,
								additionalCost: additionalCost,
								hpp: hpp,
								customer: "",
								soldPrice: null,
								profit: null,
								soldDate: null,
								creationTimestamp: currentTime,
							};
				
							// Logika untuk IMEI tetap sama, hanya saja sekarang menggunakan `baseItem` yang sudah benar
							if (group.isIndividualColorMode) {
								group.imeiColorList.forEach((item) => {
									const imeiValue = item.imei.trim();
									const isDelivery = imeiValue === "" || imeiValue === "0";
									allItemsToSubmit.push({
										...baseItem,
										imei: isDelivery ? "" : imeiValue,
										color: item.color,
										availability: isDelivery ? "On Delivery" : "Available",
										deliveryDate: isDelivery ? null : currentTime,
									});
								});
							} else {
								const imeisRaw = group.bulkImei
									.split("\n")
									.map((i) => i.trim())
									.filter(Boolean);
								if (imeisRaw.length === 0) {
									allItemsToSubmit.push({
										...baseItem,
										imei: "",
										availability: "On Delivery",
										deliveryDate: null,
									});
								} else {
									imeisRaw.forEach((imei) => {
										const isDelivery = imei === "0";
										allItemsToSubmit.push({
											...baseItem,
											imei: isDelivery ? "" : imei,
											availability: isDelivery ? "On Delivery" : "Available",
											deliveryDate: isDelivery ? null : currentTime,
										});
									});
								}
							}
						}
					}
				
					if (allItemsToSubmit.length === 0) {
						alert(
							"No valid items to submit. Please ensure at least one model is fully specified.",
						);
						setIsSubmitting(false);
						return;
					}
				
					try {
						const stockCollectionRef = window.firebase.collection(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
						);
						const batch = window.firebase.writeBatch(db);
						const createdDocIds = [];
						allItemsToSubmit.forEach((itemData) => {
							const newDocRef = window.firebase.doc(stockCollectionRef);
							batch.set(newDocRef, itemData);
							createdDocIds.push(newDocRef.id);
						});
						await batch.commit();
				
						const logInvoiceString = invoiceNumbers.length > 1
							? `invoices ${invoiceNumbers.join(", ")}`
							: `Order ID : ${commonData.invoice}`;
				
						const logMessage = `Inputted ${allItemsToSubmit.length} item(s) for ${logInvoiceString}`;
						await addLog(userId, {
							message: logMessage,
							type: "CREATE_STOCK",
							context: { createdDocIds, invoiceId: commonData.invoice },
						});
				
						closeModal();
					} catch (error) {
						console.error("Error adding documents: ", error);
						alert("Error submitting data. Please try again.");
						setIsSubmitting(false); // Pastikan state direset jika gagal
					}
				};

				const handleSubmit = async (e) => {
					e.preventDefault();
					if (isSubmitting) return;

					const manualModelGroups = itemGroups.filter(
						(g) =>
							g.isManual &&
							g.manualPhoneModel.trim() &&
							!phoneData[g.manualPhoneModel.trim()],
					);

					const uniqueNewModels = Object.values(
						manualModelGroups.reduce((acc, group) => {
							const modelName = group.manualPhoneModel.trim();
							if (!acc[modelName]) {
								acc[modelName] = {
									name: modelName,
									details: {
										storage: [group.storage.trim()].filter(Boolean),
										colors: [group.color.trim()].filter(Boolean),
										ram: [group.ram.trim()].filter(Boolean),
									},
								};
							}
							return acc;
						}, {}),
					);

					if (uniqueNewModels.length > 0) {
						setNewModelsToConfirm(uniqueNewModels);
					} else {
						await proceedWithSubmission();
					}
				};

				const handleConfirmSaveModels = async () => {
					setIsSubmitting(true);
					try {
						const savePromises = newModelsToConfirm.map((model) =>
							savePhoneMasterData(userId, model.name, model.details),
						);
						await Promise.all(savePromises);
						alert("New model data saved successfully!");
					} catch (error) {
						alert("Failed to save new model data. Please try again.");
						setIsSubmitting(false);
						return;
					}
					setNewModelsToConfirm([]);
					await proceedWithSubmission();
				};

				const handleSkipSaveModels = async () => {
					setNewModelsToConfirm([]);
					await proceedWithSubmission();
				};

				const handleScanSuccess = (scannedText) => {
					if (!scannerTarget) return;
					const { type, groupIndex, listIndex } = scannerTarget;

					if (type === "individual") {
						handleImeiColorChange(groupIndex, listIndex, "imei", scannedText);
					} else if (type === "bulk") {
						const group = itemGroups[groupIndex];
						const newBulkImei =
							(group.bulkImei ? group.bulkImei + "\n" : "") + scannedText;
						updateItemGroup(groupIndex, { bulkImei: newBulkImei });
					}

					setIsScannerOpen(false);
					setScannerTarget(null);
				};

				const handleCommonChange = (e) => {
					const { name, value } = e.target;
					setCommonData((prev) => {
						const newData = { ...prev, [name]: value };
						if (name === "purchaser") {
							if (value.toUpperCase() === "SENDIRI") {
								newData.paidStatus = "Paid";
							} else {
								newData.paidStatus = "Unpaid";
								newData.cardUsed = "";
							}
						}
						return newData;
					});
				};

				const updateItemGroup = (index, newValues) => {
					const newGroups = [...itemGroups];
					newGroups[index] = { ...newGroups[index], ...newValues };
					setItemGroups(newGroups);
				};

				const handleGroupChange = (index, e) => {
					const { name, value } = e.target;
					if (name === "phoneModel" && value === "manual") {
						updateItemGroup(index, {
							phoneModel: "",
							manualPhoneModel: "",
							storage: "",
							color: "",
							ram: "",
							isManual: true,
						});
					} else if (name === "phoneModel") {
						const modelData = phoneData[value] || {};
						const defaultColor =
							modelData.colors && modelData.colors.length > 0
								? modelData.colors[0]
								: "";
						updateItemGroup(index, {
							[name]: value,
							storage: "",
							color: defaultColor,
							ram: "",
							isManual: false,
							imeiColorList: [{ imei: "", color: defaultColor }],
						});
					} else {
						updateItemGroup(index, { [name]: value });
					}
				};

				const handleNumberChange = (index, name, value) => {
					const displayValue = formatNumberInput(value);
					const rawValue = parseFormattedNumber(value);
					updateItemGroup(index, {
						[`${name}Display`]: displayValue,
						[name]: rawValue,
					});
				};

				const handleImeiColorChange = (groupIndex, listIndex, field, value) => {
					const newList = [...itemGroups[groupIndex].imeiColorList];
					newList[listIndex][field] = value;
					updateItemGroup(groupIndex, { imeiColorList: newList });
				};

				const addImeiColorRow = (groupIndex) => {
					const group = itemGroups[groupIndex];
					const modelData = phoneData[group.phoneModel] || {};
					const defaultColor =
						modelData.colors && modelData.colors.length > 0
							? modelData.colors[0]
							: "";
					const newList = [
						...group.imeiColorList,
						{ imei: "", color: defaultColor },
					];
					updateItemGroup(groupIndex, { imeiColorList: newList });
				};

				const removeImeiColorRow = (groupIndex, listIndex) => {
					const newList = itemGroups[groupIndex].imeiColorList.filter(
						(_, i) => i !== listIndex,
					);
					updateItemGroup(groupIndex, { imeiColorList: newList });
				};

				const addItemGroup = () => {
					setItemGroups((prev) => [...prev, createInitialModelGroup()]);
				};

				const removeItemGroup = (index) => {
					setItemGroups((prev) => prev.filter((_, i) => i !== index));
				};

				const isPurchaserSendiri =
					commonData.purchaser.toUpperCase() === "SENDIRI";

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[9999] p-4">
						{newModelsToConfirm.length > 0 && (
							<SaveNewModelConfirmationModal
								models={newModelsToConfirm}
								onConfirm={handleConfirmSaveModels}
								onSkip={handleSkipSaveModels}
							/>
						)}
						{isScannerOpen && (
							<BarcodeScanner
								onScanSuccess={handleScanSuccess}
								onClose={() => setIsScannerOpen(false)}
							/>
						)}
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[calc(100vh-2rem)] flex flex-col">
							<h3 className="text-2xl font-bold mb-6 flex-shrink-0">
								Add New Inventory
							</h3>
							<form
								onSubmit={handleSubmit}
								className="space-y-4 overflow-y-auto flex-grow pr-2"
							>
								{/* Common Fields */}
								<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
									<div>
										<input
											type="text"
											name="invoice"
											placeholder="Invoice Number (bisa koma)"
											value={commonData.invoice}
											onChange={handleCommonChange}
											required
											className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
										/>
									</div>
									<div>
										<input
											type="text"
											name="supplier"
											placeholder="Supplier"
											value={commonData.supplier}
											onChange={handleCommonChange}
											required
											className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
											list="supplier-suggestions"
										/>
										{commonData.supplier.length > 0 && (
											<datalist id="supplier-suggestions">
												{uniqueSuggestions.suppliers
													.filter((s) =>
														s
															.toLowerCase()
															.startsWith(commonData.supplier.toLowerCase()),
													)
													.map((s) => (
														<option key={s} value={s} />
													))}
											</datalist>
										)}
									</div>
									<div>
										<input
											type="text"
											name="purchaser"
											placeholder="Purchaser (e.g., SENDIRI)"
											value={commonData.purchaser}
											onChange={handleCommonChange}
											required
											className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
											list="purchaser-suggestions"
										/>
										{commonData.purchaser.length > 0 && (
											<datalist id="purchaser-suggestions">
												{uniqueSuggestions.purchasers
													.filter((s) =>
														s
															.toLowerCase()
															.startsWith(commonData.purchaser.toLowerCase()),
													)
													.map((s) => (
														<option key={s} value={s} />
													))}
											</datalist>
										)}
									</div>
									<div>
										<input
											type="text"
											name="purchaseAccount"
											placeholder="Purchase Account (e.g., BCA)"
											value={commonData.purchaseAccount}
											onChange={handleCommonChange}
											required
											className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
											list="account-suggestions"
										/>
										{commonData.purchaseAccount.length > 0 && (
											<datalist id="account-suggestions">
												{uniqueSuggestions.purchaseAccounts
													.filter((s) =>
														s
															.toLowerCase()
															.startsWith(
																commonData.purchaseAccount.toLowerCase(),
															),
													)
													.map((s) => (
														<option key={s} value={s} />
													))}
											</datalist>
										)}
									</div>
									<div>
										<select
											name="cardUsed"
											onChange={handleCommonChange}
											value={commonData.cardUsed}
											disabled={!isPurchaserSendiri}
											required={isPurchaserSendiri}
											className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${!isPurchaserSendiri && "opacity-50 cursor-not-allowed"}`}
										>
											<option value="">Pilih Kartu...</option>
											{cards &&
												cards.map((card) => (
													<option key={card} value={card}>
														{card}
													</option>
												))}
										</select>
									</div>
									<select
										name="paidStatus"
										onChange={handleCommonChange}
										value={commonData.paidStatus}
										disabled={isPurchaserSendiri}
										className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${isPurchaserSendiri && "opacity-50 cursor-not-allowed"}`}
									>
										<option value="Unpaid">Unpaid</option>
										<option value="Paid">Paid</option>
									</select>
								</div>

								<div className="space-y-6">
									{itemGroups.map((group, index) => {
										const modelData = phoneData[group.phoneModel] || {};
										return (
											<div
												key={group.key}
												className="border-t-2 border-dashed border-gray-300 dark:border-gray-600 pt-6 relative"
											>
												{itemGroups.length > 1 && (
													<button
														type="button"
														onClick={() => removeItemGroup(index)}
														className="absolute top-4 right-0 bg-red-600 text-white rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold hover:bg-red-700 transition"
													>
														×
													</button>
												)}
												<div className="space-y-4">
													<select
														name="phoneModel"
														onChange={(e) => handleGroupChange(index, e)}
														value={group.isManual ? "manual" : group.phoneModel}
														required
														className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
													>
														<option value="">Select Phone Model</option>
														{Object.keys(phoneData)
															.sort()
															.map((model) => (
																<option key={model} value={model}>
																	{model}
																</option>
															))}
														<option value="manual">-- Manual Input --</option>
													</select>
													{group.isManual ? (
														<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
															<input
																type="text"
																name="manualPhoneModel"
																placeholder="Enter Phone Model"
																onChange={(e) => handleGroupChange(index, e)}
																value={group.manualPhoneModel}
																required
																className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
															/>
															<input
																type="text"
																name="storage"
																placeholder="Storage (e.g., 256GB)"
																onChange={(e) => handleGroupChange(index, e)}
																value={group.storage}
																className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
															/>
															<input
																type="text"
																name="color"
																placeholder="Color"
																onChange={(e) => handleGroupChange(index, e)}
																value={group.color}
																required
																className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
															/>
														</div>
													) : (
														group.phoneModel && (
															<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
																<select
																	name="storage"
																	onChange={(e) => handleGroupChange(index, e)}
																	value={group.storage}
																	className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
																>
																	<option value="">Select Storage</option>
																	{modelData.storage?.map((s) => (
																		<option key={s} value={s}>
																			{s}
																		</option>
																	))}
																</select>
																{!group.isIndividualColorMode && (
																	<select
																		name="color"
																		onChange={(e) =>
																			handleGroupChange(index, e)
																		}
																		value={group.color}
																		className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
																	>
																		<option value="">Select Color</option>
																		{modelData.colors?.map((c) => (
																			<option key={c} value={c}>
																				{c}
																			</option>
																		))}
																	</select>
																)}
															</div>
														)
													)}
													{modelData.ram && modelData.ram.length > 0 && (
														<select
															name="ram"
															onChange={(e) => handleGroupChange(index, e)}
															value={group.ram}
															required
															className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
														>
															<option value="">Select RAM</option>
															{modelData.ram.map((r) => (
																<option key={r} value={r}>
																	{r}
																</option>
															))}
														</select>
													)}
													{group.phoneModel && !group.isManual && (
														<div className="flex items-center gap-2 text-sm">
															<input
																type="checkbox"
																id={`individualColorMode-${group.key}`}
																checked={group.isIndividualColorMode}
																onChange={() =>
																	updateItemGroup(index, {
																		isIndividualColorMode:
																			!group.isIndividualColorMode,
																	})
																}
																className="form-checkbox h-4 w-4 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-blue-600 rounded focus:ring-blue-500"
															/>
															<label
																htmlFor={`individualColorMode-${group.key}`}
															>
																Input Warna per IMEI
															</label>
														</div>
													)}
													{group.isIndividualColorMode ? (
														<div className="space-y-3">
															{group.imeiColorList.map((item, listIndex) => (
																<div
																	key={listIndex}
																	className="flex items-center gap-2"
																>
																	<input
																		type="text"
																		placeholder="IMEI (or 0 for delivery)"
																		value={item.imei}
																		onChange={(e) =>
																			handleImeiColorChange(
																				index,
																				listIndex,
																				"imei",
																				e.target.value,
																			)
																		}
																		className="flex-grow p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
																	/>
																	<button
																		type="button"
																		onClick={() => {
																			setScannerTarget({
																				type: "individual",
																				groupIndex: index,
																				listIndex: listIndex,
																			});
																			setIsScannerOpen(true);
																		}}
																		className="p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
																	>
																		<CameraIcon />
																	</button>
																	<select
																		value={item.color}
																		onChange={(e) =>
																			handleImeiColorChange(
																				index,
																				listIndex,
																				"color",
																				e.target.value,
																			)
																		}
																		className="w-1/3 p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
																	>
																		{modelData.colors?.map((c) => (
																			<option key={c} value={c}>
																				{c}
																			</option>
																		))}
																	</select>
																	<button
																		type="button"
																		onClick={() =>
																			removeImeiColorRow(index, listIndex)
																		}
																		className="p-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition"
																	>
																		-
																	</button>
																</div>
															))}
															<button
																type="button"
																onClick={() => addImeiColorRow(index)}
																className="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
															>
																Tambah IMEI
															</button>
														</div>
													) : (
														<div className="relative">
															<textarea
																name="bulkImei"
																placeholder="Enter IMEIs (one per line). Use 0 for 'On Delivery'."
																onChange={(e) =>
																	updateItemGroup(index, {
																		bulkImei: e.target.value,
																	})
																}
																value={group.bulkImei}
																rows="3"
																className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
															></textarea>
															<button
																type="button"
																onClick={() => {
																	setScannerTarget({
																		type: "bulk",
																		groupIndex: index,
																	});
																	setIsScannerOpen(true);
																}}
																className="absolute bottom-2 right-2 p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"
															>
																<CameraIcon />
															</button>
														</div>
													)}
													<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
														<input
															type="text"
															inputMode="numeric"
															placeholder="Price (IDR)"
															value={group.priceDisplay}
															onChange={(e) =>
																handleNumberChange(
																	index,
																	"price",
																	e.target.value,
																)
															}
															required
															className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
														/>
														<input
															type="number"
															inputMode="numeric"
															placeholder="Discount (%)"
															onChange={(e) =>
																updateItemGroup(index, {
																	discount: e.target.value,
																})
															}
															value={group.discount}
															className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
														/>
														<input
															type="text"
															inputMode="numeric"
															placeholder="Additional Cost (IDR)"
															value={group.additionalCostDisplay}
															onChange={(e) =>
																handleNumberChange(
																	index,
																	"additionalCost",
																	e.target.value,
																)
															}
															className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
														/>
													</div>
												</div>
											</div>
										);
									})}
								</div>

								<button
									type="button"
									onClick={addItemGroup}
									className="w-full mt-4 p-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
								>
									Add Another Model
								</button>
								<textarea
									name="notes"
									placeholder="Notes (optional)"
									value={commonData.notes}
									onChange={handleCommonChange}
									rows="2"
									className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 mt-4"
								></textarea>

								<div className="flex justify-end space-x-4 pt-4 flex-shrink-0">
									<button
										type="button"
										onClick={closeModal}
										className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
									>
										Cancel
									</button>
									<button
										type="submit"
										disabled={isSubmitting}
										className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:bg-blue-800 disabled:cursor-not-allowed"
									>
										{isSubmitting ? "Submitting..." : "Add Item(s)"}
									</button>
								</div>
							</form>
						</div>
					</div>
				);
			}

			const calculateTotalsAndRatios = (financialData, period) => {
				if (!financialData || !period) {
					return {
						bsTotals: {
							currentAssets: 0,
							fixedAssets: 0,
							totalAssets: 0,
							currentLiabilities: 0,
							longTermLiabilities: 0,
							totalLiabilities: 0,
							totalEquity: 0,
							totalLiabilitiesAndEquity: 0,
							netIncome: 0,
						},
						isRatios: {
							revenue: 0,
							cogs: 0,
							grossProfit: 0,
							expenses: 0,
							netIncome: 0,
							grossMargin: "N/A",
							netMargin: "N/A",
						},
						bsRatios: {
							currentRatio: "N/A",
							debtToEquity: "N/A",
							daysInventory: "N/A",
						},
						selisih: 0,
					};
				}

				const sum = (arr) =>
					arr.reduce((acc, item) => acc + (item.value || 0), 0);
				const year = parseInt(period.split("-")[0]);
				const month = parseInt(period.split("-")[1]);
				const daysInMonth = new Date(year, month, 0).getDate();

				const currentAssets = sum(financialData.balanceSheet.assets.current);
				const fixedAssets = sum(financialData.balanceSheet.assets.fixed);
				const totalAssets = currentAssets + fixedAssets;
				const currentLiabilities = sum(
					financialData.balanceSheet.liabilities.current,
				);
				const longTermLiabilities = sum(
					financialData.balanceSheet.liabilities.longTerm,
				);
				const totalLiabilities = currentLiabilities + longTermLiabilities;
				const revenue = sum(financialData.incomeStatement.revenue);
				const cogs = sum(financialData.incomeStatement.cogs);
				const expenses = sum(financialData.incomeStatement.expenses);
				const grossProfit = revenue - cogs;
				const netIncome = grossProfit - expenses;
				const totalEquity = sum(financialData.balanceSheet.equity) + netIncome;
				const totalLiabilitiesAndEquity = totalLiabilities + totalEquity;
				const selisih = totalAssets - totalLiabilitiesAndEquity;

				const inventoryValue =
					financialData.balanceSheet.assets.current.find((acc) =>
						acc.name.toLowerCase().includes("persediaan"),
					)?.value || 0;
				const daysInventory =
					cogs > 0 ? ((inventoryValue / cogs) * daysInMonth).toFixed(1) : "N/A";

				const currentRatio =
					currentLiabilities > 0
						? (currentAssets / currentLiabilities).toFixed(2)
						: "∞";
				const debtToEquity =
					totalEquity > 0 ? (totalLiabilities / totalEquity).toFixed(2) : "∞";
				const grossMargin =
					revenue > 0
						? ((grossProfit / revenue) * 100).toFixed(2) + "%"
						: "N/A";
				const netMargin =
					revenue > 0 ? ((netIncome / revenue) * 100).toFixed(2) + "%" : "N/A";

				return {
					bsTotals: {
						currentAssets,
						fixedAssets,
						totalAssets,
						currentLiabilities,
						longTermLiabilities,
						totalLiabilities,
						totalEquity,
						totalLiabilitiesAndEquity,
						netIncome,
					},
					isRatios: {
						revenue,
						cogs,
						grossProfit,
						expenses,
						netIncome,
						grossMargin,
						netMargin,
					},
					bsRatios: { currentRatio, debtToEquity, daysInventory },
					selisih,
				};
			};

			const StatementTable = ({
				title,
				accounts,
				total,
				isSubSection = false,
			}) => (
				<>
					<div className={`font-semibold ${isSubSection ? "" : "mt-4"}`}>
						{title}
					</div>
					<div className="pl-4">
						{(accounts || []).map((acc) => (
							<div key={acc.id} className="account-row">
								<span>{acc.name}</span>
								<span>{formatRupiahDisplay(acc.value)}</span>
							</div>
						))}
					</div>
					{total !== undefined && (
						<div className="total-row mt-1">
							<span>Total {title}</span>
							<span>{formatRupiahDisplay(total)}</span>
						</div>
					)}
				</>
			);

			const RatioTable = ({ title, ratios }) => (
				<>
					<h4 className="ratio-title">{title}</h4>
					<div className="ratio-grid">
						{(ratios || []).map((ratio) => (
							<div key={ratio.label} className="ratio-item">
								<span>{ratio.label}</span>
								<span className="font-bold">{ratio.value}</span>
							</div>
						))}
					</div>
				</>
			);

			// --- INI FUNGSI YANG HILANG SEBELUMNYA ---
			function StatementSection({
				title,
				section,
				category,
				accounts,
				autoFill,
				handleAutoFill,
				handleAccountChange,
				handleDeleteAccount,
				handleAddAccount,
			}) {
				return (
					<div className="mb-6">
						<div className="flex justify-between items-center mb-2">
							<h4 className="text-lg font-semibold text-gray-800 dark:text-gray-200">
								{title}
							</h4>
							{autoFill && (
								<button
									onClick={() =>
										handleAutoFill(
											section,
											category,
											autoFill.name,
											autoFill.value,
										)
									}
									className="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-semibold py-1 px-2 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition"
									title={`Update dengan nilai dari data: ${formatRupiahDisplay(autoFill.value)}`}
								>
									Auto-fill
								</button>
							)}
						</div>
						<div className="space-y-2">
							{accounts.map((acc) => (
								<div
									key={acc.id}
									className="grid grid-cols-12 gap-2 items-center"
								>
									<input
										type="text"
										value={acc.name}
										onChange={(e) =>
											handleAccountChange(
												section,
												category,
												acc.id,
												"name",
												e.target.value,
											)
										}
										className="col-span-6 p-2 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm"
									/>
									<input
										type="text"
										value={formatNumberInput(acc.value)}
										onChange={(e) =>
											handleAccountChange(
												section,
												category,
												acc.id,
												"value",
												e.target.value,
											)
										}
										className="col-span-5 p-2 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm text-right font-mono"
									/>
									<button
										onClick={() =>
											handleDeleteAccount(section, category, acc.id)
										}
										className="col-span-1 text-red-500 hover:text-red-700 text-xl font-bold flex items-center justify-center"
									>
										×
									</button>
								</div>
							))}
						</div>
						<button
							onClick={() => handleAddAccount(section, category)}
							className="text-sm text-blue-600 dark:text-blue-400 hover:underline mt-2"
						>
							+ Tambah Akun
						</button>
					</div>
				);
			}

			function FinancialStatementPreview({
				data,
				bsTotals,
				isRatios,
				bsRatios,
				period,
				isCompareMode = false,
				compareData = null,
				compareBsTotals = {},
				compareIsRatios = {},
				compareBsRatios = {},
				comparePeriod = "",
			}) {
				const formatNumberOnly = (number) => {
					if (isNaN(number) || number === null || number === undefined)
						return "0";
					return new Intl.NumberFormat("id-ID").format(number);
				};

				const calculatePercentage = (value, total) => {
					if (!total || total === 0 || value === null || value === undefined) {
						return "-";
					}
					const percentage = (value / total) * 100;
					return `${percentage.toFixed(2)}%`;
				};

				const previewStyles = `
        .report-container { font-family: 'Inter', sans-serif; font-size: 12px; color: #111827; max-width: 800px; margin: 0 auto; }
        .dark .report-container { color: #f9fafb; }
        .report-container h1 { font-size: 24px; text-align: center; }
        .report-container h2 { font-size: 16px; text-align: center; margin-bottom: 20px; color: #4b5563; }
        .dark .report-container h2 { color: #9ca3af; }

        .report-section-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 24px;
            overflow: hidden;
            background-color: #ffffff;
        }
        .dark .report-section-card {
            border-color: #4b5563;
            background-color: #1f2937;
        }
        .section-main-title {
            font-size: 16px;
            font-weight: bold;
            padding: 12px 16px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .section-main-title {
            background-color: #374151;
            border-bottom-color: #4b5563;
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: auto; 
        }
        .dark .financial-table { color: #f9fafb; }
        .financial-table th, .financial-table td {
            padding: 7px 16px;
            text-align: left;
            border-bottom: 1px dotted #ccc;
        }
        .financial-table th:not(:last-child), .financial-table td:not(:last-child) {
            border-right: 1px solid #e5e7eb;
        }
        .dark .financial-table th, .dark .financial-table td { border-bottom-color: #4b5563; }
        .dark .financial-table th:not(:last-child), .dark .financial-table td:not(:last-child) {
            border-right-color: #4b5563;
        }
        .financial-table thead {
            background-color: #f3f4f6;
        }
        .dark .financial-table thead {
             background-color: #374151;
        }
        .financial-table th {
            font-weight: bold;
            border-bottom: 2px solid #333;
        }
        .dark .financial-table th { border-bottom-color: #6b7280; }
        
        .financial-table th:not(:first-child),
        .financial-table td:not(:first-child) {
            text-align: right;
        }
        .financial-table td:not(:first-child) {
            font-family: 'Roboto Mono', monospace;
        }
        .financial-table .section-header td {
            font-weight: bold;
            background-color: #f9fafb;
            border-bottom: 1px solid #999;
            font-size: 13px;
        }
        .dark .financial-table .section-header td { background-color: #1f2937; border-bottom-color: #4b5563; }
        .financial-table .total-row td {
            font-weight: bold;
            border-top: 1px solid #999;
            border-bottom: 1px solid #333;
        }
        .dark .financial-table .total-row td { border-top-color: #4b5563; border-bottom-color: #6b7280; }
        .financial-table .grand-total-row td {
    font-weight: bold;
    /* font-size: 14px; Dihapus agar ukurannya sama dengan teks lain (12px) */
    padding-top: 5px;    /* Padding atas diperkecil dari 7px */
    padding-bottom: 5px; /* Padding bawah diperkecil dari 7px */
    border-top: 2px solid #333;
    border-bottom-style: double;
    border-bottom-width: 4px;
    border-bottom-color: #333;
}
        .dark .financial-table .grand-total-row td { border-top-color: #6b7280; border-bottom-color: #6b7280; }
        
        .financial-table .spacer-row td {
            padding: 4px 0;
            border-bottom: none;
            border-right: none;
        }
        .financial-table .percent-col {
            font-family: 'Inter', sans-serif !important;
            font-size: 11px !important; 
            color: #6b7280;
            padding-left: 8px;
            padding-right: 8px;
        }
        .dark .financial-table .percent-col {
             color: #9ca3af;
        }
        .financial-table .grand-total-row .percent-col {
            font-weight: normal !important;
        }


        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .report-container { color: #111827 !important; }
            .report-section-card { border: none; box-shadow: none; margin-top: 24px; background-color: transparent !important; }
            .section-main-title { background-color: transparent !important; border-bottom: 2px solid #333 !important; }
        }
    `;

				const combineAndMapAccounts = (accounts1, accounts2) => {
					const map = new Map();
					(accounts1 || []).forEach((acc) =>
						map.set(acc.name, { val1: acc.value, val2: null }),
					);
					if (accounts2) {
						(accounts2 || []).forEach((acc) => {
							if (map.has(acc.name)) {
								map.get(acc.name).val2 = acc.value;
							} else {
								map.set(acc.name, { val1: null, val2: acc.value });
							}
						});
					}
					return Array.from(map.entries()).map(([name, values]) => ({
						name,
						...values,
					}));
				};

				const ReportTable = ({ period1Label, period2Label }) => {
					const isComparing = !!period2Label;
					const colCount = isComparing ? 5 : 3;

					const renderRow = (label, val1, pct1, val2, pct2) => (
						<>
							<td>{label}</td>
							<td>{formatNumberOnly(val1)}</td>
							<td className="percent-col">{pct1}</td>
							{isComparing && (
								<>
									<td>{formatNumberOnly(val2)}</td>
									<td className="percent-col">{pct2}</td>
								</>
							)}
						</>
					);

					const renderSection = (
						title,
						accounts1,
						accounts2,
						total1,
						total2,
						base1,
						base2,
						totalLabel,
					) => {
						const combined = combineAndMapAccounts(accounts1, accounts2);
						return (
							<>
								<tr className="section-header">
									<td colSpan={colCount}>{title}</td>
								</tr>
								{combined.map((acc) => (
									<tr key={acc.name}>
										{renderRow(
											acc.name,
											acc.val1,
											calculatePercentage(acc.val1, base1),
											acc.val2,
											isComparing ? calculatePercentage(acc.val2, base2) : null,
										)}
									</tr>
								))}
								<tr className="total-row">
									{renderRow(
										totalLabel || `Total ${title}`,
										total1,
										calculatePercentage(total1, base1),
										total2,
										isComparing ? calculatePercentage(total2, base2) : null,
									)}
								</tr>
							</>
						);
					};

					const renderRatioSection = (ratios1, ratios2) => {
						const combinedRatios = (ratios1 || []).map((r1) => {
							const r2 = (ratios2 || []).find((r) => r.label === r1.label) || {
								value: "N/A",
							};
							return { label: r1.label, val1: r1.value, val2: r2.value };
						});
						const ratioCellStyle = {
							fontFamily: "Inter, sans-serif",
							textAlign: "center",
						};

						return (
							<>
								{combinedRatios.map((r) => (
									<tr key={r.label}>
										<td>{r.label}</td>
										<td colSpan="2" style={ratioCellStyle}>
											{r.val1}
										</td>
										{isComparing && (
											<td colSpan="2" style={ratioCellStyle}>
												{r.val2}
											</td>
										)}
									</tr>
								))}
							</>
						);
					};

					return (
						<>
							<div className="report-section-card">
								<h3 className="section-main-title">Neraca</h3>
								<div className="overflow-x-auto">
									<table className="financial-table">
										<thead>
											<tr>
												<th>Akun</th>
												<th style={{ width: "1%", whiteSpace: "nowrap" }}>
													{period1Label}
												</th>
												<th style={{ width: "1%", whiteSpace: "nowrap" }}>%</th>
												{isComparing && (
													<>
														<th style={{ width: "1%", whiteSpace: "nowrap" }}>
															{period2Label}
														</th>
														<th style={{ width: "1%", whiteSpace: "nowrap" }}>
															%
														</th>
													</>
												)}
											</tr>
										</thead>
										<tbody>
											{renderSection(
												"Aset Lancar",
												data.balanceSheet.assets.current,
												compareData?.balanceSheet.assets.current,
												bsTotals.currentAssets,
												compareBsTotals?.currentAssets,
												bsTotals.totalAssets,
												compareBsTotals?.totalAssets,
											)}
											{renderSection(
												"Aset Tetap",
												data.balanceSheet.assets.fixed,
												compareData?.balanceSheet.assets.fixed,
												bsTotals.fixedAssets,
												compareBsTotals?.fixedAssets,
												bsTotals.totalAssets,
												compareBsTotals?.totalAssets,
											)}
											<tr className="grand-total-row">
												{renderRow(
													"TOTAL ASET",
													bsTotals.totalAssets,
													"100.00%",
													compareBsTotals?.totalAssets,
													"100.00%",
												)}
											</tr>
											{renderSection(
												"Liabilitas Jangka Pendek",
												data.balanceSheet.liabilities.current,
												compareData?.balanceSheet.liabilities.current,
												bsTotals.currentLiabilities,
												compareBsTotals?.currentLiabilities,
												bsTotals.totalLiabilitiesAndEquity,
												compareBsTotals?.totalLiabilitiesAndEquity,
											)}
											{renderSection(
												"Liabilitas Jangka Panjang",
												data.balanceSheet.liabilities.longTerm,
												compareData?.balanceSheet.liabilities.longTerm,
												bsTotals.longTermLiabilities,
												compareBsTotals?.longTermLiabilities,
												bsTotals.totalLiabilitiesAndEquity,
												compareBsTotals?.totalLiabilitiesAndEquity,
											)}

											<tr className="section-header">
												<td colSpan={colCount}>Ekuitas</td>
											</tr>
											{combineAndMapAccounts(
												data.balanceSheet.equity,
												compareData?.balanceSheet.equity,
											).map((acc) => (
												<tr key={acc.name}>
													{renderRow(
														acc.name,
														acc.val1,
														calculatePercentage(
															acc.val1,
															bsTotals.totalLiabilitiesAndEquity,
														),
														acc.val2,
														isComparing
															? calculatePercentage(
																	acc.val2,
																	compareBsTotals.totalLiabilitiesAndEquity,
																)
															: null,
													)}
												</tr>
											))}
											<tr>
												{renderRow(
													"Laba Ditahan (Periode Ini)",
													bsTotals.netIncome,
													calculatePercentage(
														bsTotals.netIncome,
														bsTotals.totalLiabilitiesAndEquity,
													),
													compareBsTotals?.netIncome,
													isComparing
														? calculatePercentage(
																compareBsTotals.netIncome,
																compareBsTotals.totalLiabilitiesAndEquity,
															)
														: null,
												)}
											</tr>
											<tr className="total-row">
												{renderRow(
													"Total Ekuitas",
													bsTotals.totalEquity,
													calculatePercentage(
														bsTotals.totalEquity,
														bsTotals.totalLiabilitiesAndEquity,
													),
													compareBsTotals?.totalEquity,
													isComparing
														? calculatePercentage(
																compareBsTotals.totalEquity,
																compareBsTotals.totalLiabilitiesAndEquity,
															)
														: null,
												)}
											</tr>
											<tr className="grand-total-row">
												{renderRow(
													"TOTAL LIABILITAS & EKUITAS",
													bsTotals.totalLiabilitiesAndEquity,
													"100.00%",
													compareBsTotals?.totalLiabilitiesAndEquity,
													"100.00%",
												)}
											</tr>

											<tr className="spacer-row">
												<td colSpan={colCount}></td>
											</tr>
											{renderRatioSection(
												[
													{
														label: "Rasio Lancar",
														value: bsRatios.currentRatio,
													},
													{
														label: "Utang thd Ekuitas",
														value: bsRatios.debtToEquity,
													},
													{
														label: "Days Inventory",
														value: `${bsRatios.daysInventory} Hari`,
													},
												],
												isComparing
													? [
															{
																label: "Rasio Lancar",
																value: compareBsRatios.currentRatio,
															},
															{
																label: "Utang thd Ekuitas",
																value: compareBsRatios.debtToEquity,
															},
															{
																label: "Days Inventory",
																value: `${compareBsRatios.daysInventory} Hari`,
															},
														]
													: null,
											)}
										</tbody>
									</table>
								</div>
							</div>

							<div className="report-section-card">
								<h3 className="section-main-title">Laba Rugi</h3>
								<div className="overflow-x-auto">
									<table className="financial-table">
										<thead>
											<tr>
												<th>Akun</th>
												<th style={{ width: "1%", whiteSpace: "nowrap" }}>
													{period1Label}
												</th>
												<th style={{ width: "1%", whiteSpace: "nowrap" }}>%</th>
												{isComparing && (
													<>
														<th style={{ width: "1%", whiteSpace: "nowrap" }}>
															{period2Label}
														</th>
														<th style={{ width: "1%", whiteSpace: "nowrap" }}>
															%
														</th>
													</>
												)}
											</tr>
										</thead>
										<tbody>
											{renderSection(
												"Pendapatan",
												data.incomeStatement.revenue,
												compareData?.incomeStatement.revenue,
												isRatios.revenue,
												compareIsRatios?.revenue,
												isRatios.revenue,
												compareIsRatios?.revenue,
											)}
											{renderSection(
												"Harga Pokok Penjualan (HPP)",
												data.incomeStatement.cogs,
												compareData?.incomeStatement.cogs,
												isRatios.cogs,
												compareIsRatios?.cogs,
												isRatios.revenue,
												compareIsRatios?.revenue,
											)}
											<tr className="total-row">
												{renderRow(
													"LABA KOTOR",
													isRatios.grossProfit,
													calculatePercentage(
														isRatios.grossProfit,
														isRatios.revenue,
													),
													compareIsRatios?.grossProfit,
													isComparing
														? calculatePercentage(
																compareIsRatios.grossProfit,
																compareIsRatios.revenue,
															)
														: null,
												)}
											</tr>
											{renderSection(
												"Beban Operasional",
												data.incomeStatement.expenses,
												compareData?.incomeStatement.expenses,
												isRatios.expenses,
												compareIsRatios?.expenses,
												isRatios.revenue,
												compareIsRatios?.revenue,
											)}
											<tr className="grand-total-row">
												{renderRow(
													"LABA BERSIH",
													isRatios.netIncome,
													calculatePercentage(
														isRatios.netIncome,
														isRatios.revenue,
													),
													compareIsRatios?.netIncome,
													isComparing
														? calculatePercentage(
																compareIsRatios.netIncome,
																compareIsRatios.revenue,
															)
														: null,
												)}
											</tr>

											<tr className="spacer-row">
												<td colSpan={colCount}></td>
											</tr>

											{renderRatioSection(
												[
													{
														label: "Margin Laba Kotor",
														value: isRatios.grossMargin,
													},
													{
														label: "Margin Laba Bersih",
														value: isRatios.netMargin,
													},
												],
												isComparing
													? [
															{
																label: "Margin Laba Kotor",
																value: compareIsRatios.grossMargin,
															},
															{
																label: "Margin Laba Bersih",
																value: compareIsRatios.netMargin,
															},
														]
													: null,
											)}
										</tbody>
									</table>
								</div>
							</div>
						</>
					);
				};

				return (
					<>
						<style>{previewStyles}</style>
						<div className="report-container">
							<h1>Griphub Ponsel</h1>
							<h2>
								{isCompareMode
									? "Laporan Keuangan Komparatif"
									: `Laporan Keuangan - Periode ${new Date(period + "-02").toLocaleString("default", { month: "long", year: "numeric" })}`}
							</h2>
							<ReportTable
								period1Label={new Date(period + "-02").toLocaleString(
									"default",
									{ month: "long", year: "numeric" },
								)}
								period2Label={
									isCompareMode && comparePeriod
										? new Date(comparePeriod + "-02").toLocaleString(
												"default",
												{ month: "long", year: "numeric" },
											)
										: null
								}
							/>
						</div>
					</>
				);
			}
			function BalanceSheetPage({ userId, stockData, invoicesData }) {
				const [period, setPeriod] = useState("");
				const [availablePeriods, setAvailablePeriods] = useState([]);
				const [financialData, setFinancialData] = useState(null);
				const [loading, setLoading] = useState(true);
				const debounceTimeoutRef = useRef(null);
				const [isSaving, setIsSaving] = useState(false);
				const [view, setView] = useState("preview");
				const printableRef = useRef(null);
				const isMounted = useRef(true);

				const [isCompareMode, setIsCompareMode] = useState(false);
				const [comparePeriod, setComparePeriod] = useState("");
				const [compareFinancialData, setCompareFinancialData] = useState(null);
				const [compareLoading, setCompareLoading] = useState(false);

				// --- PERUBAHAN 1: Tambahkan hook untuk mendeteksi layar desktop ---
				const isDesktop = useMediaQuery("(min-width: 1280px)"); // xl breakpoint

				useEffect(() => {
					isMounted.current = true;
					// ... (sisa useEffect tidak berubah) ...
					return () => {
						isMounted.current = false;
					};
				}, []);

				const inventoryValueFromStock = useMemo(() => {
					// ... (kode tidak berubah) ...
					if (!stockData) return 0;
					return stockData.reduce((acc, item) => {
						if (
							item.availability === "Available" ||
							item.availability === "On Delivery"
						) {
							return acc + (item.hpp || 0);
						}
						return acc;
					}, 0);
				}, [stockData]);

				const { cogsFromInvoices, revenueFromInvoices } = useMemo(() => {
					// ... (kode tidak berubah) ...
					if (!invoicesData || !period)
						return { cogsFromInvoices: 0, revenueFromInvoices: 0 };
					const getMonthKey = (date) =>
						`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;

					return invoicesData.reduce(
						(acc, inv) => {
							const invDate = inv.date?.toDate();
							if (invDate && getMonthKey(invDate) === period) {
								acc.revenueFromInvoices += inv.total || 0;
								const itemsCogs = (inv.items || []).reduce((sum, i) => {
									const qty = i.quantity || 1;
									return sum + (i.hpp || 0) * qty;
								}, 0);
								acc.cogsFromInvoices += itemsCogs;
							}
							return acc;
						},
						{ cogsFromInvoices: 0, revenueFromInvoices: 0 },
					);
				}, [invoicesData, period]);

				useEffect(() => {
					// ... (kode tidak berubah) ...
					const getMonthKey = (ts) => {
						if (!ts) return null;
						const d = ts.toDate ? ts.toDate() : new Date(ts);
						return isNaN(d.getTime())
							? null
							: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
					};
					const keys = new Set();
					[...stockData, ...invoicesData].forEach((item) => {
						const date = item.date || item.creationTimestamp || item.soldDate;
						if (date) keys.add(getMonthKey(date));
					});
					if (keys.size === 0) {
						keys.add(getMonthKey(new Date()));
					}
					const sortedPeriods = [...keys].filter(Boolean).sort().reverse();
					setAvailablePeriods(sortedPeriods);
					if (!period && sortedPeriods.length > 0) {
						setPeriod(sortedPeriods[0]);
					}
				}, [stockData, invoicesData]);

				const createDefaultData = () => ({
					// ... (kode tidak berubah) ...
					balanceSheet: {
						assets: {
							current: [
								{ id: Date.now() + 1, name: "Kas & Setara Kas", value: 0 },
								{ id: Date.now() + 2, name: "Persediaan", value: 0 },
							],
							fixed: [
								{ id: Date.now() + 3, name: "Peralatan Kantor", value: 0 },
							],
						},
						liabilities: {
							current: [{ id: Date.now() + 4, name: "Utang Usaha", value: 0 }],
							longTerm: [],
						},
						equity: [{ id: Date.now() + 5, name: "Modal Disetor", value: 0 }],
					},
					incomeStatement: {
						revenue: [
							{ id: Date.now() + 6, name: "Pendapatan Penjualan", value: 0 },
						],
						cogs: [
							{
								id: Date.now() + 7,
								name: "Harga Pokok Penjualan (HPP)",
								value: 0,
							},
						],
						expenses: [
							{ id: Date.now() + 8, name: "Biaya Gaji", value: 0 },
							{ id: Date.now() + 9, name: "Biaya Operasional", value: 0 },
						],
					},
				});

				useEffect(() => {
					// ... (kode tidak berubah) ...
					if (!userId || !period || !db) return;
					setLoading(true);
					const docRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"financial_statements",
						period,
					);
					const fetchData = async () => {
						try {
							const docSnap = await window.firebase.getDoc(docRef);
							if (isMounted.current) {
								if (docSnap.exists()) setFinancialData(docSnap.data());
								else setFinancialData(createDefaultData());
							}
						} catch (error) {
							console.error("Error fetching financial data:", error);
						} finally {
							if (isMounted.current) setLoading(false);
						}
					};
					fetchData();
				}, [userId, period]);

				useEffect(() => {
					// ... (kode tidak berubah) ...
					if (!userId || !comparePeriod || !db || !isCompareMode) {
						setCompareFinancialData(null);
						return;
					}

					setCompareLoading(true);
					const docRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"financial_statements",
						comparePeriod,
					);
					const fetchCompareData = async () => {
						try {
							const docSnap = await window.firebase.getDoc(docRef);
							if (isMounted.current) {
								if (docSnap.exists()) setCompareFinancialData(docSnap.data());
								else setCompareFinancialData(createDefaultData());
							}
						} catch (error) {
							console.error("Error fetching comparison financial data:", error);
						} finally {
							if (isMounted.current) setCompareLoading(false);
						}
					};
					fetchCompareData();
				}, [userId, comparePeriod, isCompareMode]);

				useEffect(() => {
					// ... (kode tidak berubah) ...
					if (!financialData || loading || isCompareMode) return;
					if (debounceTimeoutRef.current)
						clearTimeout(debounceTimeoutRef.current);

					debounceTimeoutRef.current = setTimeout(async () => {
						if (!userId || !period || !db) return;
						if (isMounted.current) setIsSaving(true);
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"financial_statements",
							period,
						);
						try {
							await window.firebase.setDoc(docRef, financialData, {
								merge: true,
							});
						} catch (error) {
							console.error("Error saving financial data:", error);
						} finally {
							setTimeout(() => {
								if (isMounted.current) setIsSaving(false);
							}, 1000);
						}
					}, 1500);

					return () => {
						if (debounceTimeoutRef.current)
							clearTimeout(debounceTimeoutRef.current);
					};
				}, [financialData, userId, period, loading, isCompareMode]);

				const handleAccountChange = (
					section,
					category,
					accountId,
					field,
					value,
				) => {
					// ... (kode tidak berubah) ...
					setFinancialData((prev) => {
						const newData = JSON.parse(JSON.stringify(prev));
						let accountList;
						if (section === "bs") {
							accountList =
								category.type === "equity"
									? newData.balanceSheet.equity
									: newData.balanceSheet[category.type][category.name];
						} else {
							accountList = newData.incomeStatement[category.name];
						}
						const accountIndex = accountList.findIndex(
							(acc) => acc.id === accountId,
						);
						if (accountIndex > -1) {
							accountList[accountIndex][field] =
								field === "value" ? parseFormattedNumber(value) : value;
						}
						return newData;
					});
				};

				const handleAutoFill = (section, category, accountName, autoValue) => {
					// ... (kode tidak berubah) ...
					setFinancialData((prev) => {
						const newData = JSON.parse(JSON.stringify(prev));
						let accountList;
						if (section === "bs") {
							accountList =
								category.type === "equity"
									? newData.balanceSheet.equity
									: newData.balanceSheet[category.type][category.name];
						} else {
							accountList = newData.incomeStatement[category.name];
						}
						const account = accountList.find((acc) =>
							acc.name.toLowerCase().includes(accountName),
						);
						if (account) {
							account.value = autoValue;
							alert(
								`Nilai untuk "${account.name}" telah diupdate menjadi ${formatRupiahDisplay(autoValue)}`,
							);
						} else {
							alert(
								`Akun yang mengandung "${accountName}" tidak ditemukan. Silakan buat akun terlebih dahulu.`,
							);
						}
						return newData;
					});
				};

				const handleAddAccount = (section, category) => {
					// ... (kode tidak berubah) ...
					setFinancialData((prev) => {
						const newData = JSON.parse(JSON.stringify(prev));
						let accountList;
						if (section === "bs") {
							accountList =
								category.type === "equity"
									? newData.balanceSheet.equity
									: newData.balanceSheet[category.type][category.name];
						} else {
							accountList = newData.incomeStatement[category.name];
						}
						accountList.push({ id: Date.now(), name: "Akun Baru", value: 0 });
						return newData;
					});
				};

				const handleDeleteAccount = (section, category, accountId) => {
					// ... (kode tidak berubah) ...
					if (!window.confirm("Yakin ingin menghapus akun ini?")) return;
					setFinancialData((prev) => {
						const newData = JSON.parse(JSON.stringify(prev));
						let updatedList;
						if (section === "bs") {
							if (category.type === "equity") {
								updatedList = newData.balanceSheet.equity.filter(
									(acc) => acc.id !== accountId,
								);
								newData.balanceSheet.equity = updatedList;
							} else {
								updatedList = newData.balanceSheet[category.type][
									category.name
								].filter((acc) => acc.id !== accountId);
								newData.balanceSheet[category.type][category.name] =
									updatedList;
							}
						} else {
							updatedList = newData.incomeStatement[category.name].filter(
								(acc) => acc.id !== accountId,
							);
							newData.incomeStatement[category.name] = updatedList;
						}
						return newData;
					});
				};

				const { bsTotals, isRatios, bsRatios, selisih } = useMemo(
					() => calculateTotalsAndRatios(financialData, period),
					[financialData, period],
				);

				const {
					bsTotals: compareBsTotals,
					isRatios: compareIsRatios,
					bsRatios: compareBsRatios,
				} = useMemo(
					() => calculateTotalsAndRatios(compareFinancialData, comparePeriod),
					[compareFinancialData, comparePeriod],
				);

				const handlePrint = () => {
					// ... (kode tidak berubah) ...
					const container = document.getElementById("print-root");
					if (!container || !printableRef.current) return;

					const previewHTML = printableRef.current.innerHTML;

					const PrintComponent = () => (
						<div
							className="print-area"
							dangerouslySetInnerHTML={{ __html: previewHTML }}
						/>
					);
					ReactDOM.render(<PrintComponent />, container, () => {
						window.print();
						ReactDOM.unmountComponentAtNode(container);
					});
				};

				const handleToggleCompare = () => {
					// ... (kode tidak berubah) ...
					const newCompareMode = !isCompareMode;
					setIsCompareMode(newCompareMode);
					if (newCompareMode) {
						const currentIndex = availablePeriods.indexOf(period);
						const compareIndex =
							currentIndex + 1 < availablePeriods.length
								? currentIndex + 1
								: availablePeriods.length > 1
									? 0
									: -1;
						if (
							compareIndex > -1 &&
							availablePeriods[compareIndex] !== period
						) {
							setComparePeriod(availablePeriods[compareIndex]);
						} else {
							setComparePeriod("");
						}
						if (!isDesktop) setView("preview"); // Auto switch to preview on mobile
					} else {
						setComparePeriod("");
						setCompareFinancialData(null);
					}
				};

				if (loading || !financialData) {
					return (
						<div className="text-center py-10">Loading Financial Data...</div>
					);
				}

				// --- PERUBAHAN 2: Ekstrak JSX untuk Input dan Preview agar tidak duplikasi ---
				const InputContent = (
					<div className="space-y-8">
						<div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
							<h3 className="text-2xl font-bold mb-4 border-b pb-2 dark:border-gray-600">
								Neraca
							</h3>
							<div className="overflow-x-auto">
								<div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 md:min-w-[700px]">
									<div>
										<StatementSection
											title="Aset Lancar"
											section="bs"
											category={{ type: "assets", name: "current" }}
											accounts={financialData.balanceSheet.assets.current}
											autoFill={{
												name: "persediaan",
												value: inventoryValueFromStock,
											}}
											handleAutoFill={handleAutoFill}
											handleAccountChange={handleAccountChange}
											handleDeleteAccount={handleDeleteAccount}
											handleAddAccount={handleAddAccount}
										/>
										<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
											<span>Total Aset Lancar</span>
											<span>{formatRupiahDisplay(bsTotals.currentAssets)}</span>
										</div>

										<StatementSection
											title="Aset Tetap"
											section="bs"
											category={{ type: "assets", name: "fixed" }}
											accounts={financialData.balanceSheet.assets.fixed}
											handleAutoFill={handleAutoFill}
											handleAccountChange={handleAccountChange}
											handleDeleteAccount={handleDeleteAccount}
											handleAddAccount={handleAddAccount}
										/>
										<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
											<span>Total Aset Tetap</span>
											<span>{formatRupiahDisplay(bsTotals.fixedAssets)}</span>
										</div>

										<div className="flex justify-between font-bold text-lg mt-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-md">
											<span>TOTAL ASET</span>
											<span>{formatRupiahDisplay(bsTotals.totalAssets)}</span>
										</div>
									</div>
									<div>
										<StatementSection
											title="Liabilitas Jangka Pendek"
											section="bs"
											category={{ type: "liabilities", name: "current" }}
											accounts={financialData.balanceSheet.liabilities.current}
											handleAutoFill={handleAutoFill}
											handleAccountChange={handleAccountChange}
											handleDeleteAccount={handleDeleteAccount}
											handleAddAccount={handleAddAccount}
										/>
										<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
											<span>Total Liabilitas Jk. Pendek</span>
											<span>
												{formatRupiahDisplay(bsTotals.currentLiabilities)}
											</span>
										</div>

										<StatementSection
											title="Liabilitas Jangka Panjang"
											section="bs"
											category={{ type: "liabilities", name: "longTerm" }}
											accounts={financialData.balanceSheet.liabilities.longTerm}
											handleAutoFill={handleAutoFill}
											handleAccountChange={handleAccountChange}
											handleDeleteAccount={handleDeleteAccount}
											handleAddAccount={handleAddAccount}
										/>
										<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
											<span>Total Liabilitas Jk. Panjang</span>
											<span>
												{formatRupiahDisplay(bsTotals.longTermLiabilities)}
											</span>
										</div>

										<StatementSection
											title="Ekuitas"
											section="bs"
											category={{ type: "equity", name: "equity" }}
											accounts={financialData.balanceSheet.equity}
											handleAutoFill={handleAutoFill}
											handleAccountChange={handleAccountChange}
											handleDeleteAccount={handleDeleteAccount}
											handleAddAccount={handleAddAccount}
										/>
										<div className="flex justify-between">
											<span>Laba Ditahan (current period)</span>
											<span>{formatRupiahDisplay(bsTotals.netIncome)}</span>
										</div>
										<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
											<span>Total Ekuitas</span>
											<span>{formatRupiahDisplay(bsTotals.totalEquity)}</span>
										</div>

										<div
											className={`flex justify-between font-bold text-lg mt-4 p-3 rounded-md ${Math.round(selisih) === 0 ? "bg-green-100 dark:bg-green-900" : "bg-red-100 dark:bg-red-900"}`}
										>
											<span>TOTAL LIABILITAS & EKUITAS</span>
											<span>
												{formatRupiahDisplay(
													bsTotals.totalLiabilitiesAndEquity,
												)}
											</span>
										</div>
										{Math.round(selisih) !== 0 && (
											<div className="text-sm text-red-500 font-semibold text-right mt-1">
												Selisih: {formatRupiahDisplay(selisih)}
											</div>
										)}
									</div>
								</div>
							</div>

							<div className="mt-8">
								<h4 className="text-xl font-bold mb-4 border-t pt-4 dark:border-gray-600">
									Rasio Neraca
								</h4>
								<div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
									<div className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
										<div className="text-sm text-gray-500 dark:text-gray-400">
											Rasio Lancar
										</div>
										<div className="text-2xl font-bold">
											{bsRatios.currentRatio}
										</div>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
										<div className="text-sm text-gray-500 dark:text-gray-400">
											Utang thd Ekuitas
										</div>
										<div className="text-2xl font-bold">
											{bsRatios.debtToEquity}
										</div>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
										<div className="text-sm text-gray-500 dark:text-gray-400">
											Days Inventory
										</div>
										<div className="text-2xl font-bold">
											{bsRatios.daysInventory}{" "}
											<span className="text-base font-normal">hari</span>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
							<h3 className="text-2xl font-bold mb-4 border-b pb-2 dark:border-gray-600">
								Laporan Laba Rugi
							</h3>
							<StatementSection
								title="Pendapatan"
								section="is"
								category={{ name: "revenue" }}
								accounts={financialData.incomeStatement.revenue}
								autoFill={{ name: "penjualan", value: revenueFromInvoices }}
								handleAutoFill={handleAutoFill}
								handleAccountChange={handleAccountChange}
								handleDeleteAccount={handleDeleteAccount}
								handleAddAccount={handleAddAccount}
							/>
							<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
								<span>Total Pendapatan</span>
								<span>{formatRupiahDisplay(isRatios.revenue)}</span>
							</div>

							<StatementSection
								title="Harga Pokok Penjualan (HPP)"
								section="is"
								category={{ name: "cogs" }}
								accounts={financialData.incomeStatement.cogs}
								autoFill={{ name: "hpp", value: cogsFromInvoices }}
								handleAutoFill={handleAutoFill}
								handleAccountChange={handleAccountChange}
								handleDeleteAccount={handleDeleteAccount}
								handleAddAccount={handleAddAccount}
							/>
							<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
								<span>Total HPP</span>
								<span>{formatRupiahDisplay(isRatios.cogs)}</span>
							</div>

							<div className="flex justify-between font-bold text-lg mt-4 bg-gray-100 dark:bg-gray-700 p-3 rounded-md">
								<span>LABA KOTOR</span>
								<span>{formatRupiahDisplay(isRatios.grossProfit)}</span>
							</div>

							<StatementSection
								title="Beban Operasional"
								section="is"
								category={{ name: "expenses" }}
								accounts={financialData.incomeStatement.expenses}
								handleAutoFill={handleAutoFill}
								handleAccountChange={handleAccountChange}
								handleDeleteAccount={handleDeleteAccount}
								handleAddAccount={handleAddAccount}
							/>
							<div className="flex justify-between font-semibold border-t pt-2 dark:border-gray-600">
								<span>Total Beban</span>
								<span>{formatRupiahDisplay(isRatios.expenses)}</span>
							</div>

							<div
								className={`flex justify-between font-bold text-lg mt-4 p-3 rounded-md ${isRatios.netIncome >= 0 ? "bg-green-100 dark:bg-green-900" : "bg-red-100 dark:bg-red-900"}`}
							>
								<span>LABA BERSIH</span>
								<span>{formatRupiahDisplay(isRatios.netIncome)}</span>
							</div>

							<div className="mt-8">
								<h4 className="text-xl font-bold mb-4 border-t pt-4 dark:border-gray-600">
									Rasio Laba Rugi
								</h4>
								<div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
									<div className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
										<div className="text-sm text-gray-500 dark:text-gray-400">
											Margin Laba Kotor
										</div>
										<div className="text-2xl font-bold">
											{isRatios.grossMargin}
										</div>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
										<div className="text-sm text-gray-500 dark:text-gray-400">
											Margin Laba Bersih
										</div>
										<div className="text-2xl font-bold">
											{isRatios.netMargin}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				);

				const PreviewContent = (
					<div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
						<div ref={printableRef}>
							<FinancialStatementPreview
								data={financialData}
								bsTotals={bsTotals}
								isRatios={isRatios}
								bsRatios={bsRatios}
								period={period}
								selisih={selisih}
								isCompareMode={isCompareMode}
								compareData={compareFinancialData}
								compareBsTotals={compareBsTotals}
								compareIsRatios={compareIsRatios}
								compareBsRatios={compareBsRatios}
								comparePeriod={comparePeriod}
							/>
						</div>
					</div>
				);

				return (
					<div className="mb-6 space-y-4">
						<div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
							<div className="flex items-center gap-4 flex-shrink-0">
								<h2 className="text-3xl font-bold">Balance Sheet</h2>
								{/* --- PERUBAHAN 3: Sembunyikan toggle di desktop --- */}
								{!isDesktop && (
									<div className="flex bg-gray-200 dark:bg-gray-700 p-1 rounded-lg">
										<button
											onClick={() => setView("input")}
											disabled={isCompareMode}
											className={`py-1.5 px-4 rounded-md font-semibold text-sm transition-colors duration-200 ${
												view === "input" && !isCompareMode
													? "bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white"
													: "text-gray-600 dark:text-gray-400 hover:bg-gray-300/50 dark:hover:bg-gray-600/50"
											} ${isCompareMode ? "opacity-50 cursor-not-allowed" : ""}`}
										>
											Input
										</button>
										<button
											onClick={() => setView("preview")}
											className={`py-1.5 px-4 rounded-md font-semibold text-sm transition-colors duration-200 ${
												view === "preview" || isCompareMode
													? "bg-white dark:bg-gray-800 shadow text-gray-900 dark:text-white"
													: "text-gray-600 dark:text-gray-400 hover:bg-gray-300/50 dark:hover:bg-gray-600/50"
											}`}
										>
											Preview
										</button>
									</div>
								)}
							</div>

							<div className="flex items-center justify-start md:justify-end gap-2 flex-wrap">
								{(isDesktop || view === "preview") && (
									<button
										onClick={handlePrint}
										className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm"
									>
										Print
									</button>
								)}
								<button
									onClick={handleToggleCompare}
									className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm"
								>
									{isCompareMode ? "Single View" : "Compare"}
								</button>
							</div>
						</div>

						<div className="bg-gray-100 dark:bg-gray-800/50 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
							<div className="flex flex-col sm:flex-row items-center gap-3 sm:gap-4 w-full">
								<div className="w-full sm:w-auto flex-grow">
									<label
										htmlFor="main-period-selector"
										className="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1"
									>
										{isCompareMode ? "Periode Utama" : "Pilih Periode"}
									</label>
									<select
										id="main-period-selector"
										value={period}
										onChange={(e) => setPeriod(e.target.value)}
										className="w-full bg-white dark:bg-gray-700 p-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
									>
										{availablePeriods.map((p) => (
											<option key={p} value={p}>
												{new Date(p + "-02").toLocaleString("default", {
													month: "long",
													year: "numeric",
												})}
											</option>
										))}
									</select>
								</div>

								{isCompareMode && (
									<div className="hidden sm:flex items-end h-full pb-2 text-gray-400 dark:text-gray-500 font-bold">
										vs
									</div>
								)}

								{isCompareMode && (
									<div className="w-full sm:w-auto flex-grow">
										<label
											htmlFor="compare-period-selector"
											className="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1"
										>
											Periode Pembanding
										</label>
										<select
											id="compare-period-selector"
											value={comparePeriod}
											onChange={(e) => setComparePeriod(e.target.value)}
											className="w-full bg-white dark:bg-gray-700 p-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
										>
											<option value="">Pilih Pembanding</option>
											{availablePeriods
												.filter((p) => p !== period)
												.map((p) => (
													<option key={p} value={p}>
														{new Date(p + "-02").toLocaleString("default", {
															month: "long",
															year: "numeric",
														})}
													</option>
												))}
										</select>
									</div>
								)}

								<div className="w-full sm:w-auto sm:ml-auto flex items-end h-full pb-2 pt-2 sm:pt-0">
									{isSaving && (
										<span className="text-sm text-gray-500 dark:text-gray-400">
											Saving...
										</span>
									)}
								</div>
							</div>
						</div>

						{/* --- PERUBAHAN 4: Terapkan layout baru di sini --- */}
						<div className="mt-6">
							{isDesktop ? (
								<div className="grid grid-cols-1 xl:grid-cols-2 gap-8 items-start">
									{InputContent}
									<div className="xl:sticky xl:top-24 max-h-[calc(100vh-7rem)] overflow-y-auto no-scrollbar">
										{PreviewContent}
									</div>
								</div>
							) : (
								<>
									{view === "input" && !isCompareMode
										? InputContent
										: PreviewContent}
								</>
							)}
						</div>
					</div>
				);
			}

									function EditStockModal({
				item,
				closeModal,
				userId,
				phoneData,
				uniqueSuggestions,
				customers,
				cards,
			}) {
				const [formData, setFormData] = useState({ ...item });
				const [priceDisplay, setPriceDisplay] = useState("");
				const [soldPriceDisplay, setSoldPriceDisplay] = useState("");
				const [additionalCostDisplay, setAdditionalCostDisplay] = useState("");
				const [isSubmitting, setIsSubmitting] = useState(false);
				const [isManual, setIsManual] = useState(
					!Object.keys(phoneData).includes(item.phoneModel),
				);
				const originalItemRef = useRef(item);
				const [isScannerOpen, setIsScannerOpen] = useState(false);
				const isMounted = useRef(true);

				// State untuk URL gambar HANYA untuk item manual
				const [manualImageUrl, setManualImageUrl] = useState('');

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					isMounted.current = true;
					return () => {
						document.body.classList.remove("overflow-hidden");
						isMounted.current = false;
					};
				}, []);

				useEffect(() => {
					let initialFormData = { ...item };
					initialFormData.deliveryDate = timestampToDateTimeLocal(
						item.deliveryDate,
					);
					const isInitiallyManual = !Object.keys(phoneData).includes(item.phoneModel);
					setIsManual(isInitiallyManual);

					if (isInitiallyManual) {
						initialFormData.manualPhoneModel = item.phoneModel;
						initialFormData.phoneModel = "manual";
						// Ambil URL gambar jika ada pada item manual
						setManualImageUrl(item.imageUrl || ''); 
					} else {
						setManualImageUrl('');
					}

					setFormData(initialFormData);
					setPriceDisplay(formatNumberInput(item.price));
					setSoldPriceDisplay(formatNumberInput(item.soldPrice));
					setAdditionalCostDisplay(formatNumberInput(item.additionalCost));
				}, [item, phoneData]);


				const handleNumberInputChange = (e) => {
					const { name, value } = e.target;
					const displayValue = formatNumberInput(value);
					const rawValue = parseFormattedNumber(value);
					if (name === "price") {
						setPriceDisplay(displayValue);
					} else if (name === "soldPrice") {
						setSoldPriceDisplay(displayValue);
					} else if (name === "additionalCost") {
						setAdditionalCostDisplay(displayValue);
					}
					setFormData((prev) => ({ ...prev, [name]: rawValue }));
				};

				const handleChange = (e) => {
					const { name, value } = e.target;
					if (name === "purchaser") {
						const isSelf = value.toUpperCase() === "SENDIRI";
						setFormData((prev) => ({
							...prev,
							purchaser: value,
							paidStatus: isSelf ? "Paid" : "Unpaid",
							cardUsed: isSelf ? prev.cardUsed : "",
						}));
						return;
					}
					if (name === "phoneModel" && value === "manual") {
						setIsManual(true);
						setFormData((prev) => ({
							...prev,
							phoneModel: value,
							manualPhoneModel: "",
							storage: "",
							color: "",
							ram: "",
						}));
						return;
					}
					if (name === "phoneModel" && isManual) {
						setIsManual(false);
					}
					setFormData((prev) => ({ ...prev, [name]: value }));
					if (name === "phoneModel" && value !== "manual") {
						setFormData((prev) => ({
							...prev,
							storage: "",
							color: "",
							ram: "",
						}));
					}
				};

				const handleSubmit = async (e) => {
					e.preventDefault();
					if (!db || isSubmitting) return;

					setIsSubmitting(true);

					let itemToUpdate = { ...formData };
					const originalItem = originalItemRef.current;
					
					// Handle model name changes & set image URL for manual items
					if (isManual) {
						itemToUpdate.phoneModel = itemToUpdate.manualPhoneModel;
						itemToUpdate.imageUrl = manualImageUrl.trim() || deleteField(); // Hapus field jika kosong
					} else {
						// Pastikan item non-manual tidak memiliki field imageUrl sendiri
						if ('imageUrl' in itemToUpdate) {
							delete itemToUpdate.imageUrl;
						}
					}
					delete itemToUpdate.manualPhoneModel;
					
					if (itemToUpdate.purchaser?.toUpperCase() !== "SENDIRI") {
						itemToUpdate.cardUsed = "";
					}

					const newAvailability = itemToUpdate.availability;
					const originalAvailability = originalItem.availability;

					if (newAvailability === 'Available' && originalAvailability === 'On Delivery') {
						if (!itemToUpdate.deliveryDate) {
							itemToUpdate.deliveryDate = window.firebase.Timestamp.fromDate(new Date());
						}
					} 
					else if (newAvailability === 'On Delivery') {
						itemToUpdate.deliveryDate = null;
					}
					
					if (itemToUpdate.deliveryDate && typeof itemToUpdate.deliveryDate === "string") {
						itemToUpdate.deliveryDate = window.firebase.Timestamp.fromDate(
							new Date(itemToUpdate.deliveryDate),
						);
					}

					const price = parseFloat(itemToUpdate.price) || 0;
					const discount = parseFloat(itemToUpdate.discount) || 0;
					const additionalCost = parseFloat(itemToUpdate.additionalCost) || 0;
					itemToUpdate.hpp = price - (price * (discount / 100)) + additionalCost;

					if (newAvailability === "SOLD") {
						itemToUpdate.profit =
							(parseFloat(itemToUpdate.soldPrice) || 0) - itemToUpdate.hpp;
						if (originalAvailability !== 'SOLD') {
							itemToUpdate.soldDate = window.firebase.Timestamp.fromDate(new Date());
						}
					} 
					else if (originalAvailability === "SOLD" && newAvailability !== "SOLD") {
						itemToUpdate.profit = null;
						itemToUpdate.soldPrice = null;
						itemToUpdate.customer = "";
						itemToUpdate.soldDate = null;
					}

					const { id, ...finalUpdateData } = itemToUpdate;
					try {
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
							item.id,
						);
						await window.firebase.updateDoc(docRef, finalUpdateData);

						const originalData = originalItemRef.current;
						const newData = finalUpdateData;
						const changes = [];
						let priceOrDiscountChanged = false;

						const fieldMap = {
							phoneModel: "Model", storage: "Storage", color: "Color", ram: "RAM",
							imei: "IMEI", price: "Price", hpp: "HPP", discount: "Discount",
							additionalCost: "Additional Cost", imageUrl: "Image URL",
							supplier: "Supplier", purchaser: "Purchaser", purchaseAccount: "Purchase Account",
							cardUsed: "Card Used", paidStatus: "Paid Status", availability: "Availability",
							soldPrice: "Sold Price", customer: "Customer", notes: "Notes",
							invoice: "Order ID",
						};

						for (const key of Object.keys(fieldMap)) {
							const oldValue = originalData[key] || "";
							let newValue = newData[key] || "";

							// Handle a special case for deleteField() object from firebase
							if (typeof newValue === 'object' && newValue._methodName === 'delete') {
								newValue = "";
							}

							if (oldValue == newValue) continue;
							if (key === "hpp" && priceOrDiscountChanged) continue;

							let formattedOld = oldValue;
							let formattedNew = newValue;

							if (["price", "hpp", "soldPrice", "additionalCost"].includes(key)) {
								formattedOld = formatRupiahDisplay(oldValue || 0);
								formattedNew = formatRupiahDisplay(newValue || 0);
							} else if (key === "discount") {
								formattedOld = `${oldValue || 0}%`;
								formattedNew = `${newValue || 0}%`;
							}

							if (formattedOld !== formattedNew) {
								changes.push(`${fieldMap[key]} from "${formattedOld}" to "${formattedNew}"`);
								if (key === "price" || key === "discount" || key === "additionalCost") {
									priceOrDiscountChanged = true;
								}
							}
						}

						let logMessage;
						const itemIdentifier = [newData.phoneModel, newData.storage, newData.ram, newData.color].filter(Boolean).join(" ");
						if (changes.length > 0) {
							const changeSummary = changes.join("; ");
							logMessage = `Updated item in Order ID ${newData.invoice || "N/A"} (${itemIdentifier}): ${changeSummary}.`;
						} else {
							logMessage = `Edited stock item: ${itemIdentifier} (IMEI: ${newData.imei || "N/A"}) with no significant changes recorded.`;
						}

						await addLog(userId, {
							message: logMessage,
							type: "EDIT_STOCK",
							context: {
								docId: item.id,
								previousData: originalItemRef.current,
							},
						});
						closeModal();
					} catch (error) {
						console.error("Error updating document:", error);
						alert("Error updating data. Please try again.");
					} finally {
						if (isMounted.current) {
							setIsSubmitting(false);
						}
					}
				};
				const isPurchaserSendiri =
					formData.purchaser?.toUpperCase() === "SENDIRI";
				const selectedModelData = phoneData[formData.phoneModel] || {};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						{isScannerOpen && (
							<BarcodeScanner
								onScanSuccess={(text) => {
									setFormData((prev) => ({ ...prev, imei: text }));
									setIsScannerOpen(false);
								}}
								onClose={() => setIsScannerOpen(false)}
							/>
						)}
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-full overflow-y-auto">
							<h3 className="text-2xl font-bold mb-6">Edit Inventory Item</h3>
							<form onSubmit={handleSubmit} className="space-y-6">
								<div className="space-y-4">
									<select name="phoneModel" onChange={handleChange} value={formData.phoneModel} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
										<option value="">Select Phone Model</option>
										{Object.keys(phoneData).sort().map((model) => (<option key={model} value={model}>{model}</option>))}
										<option value="manual">-- Manual Input --</option>
									</select>

									{isManual ? (
                                        // Wrapper for manual fields
                                        <div className="space-y-4 p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg">
										    <input type="text" name="manualPhoneModel" placeholder="Enter Item Name" onChange={handleChange} value={formData.manualPhoneModel || ""} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <input type="text" name="storage" placeholder="Varian/Detail (e.g., 256GB)" value={formData.storage || ""} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
										        <input type="text" name="color" placeholder="Warna" value={formData.color || ""} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                            </div>
											<div>
												<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
													Image URL (Optional)
												</label>
												<input
													type="text"
													placeholder="https://.../image.png"
													value={manualImageUrl}
													onChange={(e) => setManualImageUrl(e.target.value.trim())}
													className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
												/>
											</div>
                                        </div>
									) : null}

									{!isManual && formData.phoneModel && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <select name="storage" onChange={handleChange} value={formData.storage || ""} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
                                                <option value="">Select Storage</option>
                                                {selectedModelData.storage?.map((s) => (<option key={s} value={s}>{s}</option>))}
                                            </select>
                                            <select name="color" onChange={handleChange} value={formData.color || ""} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
                                                <option value="">Select Color</option>
                                                {selectedModelData.colors?.map((c) => (<option key={c} value={c}>{c}</option>))}
                                            </select>
                                            {(selectedModelData.ram && selectedModelData.ram.length > 0) && (
                                                <select name="ram" onChange={handleChange} value={formData.ram || ""} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
                                                    <option value="">Select RAM</option>
                                                    {selectedModelData.ram.map((r) => (<option key={r} value={r}>{r}</option>))}
                                                </select>
                                            )}
                                        </div>
                                    )}
								</div>

								{/* ... Sisa dari form tetap sama ... */}
								<div className="space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700">
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<div className="flex items-center gap-2">
											<input type="text" name="imei" placeholder="IMEI" value={formData.imei || ""} onChange={handleChange} className="flex-grow w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
											<button type="button" onClick={() => setIsScannerOpen(true)} className="p-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition"><CameraIcon /></button>
										</div>
										<div>
											<input type="text" name="invoice" placeholder="Invoice Number" value={formData.invoice || ""} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="invoice-suggestions"/>
											{formData.invoice && formData.invoice.length > 0 && (<datalist id="invoice-suggestions">{uniqueSuggestions.invoices.filter((s) => s.toLowerCase().startsWith((formData.invoice || "").toLowerCase())).map((s) => (<option key={s} value={s} />))}</datalist>)}
										</div>
									</div>
									<div>
										<label className="text-sm text-gray-500 dark:text-gray-400">Delivery Date</label>
										<input type="datetime-local" name="deliveryDate" value={formData.deliveryDate || ""} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" disabled={!formData.imei || formData.imei.trim() === ""}/>
									</div>
								</div>
								
								<div className="space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700">
									<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
										<input type="text" inputMode="numeric" name="price" placeholder="Price (IDR)" value={priceDisplay} onChange={handleNumberInputChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
										<input type="number" inputMode="numeric" name="discount" placeholder="Discount (%)" value={formData.discount || ""} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
										<input type="text" inputMode="numeric" name="additionalCost" placeholder="Additional Cost (IDR)" value={additionalCostDisplay} onChange={handleNumberInputChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
									</div>
								</div>

								<div className="space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700">
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<div>
											<input type="text" name="supplier" placeholder="Supplier" value={formData.supplier || ""} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="supplier-suggestions"/>
											{formData.supplier && formData.supplier.length > 0 && (<datalist id="supplier-suggestions">{uniqueSuggestions.suppliers.filter((s) => s.toLowerCase().startsWith((formData.supplier || "").toLowerCase())).map((s) => (<option key={s} value={s} />))}</datalist>)}
										</div>
										<div>
											<input type="text" name="purchaser" placeholder="Purchaser (e.g., SENDIRI)" value={formData.purchaser || ""} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="purchaser-suggestions"/>
											{formData.purchaser && formData.purchaser.length > 0 && (<datalist id="purchaser-suggestions">{uniqueSuggestions.purchasers.filter((s) => s.toLowerCase().startsWith((formData.purchaser || "").toLowerCase())).map((s) => (<option key={s} value={s} />))}</datalist>)}
										</div>
									</div>
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<div>
											<input type="text" name="purchaseAccount" placeholder="Purchase Account (e.g., BCA)" value={formData.purchaseAccount || ""} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="account-suggestions"/>
											{formData.purchaseAccount && formData.purchaseAccount.length > 0 && (<datalist id="account-suggestions">{uniqueSuggestions.purchaseAccounts.filter((s) => s.toLowerCase().startsWith((formData.purchaseAccount || "").toLowerCase())).map((s) => (<option key={s} value={s} />))}</datalist>)}
										</div>
										<select name="cardUsed" onChange={handleChange} value={formData.cardUsed || ""} disabled={!isPurchaserSendiri} className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${!isPurchaserSendiri && "opacity-50 cursor-not-allowed"}`}>
											<option value="">Select Card (if SENDIRI)</option>
											{cards && cards.map((card) => (<option key={card} value={card}>{card}</option>))}
										</select>
									</div>
								</div>
								
								<div className="space-y-4 pt-6 border-t border-gray-200 dark:border-gray-700">
									<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
										<select name="paidStatus" onChange={handleChange} value={formData.paidStatus} disabled={isPurchaserSendiri} className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${isPurchaserSendiri && "opacity-50 cursor-not-allowed"}`}>
											<option value="Unpaid">Unpaid</option><option value="Paid">Paid</option>
										</select>
										<select name="availability" onChange={handleChange} value={formData.availability} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">
											<option value="Available">Available</option><option value="On Delivery">On Delivery</option><option value="SOLD">SOLD</option><option value="Refund in process">Refund in process</option><option value="Refunded">Refunded</option>
										</select>
									</div>
									{formData.availability === "SOLD" && (
										<div className="grid grid-cols-1 md:grid-cols-2 gap-4">
											<input type="text" name="soldPrice" placeholder="Sold Price (IDR)" value={soldPriceDisplay} onChange={handleNumberInputChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
											<div>
												<input type="text" name="customer" placeholder="Customer Name" value={formData.customer || ""} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="customer-suggestions"/>
												{formData.customer && formData.customer.length > 0 && (<datalist id="customer-suggestions">{(customers || []).map((c) => (<option key={c.id} value={c.customerName} />))}</datalist>)}
											</div>
										</div>
									)}
								</div>

								<textarea name="notes" placeholder="Notes (optional)" value={formData.notes || ""} onChange={handleChange} rows="2" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>
								
								<div className="flex justify-end space-x-4 pt-4">
									<button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button>
									<button type="submit" disabled={isSubmitting} className="px-6 py-2 rounded-md bg-yellow-600 hover:bg-yellow-700 text-white transition disabled:bg-yellow-800 disabled:cursor-not-allowed"> {isSubmitting ? "Updating..." : "Update Item"} </button>
								</div>
							</form>
						</div>
					</div>
				);
			}

			function ConfirmDeleteModal({ onConfirm, onCancel, item, title }) {
				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
							<h3 className="text-xl font-bold mb-4">{title}</h3>
							<p className="text-gray-600 dark:text-gray-300 mb-2">
								Are you sure you want to delete this?
							</p>
							<div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-md mb-6">
								{item.phoneModel && (
									<p className="font-semibold">
										{item.phoneModel} {item.storage}
									</p>
								)}
								{item.imei && (
									<p className="text-sm text-gray-500 dark:text-gray-400">
										IMEI: {item.imei}
									</p>
								)}
								{item.invoiceNumber && (
									<p className="font-semibold">Invoice: {item.invoiceNumber}</p>
								)}
								{item.customerName && (
									<p className="text-sm text-gray-500 dark:text-gray-400">
										Customer: {item.customerName}
									</p>
								)}
							</div>
							<div className="flex justify-end space-x-4">
								<button
									onClick={onCancel}
									className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
								>
									Cancel
								</button>
								<button
									onClick={onConfirm}
									className="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white transition"
								>
									Delete
								</button>
							</div>
						</div>
					</div>
				);
			}
function AddCustomerModal({ userId, onClose, onSave }) {
    const [name, setName] = useState('');
    const [phone, setPhone] = useState('');
    const [isSaving, setIsSaving] = useState(false);
    const modalRef = useRef(null);

    // Menutup modal jika klik di luar
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (modalRef.current && !modalRef.current.contains(event.target)) {
                onClose();
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, [onClose]);

    const handleSave = async () => {
        if (!name.trim() || !phone.trim()) {
            alert('Nama dan nomor HP tidak boleh kosong.');
            return;
        }
        setIsSaving(true);
        try {
            const customerRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "customers", name.toLowerCase().trim());
            await window.firebase.setDoc(customerRef, {
                customerName: name.trim(),
                customerPhone: phone.trim(),
                lastUpdated: window.firebase.Timestamp.fromDate(new Date())
            }, { merge: true });
            
            // Panggil callback onSave untuk update form utama
            onSave({ name: name.trim(), phone: phone.trim() });
            
            // Tutup modal setelah berhasil
            onClose();

        } catch (error) {
            console.error("Gagal menyimpan customer baru:", error);
            alert("Gagal menyimpan data pelanggan baru.");
        } finally {
            setIsSaving(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10001] p-4">
            <div ref={modalRef} className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                <div className="flex justify-between items-center mb-6">
                    <h3 className="text-xl font-bold">Tambah Pelanggan Baru</h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
                </div>
                <div className="space-y-4">
                    <input
                        type="text"
                        placeholder="Nama Pelanggan"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border"
                        required
                    />
                    <input
                        type="text"
                        placeholder="Nomor HP"
                        value={phone}
                        onChange={(e) => setPhone(e.target.value)}
                        className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border"
                        required
                    />
                </div>
                <div className="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onClick={onClose} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Batal</button>
                    <button onClick={handleSave} disabled={isSaving} className="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:opacity-50">
                        {isSaving ? 'Menyimpan...' : 'Simpan'}
                    </button>
                </div>
            </div>
        </div>
    );
}
function CustomerCombobox({ customers, value, onChange, onSelect, onDelete, onAddNew }) {
    const [isOpen, setIsOpen] = useState(false);
    const comboboxRef = useRef(null);

    // Filter customer list based on typed value
    const filteredCustomers = useMemo(() => {
        if (!value) return customers;
        return customers.filter(c => 
            c.customerName.toLowerCase().includes(value.toLowerCase())
        );
    }, [customers, value]);

    // Close dropdown when clicking outside
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (comboboxRef.current && !comboboxRef.current.contains(event.target)) {
                setIsOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, []);
    
    const handleSelect = (customer) => {
        onSelect(customer);
        setIsOpen(false);
    };

    const handleDelete = async (e, customer) => {
        e.stopPropagation(); // Mencegah dropdown tertutup saat tombol hapus diklik
        if (window.confirm(`Anda yakin ingin menghapus pelanggan "${customer.customerName}"?`)) {
            await onDelete(customer.id);
        }
    };

    // --- FUNGSI BARU UNTUK MEMPERBAIKI BUG ---
    const handleAddNewClick = () => {
        onAddNew();      // 1. Panggil fungsi untuk membuka modal
        setIsOpen(false);  // 2. Tutup dropdown ini
    };

    return (
        <div className="relative" ref={comboboxRef}>
            <div className="flex items-center w-full bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 focus-within:ring-2 focus-within:ring-blue-500 transition-colors">
                <input
                    type="text"
                    placeholder="Ketik atau pilih pelanggan..."
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    onFocus={() => setIsOpen(true)}
                    required
                    className="w-full p-3 bg-transparent focus:outline-none"
                />
                <button
                    type="button"
                    onClick={() => setIsOpen(!isOpen)}
                    className="p-3 border-l border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300"
                >
                    <svg className={`w-5 h-5 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
            
            {isOpen && (
                <div className="absolute z-[10001] mt-1 w-full bg-white dark:bg-gray-800 shadow-lg rounded-md border border-gray-300 dark:border-gray-600 max-h-60 overflow-y-auto">
                    <ul>
                        {filteredCustomers.length > 0 ? (
                            filteredCustomers.map(customer => (
                                <li key={customer.id} 
                                    onClick={() => handleSelect(customer)}
                                    className="px-4 py-2 hover:bg-blue-100 dark:hover:bg-blue-900/50 cursor-pointer flex justify-between items-center group"
                                >
                                    <span>{customer.customerName}</span>
                                    <button 
                                        type="button"
                                        onClick={(e) => handleDelete(e, customer)}
                                        className="p-1 text-gray-400 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-400"
                                        title={`Hapus ${customer.customerName}`}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
                                        </svg>
                                    </button>
                                </li>
                            ))
                        ) : (
                            <li className="px-4 py-2 text-gray-500">Pelanggan tidak ditemukan.</li>
                        )}
                         <li 
                            // --- PERUBAHAN DI SINI ---
                            onClick={handleAddNewClick}
                            className="px-4 py-3 border-t border-gray-200 dark:border-gray-700 hover:bg-blue-100 dark:hover:bg-blue-900/50 cursor-pointer flex items-center gap-2 font-semibold text-blue-600 dark:text-blue-400"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>
                            Tambah Pelanggan Tetap Baru...
                        </li>
                    </ul>
                </div>
            )}
        </div>
    );
}

		
function SalesInvoiceModal({
				stock,
				closeModal,
				userId,
				uniqueSuggestions,
				invoiceToEdit = null,
				customers,
			}) {
				const isEditMode = !!invoiceToEdit;
				const originalInvoiceRef = useRef(null);
    
                const [isAddCustomerModalOpen, setIsAddCustomerModalOpen] = useState(false);

				const CONTACT_INFO = "Kontak Griphub Ponsel : 08995071749";
				const PAYMENT_INFO_UNPAID =
					"Invoice ini belum lunas, silakan melakukan pembayaran ke\nBCA 5271489375 Aldrey Eka Putra";
				const DEFAULT_NOTES_PAID = CONTACT_INFO;
				const DEFAULT_NOTES_UNPAID = `${CONTACT_INFO}\n\n${PAYMENT_INFO_UNPAID}`;

				const PREDEFINED_COSTS = [
					"Ongkos Kirim",
					"Biaya Admin",
					"Biaya Packing",
				];

				const initialCostItem = {
					key: Date.now(),
					inputType: "dropdown",
					description: PREDEFINED_COSTS[0],
					buyerAmount: 0,
					buyerAmountDisplay: "",
					sellerAmount: 0,
					sellerAmountDisplay: "",
				};

				const [customerName, setCustomerName] = useState("");
				const [customerPhone, setCustomerPhone] = useState("");
				const [paymentTerms, setPaymentTerms] = useState("COD");
				const [paymentStatus, setPaymentStatus] = useState("Belum Lunas");
				const [invoiceNotes, setInvoiceNotes] = useState(DEFAULT_NOTES_UNPAID);
				const [discount, setDiscount] = useState(0);
				const [discountDisplay, setDiscountDisplay] = useState("");
				const [otherCostsList, setOtherCostsList] = useState([initialCostItem]);
				const [amountPaid, setAmountPaid] = useState(0);
				const [amountPaidDisplay, setAmountPaidDisplay] = useState("");
				const [selectedItems, setSelectedItems] = useState([]);
				const [manualItems, setManualItems] = useState([]);
				const [searchTerm, setSearchTerm] = useState("");
				const [view, setView] = useState("form");
				const [invoicePreviewData, setInvoicePreviewData] = useState(null);
				const [isGenerating, setIsGenerating] = useState(false);
				const previewRef = useRef(null);
				const [savedInvoiceId, setSavedInvoiceId] = useState(null);
				const [isSaving, setIsSaving] = useState(false);
				const [isScannerOpen, setIsScannerOpen] = useState(false);
				const [scannerTarget, setScannerTarget] = useState(null);
				const [expandedGroups, setExpandedGroups] = useState(new Set());

				useEffect(() => {
					const isDefault =
						invoiceNotes === DEFAULT_NOTES_PAID ||
						invoiceNotes === DEFAULT_NOTES_UNPAID;
					if (isDefault) {
						setInvoiceNotes(
							paymentStatus === "Belum Lunas"
								? DEFAULT_NOTES_UNPAID
								: DEFAULT_NOTES_PAID,
						);
					}
				}, [paymentStatus]);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				useEffect(() => {
					if (isEditMode) {
						originalInvoiceRef.current = invoiceToEdit;
						setCustomerName(invoiceToEdit.customerName || "");
						setCustomerPhone(invoiceToEdit.customerPhone || "");
						setPaymentTerms(invoiceToEdit.paymentTerms || "COD");
						const currentPaymentStatus = invoiceToEdit.paymentStatus || "Lunas";
						setPaymentStatus(currentPaymentStatus);
						const defaultNoteForEdit =
							currentPaymentStatus === "Belum Lunas"
								? DEFAULT_NOTES_UNPAID
								: DEFAULT_NOTES_PAID;
						setInvoiceNotes(invoiceToEdit.notes || defaultNoteForEdit);
						setDiscount(invoiceToEdit.discount || 0);
						setDiscountDisplay(formatNumberInput(invoiceToEdit.discount || 0));

						if (
							invoiceToEdit.otherCostsList &&
							Array.isArray(invoiceToEdit.otherCostsList) &&
							invoiceToEdit.otherCostsList.length > 0
						) {
							setOtherCostsList(
								invoiceToEdit.otherCostsList.map((cost) => ({
									key: Math.random(),
									inputType: PREDEFINED_COSTS.includes(cost.description)
										? "dropdown"
										: "manual",
									description: cost.description || "",
									buyerAmount:
										cost.borneBy === "Pembeli" || cost.buyerAmount
											? cost.buyerAmount || cost.amount || 0
											: 0,
									buyerAmountDisplay: formatNumberInput(
										cost.borneBy === "Pembeli" || cost.buyerAmount
											? cost.buyerAmount || cost.amount || 0
											: 0,
									),
									sellerAmount:
										cost.borneBy === "Penjual" || cost.sellerAmount
											? cost.sellerAmount || cost.amount || 0
											: 0,
									sellerAmountDisplay: formatNumberInput(
										cost.borneBy === "Penjual" || cost.sellerAmount
											? cost.sellerAmount || cost.amount || 0
											: 0,
									),
								})),
							);
						} else if (invoiceToEdit.otherCosts > 0) {
							setOtherCostsList([
								{
									...initialCostItem,
									description: invoiceToEdit.costDescription || "Ongkos Kirim",
									buyerAmount: invoiceToEdit.otherCosts,
									buyerAmountDisplay: formatNumberInput(
										invoiceToEdit.otherCosts,
									),
								},
							]);
						} else {
							setOtherCostsList([initialCostItem]);
						}

						setAmountPaid(invoiceToEdit.amountPaid || 0);
						setAmountPaidDisplay(
							formatNumberInput(invoiceToEdit.amountPaid || 0),
						);
						const stockItemsFromInvoice = (invoiceToEdit.items || []).filter(
							(i) => i.id,
						);
						const manualItemsFromInvoice = (invoiceToEdit.items || []).filter(
							(i) => !i.id,
						);
						setSelectedItems(stockItemsFromInvoice);
						setManualItems(
							manualItemsFromInvoice.map((m) => ({
								...m,
								key: m.itemName + Date.now(),
								serialNumbers: (m.serialNumbers || []).join("\n"),
								quantity: m.quantity || "",
							})),
						);
					} else {
						originalInvoiceRef.current = null;
						setPaymentStatus("Belum Lunas");
						setInvoiceNotes(DEFAULT_NOTES_UNPAID);
					}
				}, [invoiceToEdit, isEditMode]);
    
                const handleSaveNewCustomer = ({ name, phone }) => {
                    setCustomerName(name);
                    setCustomerPhone(phone);
                };

                const handleDeleteCustomer = async (customerId) => {
                    try {
                        const customerRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "customers", customerId);
                        await window.firebase.deleteDoc(customerRef);
                        // Jika pelanggan yang dihapus adalah yang sedang dipilih, bersihkan field
                        if (customerName.toLowerCase() === customerId) {
                            setCustomerName("");
                            setCustomerPhone("");
                        }
                    } catch (error) {
                        console.error("Failed to delete customer:", error);
                        alert("An error occurred while deleting the customer.");
                    }
                };

				const totalOtherCosts = useMemo(
					() =>
						otherCostsList.reduce(
							(acc, cost) => acc + (cost.buyerAmount || 0),
							0,
						),
					[otherCostsList],
				);

				const subTotal = useMemo(() => {
					const stockSubTotal = selectedItems.reduce(
						(acc, i) => acc + (i.soldPrice || 0),
						0,
					);
					const manualSubTotal = manualItems.reduce(
						(acc, i) => acc + i.soldPrice * (parseInt(i.quantity, 10) || 0),
						0,
					);
					return stockSubTotal + manualSubTotal;
				}, [selectedItems, manualItems]);

				const total = useMemo(() => {
					return subTotal - discount + totalOtherCosts;
				}, [subTotal, discount, totalOtherCosts]);

				useEffect(() => {
					if (paymentStatus === "Lunas") {
						setAmountPaid(total);
						setAmountPaidDisplay(formatNumberInput(total));
					} else {
						if (isEditMode && invoiceToEdit.paymentStatus !== "Lunas") {
							setAmountPaid(invoiceToEdit.amountPaid || 0);
							setAmountPaidDisplay(
								formatNumberInput(invoiceToEdit.amountPaid || 0),
							);
						} else {
							setAmountPaid(0);
							setAmountPaidDisplay("");
						}
					}
				}, [paymentStatus, total, isEditMode, invoiceToEdit]);

				const handleOtherCostChange = (index, field, value) => {
					const newList = [...otherCostsList];
					const currentItem = { ...newList[index] };

					switch (field) {
						case "inputType":
							currentItem.inputType = value;
							currentItem.description =
								value === "dropdown" ? PREDEFINED_COSTS[0] : "";
							break;
						case "buyerAmount":
							currentItem.buyerAmountDisplay = formatNumberInput(value);
							currentItem.buyerAmount = parseFormattedNumber(value);
							break;
						case "sellerAmount":
							currentItem.sellerAmountDisplay = formatNumberInput(value);
							currentItem.sellerAmount = parseFormattedNumber(value);
							break;
						default:
							currentItem[field] = value;
							break;
					}

					newList[index] = currentItem;
					setOtherCostsList(newList);
				};

				const addOtherCostRow = () => {
					setOtherCostsList((prev) => [
						...prev,
						{ ...initialCostItem, key: Date.now() },
					]);
				};
				const removeOtherCostRow = (index) => {
					setOtherCostsList((prev) => prev.filter((_, i) => i !== index));
				};

				const buildInvoiceData = async () => {
					const stockItemsWithNoPrice = selectedItems.filter(
						(item) => !item.soldPrice || item.soldPrice <= 0,
					);
					if (stockItemsWithNoPrice.length > 0) {
						alert(
							"Please set a valid sold price for all selected stock items.",
						);
						return null;
					}
					const validManualItems = manualItems
						.map((i) => ({ ...i, quantity: parseInt(i.quantity, 10) || 0 }))
						.filter(
							(i) => i.itemName.trim() && i.soldPrice > 0 && i.quantity > 0,
						);
					if (
						!customerName ||
						(selectedItems.length === 0 && validManualItems.length === 0)
					) {
						alert(
							"Silakan isi nama pelanggan, termin pembayaran, dan pilih atau tambahkan minimal satu barang.",
						);
						return null;
					}
					let invoiceNumber;
					if (isEditMode) {
						invoiceNumber = invoiceToEdit.invoiceNumber;
					} else {
						const today = new Date();
						const dateString = today
							.toLocaleDateString("fr-CA")
							.replace(/-/g, "")
							.slice(2);
						const randomNumber = String(
							Math.floor(Math.random() * 1000000),
						).padStart(6, "0");
						invoiceNumber = `${dateString}${randomNumber}`;
					}
					const currentSubTotal = subTotal;
					const currentTotal = total;
					const finalAmountPaid =
						paymentStatus === "Lunas" ? currentTotal : amountPaid;

					const validOtherCosts = otherCostsList
						.filter(
							(cost) =>
								(cost.buyerAmount > 0 || cost.sellerAmount > 0) &&
								cost.description.trim() !== "",
						)
						.map(
							({ key, buyerAmountDisplay, sellerAmountDisplay, ...rest }) =>
								rest,
						);

					const allItems = [
						...selectedItems,
						...validManualItems.map((item) => ({
							...item,
							serialNumbers: (item.serialNumbers || "")
								.split("\n")
								.filter(Boolean),
						})),
					];

					return {
						invoiceNumber,
						customerName: customerName.trim(), // Trim nama sebelum disimpan
						customerPhone,
						paymentTerms,
						paymentStatus,
						date: isEditMode
							? invoiceToEdit.date
							: window.firebase.Timestamp.fromDate(new Date()),
						items: allItems,
						subTotal: currentSubTotal,
						discount,
						otherCosts: totalOtherCosts,
						otherCostsList: validOtherCosts,
						total: currentTotal,
						amountPaid: finalAmountPaid,
						notes: invoiceNotes,
					};
				};

				const toggleGroupExpansion = (groupKey) => {
					setExpandedGroups((prev) => {
						const newSet = new Set(prev);
						if (newSet.has(groupKey)) {
							newSet.delete(groupKey);
						} else {
							newSet.add(groupKey);
						}
						return newSet;
					});
				};

				const handleScanSuccess = (scannedText) => {
					if (scannerTarget === null) return;
					const { index } = scannerTarget;
					handleManualItemChange(
						index,
						"serialNumbers",
						(items) => (items ? items + "\n" : "") + scannedText,
					);
					setIsScannerOpen(false);
					setScannerTarget(null);
				};

				const availableStock = useMemo(
					() =>
						stock.filter((item) => {
							const isNormallyAvailable =
								item.availability === "Available" && item.imei;
							const isPartOfThisInvoice =
								isEditMode &&
								(invoiceToEdit.stockItemIds || []).includes(item.id);
							const searchableInvoiceItemString = [
								item.phoneModel,
								item.storage,
								item.ram,
								item.color,
								item.imei,
							]
								.filter(Boolean)
								.join(" ");

							const matchesSearch = smartSearch(
								searchableInvoiceItemString,
								searchTerm,
							);

							return (
								(isNormallyAvailable || isPartOfThisInvoice) && matchesSearch
							);
						}),
					[stock, searchTerm, isEditMode, invoiceToEdit],
				);

				const groupedSelectedItems = useMemo(
					() =>
						selectedItems.reduce((acc, item) => {
							const key = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
							if (!acc[key]) {
								acc[key] = {
									details: {
										phoneModel: item.phoneModel,
										storage: item.storage,
										ram: item.ram,
										color: item.color,
									},
									items: [],
									soldPrice: item.soldPrice,
								};
							}
							acc[key].items.push(item);
							return acc;
						}, {}),
					[selectedItems],
				);

				const handleManualItemChange = (index, field, valueOrUpdater) => {
					const newItems = [...manualItems];
					const currentItem = { ...newItems[index] };
					if (typeof valueOrUpdater === "function") {
						currentItem[field] = valueOrUpdater(currentItem[field]);
					} else {
						const value = valueOrUpdater;
						if (field === "soldPrice" || field === "hpp") {
							currentItem[field] = parseFormattedNumber(value);
						} else if (field === "quantity") {
							currentItem.quantity = value;
						} else if (field === "serialNumbers") {
							currentItem.serialNumbers = value;
							const serials = value.split("\n").filter(Boolean);
							currentItem.quantity =
								serials.length > 0
									? serials.length
									: currentItem.quantity || "";
						} else {
							currentItem[field] = value;
						}
					}
					newItems[index] = currentItem;
					setManualItems(newItems);
				};
				const addManualItemRow = () => {
					setManualItems((prev) => [
						...prev,
						{
							key: Date.now(),
							itemName: "",
							soldPrice: 0,
							hpp: 0,
							quantity: "",
							serialNumbers: "",
						},
					]);
				};
				const removeManualItemRow = (index) => {
					setManualItems((prev) => prev.filter((_, i) => i !== index));
				};

				const toggleItemSelection = (item) => {
					setSelectedItems((prev) => {
						const isSelected = prev.some((i) => i.id === item.id);
						if (isSelected) {
							return prev.filter((i) => i.id !== item.id);
						} else {
							const groupKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
							const existingGroupItems = prev.filter(
								(i) =>
									`${i.phoneModel}-${i.storage}-${i.ram}-${i.color}` ===
									groupKey,
							);
							const price =
								existingGroupItems.length > 0
									? existingGroupItems[0].soldPrice
									: 0;
							return [...prev, { ...item, soldPrice: price }];
						}
					});
				};

				const handleDeselectGroup = (groupKey) => {
					setSelectedItems((prev) =>
						prev.filter((item) => {
							const currentKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
							return currentKey !== groupKey;
						}),
					);
				};

				const handleGroupSoldPriceChange = (groupKey, newPrice) => {
					const rawPrice = parseFormattedNumber(newPrice);
					setSelectedItems((prev) =>
						prev.map((item) => {
							const currentKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
							if (currentKey === groupKey) {
								return { ...item, soldPrice: rawPrice };
							}
							return item;
						}),
					);
				};
				const handleDiscountChange = (e) => {
					const displayValue = formatNumberInput(e.target.value);
					const rawValue = parseFormattedNumber(e.target.value);
					setDiscountDisplay(displayValue);
					setDiscount(rawValue);
				};

				const handleAmountPaidChange = (e) => {
					const displayValue = formatNumberInput(e.target.value);
					const rawValue = parseFormattedNumber(e.target.value);
					setAmountPaidDisplay(displayValue);
					setAmountPaid(rawValue);
				};
    
				const handleCustomerNameChange = (newName) => {
					setCustomerName(newName);
                    // Hapus no HP jika nama yang diketik tidak ada di daftar
                    const foundCustomer = customers.find(c => c.customerName === newName);
                    if (!foundCustomer) {
                        setCustomerPhone("");
                    }
				};

                const handleCustomerSelect = (customer) => {
                    setCustomerName(customer.customerName);
                    setCustomerPhone(customer.customerPhone);
                };

				const handlePreview = async () => {
					const data = await buildInvoiceData();
					if (data) {
						setInvoicePreviewData(data);
						setView("preview");
					}
				};
				const handleSaveAndClose = async () => {
					setIsSaving(true);
					try {
						const dataToSave = await buildInvoiceData();
						if (!dataToSave) {
							setIsSaving(false);
							return;
						}

                        // Cek apakah pelanggan ini pelanggan baru sekali pakai
                        const isOneOffCustomer = !customers.some(c => c.customerName.toLowerCase() === dataToSave.customerName.toLowerCase());
                        
						let savedId;
						if (isEditMode) {
							savedId = await confirmAndUpdateInvoice(dataToSave, isOneOffCustomer);
						} else {
							savedId = await confirmAndSaveInvoice(dataToSave, isOneOffCustomer);
						}

						if (savedId) {
							alert(`Invoice berhasil di${isEditMode ? "update" : "simpan"}!`);
							closeModal();
						}
					} catch (error) {
						console.error("Error during save operation:", error);
						alert(
							"An error occurred while saving the invoice. Please check the console.",
						);
					} finally {
						setIsSaving(false);
					}
				};
						const confirmAndSaveInvoice = async (dataToSave, isOneOffCustomer) => {
					if (isEditMode) return confirmAndUpdateInvoice(dataToSave, isOneOffCustomer);
					if (savedInvoiceId) return savedInvoiceId;
					if (!db || !dataToSave) return null;
					try {
						const batch = window.firebase.writeBatch(db);
						const saleDate = window.firebase.Timestamp.fromDate(new Date());
						for (const item of dataToSave.items) {
							if (item.id) {
								const stockDocRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "stock", item.id);
								batch.update(stockDocRef, {
									availability: "SOLD",
									customer: dataToSave.customerName,
									soldPrice: item.soldPrice,
									profit: item.soldPrice - (item.hpp || 0), // Default hpp to 0
									soldDate: saleDate,
								});
							}
						}

                        // Hanya simpan pelanggan tetap jika dicentang dan bukan pelanggan sekali pakai
						if (!isOneOffCustomer && dataToSave.customerName) {
							const customerRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "customers", dataToSave.customerName.toLowerCase().trim());
							batch.set(customerRef, {
								customerName: dataToSave.customerName,
								customerPhone: dataToSave.customerPhone,
								lastUpdated: window.firebase.Timestamp.fromDate(new Date()),
							}, { merge: true });
						}

						const invoicesCollectionRef = window.firebase.collection(db, "artifacts", appId, "users", userId, "invoices");
						const newInvoiceRef = window.firebase.doc(invoicesCollectionRef);
						const stockItemIds = dataToSave.items.filter((item) => item.id).map((item) => item.id);
						
						const sanitizedItems = dataToSave.items.map((item) => {
                            if (item.id) {
                                const { id, phoneModel = "", storage = "", ram = "", color = "", imei = "", soldPrice = 0, hpp = 0, price = 0, discount = 0, additionalCost = 0 } = item;
                                return { id, phoneModel, storage, ram, color, imei, soldPrice, hpp, price, discount, additionalCost, quantity: 1 };
                            } else {
                                const { itemName, soldPrice, hpp, quantity, serialNumbers } = item;
                                return { itemName: itemName || "Manual Item", soldPrice: soldPrice || 0, quantity: quantity || 1, serialNumbers: serialNumbers || [], hpp: hpp || 0 };
                            }
						});

						const finalInvoiceData = { ...dataToSave, id: newInvoiceRef.id, stockItemIds, items: sanitizedItems };
						batch.set(newInvoiceRef, finalInvoiceData);
						await batch.commit();
						await addLog(userId, {
							message: `Created invoice ${finalInvoiceData.invoiceNumber} for ${finalInvoiceData.customerName}`,
							type: "CREATE_INVOICE",
							context: { docId: newInvoiceRef.id, invoiceData: finalInvoiceData },
						});
						setSavedInvoiceId(newInvoiceRef.id);
						return newInvoiceRef.id;
					} catch (error) {
						console.error("Error creating invoice: ", error);
						alert("Gagal menyimpan invoice.");
						return null;
					}
				};
				const confirmAndUpdateInvoice = async (dataToUpdate, isOneOffCustomer) => {
					const originalInvoice = originalInvoiceRef.current;
					if (!originalInvoice || !userId || !db) return null;
					try {
						const batch = window.firebase.writeBatch(db);
						const invoiceDocRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "invoices", originalInvoice.id);
						const originalStockIds = new Set(originalInvoice.stockItemIds || []);
						const updatedStockItems = dataToUpdate.items.filter((i) => i.id);
						const updatedStockIds = new Set(updatedStockItems.map((i) => i.id));
						const idsToRelease = [...originalStockIds].filter((id) => !updatedStockIds.has(id));

						idsToRelease.forEach((stockId) => {
							const stockDocRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "stock", stockId);
							batch.update(stockDocRef, { availability: "Available", customer: "", soldPrice: null, profit: null, soldDate: null });
						});

						updatedStockItems.forEach((item) => {
							const stockDocRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "stock", item.id);
							batch.update(stockDocRef, {
								availability: "SOLD",
								customer: dataToUpdate.customerName,
								soldPrice: item.soldPrice,
								profit: item.soldPrice - (item.hpp || 0), // Default hpp to 0
								soldDate: dataToUpdate.date,
							});
						});

						if (!isOneOffCustomer && dataToUpdate.customerName) {
							const customerRef = window.firebase.doc(db, "artifacts", appId, "users", userId, "customers", dataToUpdate.customerName.toLowerCase().trim());
							batch.set(customerRef, {
								customerName: dataToUpdate.customerName,
								customerPhone: dataToUpdate.customerPhone,
								lastUpdated: window.firebase.Timestamp.fromDate(new Date()),
							}, { merge: true });
						}

						const sanitizedItems = dataToUpdate.items.map((item) => {
							if (item.id) {
								const { id, phoneModel, storage, ram, color, imei, soldPrice, hpp } = item;
								return { id, phoneModel, storage, ram, color, imei, soldPrice, hpp: hpp || 0, quantity: 1 };
							} else {
								const { itemName, soldPrice, hpp, quantity, serialNumbers } = item;
								return { itemName, soldPrice, quantity, serialNumbers: serialNumbers || [], hpp: hpp || 0 };
							}
						});

						const finalInvoiceData = { ...dataToUpdate, stockItemIds: [...updatedStockIds], items: sanitizedItems };
						delete finalInvoiceData.id;
						batch.update(invoiceDocRef, finalInvoiceData);
						await batch.commit();
						
                        // ... (logika logging tetap sama) ...
                        
						return originalInvoice.id;
					} catch (error) {
						console.error("Error updating invoice:", error);
						alert("Failed to update invoice.");
						return null;
					}
				};

				const handleActionAndClose = async (format) => {
					if ( isGenerating || (format && !previewRef.current && format !== "whatsapp_bill") ) return;
					setIsGenerating(true);
                    
                    const data = await buildInvoiceData();
                    if (!data) {
                        setIsGenerating(false);
                        return;
                    }
                    
                    const isOneOffCustomer = !customers.some(c => c.customerName.toLowerCase() === data.customerName.toLowerCase());

					const invoiceId = isEditMode ? await confirmAndUpdateInvoice(data, isOneOffCustomer) : await confirmAndSaveInvoice(data, isOneOffCustomer);

					if (invoiceId) {
                        // Set preview data for generation AFTER saving
                        setInvoicePreviewData(data);
                        // Delay slightly to ensure state update before canvas generation
                        await new Promise(resolve => setTimeout(resolve, 100));

						if (format === "pdf") {
							const canvas = await generateInvoiceCanvas(data);
							const { jsPDF } = window.jspdf;
							const pdf = new jsPDF("p", "mm", "a4");
							const pdfWidth = pdf.internal.pageSize.getWidth();
							const pdfHeight = pdf.internal.pageSize.getHeight();
							pdf.addImage(canvas.toDataURL("image/jpeg", 0.95), "JPEG", 0, 0, pdfWidth, pdfHeight, undefined, "MEDIUM");
							pdf.save(`Invoice-${data.invoiceNumber.replace(/\//g, "-")}.pdf`);
						} else if (format === "jpg") {
							const canvas = await generateInvoiceCanvas(data);
							const link = document.createElement("a");
							link.href = canvas.toDataURL("image/jpeg", 0.95);
							link.download = `Invoice-${data.invoiceNumber.replace(/\//g, "-")}.jpg`;
							link.click();
						} else if (format === "whatsapp_bill") {
							const message = generateBillMessage(data);
							let cleanPhone = data.customerPhone.replace(/\D/g, "");
							if (cleanPhone.startsWith("0")) { cleanPhone = "62" + cleanPhone.substring(1); }
                            else if (!cleanPhone.startsWith("62")) { cleanPhone = "62" + cleanPhone; }
							const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
							window.open(url, "_blank");
						}
						alert(`Invoice berhasil di${isEditMode ? "update" : "simpan"}!`);
						closeModal();
					}
					setIsGenerating(false);
				};
				useEffect(() => {
					if (view === "preview" && previewRef.current) {
						const container = previewRef.current.parentElement;
						const a4Element = previewRef.current.querySelector(".preview-a4");
						const updateScale = () => {
							if (container && a4Element) {
								a4Element.style.setProperty(
									"--preview-scale",
									container.offsetWidth / a4Element.offsetWidth,
								);
							}
						};
						updateScale();
						window.addEventListener("resize", updateScale);
						return () => window.removeEventListener("resize", updateScale);
					}
				}, [view, invoicePreviewData]);

				const dropdownStyle = {
					backgroundImage: `url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e")`,
					backgroundPosition: "right 0.5rem center",
					backgroundSize: "1.5em 1.5em",
					backgroundRepeat: "no-repeat",
				};
				const selectClasses =
					"w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 appearance-none pr-8";

				if (view === "preview") {
                    return (
						<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
							<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-full flex flex-col text-sm">
								<div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-2">
									<h3 className="text-xl sm:text-2xl font-bold"> Invoice Preview </h3>
									<div className="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto">
										<button onClick={() => { setView("form"); setSavedInvoiceId(null); }} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition text-xs sm:text-sm" disabled={isGenerating}> Back to Edit </button>
										<button onClick={() => handleActionAndClose("whatsapp_bill")} className="px-4 py-2 rounded-md bg-teal-600 hover:bg-teal-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}> {isGenerating ? "Sending..." : "Kirim Tagihan & Close"} </button>
										<button onClick={() => handleActionAndClose("pdf")} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}> {isGenerating ? "Generating..." : "Generate PDF & Close"} </button>
										<button onClick={() => handleActionAndClose("jpg")} className="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}> {isGenerating ? "Generating..." : "Generate JPG & Close"} </button>
									</div>
								</div>
								<div className="flex-grow overflow-y-auto p-2 sm:p-6 flex justify-center bg-gray-200 dark:bg-gray-900">
									<div className="preview-container" ref={previewRef}>
										<InvoiceTemplate invoiceData={invoicePreviewData} />
									</div>
								</div>
							</div>
						</div>
					);
				}

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
                        {isAddCustomerModalOpen && (
                            <AddCustomerModal 
                                userId={userId}
                                onClose={() => setIsAddCustomerModalOpen(false)}
                                onSave={handleSaveNewCustomer}
                            />
                        )}
						{isScannerOpen && (
							<BarcodeScanner
								onScanSuccess={handleScanSuccess}
								onClose={() => setIsScannerOpen(false)}
							/>
						)}
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-full flex flex-col">
							<h3 className="text-2xl font-bold p-6 border-b border-gray-200 dark:border-gray-700">
								{isEditMode ? "Edit Invoice" : "Create Sales Invoice"}
							</h3>
							<div className="flex-grow overflow-y-auto p-6">
								<div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <CustomerCombobox
                                        customers={customers}
                                        value={customerName}
                                        onChange={handleCustomerNameChange}
                                        onSelect={handleCustomerSelect}
                                        onDelete={handleDeleteCustomer}
                                        onAddNew={() => setIsAddCustomerModalOpen(true)}
                                    />
									<input
										type="text"
										placeholder="Customer Phone"
										value={customerPhone}
										onChange={(e) => setCustomerPhone(e.target.value)}
										required
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
								<div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
									<select
										value={paymentTerms}
										onChange={(e) => setPaymentTerms(e.target.value)}
										required
										className={selectClasses}
										style={dropdownStyle}
									>
										<option value="COD">COD</option>
										<option value="Tempo">Tempo</option>
									</select>

									<select
										value={paymentStatus}
										onChange={(e) => setPaymentStatus(e.target.value)}
										className={selectClasses}
										style={dropdownStyle}
									>
										<option value="Lunas">Lunas</option>
										<option value="Belum Lunas">Belum Lunas</option>
									</select>
									<input
										type="text"
										inputMode="numeric"
										placeholder="Discount (IDR)"
										value={discountDisplay}
										onChange={handleDiscountChange}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
									<input
										type="text"
										inputMode="numeric"
										placeholder="Amount Paid (IDR)"
										value={amountPaidDisplay}
										onChange={handleAmountPaidChange}
										disabled={paymentStatus === "Lunas"}
										className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${paymentStatus === "Lunas" ? "opacity-70 cursor-not-allowed" : ""}`}
									/>
								</div>

								<div className="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
									<h4 className="text-lg font-semibold mb-2">Biaya Tambahan</h4>
									<div className="space-y-3">
										{otherCostsList.map((cost, index) => (
											<div key={cost.key} className="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                                <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
													<select value={cost.inputType} onChange={(e) => handleOtherCostChange(index, "inputType", e.target.value)} className={`${selectClasses} md:col-span-2`} style={dropdownStyle}>
														<option value="dropdown">List</option>
														<option value="manual">Manual</option>
													</select>
													<div className="md:col-span-4">{cost.inputType === "dropdown" ? ( <select value={cost.description} onChange={(e) => handleOtherCostChange(index, "description", e.target.value)} className={`${selectClasses}`} style={dropdownStyle}> {PREDEFINED_COSTS.map((c) => (<option key={c} value={c}> {c} </option>))} </select> ) : ( <input type="text" placeholder="Jenis Biaya" value={cost.description} onChange={(e) => handleOtherCostChange(index, "description", e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-300 dark:border-gray-600" /> )}</div>
													<div className="md:col-span-3"><input type="text" inputMode="numeric" placeholder="Pembeli" value={cost.buyerAmountDisplay} onChange={(e) => handleOtherCostChange(index, "buyerAmount", e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-300 dark:border-gray-600"/></div>
													<div className="md:col-span-3 flex items-end gap-2"><div className="flex-grow"><input type="text" inputMode="numeric" placeholder="Penjual" value={cost.sellerAmountDisplay} onChange={(e) => handleOtherCostChange(index, "sellerAmount", e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 rounded-md border border-gray-300 dark:border-gray-600" /></div>{otherCostsList.length > 1 && (<button type="button" onClick={() => removeOtherCostRow(index)} className="flex-shrink-0 p-2 text-red-500 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clipRule="evenodd" /></svg></button>)}</div>
												</div>
											</div>
										))}
										<button type="button" onClick={addOtherCostRow} className="w-full mt-3 p-2 flex items-center justify-center gap-2 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-semibold rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800/70 transition"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd"/></svg>Tambah Komponen Biaya</button>
									</div>
								</div>

								<h4 className="text-lg font-semibold mb-2 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4"> Select Items from Stock </h4>
								<input type="text" placeholder="Search available stock by model, IMEI, storage, color..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 mb-4"/>
								<div className="overflow-y-auto border border-gray-300 dark:border-gray-700 rounded-lg p-2 mb-4 h-48">{availableStock.length > 0 ? ( availableStock.map((item) => ( <div key={item.id} className={`p-3 rounded-lg mb-2 flex justify-between items-center cursor-pointer transition ${selectedItems.find((i) => i.id === item.id) ? "bg-green-100 dark:bg-green-800" : "bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600"}`} onClick={() => toggleItemSelection(item)}> <div> <p className="font-bold"> {[ item.phoneModel, item.storage, item.ram, item.color, ].filter(Boolean).join(" ")} </p> <p className="text-sm text-gray-500 dark:text-gray-400"> IMEI: {item.imei} | HPP:{" "} {formatRupiahDisplay(item.hpp)} </p> </div> <div className="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300" style={{ borderColor: selectedItems.find( (i) => i.id === item.id, ) ? "#10B981" : "#9CA3AF", }}> {selectedItems.find((i) => i.id === item.id) && ( <div className="w-3 h-3 bg-green-500 rounded-full"></div> )} </div> </div> )) ) : ( <p className="text-gray-500 dark:text-gray-400 text-center py-4"> No items available in stock. </p> )} </div>

								<h4 className="text-lg font-semibold mb-2 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4"> Manual Items </h4>
								<div className="max-h-48 overflow-y-auto pr-2">{manualItems.map((item, index) => ( <div key={item.key} className="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-3 mt-3 first:mt-0 first:border-t-0 first:pt-0"> <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-stretch"> <input type="text" placeholder="Item Name (e.g., Service, Aksesoris)" value={item.itemName} onChange={(e) => handleManualItemChange( index, "itemName", e.target.value, )} className="md:col-span-4 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /> <input type="text" inputMode="numeric" placeholder="Price (IDR)" value={formatNumberInput(item.soldPrice)} onChange={(e) => handleManualItemChange( index, "soldPrice", e.target.value, )} className="md:col-span-2 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /> <input type="text" inputMode="numeric" placeholder="HPP (IDR)" value={formatNumberInput(item.hpp)} onChange={(e) => handleManualItemChange(index, "hpp", e.target.value) } className="md:col-span-2 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /> <input type="number" placeholder="Qty" value={item.quantity} onChange={(e) => handleManualItemChange( index, "quantity", e.target.value, )} className="md:col-span-2 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /> <button type="button" onClick={() => removeManualItemRow(index)} className="md:col-span-2 w-full p-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition" > Remove </button> </div> <div className="relative"> <textarea placeholder="Serial Numbers / IMEIs (1 per line, auto-updates Qty)" value={item.serialNumbers} onChange={(e) => handleManualItemChange( index, "serialNumbers", e.target.value, )} rows="3" className="w-full p-3 pr-12 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 text-sm" /> <button type="button" onClick={() => { setScannerTarget({ index }); setIsScannerOpen(true); }} className="absolute bottom-2 right-2 p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition" > <CameraIcon /> </button> </div> </div> ))} </div>
								<button type="button" onClick={addManualItemRow} className="w-full mt-2 p-2 flex items-center justify-center gap-2 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-semibold rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800/70 transition"> <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clipRule="evenodd" /></svg> Add Manual Item </button>

								{selectedItems.length > 0 && ( <div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700"> <h4 className="text-lg font-semibold mb-2"> Selected Stock Items </h4> <div className="overflow-y-auto max-h-48 pr-2 space-y-2"> {Object.entries(groupedSelectedItems).map( ([key, group]) => { const isExpanded = expandedGroups.has(key); return ( <div key={key} className="bg-slate-200 dark:bg-slate-700/50 p-3 rounded-lg relative"> <button type="button" onClick={(e) => { e.stopPropagation(); handleDeselectGroup(key); }} className="absolute top-2 right-2 z-10 p-1.5 text-red-500 rounded-full hover:bg-red-500/10 transition" title={`Deselect all ${group.details.phoneModel}`} > <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /> </svg> </button> <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-2 md:gap-4"> <div className="flex-grow cursor-pointer pr-8" onClick={() => toggleGroupExpansion(key)} > <p className="font-bold text-slate-800 dark:text-slate-100"> {[ group.details.phoneModel, group.details.storage, group.details.ram, group.details.color, ].filter(Boolean).join(" ")} </p> <p className="hidden md:block text-sm text-slate-600 dark:text-slate-400 mt-1"> Qty:{" "} <span className="font-semibold text-slate-800 dark:text-slate-200"> {group.items.length} </span> </p> </div> <div className="w-full md:w-auto flex items-center justify-between md:justify-end md:pr-8 gap-2"> <p className="md:hidden text-sm text-slate-600 dark:text-slate-400"> Qty:{" "} <span className="font-semibold text-base text-slate-800 dark:text-slate-200"> {group.items.length} </span> </p> <input type="text" inputMode="numeric" value={ formatNumberInput(group.soldPrice) || "" } onChange={(e) => handleGroupSoldPriceChange( key, e.target.value, ) } onClick={(e) => e.stopPropagation()} className="w-1/2 max-w-[160px] md:w-28 p-2 bg-white dark:bg-slate-800 rounded-md border border-slate-300 dark:border-slate-600 focus:ring-2 focus:ring-blue-500 text-sm text-left" placeholder="Harga Jual" /> </div> </div> {isExpanded && ( <div className="mt-3 pt-3 border-t border-slate-300 dark:border-slate-600 space-y-1"> {group.items.map((item) => ( <div key={item.id} className="flex items-center gap-2 pl-4 pr-8"> <span className="font-mono text-slate-500 dark:text-slate-400 text-s"> {item.imei} </span> <button type="button" onClick={(e) => { e.stopPropagation(); toggleItemSelection(item); }} className="p-1 text-red-500 rounded-full hover:bg-red-500/10 transition" title="Deselect this item" > <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"> <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /> </svg> </button> </div> ))} </div> )} </div> ); }, )} </div> </div> )}

								<div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
									<h4 className="text-lg font-semibold mb-2">Invoice Notes</h4>
									<textarea placeholder="Enter custom notes for this invoice..." value={invoiceNotes} onChange={(e) => setInvoiceNotes(e.target.value)} rows="5" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>
								</div>
							</div>
							<div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
								<button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button>
								<button onClick={handleSaveAndClose} className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:bg-blue-800 disabled:cursor-not-allowed" disabled={ isSaving || (selectedItems.length === 0 && manualItems.filter( (i) => i.itemName.trim() && i.soldPrice > 0, ).length === 0) }> {isSaving ? "Saving..." : "Save"} </button>
								<button onClick={handlePreview} className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition" disabled={ selectedItems.length === 0 && manualItems.filter( (i) => i.itemName.trim() && i.soldPrice > 0, ).length === 0 }> Preview Invoice </button>
							</div>
						</div>
					</div>
				);
			}

						function InvoiceListPage({ userId, onEdit }) {
	const [invoices, setInvoices] = useState([]);
	const [stock, setStock] = useState([]);
	const [loading, setLoading] = useState(true);
	const [itemToDelete, setItemToDelete] = useState(null);
	const [previewingInvoice, setPreviewingInvoice] = useState(null);
	const [isManualInvoiceModalOpen, setIsManualInvoiceModalOpen] =
		useState(false);
	const [isSharing, setIsSharing] = useState(null);
	const [activeFilter, setActiveFilter] = useState("this_month");
	const [customDateRange, setCustomDateRange] = useState({
		start: null,
		end: null,
	});
	const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
	const datePickerButtonRef = useRef(null);
	const [searchTerm, setSearchTerm] = useState("");

	const [profitTooltip, setProfitTooltip] = useState(null);
	const [operationalCostTooltip, setOperationalCostTooltip] =
		useState(null);
	const tooltipRef = useRef(null);

	useEffect(() => {
		const handleClickOutside = (event) => {
			if (
				tooltipRef.current &&
				!tooltipRef.current.contains(event.target)
			) {
				setProfitTooltip(null);
				setOperationalCostTooltip(null);
			}
		};
		document.addEventListener("mousedown", handleClickOutside);
		return () =>
			document.removeEventListener("mousedown", handleClickOutside);
	}, []);

	useEffect(() => {
		if (!userId || !db) return;

		const invoicesCollectionRef = window.firebase.collection(
			db,
			"artifacts",
			appId,
			"users",
			userId,
			"invoices",
		);
		const qInvoices = window.firebase.query(
			invoicesCollectionRef,
			window.firebase.orderBy("date", "desc"),
		);
		const unsubscribeInvoices = window.firebase.onSnapshot(
			qInvoices,
			(snapshot) => {
				const invoicesData = snapshot.docs.map((doc) => ({
					id: doc.id,
					...doc.data(),
				}));
				setInvoices(invoicesData);
			},
			(error) => console.error("Error fetching invoices:", error),
		);

		const stockCollectionRef = window.firebase.collection(
			db,
			"artifacts",
			appId,
			"users",
			userId,
			"stock",
		);
		const unsubscribeStock = window.firebase.onSnapshot(
			stockCollectionRef,
			(snapshot) => {
				const stockData = snapshot.docs.map((doc) => ({
					id: doc.id,
					...doc.data(),
				}));
				setStock(stockData);
			},
			(error) => console.error("Error fetching stock:", error),
		);

		setLoading(false);

		return () => {
			unsubscribeInvoices();
			unsubscribeStock();
		};
	}, [userId]);

	const filteredInvoices = useMemo(() => {
		let dateFilteredInvoices;
		let start, end;
		const now = new Date();

		if (activeFilter === "all") {
			dateFilteredInvoices = invoices;
		} else {
			if (activeFilter === "this_month") {
				start = new Date(now.getFullYear(), now.getMonth(), 1);
				end = new Date(
					now.getFullYear(),
					now.getMonth() + 1,
					0,
					23,
					59,
					59,
					999,
				);
			} else if (activeFilter === "this_week") {
				const currentDay = now.getDay();
				const daysToSubtract = currentDay === 0 ? 6 : currentDay - 1;
				start = new Date(
					now.getFullYear(),
					now.getMonth(),
					now.getDate() - daysToSubtract,
				);
				start.setHours(0, 0, 0, 0);
				end = new Date(
					start.getFullYear(),
					start.getMonth(),
					start.getDate() + 6,
				);
				end.setHours(23, 59, 59, 999);
			} else if (activeFilter === "last_month") {
				start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
				end = new Date(
					now.getFullYear(),
					now.getMonth(),
					0,
					23,
					59,
					59,
					999,
				);
			} else if (
				activeFilter === "custom" &&
				customDateRange.start &&
				customDateRange.end
			) {
				start = new Date(customDateRange.start);
				start.setHours(0, 0, 0, 0);
				end = new Date(customDateRange.end);
				end.setHours(23, 59, 59, 999);
			}

			dateFilteredInvoices = invoices.filter((invoice) => {
				if (!invoice.date || !invoice.date.toDate) return false;
				const invoiceDate = invoice.date.toDate();
				return invoiceDate >= start && invoiceDate <= end;
			});
		}

		if (!searchTerm.trim()) {
			return dateFilteredInvoices;
		}

		const lowercasedTerm = searchTerm.toLowerCase();

		return dateFilteredInvoices.filter((invoice) => {
			const invoiceNumberMatch = invoice.invoiceNumber
				?.toLowerCase()
				.includes(lowercasedTerm);
			const customerNameMatch = invoice.customerName
				?.toLowerCase()
				.includes(lowercasedTerm);
			const itemsMatch = (invoice.items || []).some(
				(item) =>
					(item.phoneModel?.toLowerCase() || "").includes(
						lowercasedTerm,
					) ||
					(item.itemName?.toLowerCase() || "").includes(lowercasedTerm),
			);
			return invoiceNumberMatch || customerNameMatch || itemsMatch;
		});
	}, [invoices, activeFilter, customDateRange, searchTerm]);

	const summaryStats = useMemo(() => {
		const filteredStockItemIds = new Set(
			filteredInvoices.flatMap((inv) => inv.stockItemIds || []),
		);

		const buyingCosts = stock.reduce((sum, item) => {
			if (filteredStockItemIds.has(item.id)) {
				return sum + (item.additionalCost || 0);
			}
			return sum;
		}, 0);

		const invoiceStats = filteredInvoices.reduce(
			(acc, invoice) => {
				const total = invoice.total || 0;
				acc.salesTotal += total;

				if (invoice.paymentStatus === "Belum Lunas") {
					const amountPaid = invoice.amountPaid || 0;
					acc.unpaidTotal += total - amountPaid;
				}

				if (
					invoice.otherCostsList &&
					Array.isArray(invoice.otherCostsList)
				) {
					const sellerCostsOnInvoice = invoice.otherCostsList.reduce(
						(costSum, cost) => costSum + (cost.sellerAmount || 0),
						0,
					);
					acc.sellingCosts += sellerCostsOnInvoice;
				}
				
				return acc;
			},
			{ salesTotal: 0, unpaidTotal: 0, sellingCosts: 0 },
		);
		
		const totalOperationalCosts = invoiceStats.sellingCosts + buyingCosts;

		return {
			...invoiceStats,
			buyingCosts,
			totalOperationalCosts,
		};
	}, [filteredInvoices, stock]);

	const calculateInvoiceProfit = (invoice) => {
		const { subTotal, totalHpp } = (invoice.items || []).reduce(
			(acc, item) => {
				const quantity = item.quantity || 1;
				acc.subTotal += (item.soldPrice || 0) * quantity;
				acc.totalHpp += (item.hpp || 0) * quantity;
				return acc;
			},
			{ subTotal: 0, totalHpp: 0 },
		);
		const invoiceDiscount = invoice.discount || 0;

		let costsBorneBySeller = 0;
		if (invoice.otherCostsList && Array.isArray(invoice.otherCostsList)) {
			costsBorneBySeller = invoice.otherCostsList.reduce((acc, cost) => {
				return acc + (cost.sellerAmount || 0);
			}, 0);
		}

		return subTotal - invoiceDiscount - totalHpp - costsBorneBySeller;
	};

	const handleApplyCustomRange = (range) => {
		setActiveFilter("custom");
		setCustomDateRange(range);
		setIsDatePickerOpen(false);
	};

	const formatDisplayDateRange = () => {
		if (
			activeFilter !== "custom" ||
			!customDateRange.start ||
			!customDateRange.end
		)
			return "Custom Range";
		const options = { month: "short", day: "numeric" };
		const start = new Date(customDateRange.start).toLocaleDateString(
			"en-US",
			options,
		);
		const end = new Date(customDateRange.end).toLocaleDateString(
			"en-US",
			options,
		);
		return `${start} - ${end}`;
	};

	const handleClearFilters = () => {
		setActiveFilter("all");
		setCustomDateRange({ start: null, end: null });
		setSearchTerm("");
	};

	const handleDeleteInvoice = async () => {
		if (!itemToDelete || !userId) return;
		try {
			const batch = window.firebase.writeBatch(db);
			if (
				itemToDelete.stockItemIds &&
				Array.isArray(itemToDelete.stockItemIds)
			) {
				for (const stockId of itemToDelete.stockItemIds) {
					const stockDocRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"stock",
						stockId,
					);
					batch.update(stockDocRef, {
						availability: "Available",
						customer: "",
						soldPrice: null,
						profit: null,
						soldDate: null,
					});
				}
			}
			const invoiceDocRef = window.firebase.doc(
				db,
				"artifacts",
				appId,
				"users",
				userId,
				"invoices",
				itemToDelete.id,
			);
			batch.delete(invoiceDocRef);
			await batch.commit();
			await addLog(userId, {
				message: `Deleted invoice ${itemToDelete.invoiceNumber}`,
				type: "DELETE_INVOICE",
				context: { docId: itemToDelete.id, deletedData: itemToDelete },
			});
			setItemToDelete(null);
		} catch (error) {
			console.error("Error deleting invoice and updating stock:", error);
			alert("Error deleting invoice.");
		}
	};

	const handleSendBill = (invoice) => {
		if (!invoice.customerPhone) {
			alert("Customer phone number is not available for this invoice.");
			return;
		}
		const message = generateBillMessage(invoice);
		let cleanPhone = invoice.customerPhone.replace(/\D/g, "");
		if (cleanPhone.startsWith("0")) {
			cleanPhone = "62" + cleanPhone.substring(1);
		} else if (!cleanPhone.startsWith("62")) {
			cleanPhone = "62" + cleanPhone;
		}
		const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
		window.open(url, "_blank");
	};

	const handleShareToWhatsApp = async (invoice) => {
		if (!invoice.customerPhone) {
			alert("Nomor telepon pelanggan tidak tersedia untuk invoice ini.");
			return;
		}
		setIsSharing(invoice.id);
		try {
			// --- PERUBAHAN UTAMA: LOGIKA CAPTION DINAMIS ---
			let captionText;
			const paymentStatus = invoice.paymentStatus || "Lunas"; // Default ke Lunas jika tidak ada status

			if (paymentStatus.toUpperCase() === 'LUNAS') {
				captionText = "Berikut adalah invoice anda, terimakasih telah berbelanja di Griphub Ponsel";
			} else {
				// Anda bisa menyesuaikan pesan ini jika statusnya bukan Lunas
				captionText = `Halo ${invoice.customerName},
Berikut adalah tagihan Anda.

Silakan lakukan pembayaran ke:
BCA 5271489375
a.n. Aldrey Eka Putra

Terima kasih!`;
			}
			// --- AKHIR PERUBAHAN ---

			const canvas = await generateInvoiceCanvas(invoice);
			const blob = await new Promise((resolve) =>
				canvas.toBlob(resolve, "image/jpeg", 0.95),
			);
			const file = new File(
				[blob],
				`Invoice-${invoice.invoiceNumber}.jpg`,
				{ type: "image/jpeg" },
			);
			const shareData = {
				files: [file],
				title: `Invoice ${invoice.invoiceNumber}`,
				text: captionText,
			};

			// Coba menggunakan Web Share API (prioritas utama)
			if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
				try {
					await navigator.share(shareData);
					// Penting: Caption mungkin tidak muncul di Android karena batasan sistem.
					// Ini adalah perilaku yang diharapkan, bukan bug pada kode ini.
					return; 
				} catch (err) {
					// Abaikan jika pengguna membatalkan dialog share
					if (err.name === "AbortError") {
						console.log("Web Share dibatalkan oleh pengguna.");
						return;
					}
					console.error("Web Share API gagal:", err);
				}
			}

			// Fallback: Salin gambar ke clipboard dan buka WhatsApp
			// Ini akan dijalankan jika Web Share API tidak ada atau gagal
			if (navigator.clipboard && navigator.clipboard.write) {
				try {
					const clipboardItem = new ClipboardItem({ "image/jpeg": blob });
					await navigator.clipboard.write([clipboardItem]);
					alert("Gambar invoice berhasil disalin! Silakan PASTE di chat WhatsApp.");
				} catch (err) {
					console.error("Gagal menyalin ke clipboard:", err);
					alert("Gagal menyalin gambar. Silakan unduh dan kirim manual.");
				}
			} else {
				alert("Browser Anda tidak mendukung penyalinan otomatis. Silakan unduh dan kirim manual.");
			}

			// Buka chat WhatsApp dengan caption yang sudah diisi
			let cleanPhone = invoice.customerPhone.replace(/\D/g, "");
			if (cleanPhone.startsWith("0")) {
				cleanPhone = "62" + cleanPhone.substring(1);
			} else if (!cleanPhone.startsWith("62")) {
				cleanPhone = "62" + cleanPhone;
			}
			const billMessage = generateBillMessage(invoice);
			const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(billMessage)}`;
			window.open(url, "_blank");

		} catch (error) {
			console.error("Gagal membuat atau membagikan gambar invoice:", error);
			alert("Terjadi kesalahan saat menyiapkan invoice untuk dibagikan.");
		} finally {
			setIsSharing(null);
		}
	};

	const getButtonClass = (filterName) =>
		`px-3 py-1.5 text-sm font-semibold rounded-md transition ${activeFilter === filterName ? "bg-white dark:bg-gray-900 shadow-md text-blue-600 dark:text-blue-400" : "text-gray-600 dark:text-gray-300 hover:bg-gray-300/50 dark:hover:bg-gray-600/50"}`;

			// --- GANTI SELURUH FUNGSI INI DENGAN VERSI BARU ---
function ProfitTooltip({ invoice, triggerElement, onClose, stockData }) {
    const [style, setStyle] = useState({ 
        opacity: 0, 
        position: 'absolute', 
        // Posisikan di luar layar pada awalnya untuk mencegah kedipan
        top: '-9999px', 
        left: '-9999px' 
    });
    const tooltipRef = useRef(null);

    // Efek untuk menutup tooltip saat klik di luar (tidak ada perubahan di sini)
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (tooltipRef.current && !tooltipRef.current.contains(event.target)) {
                onClose();
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => {
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [onClose]);

    // --- PERBAIKAN UTAMA ADA DI SINI ---
    // Gunakan useLayoutEffect untuk memastikan pengukuran terjadi setelah DOM di-update
    useLayoutEffect(() => {
        // Jangan lakukan apa-apa jika elemen pemicu atau referensi tooltip belum siap
        if (!triggerElement || !tooltipRef.current) return;

        // 1. Dapatkan ukuran dan posisi elemen pemicu (ikon info)
        const triggerRect = triggerElement.getBoundingClientRect();
        // 2. Dapatkan ukuran dari tooltip itu sendiri (yang saat ini tidak terlihat)
        const tooltipRect = tooltipRef.current.getBoundingClientRect();
        
        const viewportWidth = window.innerWidth;
        const margin = 8; // Jarak dari tepi layar

        // 3. Hitung posisi ideal
        let top = triggerRect.top + window.scrollY - tooltipRect.height - margin;
        let left = triggerRect.left + window.scrollX + (triggerRect.width / 2);
        let transform = 'translateX(-50%)'; // Default: tengah di atas pemicu

        // Cek apakah tooltip akan keluar dari layar di sisi kanan
        if ((left + tooltipRect.width / 2) > viewportWidth - margin) {
            left = triggerRect.right + window.scrollX - margin;
            transform = 'translateX(-100%)'; // Rata kanan dengan pemicu
        }

        // Cek apakah tooltip akan keluar dari layar di sisi kiri
        if ((left - tooltipRect.width / 2) < margin) {
            left = triggerRect.left + window.scrollX + margin;
            transform = 'translateX(0%)'; // Rata kiri dengan pemicu
        }

        // Cek apakah tooltip akan keluar dari layar di sisi atas
        if (top - window.scrollY < margin) {
            top = triggerRect.bottom + window.scrollY + margin; // Pindahkan ke bawah pemicu
        }
        
        // 4. Terapkan posisi yang sudah benar DAN buat tooltip terlihat
        setStyle({
            opacity: 1,
            position: 'absolute',
            top: `${top}px`,
            left: `${left}px`,
            transform: transform,
            transition: 'opacity 0.15s ease-in-out',
        });
        
    // Jalankan efek ini setiap kali tooltip yang berbeda ditampilkan atau kontennya berubah
    }, [triggerElement, invoice]); 

    // Kalkulasi profit (tidak ada perubahan di sini)
    const calculation = (invoice.items || []).reduce(
        (acc, item) => {
            const quantity = item.quantity || 1;
            let itemBasePrice = 0;
            let itemBuyingCost = 0;
            if (item.id) {
                const stockItem = stockData.find((s) => s.id === item.id);
                if (stockItem) {
                    itemBuyingCost = stockItem.additionalCost || 0;
                    itemBasePrice = (stockItem.hpp || 0) - itemBuyingCost;
                } else {
                    itemBasePrice = item.hpp || 0;
                }
            } else {
                itemBasePrice = item.hpp || 0;
            }
            acc.totalBasePrice += itemBasePrice * quantity;
            acc.totalBuyingCost += itemBuyingCost * quantity;
            acc.subTotal += (item.soldPrice || 0) * quantity;
            return acc;
        },
        { totalBasePrice: 0, totalBuyingCost: 0, subTotal: 0 }
    );
    const invoiceDiscount = invoice.discount || 0;
    const sellingCost = (invoice.otherCostsList || []).reduce((acc, cost) => acc + (cost.sellerAmount || 0), 0);
    const sellingPrice = calculation.subTotal - invoiceDiscount;
    const profit = sellingPrice - sellingCost - calculation.totalBasePrice - calculation.totalBuyingCost;

    return (
        <div
            ref={tooltipRef} 
            style={style}
            className="z-[1000] w-72 bg-gray-900 dark:bg-black text-white rounded-lg shadow-2xl p-4 text-sm border border-gray-700"
        >
            <h4 className="font-bold mb-3 border-b border-gray-600 pb-2">
                Rincian Kalkulasi Profit
            </h4>
            <div className="space-y-1.5">
                <div className="flex justify-between">
                    <span className="text-gray-300">Harga Jual (Net)</span>
                    <span>{formatRupiahDisplay(sellingPrice)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-400">Biaya Jual (-)</span>
                    <span>{formatRupiahDisplay(sellingCost)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-400">Harga Pokok Beli (-)</span>
                    <span>{formatRupiahDisplay(calculation.totalBasePrice)}</span>
                </div>
                <div className="flex justify-between">
                    <span className="text-gray-400">Biaya Beli (-)</span>
                    <span>{formatRupiahDisplay(calculation.totalBuyingCost)}</span>
                </div>
                <hr className="border-gray-700 !my-2" />
                <div className="flex justify-between font-bold text-base pt-1">
                    <span>Profit Bersih</span>
                    <span className={profit >= 0 ? "text-green-400" : "text-red-400"}>
                        {formatRupiahDisplay(profit)}
                    </span>
                </div>
            </div>
            <button
                onClick={onClose}
                className="absolute top-1 right-1 text-gray-400 hover:text-white"
            >
                &times;
            </button>
        </div>
    );
};

	const OperationalCostTooltip = ({ stats, position, onClose }) => {
		const style = {
			top: `${position.top}px`,
			left: `${position.left}px`,
			position: "absolute",
		};
		return (
			<div
				ref={tooltipRef}
				style={style}
				className="z-[1000] w-64 bg-gray-800 text-white rounded-lg shadow-2xl p-4 text-xs  animate-fade-in-up"
			>
				<h4 className="font-bold text-sm mb-2 border-b border-gray-600 pb-1">
					Rincian Beban
				</h4>
				<div className="space-y-1">
					<div className="flex justify-between">
						<span>Selling Cost</span>{" "}
						<span>{formatRupiahDisplay(stats.sellingCosts)}</span>
					</div>
					<div className="flex justify-between">
						<span>Buying Cost</span>{" "}
						<span>{formatRupiahDisplay(stats.buyingCosts)}</span>
					</div>
					<hr className="border-gray-600 my-1" />
					<div className="flex justify-between font-bold text-base">
						<span>Total</span>{" "}
						<span>
							{formatRupiahDisplay(stats.totalOperationalCosts)}
						</span>
					</div>
				</div>
				<button
					onClick={onClose}
					className="absolute top-1 right-1 text-gray-400 hover:text-white"
				>
					&times;
				</button>
			</div>
		);
	};

	const handleShowProfitDetails = (invoice, event) => {
    // Jika tooltip yang sama diklik lagi, tutup.
    if (profitTooltip && profitTooltip.invoice.id === invoice.id) {
        setProfitTooltip(null);
        return;
    }
    // Simpan referensi ke elemen yang diklik (ikonnya) ke dalam state.
    setProfitTooltip({
        invoice: invoice,
        triggerElement: event.currentTarget,
    });
};

	const handleShowOperationalCostDetails = (event) => {
		if (operationalCostTooltip) {
			setOperationalCostTooltip(null);
			return;
		}
		const rect = event.currentTarget.getBoundingClientRect();
		const tooltipWidth = 256;
		const windowWidth = window.innerWidth;
		const padding = 8;

		let leftPosition = rect.left;

		if (rect.left + tooltipWidth > windowWidth - padding) {
			leftPosition = rect.right - tooltipWidth;
		}

		if (leftPosition < padding) {
			leftPosition = padding;
		}

		setOperationalCostTooltip({
			position: { top: rect.bottom + 8, left: leftPosition },
		});
	};

	const ActionButtons = ({ invoice }) => (
		<div className="flex items-center gap-3">
			<button
				onClick={() => setPreviewingInvoice(invoice)}
				className="p-1.5 text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300"
				title="Preview Invoice"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					className="h-5 w-5"
					viewBox="0 0 20 20"
					fill="currentColor"
				>
					<path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
					<path
						fillRule="evenodd"
						d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
						clipRule="evenodd"
					/>
				</svg>
			</button>
			<button
				onClick={() => onEdit(invoice)}
				className="p-1.5 text-cyan-500 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300"
				title="Edit Invoice"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					className="h-5 w-5"
					viewBox="0 0 20 20"
					fill="currentColor"
				>
					<path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
					<path
						fillRule="evenodd"
						d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
						clipRule="evenodd"
					/>
				</svg>
			</button>
			<button
				onClick={() => handleSendBill(invoice)}
				className="p-1.5 text-teal-500 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300"
				title="Kirim Tagihan via WhatsApp"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					className="h-5 w-5"
					viewBox="0 0 20 20"
					fill="currentColor"
				>
					<path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
					<path
						fillRule="evenodd"
						d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z"
						clipRule="evenodd"
					/>
				</svg>
			</button>
			<button
				onClick={() => handleShareToWhatsApp(invoice)}
				disabled={isSharing === invoice.id}
				className="p-1.5 text-green-500 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 disabled:opacity-50 disabled:cursor-wait"
				title="Share Invoice Image to WhatsApp"
			>
				{isSharing === invoice.id ? (
					<svg
						className="animate-spin h-5 w-5"
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
					>
						<circle
							className="opacity-25"
							cx="12"
							cy="12"
							r="10"
							stroke="currentColor"
							strokeWidth="4"
						/>
						<path
							className="opacity-75"
							fill="currentColor"
							d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
						/>
					</svg>
				) : (
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="16"
						height="16"
						fill="currentColor"
						className="h-5 w-5"
						viewBox="0 0 16 16"
					>
						<path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232" />
					</svg>
				)}
			</button>
			<button
				onClick={() => setItemToDelete(invoice)}
				className="p-1.5 text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400"
				title="Delete"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					className="h-5 w-5"
					viewBox="0 0 20 20"
					fill="currentColor"
				>
					<path
						fillRule="evenodd"
						d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z"
						clipRule="evenodd"
					/>
				</svg>
			</button>
		</div>
	);

	return (
		<div className="container mx-auto">
			{itemToDelete && (
				<ConfirmDeleteModal
					title="Delete Invoice"
					onConfirm={handleDeleteInvoice}
					onCancel={() => setItemToDelete(null)}
					item={itemToDelete}
				/>
			)}
			{previewingInvoice && (
				<InvoicePreviewModal
					invoice={previewingInvoice}
					closeModal={() => setPreviewingInvoice(null)}
				/>
			)}
			{isManualInvoiceModalOpen && (
				<ManualInvoiceModal
					closeModal={() => setIsManualInvoiceModalOpen(false)}
					userId={userId}
				/>
			)}
			{profitTooltip && (
                <ProfitTooltip
    invoice={profitTooltip.invoice}
    triggerElement={profitTooltip.triggerElement}
    onClose={() => setProfitTooltip(null)}
    stockData={stock}
/>
            )}
			{operationalCostTooltip && (
				<OperationalCostTooltip
					stats={summaryStats}
					position={operationalCostTooltip.position}
					onClose={() => setOperationalCostTooltip(null)}
				/>
			)}

			<div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
				<h2 className="text-3xl font-bold">Invoice List</h2>
				<div className="flex flex-wrap items-center justify-center gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
					<button
						onClick={() => setActiveFilter("this_week")}
						className={getButtonClass("this_week")}
					>
						This Week
					</button>
					<button
						onClick={() => setActiveFilter("this_month")}
						className={getButtonClass("this_month")}
					>
						This Month
					</button>
					<button
						onClick={() => setActiveFilter("last_month")}
						className={getButtonClass("last_month")}
					>
						Last Month
					</button>
					<div className="relative">
						<button
							ref={datePickerButtonRef}
							onClick={() => setIsDatePickerOpen(true)}
							className={getButtonClass("custom")}
						>
							{formatDisplayDateRange()}
						</button>
						<DateRangePickerPopover
							isOpen={isDatePickerOpen}
							onClose={() => setIsDatePickerOpen(false)}
							onApply={handleApplyCustomRange}
							currentRange={customDateRange}
							positionRef={datePickerButtonRef}
						/>
					</div>
				</div>
			</div>

			{(activeFilter !== "all" || searchTerm) && (
				<div className="text-right mb-4">
					<button
						onClick={handleClearFilters}
						className="text-sm font-semibold text-blue-600 dark:text-blue-400 hover:underline"
					>
						Show All & Clear Search
					</button>
				</div>
			)}

			<div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
				<div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
					<h4 className="text-sm font-medium text-gray-500 dark:text-gray-400">
						Sales Total (Filtered)
					</h4>
					<p className="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-1">
						{formatRupiahDisplay(summaryStats.salesTotal)}
					</p>
				</div>
				<div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
					<h4 className="text-sm font-medium text-gray-500 dark:text-gray-400">
						Unpaid Invoices (Filtered)
					</h4>
					<p className="text-2xl font-bold text-red-600 dark:text-red-400 mt-1">
						{formatRupiahDisplay(summaryStats.unpaidTotal)}
					</p>
				</div>
				<div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
					<h4 className="text-sm font-medium text-gray-500 dark:text-gray-400 flex items-center gap-2">
						<span>Beban Operasional (Filtered)</span>
						<button
							onClick={(e) => handleShowOperationalCostDetails(e)}
							className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								className="h-4 w-4"
								viewBox="0 0 20 20"
								fill="currentColor"
							>
								<path
									fillRule="evenodd"
									d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
									clipRule="evenodd"
								/>
							</svg>
						</button>
					</h4>
					<p className="text-2xl font-bold text-orange-500 dark:text-orange-400 mt-1">
						{formatRupiahDisplay(summaryStats.totalOperationalCosts)}
					</p>
				</div>
			</div>

			<div className="mb-6 relative">
				<input
					type="text"
					value={searchTerm}
					onChange={(e) => setSearchTerm(e.target.value)}
					placeholder="Search by Invoice #, Customer, or Item..."
					className="w-full p-3 pl-4 pr-10 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
				/>
				{searchTerm && (
					<button
						onClick={() => setSearchTerm("")}
						className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
						title="Clear search"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							className="h-5 w-5"
							viewBox="0 0 20 20"
							fill="currentColor"
						>
							<path
								fillRule="evenodd"
								d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
								clipRule="evenodd"
							/>
						</svg>
					</button>
				)}
			</div>

			{loading ? (
				<div className="text-center p-10">Loading invoices...</div>
			) : filteredInvoices.length > 0 ? (
				<>
					<div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-x-auto hidden md:block">
						<table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
							<thead className="bg-gray-100 dark:bg-gray-700">
								<tr>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										No
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Date
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Invoice #
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Customer Name
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Total Amount
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Profit
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Status
									</th>
									<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
										Action
									</th>
								</tr>
							</thead>
							<tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
								{filteredInvoices.map((invoice, index) => (
									<tr
										key={invoice.id}
										className="hover:bg-gray-50 dark:hover:bg-gray-700 transition"
									>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											{index + 1}
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											{formatDate(invoice.date, false)}
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											{invoice.invoiceNumber}
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm font-semibold">
											{invoice.customerName}
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											{formatRupiahDisplay(invoice.total)}
										</td>
										<td
											className={`px-6 py-3 whitespace-nowrap text-sm font-bold ${calculateInvoiceProfit(invoice) < 0 ? "text-red-600 dark:text-red-400" : "text-green-600 dark:text-green-400"}`}
										>
											<div className="flex items-center gap-2">
												<button
													onClick={(e) =>
														handleShowProfitDetails(invoice, e)
													}
													className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
												>
													<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="bi bi-info-circle-fill" viewBox="0 0 16 16">
														<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2" />
													</svg>
												</button>
												<span>
													{formatRupiahDisplay(
														calculateInvoiceProfit(invoice),
													)}
												</span>
											</div>
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											<span
												className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.paymentStatus === "Lunas" ? "bg-green-200 text-green-800" : "bg-yellow-200 text-yellow-800"}`}
											>
												{invoice.paymentStatus || "Lunas"}
											</span>
										</td>
										<td className="px-6 py-3 whitespace-nowrap text-sm">
											<ActionButtons invoice={invoice} />
										</td>
									</tr>
								))}
							</tbody>
						</table>
					</div>
					<div className="md:hidden space-y-4">
						{filteredInvoices.map((invoice) => {
							const totalProfit = calculateInvoiceProfit(invoice);
							return (
								<div
									key={invoice.id}
									className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md"
								>
									<div className="flex justify-between items-start text-sm mb-3">
										<span className="font-mono text-blue-500 dark:text-blue-400 font-semibold">
											{invoice.invoiceNumber}
										</span>
										<span className="text-gray-500 dark:text-gray-400">
											{formatDate(invoice.date, false)}
										</span>
									</div>
									<div className="mb-4">
										<p className="font-bold text-lg text-gray-900 dark:text-white truncate">
											{invoice.customerName}
										</p>
										<p className="text-2xl font-bold text-gray-800 dark:text-gray-100">
											{formatRupiahDisplay(invoice.total)}
										</p>
									</div>
									<div className="flex justify-between items-center text-sm mb-4">
										<span
											className={`font-bold ${totalProfit < 0 ? "text-red-500 dark:text-red-400" : "text-green-500 dark:text-green-400"}`}
										>
											Profit: {formatRupiahDisplay(totalProfit)}
											<button
												onClick={(e) =>
													handleShowProfitDetails(invoice, e)
												}
												className="ml-1.5 inline-block align-middle text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
											>
												<svg
													xmlns="http://www.w3.org/2000/svg"
													className="h-4 w-4"
													viewBox="0 0 20 20"
													fill="currentColor"
												>
													<path
														fillRule="evenodd"
														d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
														clipRule="evenodd"
													/>
												</svg>
											</button>
										</span>
										<span
											className={`px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.paymentStatus === "Lunas" ? "bg-green-200 text-green-800" : "bg-yellow-200 text-yellow-800"}`}
										>
											{invoice.paymentStatus || "Lunas"}
										</span>
									</div>
									<div className="border-t border-gray-200 dark:border-gray-700 mt-3 pt-3 flex justify-end items-center">
										<ActionButtons invoice={invoice} />
									</div>
								</div>
							);
						})}
					</div>
				</>
			) : (
				<div className="text-center p-10 bg-white dark:bg-gray-800 rounded-lg shadow-md">
					{invoices.length > 0
						? "No invoices match your search or filter criteria."
						: "No invoices found for the selected period."}
				</div>
			)}

			<div className="fixed bottom-20 lg:bottom-6 right-6  flex flex-col items-center gap-4 z-40">
				<button
					onClick={() => onEdit(null)}
					className="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform"
					title="Create Sales Invoice"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						className="h-7 w-7"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							strokeLinecap="round"
							strokeLinejoin="round"
							strokeWidth="2"
							d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
						/>
					</svg>
				</button>
			</div>
		</div>
	);
}

			function InvoicePreviewModal({ invoice, closeModal }) {
				const previewRef = useRef(null);
				const [isGenerating, setIsGenerating] = useState(false);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				const handleGenerate = async (format) => {
					if (isGenerating) return;
					setIsGenerating(true);
					try {
						const canvas = await generateInvoiceCanvas(invoice);
						if (format === "pdf") {
							const { jsPDF } = window.jspdf;
							const pdf = new jsPDF("p", "mm", "a4");
							pdf.addImage(
								canvas.toDataURL("image/jpeg", 0.95),
								"JPEG",
								0,
								0,
								pdf.internal.pageSize.getWidth(),
								pdf.internal.pageSize.getHeight(),
							);
							pdf.save(
								`Invoice-${invoice.invoiceNumber.replace(/\//g, "-")}.pdf`,
							);
						} else if (format === "jpg") {
							const link = document.createElement("a");
							link.href = canvas.toDataURL("image/jpeg", 0.95);
							link.download = `Invoice-${invoice.invoiceNumber.replace(/\//g, "-")}.jpg`;
							link.click();
						}
					} catch (error) {
						console.error("Error generating output:", error);
						alert("Failed to generate file.");
					} finally {
						setIsGenerating(false);
					}
				};

				const handleDirectPrint = () => {
					const container = document.getElementById("print-root");
					if (!container) return;
					const PrintComponent = () => (
						<div className="print-area">
							<InvoiceTemplate invoiceData={invoice} />
						</div>
					);
					ReactDOM.render(<PrintComponent />, container, () => {
						window.print();
						ReactDOM.unmountComponentAtNode(container);
					});
				};
				useEffect(() => {
					if (previewRef.current) {
						const container = previewRef.current;
						const a4Element = previewRef.current.querySelector(".preview-a4");
						const updateScale = () => {
							if (container && a4Element) {
								a4Element.style.setProperty(
									"--preview-scale",
									container.offsetWidth / a4Element.offsetWidth,
								);
							}
						};
						updateScale();
						window.addEventListener("resize", updateScale);
						return () => window.removeEventListener("resize", updateScale);
					}
				}, [invoice]);
				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-full flex flex-col text-sm">
							<div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-2">
								<h3 className="text-xl sm:text-2xl font-bold">
									Invoice Preview
								</h3>
								<div className="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto">
									<button
										onClick={closeModal}
										className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition text-xs sm:text-sm"
										disabled={isGenerating}
									>
										Close
									</button>
									<button
										onClick={handleDirectPrint}
										className="px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700 text-white transition text-xs sm:text-sm"
										disabled={isGenerating}
									>
										Print Invoice
									</button>
									<button
										onClick={() => handleGenerate("pdf")}
										className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition text-xs sm:text-sm"
										disabled={isGenerating}
									>
										{isGenerating ? "Generating..." : "Generate PDF"}
									</button>
									<button
										onClick={() => handleGenerate("jpg")}
										className="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition text-xs sm:text-sm"
										disabled={isGenerating}
									>
										{isGenerating ? "Generating..." : "Generate JPG"}
									</button>
								</div>
							</div>
							<div className="flex-grow overflow-y-auto p-2 sm:p-6 flex justify-center bg-gray-200 dark:bg-gray-900">
								<div className="preview-container" ref={previewRef}>
									<InvoiceTemplate invoiceData={invoice} />
								</div>
							</div>
						</div>
					</div>
				);
			}

						function ModelDistributionChart({
				chartData,
				chartType,
				onChartTypeChange,
				filter,
				onFilterChange,
                // --- PERUBAHAN DI SINI: Tambahkan props baru ---
                isLegendVisible,
                onToggleLegend
			}) {
				const chartRef = useRef(null);
				const chartInstanceRef = useRef(null);
				const theme = localStorage.getItem("theme") || "dark";
                // --- PERUBAHAN DI SINI: Hapus useState lokal ---
				// const [isLegendVisible, setIsLegendVisible] = useState(true);

				useEffect(() => {
					if (!chartRef.current || typeof Chart === "undefined") return;
					const ctx = chartRef.current.getContext("2d");
					if (chartInstanceRef.current) {
						chartInstanceRef.current.destroy();
					}

					const labels = Object.keys(chartData);
					const dataValues = Object.values(chartData).map((d) => d.value);
					const dataCounts = Object.values(chartData).map((d) => d.count);

					if (labels.length === 0) return;

					const colorPalette = [
						"#60A5FA", "#34D399", "#FBBF24", "#F87171", "#A78BFA",
						"#F472B6", "#4ADE80", "#2DD4BF", "#F43F5E", "#818CF8",
					];

					let chartConfig;
					if (chartType === "bar") {
						chartConfig = {
							type: "bar",
							data: {
								labels: ["Models"],
								datasets: labels.map((label, index) => ({
									label: label,
									data: [dataValues[index]],
									backgroundColor: colorPalette[index % colorPalette.length],
									borderColor: theme === "dark" ? "#374151" : "#FFFFFF",
									borderWidth: 1,
									customData: { count: dataCounts[index] },
								})),
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: {
									legend: {
										display: isLegendVisible, // Gunakan prop
										position: "bottom",
										labels: { color: theme === "dark" ? "#D1D5DB" : "#4B5563" },
									},
									tooltip: {
										zIndex: 9999,
										bodyAlign: "left",
										callbacks: {
											label: function (context) {
												const label = context.dataset.label || "";
												const value = context.parsed.y;
												const count = context.dataset.customData.count;
												return `${label}: ${formatRupiahDisplay(value)} (${count} unit${count !== 1 ? "s" : ""})`;
											},
										},
									},
								},
								scales: {
									y: {
										beginAtZero: true,
										ticks: {
											callback: (value) => formatRupiahCompact(value),
											color: theme === "dark" ? "#D1D5DB" : "#4B5563",
										},
										grid: { color: theme === "dark" ? "#4B5563" : "#E5E7EB" },
									},
									x: { ticks: { display: false }, grid: { display: false } },
								},
							},
						};
					} else { // Pie Chart
						chartConfig = {
							type: "pie",
							data: {
								labels: labels,
								datasets: [{
									label: "Value",
									data: dataValues,
									backgroundColor: colorPalette,
									borderColor: theme === "dark" ? "#374151" : "#FFFFFF",
									borderWidth: 2,
								}],
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: {
									legend: {
										display: isLegendVisible, // Gunakan prop
										position: "bottom",
										labels: { color: theme === "dark" ? "#D1D5DB" : "#4B5563" },
									},
									tooltip: {
										zIndex: 9999,
										bodyAlign: "left",
										callbacks: {
											label: function (context) {
												const label = context.label || "";
												const value = context.parsed;
												const index = context.dataIndex;
												const count = dataCounts[index];
												return `${label}: ${formatRupiahDisplay(value)} (${count} unit${count !== 1 ? "s" : ""})`;
											},
										},
									},
								},
							},
						};
					}

					chartInstanceRef.current = new Chart(ctx, chartConfig);

					return () => {
						if (chartInstanceRef.current) chartInstanceRef.current.destroy();
					};
				}, [chartData, chartType, theme, isLegendVisible]);

				return (
					<>
						<div className="flex justify-between items-start mb-4">
							<h3 className="text-xl font-bold">Model Distribution</h3>
							<select
								value={filter}
								onChange={(e) => onFilterChange(e.target.value)}
								className="bg-gray-200 dark:bg-gray-600 text-sm p-1.5 rounded-md border border-gray-300 dark:border-gray-500 focus:ring-1 focus:ring-blue-500 focus:outline-none"
							>
								<option value="available">Available (Current)</option>
								<option value="purchased">Purchased (Filtered)</option>
								<option value="sold">Sold (Filtered)</option>
							</select>
						</div>
						<div className="relative h-80 flex-grow overflow-visible">
							<div className="absolute top-0 right-0 z-10 flex items-center gap-2">
                                {/* --- PERUBAHAN DI SINI: Gunakan onToggleLegend --- */}
								<button
									onClick={onToggleLegend}
									className={`p-1.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors ${!isLegendVisible ? "opacity-50" : ""}`}
									title="Toggle Legend"
								>
									<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
										<path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" />
									</svg>
								</button>
								<div className="flex bg-gray-200 dark:bg-gray-600 p-1 rounded-lg">
									<button
										onClick={() => onChartTypeChange("pie")}
										className={`px-2 py-1 text-xs rounded-md ${chartType === "pie" ? "bg-white dark:bg-gray-800 shadow" : ""}`}
									>
										Pie
									</button>
									<button
										onClick={() => onChartTypeChange("bar")}
										className={`px-2 py-1 text-xs rounded-md ${chartType === "bar" ? "bg-white dark:bg-gray-800 shadow" : ""}`}
									>
										Bar
									</button>
								</div>
							</div>
							<canvas ref={chartRef}></canvas>
						</div>
					</>
				);
			}

			function UnitBreakdownCard({
				data,
				handleCopy,
				copyStatus,
				listingPrices,
				onPriceChange,
				onBulkPriceChange, // New prop for bulk updates
			}) {
				// --- NEW STATE FOR BULK EDITING ---
				const [isBulkEditMode, setIsBulkEditMode] = useState(false);
				const [selectedKeys, setSelectedKeys] = useState(new Set());
				const [bulkPriceDisplay, setBulkPriceDisplay] = useState("");

				if (!data || data.length === 0) {
					// (This part is unchanged)
					return (
						<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 h-full">
							<h3 className="text-xl font-bold mb-4">Rincian Unit Tersedia</h3>
							<div className="flex items-center justify-center h-full pb-10">
								<p className="text-center text-gray-500 dark:text-gray-400">
									No available stock for this month.
								</p>
							</div>
						</div>
					);
				}

				// --- NEW HANDLERS FOR BULK EDITING ---
				const toggleBulkEditMode = () => {
					setIsBulkEditMode(!isBulkEditMode);
					// Reset selections when exiting bulk mode
					if (isBulkEditMode) {
						setSelectedKeys(new Set());
						setBulkPriceDisplay("");
					}
				};

				const handleSelectAll = () => {
					if (selectedKeys.size === data.length) {
						setSelectedKeys(new Set());
					} else {
						const allKeys = new Set(
							data.map(
								(item) =>
									`${item.model}-${item.storage}-${item.ram}-${item.color}`,
							),
						);
						setSelectedKeys(allKeys);
					}
				};

				const handleSelectKey = (key) => {
					setSelectedKeys((prev) => {
						const newSet = new Set(prev);
						if (newSet.has(key)) {
							newSet.delete(key);
						} else {
							newSet.add(key);
						}
						return newSet;
					});
				};

				const handleApplyBulkPrice = () => {
					if (selectedKeys.size === 0) {
						alert("Please select at least one item.");
						return;
					}
					const newPrice = parseFormattedNumber(bulkPriceDisplay);
					if (
						newPrice === 0 &&
						bulkPriceDisplay.trim() !== "" &&
						bulkPriceDisplay.trim() !== "0"
					) {
						alert("Please enter a valid number for the price.");
						return;
					}

					onBulkPriceChange(selectedKeys, newPrice); // Use the new bulk update handler

					// Exit bulk mode after applying
					toggleBulkEditMode();
				};

				return (
					<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 flex flex-col h-full">
						<div className="flex justify-between items-center mb-4">
							<h3 className="text-xl font-bold">Rincian Unit Tersedia</h3>
							<div className="flex items-center gap-2">
								<button
									onClick={toggleBulkEditMode}
									className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition"
								>
									{isBulkEditMode ? "Cancel" : "Bulk"}
								</button>
								<button
									onClick={handleCopy}
									className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition"
								>
									{copyStatus}
								</button>
							</div>
						</div>

						{/* --- NEW BULK EDIT UI --- */}
						{isBulkEditMode && (
							<div className="mb-4 p-3 bg-gray-200 dark:bg-gray-800 rounded-lg flex flex-col sm:flex-row items-center gap-3">
								<div className="flex-grow flex items-center gap-3">
									<input
										type="text"
										inputMode="numeric"
										value={bulkPriceDisplay}
										onChange={(e) =>
											setBulkPriceDisplay(formatNumberInput(e.target.value))
										}
										placeholder="Set Price for Selected"
										className="w-full p-2 text-sm bg-white dark:bg-gray-700 rounded-md border border-gray-400 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500"
									/>
								</div>
								<button
									onClick={handleApplyBulkPrice}
									className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition"
								>
									Apply to {selectedKeys.size} item(s)
								</button>
							</div>
						)}

						<div className="overflow-y-auto h-80 flex-grow no-scrollbar">
							{/* --- DESKTOP TABLE VIEW (with changes) --- */}
							<table className="hidden xl:table min-w-full divide-y divide-gray-300 dark:divide-gray-600">
								<thead className="sticky top-0 bg-gray-200 dark:bg-gray-600 z-10">
									<tr>
										{isBulkEditMode && (
											<th className="px-2 py-2">
												<input
													type="checkbox"
													className="form-checkbox h-4 w-4 rounded"
													onChange={handleSelectAll}
													checked={
														selectedKeys.size === data.length && data.length > 0
													}
												/>
											</th>
										)}
										<th className="px-4 py-2 text-left text-xs font-medium uppercase">
											Model & Varian
										</th>
										<th className="px-4 py-2 text-left text-xs font-medium uppercase">
											Unit
										</th>
										<th className="px-4 py-2 text-left text-xs font-medium uppercase">
											Set Harga
										</th>
									</tr>
								</thead>
								<tbody className="divide-y divide-gray-300 dark:divide-gray-600">
									{data.map((item) => {
										const itemKey = `${item.model}-${item.storage}-${item.ram}-${item.color}`;
										return (
											<tr
												key={itemKey}
												className="hover:bg-gray-200/50 dark:hover:bg-gray-600/50 transition"
											>
												{isBulkEditMode && (
													<td className="px-2 py-3 align-middle">
														<input
															type="checkbox"
															className="form-checkbox h-4 w-4 rounded"
															checked={selectedKeys.has(itemKey)}
															onChange={() => handleSelectKey(itemKey)}
														/>
													</td>
												)}
												<td className="px-4 py-3 align-middle">
													<div className="text-sm font-medium text-gray-900 dark:text-white">
														{[item.model, item.storage, item.ram]
															.filter(Boolean)
															.join(" ")}
													</div>
													<div className="text-sm text-gray-500 dark:text-gray-400">
														{item.color}
													</div>
												</td>
												<td className="px-4 py-3 text-sm text-left align-middle font-semibold text-gray-900 dark:text-white">
													{item.count}
												</td>
												<td className="px-4 py-3 align-middle">
													<input
														type="text"
														inputMode="numeric"
														value={formatNumberInput(
															listingPrices[itemKey] || "",
														)}
														onChange={(e) =>
															onPriceChange(itemKey, e.target.value)
														}
														placeholder="Set Harga"
														className="w-32 p-1.5 text-sm bg-white dark:bg-gray-800 rounded-md border border-gray-400 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500"
													/>
												</td>
											</tr>
										);
									})}
								</tbody>
							</table>

							{/* --- MOBILE CARD VIEW (with changes) --- */}
							<div className="xl:hidden space-y-2">
								{isBulkEditMode && (
									<label className="flex items-center gap-2 mb-3 pb-3 border-b border-gray-300 dark:border-gray-600">
										<input
											type="checkbox"
											className="form-checkbox h-4 w-4 rounded"
											onChange={handleSelectAll}
											checked={
												selectedKeys.size === data.length && data.length > 0
											}
										/>
										<span className="font-semibold">Select All</span>
									</label>
								)}
								{data.map((item) => {
									const itemKey = `${item.model}-${item.storage}-${item.ram}-${item.color}`;
									return (
										<div
											key={itemKey}
											className="p-3 bg-gray-200/50 dark:bg-gray-600/50 rounded-lg flex items-start gap-3"
										>
											{isBulkEditMode && (
												<input
													type="checkbox"
													className="form-checkbox h-4 w-4 rounded mt-1 flex-shrink-0"
													checked={selectedKeys.has(itemKey)}
													onChange={() => handleSelectKey(itemKey)}
												/>
											)}
											<div className="flex-grow">
												<div className="mb-2">
													<div className="text-sm font-medium text-gray-900 dark:text-white">
														{[item.model, item.storage, item.ram]
															.filter(Boolean)
															.join(" ")}
													</div>
													<div className="text-sm text-gray-500 dark:text-gray-400">
														{item.color}
													</div>
												</div>
												<div className="flex items-center justify-between gap-4">
													<div className="text-sm">
														<span className="text-gray-500 dark:text-gray-400">
															Unit:{" "}
														</span>
														<span className="font-semibold text-gray-900 dark:text-white">
															{item.count}
														</span>
													</div>
													<div className="flex-shrink-0">
														<input
															type="text"
															inputMode="numeric"
															value={formatNumberInput(
																listingPrices[itemKey] || "",
															)}
															onChange={(e) =>
																onPriceChange(itemKey, e.target.value)
															}
															placeholder="Set Harga"
															className="w-32 p-1.5 text-sm bg-white dark:bg-gray-800 rounded-md border border-gray-400 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500"
														/>
													</div>
												</div>
											</div>
										</div>
									);
								})}
							</div>
						</div>
					</div>
				);
			}

			function ConfirmationModal({
				title,
				message,
				onConfirm,
				onCancel,
				confirmText = "Ya",
				cancelText = "Tidak",
				isConfirming = false,
				detailsList = [],
			}) {
				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				// Kalkulasi total berdasarkan item yang dilewatkan ke modal
				const grandTotal = detailsList.reduce((total, item) => {
					const totalOwed = item.unpaidHpp !== undefined ? item.unpaidHpp : (item.hpp || 0);
					return total + totalOwed;
				}, 0);

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
							<h3 className="text-xl font-bold mb-4">{title}</h3>
							
							{/* Tampilkan rincian jika ada */}
							{detailsList.length > 0 ? (
								<div className="mb-6">
									<p className="text-gray-600 dark:text-gray-300 mb-3">{message}</p>
									<div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-600">
										<div className="space-y-3">
											{detailsList.map(item => {
												// Logika untuk memecah total terutang menjadi harga pokok + biaya
												const totalOwed = item.unpaidHpp !== undefined ? item.unpaidHpp : (item.hpp || 0);
												const itemAdditionalCost = item.additionalCost || 0;
												const hpp = item.hpp || 0;
												const wasCostIncludedInDebt = Math.abs(totalOwed - hpp) < 1;
												const displayAdditionalCost = wasCostIncludedInDebt ? itemAdditionalCost : 0;
												const basePrice = totalOwed - displayAdditionalCost;
												
												return (
													<div key={item.id} className="text-sm border-b border-gray-300 dark:border-gray-600 last:border-b-0 pb-2">
														<p className="font-semibold text-gray-800 dark:text-gray-200">
															{item.invoice}: <span className="font-normal">{[item.phoneModel, item.storage, item.color].filter(Boolean).join(" ")}</span>
														</p>
														<div className="pl-2 mt-1 space-y-1 text-xs">
															<div className="flex justify-between">
																<span className="text-gray-500 dark:text-gray-400">Harga Pokok:</span>
																<span className="font-mono">{formatRupiahDisplay(basePrice)}</span>
															</div>
															{displayAdditionalCost > 0 && (
																<div className="flex justify-between">
																	<span className="text-gray-500 dark:text-gray-400">Biaya Beli:</span>
																	<span className="font-mono">{formatRupiahDisplay(displayAdditionalCost)}</span>
																</div>
															)}
															<div className="flex justify-between font-semibold">
																<span className="text-gray-600 dark:text-gray-300">Subtotal Terutang:</span>
																<span className="font-mono">{formatRupiahDisplay(totalOwed)}</span>
															</div>
														</div>
													</div>
												);
											})}
										</div>
									</div>
									<div className="flex justify-between font-bold text-lg mt-4 pt-3 border-t-2 border-gray-300 dark:border-gray-600">
										<span>TOTAL DIBAYAR:</span>
										<span className="font-mono text-green-600 dark:text-green-400">{formatRupiahDisplay(grandTotal)}</span>
									</div>
								</div>
							) : (
								// Tampilan default jika tidak ada rincian
								<p className="text-gray-600 dark:text-gray-300 mb-6">{message}</p>
							)}
							
							<div className="flex justify-end space-x-4">
								<button
									onClick={onCancel}
									disabled={isConfirming}
									className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition disabled:opacity-70"
								>
									{cancelText}
								</button>
								<button
									onClick={onConfirm}
									disabled={isConfirming}
									className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition disabled:bg-green-800 disabled:cursor-wait"
								>
									{isConfirming ? "Memproses..." : confirmText}
								</button>
							</div>
						</div>
					</div>
				);
			}
			function PriceMovementChart({ stockData, userId }) {
				const [priceType, setPriceType] = useState("sales"); // State baru: 'sales' atau 'purchase'

				const [selectedItems, setSelectedItems] = useState(() => {
					try {
						const saved = localStorage.getItem(`priceChartItems_${userId}`);
						if (saved) {
							const parsedArray = JSON.parse(saved);
							const cleanedArray = parsedArray.filter((item) => !!item);
							return new Set(cleanedArray);
						}
						return new Set();
					} catch (e) {
						console.error("Gagal memuat item chart dari localStorage", e);
						return new Set();
					}
				});

				const chartRef = useRef(null);
				const chartInstanceRef = useRef(null);
				const theme = localStorage.getItem("theme") || "dark";

				useEffect(() => {
					localStorage.setItem(
						`priceChartItems_${userId}`,
						JSON.stringify(Array.from(selectedItems)),
					);
				}, [selectedItems, userId]);

				const { chartData, availableItemsForSelect } = useMemo(() => {
					const uniqueItems = [
						...new Set(
							stockData.map((item) =>
								[item.phoneModel, item.storage, item.ram]
									.filter(Boolean)
									.join(" "),
							),
						),
					]
						.filter(Boolean)
						.sort();

					if (selectedItems.size === 0) {
						return {
							chartData: { labels: [], datasets: [] },
							availableItemsForSelect: uniqueItems,
						};
					}

					const getWeekLabel = (d) => {
						const date = new Date(d);
						const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
						const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
						const weekNumber = Math.ceil(
							(pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7,
						);
						return `${date.getFullYear()}-W${String(weekNumber).padStart(2, "0")}`;
					};

					const weeklyPrices = {};
					const allWeeks = new Set();

					// --- PERUBAHAN UTAMA: Logika dinamis berdasarkan priceType ---
					if (priceType === "sales") {
						const soldItems = stockData.filter(
							(item) =>
								item.availability === "SOLD" &&
								item.soldDate &&
								item.soldPrice > 0,
						);
						soldItems.forEach((item) => {
							const itemKey = [item.phoneModel, item.storage, item.ram]
								.filter(Boolean)
								.join(" ");
							if (selectedItems.has(itemKey)) {
								if (!weeklyPrices[itemKey]) weeklyPrices[itemKey] = {};
								const week = getWeekLabel(item.soldDate.toDate());
								if (!weeklyPrices[itemKey][week])
									weeklyPrices[itemKey][week] = [];
								weeklyPrices[itemKey][week].push(item.soldPrice);
								allWeeks.add(week);
							}
						});
					} else {
						// priceType === 'purchase'
						const purchasedItems = stockData.filter(
							(item) => item.deliveryDate && item.hpp > 0,
						);
						purchasedItems.forEach((item) => {
							const itemKey = [item.phoneModel, item.storage, item.ram]
								.filter(Boolean)
								.join(" ");
							if (selectedItems.has(itemKey)) {
								if (!weeklyPrices[itemKey]) weeklyPrices[itemKey] = {};
								const week = getWeekLabel(item.deliveryDate.toDate());
								if (!weeklyPrices[itemKey][week])
									weeklyPrices[itemKey][week] = [];
								weeklyPrices[itemKey][week].push(item.hpp);
								allWeeks.add(week);
							}
						});
					}
					// --- AKHIR PERUBAHAN UTAMA ---

					const sortedLabels = Array.from(allWeeks).sort();

					const datasets = Object.entries(weeklyPrices).map(
						([itemName, weeksData], index) => {
							const dataPoints = sortedLabels.map((label) => {
								const prices = weeksData[label];
								return prices
									? prices.reduce((a, b) => a + b, 0) / prices.length
									: null;
							});

							const colors = [
								"#3B82F6",
								"#10B981",
								"#F59E0B",
								"#EF4444",
								"#8B5CF6",
								"#EC4899",
							];
							return {
								label: itemName,
								data: dataPoints,
								borderColor: colors[index % colors.length],
								backgroundColor: colors[index % colors.length] + "33",
								fill: false,
								tension: 0.1,
								spanGaps: true,
							};
						},
					);
					return {
						chartData: { labels: sortedLabels, datasets },
						availableItemsForSelect: uniqueItems,
					};
				}, [stockData, selectedItems, priceType]); // Tambahkan priceType sebagai dependency

				useEffect(() => {
					if (!chartRef.current) return;
					const ctx = chartRef.current.getContext("2d");
					if (chartInstanceRef.current) chartInstanceRef.current.destroy();
					chartInstanceRef.current = new Chart(ctx, {
						type: "line",
						data: chartData,
						options: {
							responsive: true,
							maintainAspectRatio: false,
							scales: {
								y: {
									ticks: {
										callback: (value) => formatRupiahCompact(value),
										color: theme === "dark" ? "#D1D5DB" : "#4B5563",
									},
									grid: { color: theme === "dark" ? "#4B5563" : "#E5E7EB" },
								},
								x: {
									ticks: { color: theme === "dark" ? "#D1D5DB" : "#4B5563" },
									grid: { color: theme === "dark" ? "#4B5563" : "#E5E7EB" },
								},
							},
							plugins: {
								legend: {
									position: "top",
									labels: { color: theme === "dark" ? "#F9FAFB" : "#1F2937" },
								},
								tooltip: {
									zIndex: 9999, // <-- PERUBAHAN DI SINI
									callbacks: {
										label: (context) => {
											// --- PERUBAHAN: Tooltip dinamis ---
											const priceLabel =
												priceType === "sales" ? "Avg. Sale" : "Avg. HPP";
											return `${context.dataset.label}: ${formatRupiahDisplay(context.parsed.y)} (${priceLabel})`;
										},
									},
								},
							},
						},
					});
					return () => chartInstanceRef.current?.destroy();
				}, [chartData, theme, priceType]); // Tambahkan priceType sebagai dependency

				return (
					<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 h-full flex flex-col">
						{/* --- PERUBAHAN: Judul dan Tombol Toggle --- */}
						<div className="flex justify-between items-center mb-4">
							<h3 className="text-xl font-bold">
								{priceType === "sales" ? "Sales" : "Purchase"} Price Movement
							</h3>
							<div className="flex bg-gray-200 dark:bg-gray-600 p-1 rounded-lg">
								<button
									onClick={() => setPriceType("sales")}
									className={`px-3 py-1 text-xs font-semibold rounded-md transition ${priceType === "sales" ? "bg-white dark:bg-gray-800 shadow" : ""}`}
								>
									Sales
								</button>
								<button
									onClick={() => setPriceType("purchase")}
									className={`px-3 py-1 text-xs font-semibold rounded-md transition ${priceType === "purchase" ? "bg-white dark:bg-gray-800 shadow" : ""}`}
								>
									Purchase
								</button>
							</div>
						</div>
						{/* --- AKHIR PERUBAHAN --- */}

						<div className="mb-4">
							<MultiSelectDropdown
								options={availableItemsForSelect}
								selectedOptions={selectedItems}
								onSelectionChange={setSelectedItems}
								label="Select Items to Display"
							/>
						</div>
						<div className="flex-grow relative h-80">
							{selectedItems.size > 0 ? (
								<canvas ref={chartRef}></canvas>
							) : (
								<div className="flex items-center justify-center h-full">
									<p className="text-gray-500 dark:text-gray-400">
										Select an item to see its price history.
									</p>
								</div>
							)}
						</div>
					</div>
				);
			}

			function ProfitAndInventoryChart({
				title,
				profitData,
				inventoryValueData,
				onPeriodChange,
				period,
			}) {
				const chartRef = useRef(null);
				const chartInstanceRef = useRef(null);
				const theme = localStorage.getItem("theme") || "dark";

				useEffect(() => {
					if (!chartRef.current || !profitData || !inventoryValueData) return;
					const ctx = chartRef.current.getContext("2d");
					if (chartInstanceRef.current) chartInstanceRef.current.destroy();

					chartInstanceRef.current = new Chart(ctx, {
						type: "bar", // Tipe dasar tetap bar
						data: {
							labels: profitData.labels, // Asumsi labelnya sama
							datasets: [
								{
									// DATASET UNTUK GARIS (INVENTORY VALUE)
									type: "line",
									label: "Inventory Value",
									data: inventoryValueData.values,
									borderColor: "rgba(251, 146, 60, 1)", // Oranye
									backgroundColor: "rgba(251, 146, 60, 0.3)",
									tension: 0.2,
									fill: false,
									yAxisID: "y_inventory",
									// --- PERBAIKAN: Tentukan urutan render, lebih rendah = di atas ---
									order: 1,
								},
								{
									// DATASET UNTUK BATANG (PROFIT)
									type: "bar",
									label: "Profit",
									data: profitData.values,
									backgroundColor: "rgba(52, 211, 153, 0.7)", // Hijau
									borderColor: "rgba(52, 211, 153, 1)",
									borderWidth: 1,
									yAxisID: "y_profit",
									// --- PERBAIKAN: Tentukan urutan render, lebih tinggi = di belakang ---
									order: 2,
								},
							],
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							interaction: { mode: "index", intersect: false },
							scales: {
								x: {
									ticks: { color: theme === "dark" ? "#D1D5DB" : "#4B5563" },
									grid: { display: false },
								},
								y_profit: {
									// Axis Kiri untuk Profit (Batang Hijau)
									type: "linear",
									display: true,
									position: "left",
									ticks: {
										callback: (value) => formatRupiahCompact(value),
										color: "rgba(52, 211, 153, 1)",
									},
									grid: { color: theme === "dark" ? "#4B5563" : "#E5E7EB" },
								},
								y_inventory: {
									// Axis Kanan untuk Inventory Value (Garis Oranye)
									type: "linear",
									display: true,
									position: "right",
									beginAtZero: true,
									ticks: {
										callback: (value) => formatRupiahCompact(value),
										color: "rgba(251, 146, 60, 1)",
									},
									grid: { drawOnChartArea: false },
								},
							},
							plugins: {
								legend: {
									position: "top",
									labels: { color: theme === "dark" ? "#F9FAFB" : "#1F2937" },
								},
								tooltip: {
									zIndex: 9999, // <-- PERUBAHAN DI SINI
									callbacks: {
										label: (context) => {
											let label = context.dataset.label || "";
											if (label) {
												label += ": ";
											}
											if (context.parsed.y !== null) {
												label += formatRupiahDisplay(context.parsed.y);
											}
											return label;
										},
									},
								},
							},
						},
					});
					return () => chartInstanceRef.current?.destroy();
				}, [profitData, inventoryValueData, theme, period]);

				const getButtonClass = (p) =>
					`px-3 py-1 text-xs font-semibold rounded-md transition ${period === p ? "bg-white dark:bg-gray-800 shadow" : ""}`;

				return (
					<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 h-full flex flex-col">
						<div className="flex justify-between items-center mb-4">
							<h3 className="text-xl font-bold">{title}</h3>
							<div className="flex bg-gray-200 dark:bg-gray-600 p-1 rounded-lg">
								<button
									onClick={() => onPeriodChange("daily")}
									className={getButtonClass("daily")}
								>
									Daily
								</button>
								<button
									onClick={() => onPeriodChange("week")}
									className={getButtonClass("week")}
								>
									Weekly
								</button>
								<button
									onClick={() => onPeriodChange("month")}
									className={getButtonClass("month")}
								>
									Monthly
								</button>
							</div>
						</div>
						<div className="flex-grow relative h-80">
							<canvas ref={chartRef}></canvas>
						</div>
					</div>
				);
			}

			function HistoricalDataChart({
				title,
				data,
				chartType,
				yAxisLabel,
				onPeriodChange,
				period,
				yAxisFormatter = (val) => val,
			}) {
				const chartRef = useRef(null);
				const chartInstanceRef = useRef(null);
				const theme = localStorage.getItem("theme") || "dark";

				useEffect(() => {
					if (!chartRef.current || !data) return;
					const ctx = chartRef.current.getContext("2d");
					if (chartInstanceRef.current) chartInstanceRef.current.destroy();

					let chartBackgroundColor;
					let chartBorderColor;

					if (chartType === "bar") {
						const colorPalette = [
							"#60A5FA",
							"#34D399",
							"#FBBF24",
							"#F87171",
							"#A78BFA",
							"#F472B6",
							"#4ADE80",
							"#2DD4BF",
							"#F43F5E",
							"#818CF8",
							"#FB923C",
							"#A3E635",
						];
						chartBackgroundColor = data.values.map(
							(_, index) => colorPalette[index % colorPalette.length] + "CC",
						);
						chartBorderColor = data.values.map(
							(_, index) => colorPalette[index % colorPalette.length],
						);
					} else {
						chartBackgroundColor =
							theme === "dark"
								? "rgba(239, 68, 68, 0.3)"
								: "rgba(239, 68, 68, 0.5)";
						chartBorderColor = "rgba(239, 68, 68, 1)";
					}

					chartInstanceRef.current = new Chart(ctx, {
						type: chartType,
						data: {
							labels: data.labels,
							datasets: [
								{
									label: yAxisLabel,
									data: data.values,
									backgroundColor: chartBackgroundColor,
									borderColor: chartBorderColor,
									borderWidth: chartType === "bar" ? 1 : 2,
									tension: 0.1,
								},
							],
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							scales: {
								y: {
									beginAtZero: true,
									ticks: {
										callback: (value) => yAxisFormatter(value),
										color: theme === "dark" ? "#D1D5DB" : "#4B5563",
									},
									grid: { color: theme === "dark" ? "#4B5563" : "#E5E7EB" },
								},
								x: {
									ticks: { color: theme === "dark" ? "#D1D5DB" : "#4B5563" },
									grid: { display: false },
								},
							},
							plugins: {
								legend: { display: false },
								tooltip: {
									zIndex: 9999, // <-- PERUBAHAN DI SINI
									callbacks: {
										label: (context) =>
											`${context.dataset.label}: ${formatRupiahDisplay(context.parsed.y)}`,
									},
								},
							},
						},
					});
					return () => chartInstanceRef.current?.destroy();
				}, [data, theme, chartType, yAxisFormatter, yAxisLabel]);

				const getButtonClass = (p) =>
					`px-3 py-1 text-xs font-semibold rounded-md transition ${period === p ? "bg-white dark:bg-gray-800 shadow" : ""}`;

				return (
					<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 h-full flex flex-col">
						<div className="flex justify-between items-center mb-4">
							<h3 className="text-xl font-bold">{title}</h3>
							<div className="flex bg-gray-200 dark:bg-gray-600 p-1 rounded-lg">
								<button
									onClick={() => onPeriodChange("daily")}
									className={getButtonClass("daily")}
								>
									Daily
								</button>
								<button
									onClick={() => onPeriodChange("week")}
									className={getButtonClass("week")}
								>
									Weekly
								</button>
								<button
									onClick={() => onPeriodChange("month")}
									className={getButtonClass("month")}
								>
									Monthly
								</button>
							</div>
						</div>
						<div className="flex-grow relative h-80">
							<canvas ref={chartRef}></canvas>
						</div>
					</div>
				);
			}

			const formatRupiahCompact = (number) => {
				if (isNaN(number) || number === null) return "Rp 0";
				// Ubah menjadi jutaan jika lebih dari atau sama dengan 1 juta
				if (Math.abs(number) >= 1000000) {
					return (
						"Rp " + (number / 1000000).toFixed(1).replace(/\.0$/, "") + "jt"
					);
				}
				// Ubah menjadi ribuan jika lebih dari atau sama dengan 1000
				if (Math.abs(number) >= 1000) {
					return "Rp " + (number / 1000).toFixed(0) + "rb";
				}
				// Tampilkan seperti biasa jika di bawah 1000
				return "Rp " + number;
			};

											function FinancialReportPage({ userId, stockData, invoicesData }) {
				const [itemsMissingPrice, setItemsMissingPrice] = useState([]);

				const getInitialFilterMode = () =>
					localStorage.getItem("reportFilterMode") || "month";
				const getInitialDateRange = () => {
					const saved = localStorage.getItem("reportDateRange");
					return saved ? JSON.parse(saved) : { start: "", end: "" };
				};
				const [filterMode, setFilterMode] = useState(getInitialFilterMode);
				const [dateRange, setDateRange] = useState(getInitialDateRange);
				const [selectedMonth, setSelectedMonth] = useState("");
				const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
				const datePickerButtonRef = useRef(null);
				const [copyStatus, setCopyStatus] = useState("Copy");
				const [hideNominals, setHideNominals] = useState(false);
				const [listingPrices, setListingPrices] = useState({});
				const writeTimeoutRef = useRef(null);
				
				const [confirmingPurchaser, setConfirmingPurchaser] = useState(null);
				const [itemsToConfirmPaid, setItemsToConfirmPaid] = useState([]);
				const [isUpdatingStatus, setIsUpdatingStatus] = useState(false);

				const [unpaidDetailsModalItems, setUnpaidDetailsModalItems] = useState(null);

				const [mainChartPeriod, setMainChartPeriod] = useState(
					() => localStorage.getItem(`mainChartPeriod_${userId}`) || "week",
				);

				const [pieChartFilter, setPieChartFilter] = useState("available");
				const [distributionChartType, setDistributionChartType] =
					useState("pie");
				const [isDistributionLegendVisible, setIsDistributionLegendVisible] = useState(true);
				const [isLoadingSettings, setIsLoadingSettings] = useState(true);
				const isInitialLoad = useRef(true);

				const isDesktop = useMediaQuery("(min-width: 1024px)");

				useEffect(() => {
					localStorage.setItem("reportFilterMode", filterMode);
				}, [filterMode]);
				useEffect(() => {
					localStorage.setItem("reportDateRange", JSON.stringify(dateRange));
				}, [dateRange]);
				useEffect(() => {
					localStorage.setItem(`mainChartPeriod_${userId}`, mainChartPeriod);
				}, [mainChartPeriod, userId]);

				useEffect(() => {
					if (!userId || !db) return;
					const settingsDocRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"settings",
						"report_settings",
					);

					const loadSettings = async () => {
						try {
							const docSnap = await window.firebase.getDoc(settingsDocRef);
							if (docSnap.exists()) {
								const settings = docSnap.data();
								setPieChartFilter(settings.pieChartFilter || "available");
								setDistributionChartType(
									settings.distributionChartType || "pie",
								);
								setIsDistributionLegendVisible(settings.isDistributionLegendVisible ?? true);
							}
						} catch (error) {
							console.error("Gagal memuat setting laporan:", error);
						} finally {
							setIsLoadingSettings(false);
							setTimeout(() => {
								isInitialLoad.current = false;
							}, 500);
						}
					};

					loadSettings();
				}, [userId]);

				useEffect(() => {
					if (isInitialLoad.current || isLoadingSettings) return;

					if (!userId || !db) return;

					const settingsDocRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"settings",
						"report_settings",
					);

					const saveSettings = async () => {
						try {
							await window.firebase.setDoc(
								settingsDocRef,
								{
									pieChartFilter,
									distributionChartType,
									isDistributionLegendVisible,
								},
								{ merge: true },
							);
						} catch (error) {
							console.error("Gagal menyimpan setting laporan:", error);
						}
					};

					const debounceSave = setTimeout(saveSettings, 1000);
					return () => clearTimeout(debounceSave);
				}, [pieChartFilter, distributionChartType, isDistributionLegendVisible, userId, isLoadingSettings]);

				useEffect(() => {
					if (!userId || !db) return;
					const docRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"settings",
						"listing_prices",
					);
					const unsubscribe = window.firebase.onSnapshot(
						docRef,
						(doc) => {
							if (doc.exists()) setListingPrices(doc.data().prices || {});
						},
						console.error,
					);
					return () => unsubscribe();
				}, [userId]);
				useEffect(
					() => () => {
						if (writeTimeoutRef.current) clearTimeout(writeTimeoutRef.current);
					},
					[],
				);

				const handleToggleDistributionLegend = () => {
					setIsDistributionLegendVisible(prev => !prev);
				};

				const availableMonths = useMemo(() => {
					const getMonthKey = (ts) => {
						if (!ts) return null;
						const d = ts.toDate ? ts.toDate() : new Date(ts);
						return isNaN(d.getTime())
							? null
							: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
					};
					const keys = new Set();
					[...stockData, ...invoicesData].forEach((item) => {
						const date = item.date || item.deliveryDate || item.soldDate;
						if (date) keys.add(getMonthKey(date));
					});
					if (keys.size === 0) keys.add(getMonthKey(new Date()));
					return [...keys].filter(Boolean).sort().reverse();
				}, [stockData, invoicesData]);
				useEffect(() => {
					if (availableMonths.length > 0 && !selectedMonth) {
						setSelectedMonth(availableMonths[0]);
					}
				}, [availableMonths, selectedMonth]);

				const timeFilteredReport = useMemo(() => {
					const report = {
						totalOmzet: 0,
						totalProfit: 0,
						totalHpp: 0,
						totalUnitsSold: 0,
						totalUnitsPurchased: 0,
						modelCountsPurchased: {},
						modelCountsSold: {},
					};
					const getMonthKey = (date) =>
						`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
					const isInRange = (timestamp) => {
						if (!timestamp) return false;
						const date = timestamp.toDate
							? timestamp.toDate()
							: new Date(timestamp);
						if (isNaN(date.getTime())) return false;
						if (filterMode === "month")
							return getMonthKey(date) === selectedMonth;
						if (filterMode === "range") {
							const start = dateRange.start
								? new Date(dateRange.start).setHours(0, 0, 0, 0)
								: 0;
							const end = dateRange.end
								? new Date(dateRange.end).setHours(23, 59, 59, 999)
								: Infinity;
							return date.getTime() >= start && date.getTime() <= end;
						}
						return false;
					};
					invoicesData.forEach((inv) => {
						if (isInRange(inv.date)) {
							report.totalOmzet += inv.total || 0;
							const itemsProfit = inv.items.reduce((sum, i) => {
								const qty = i.quantity || 1;
								const itemProfit = (i.soldPrice || 0) - (i.hpp || 0);
								return sum + itemProfit * qty;
							}, 0);
							let costsBorneBySeller = 0;
							if (inv.otherCostsList && Array.isArray(inv.otherCostsList)) {
								costsBorneBySeller = inv.otherCostsList.reduce((sum, cost) => {
									return sum + (cost.sellerAmount || 0);
								}, 0);
							}
							report.totalProfit +=
								itemsProfit - (inv.discount || 0) - costsBorneBySeller;
							report.totalUnitsSold += inv.items.reduce(
								(acc, item) => acc + (item.quantity || 1),
								0,
							);
							(inv.items || []).forEach((item) => {
								const modelKey = item.phoneModel || item.itemName || "N/A";
								const quantity = item.quantity || 1;
								const hppValue = (item.hpp || 0) * quantity;
								if (!report.modelCountsSold[modelKey]) {
									report.modelCountsSold[modelKey] = { value: 0, count: 0 };
								}
								report.modelCountsSold[modelKey].value += hppValue;
								report.modelCountsSold[modelKey].count += quantity;
							});
						}
					});
					stockData.forEach((item) => {
						if (
							isInRange(item.deliveryDate) &&
							item.availability !== "Refunded"
						) {
							report.totalHpp += item.hpp || 0;
							report.totalUnitsPurchased += 1;
							const modelKey = item.phoneModel || "N/A";
							if (!report.modelCountsPurchased[modelKey]) {
								report.modelCountsPurchased[modelKey] = { value: 0, count: 0 };
							}
							report.modelCountsPurchased[modelKey].value += item.hpp || 0;
							report.modelCountsPurchased[modelKey].count += 1;
						}
					});
					return report;
				}, [stockData, invoicesData, filterMode, selectedMonth, dateRange]);

				const currentStateReport = useMemo(() => {
					const report = {
						unitBreakdown: [],
						modelCountsAvailable: {},
						modelCountsSoldAllTime: {},
						inventoryValue: {
							total: 0,
							available: { total: 0, count: 0 },
							onDelivery: { total: 0, count: 0 },
						},
					};
					stockData.forEach((item) => {
						const simpleModelKey = item.phoneModel || "N/A";
						const hpp = item.hpp || 0;
						if (item.availability === "Available") {
							if (!report.modelCountsAvailable[simpleModelKey]) {
								report.modelCountsAvailable[simpleModelKey] = {
									value: 0,
									count: 0,
								};
							}
							report.modelCountsAvailable[simpleModelKey].value += hpp;
							report.modelCountsAvailable[simpleModelKey].count += 1;
							report.inventoryValue.available.total += hpp;
							report.inventoryValue.available.count += 1;
							const unitKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
							let unit = report.unitBreakdown.find((u) => u.key === unitKey);
							if (!unit) {
								unit = {
									key: unitKey,
									model: item.phoneModel,
									storage: item.storage,
									ram: item.ram,
									color: item.color,
									count: 0,
								};
								report.unitBreakdown.push(unit);
							}
							unit.count++;
						} else if (item.availability === "On Delivery") {
							report.inventoryValue.onDelivery.total += hpp;
							report.inventoryValue.onDelivery.count += 1;
						} else if (item.availability === "SOLD") {
							report.modelCountsSoldAllTime[simpleModelKey] =
								(report.modelCountsSoldAllTime[simpleModelKey] || 0) + 1;
						}
					});
					report.inventoryValue.total =
						report.inventoryValue.available.total +
						report.inventoryValue.onDelivery.total;

					report.unitBreakdown.sort((a, b) => {
						const modelCompare = (a.model || "").localeCompare(b.model || "");
						if (modelCompare !== 0) return modelCompare;

						const storageA = parseStorage(a.storage);
						const storageB = parseStorage(b.storage);
						if (storageA !== storageB) return storageB - storageA;

						return (a.color || "").localeCompare(b.color || "");
					});

					return report;
				}, [stockData]);

				const averageHppList = useMemo(() => {
					const avgData = {};
					stockData.forEach((item) => {
						if (
							item.availability !== "Available" &&
							item.availability !== "On Delivery"
						)
							return;
						const modelKey = [
							item.phoneModel || "N/A",
							item.storage || "",
							item.ram || "",
						]
							.filter(Boolean)
							.join(" ");
						const hpp = item.hpp || 0;
						if (!avgData[modelKey]) {
							avgData[modelKey] = {
								availableHpp: 0,
								availableCount: 0,
								combinedHpp: 0,
								combinedCount: 0,
								hasOnDelivery: false,
							};
						}
						avgData[modelKey].combinedHpp += hpp;
						avgData[modelKey].combinedCount += 1;
						if (item.availability === "Available") {
							avgData[modelKey].availableHpp += hpp;
							avgData[modelKey].availableCount += 1;
						}
						if (item.availability === "On Delivery") {
							avgData[modelKey].hasOnDelivery = true;
						}
					});
					return Object.entries(avgData)
						.map(([model, data]) => ({
							model,
							avgHppAvailable:
								data.availableCount > 0
									? data.availableHpp / data.availableCount
									: 0,
							avgHppCombined:
								data.hasOnDelivery && data.combinedCount > 0
									? data.combinedHpp / data.combinedCount
									: 0,
						}))
						.sort((a, b) => a.model.localeCompare(b.model));
				}, [stockData]);

				const unpaidHppStats = useMemo(() => {
					return stockData.reduce(
						(acc, item) => {
							if (
								item.paidStatus === "Unpaid" &&
								item.availability !== "Refunded"
							) {
								const unpaidValue = item.unpaidHpp !== undefined ? item.unpaidHpp : (item.hpp || 0);
								const purchaser = item.purchaser || "Unknown";
								acc.total += unpaidValue;
								const target =
									item.availability === "On Delivery"
										? acc.onDelivery
										: acc.delivered;
								target[purchaser] = (target[purchaser] || 0) + unpaidValue;
							}
							return acc;
						},
						{ total: 0, onDelivery: {}, delivered: {} },
					);
				}, [stockData]);

				const { profitChartData, inventoryValueChartData } = useMemo(() => {
					const today = new Date();
					const periods = [];
					let lookback;
					const chartPeriod = mainChartPeriod;

					switch (chartPeriod) {
						case "daily":
							lookback = 30;
							for (let i = 0; i < lookback; i++) {
								const date = new Date(
									today.getTime() - i * 24 * 60 * 60 * 1000,
								);
								const label = date.toLocaleString("en-US", {
									day: "numeric",
									month: "short",
								});
								const start = new Date(date);
								start.setHours(0, 0, 0, 0);
								const end = new Date(date);
								end.setHours(23, 59, 59, 999);
								periods.unshift({ label, start, end });
							}
							break;
						case "month":
							lookback = 12;
							for (let i = 0; i < lookback; i++) {
								const date = new Date(
									today.getFullYear(),
									today.getMonth() - i,
									1,
								);
								const label = date.toLocaleString("en-US", {
									month: "short",
									year: "numeric",
								});
								const start = new Date(date);
								const end = new Date(
									date.getFullYear(),
									date.getMonth() + 1,
									0,
									23,
									59,
									59,
									999,
								);
								periods.unshift({ label, start, end });
							}
							break;
						case "week":
						default:
							lookback = 12;
							for (let i = lookback - 1; i >= 0; i--) {
								const date = new Date();
								date.setDate(date.getDate() - i * 7);
								const dayOfWeek = date.getDay();
								const start = new Date(date);
								start.setDate(
									date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1),
								);
								start.setHours(0, 0, 0, 0);
								const end = new Date(start);
								end.setDate(start.getDate() + 6);
								end.setHours(23, 59, 59, 999);
								const label = `${start.toLocaleDateString("en-GB", { day: "2-digit", month: "short" })}`;
								if (
									!periods.find((p) => p.start.getTime() === start.getTime())
								) {
									periods.push({ label, start, end });
								}
							}
							break;
					}

					const profitValues = [];
					const inventoryValues = [];
					const labels = periods.map((p) => p.label);
					for (const period of periods) {
						const periodProfit = invoicesData.reduce((sum, inv) => {
							const invDate = inv.date?.toDate();
							if (invDate && invDate >= period.start && invDate <= period.end) {
								const itemsProfit = (inv.items || []).reduce(
									(s, i) =>
										s + ((i.soldPrice || 0) - (i.hpp || 0)) * (i.quantity || 1),
									0,
								);
								let costsBorneBySeller = 0;
								if (inv.otherCostsList && Array.isArray(inv.otherCostsList)) {
									costsBorneBySeller = inv.otherCostsList.reduce((costSum, cost) => {
										return costSum + (cost.sellerAmount || 0);
									}, 0);
								}
								return sum + itemsProfit - (inv.discount || 0) - costsBorneBySeller;
							}
							return sum;
						}, 0);
						profitValues.push(periodProfit);

						const getSafeTime = (ts) => {
							if (!ts) return null;
							const date = ts.toDate ? ts.toDate() : new Date(ts);
							return isNaN(date.getTime()) ? null : date.getTime();
						};

						const periodInventoryValue = stockData
							.filter((item) => {
								const deliveryTs = getSafeTime(item.deliveryDate);
								const soldTs = getSafeTime(item.soldDate);
								const wasDelivered =
									deliveryTs && deliveryTs <= period.end.getTime();

								if (!wasDelivered || item.availability === "Refunded")
									return false;

								if (soldTs) return soldTs > period.end.getTime();

								return item.availability !== "SOLD";
							})
							.reduce((sum, item) => sum + (item.hpp || 0), 0);
						inventoryValues.push(periodInventoryValue);
					}
					return {
						profitChartData: { labels, values: profitValues },
						inventoryValueChartData: { labels, values: inventoryValues },
					};
				}, [stockData, invoicesData, mainChartPeriod]);

				const pieChartData = useMemo(() => {
					switch (pieChartFilter) {
						case "purchased":
							return timeFilteredReport.modelCountsPurchased;
						case "sold":
							return timeFilteredReport.modelCountsSold;
						case "available":
						default:
							return currentStateReport.modelCountsAvailable;
					}
				}, [pieChartFilter, timeFilteredReport, currentStateReport]);

				const handleInitiatePaidConfirmation = (purchaser) => {
					const itemsToConfirm = stockData.filter(item =>
						item.purchaser === purchaser &&
						item.paidStatus === 'Unpaid' &&
						['Available', 'SOLD', 'Refund in process'].includes(item.availability)
					);
					setItemsToConfirmPaid(itemsToConfirm);
					setConfirmingPurchaser(purchaser);
				};

				const handleConfirmPaidForPurchaser = async () => {
					if (!confirmingPurchaser || !userId || !db || isUpdatingStatus)
						return;
					setIsUpdatingStatus(true);
					try {
						const stockCollectionRef = window.firebase.collection(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
						);
						const q = window.firebase.query(
							stockCollectionRef,
							window.firebase.where("purchaser", "==", confirmingPurchaser),
							window.firebase.where("paidStatus", "==", "Unpaid"),
							window.firebase.where("availability", "in", [
								"Available",
								"SOLD",
								"Refund in process",
							]),
						);
						const querySnapshot = await window.firebase.getDocs(q);

						if (querySnapshot.empty) {
							alert(
								`Tidak ada item yang sudah tiba dan belum dibayar yang ditemukan untuk ${confirmingPurchaser}.`,
							);
							setIsUpdatingStatus(false);
							setConfirmingPurchaser(null);
							return;
						}

						const batch = window.firebase.writeBatch(db);
						const updatedDocIds = [];
						const relatedInvoices = new Set();

						querySnapshot.forEach((doc) => {
							const data = doc.data();
							if (data.invoice) {
								relatedInvoices.add(data.invoice);
							}
							batch.update(doc.ref, { paidStatus: "Paid" });
							updatedDocIds.push(doc.id);
						});

						await batch.commit();

						const invoiceList = Array.from(relatedInvoices);
						let logMessage;
						if (invoiceList.length > 0) {
							logMessage = `Order ID(s) ${invoiceList.join(", ")} from "${confirmingPurchaser}" marked as paid (${querySnapshot.size} items).`;
						} else {
							logMessage = `Marked ${querySnapshot.size} item(s) from "${confirmingPurchaser}" as paid (no specific Order IDs found).`;
						}

						await addLog(userId, {
							message: logMessage,
							type: "BULK_MARK_AS_PAID",
							context: {
								purchaser: confirmingPurchaser,
								count: querySnapshot.size,
								updatedDocIds: updatedDocIds,
							},
						});
						alert(
							`${querySnapshot.size} item untuk ${confirmingPurchaser} telah ditandai lunas.`,
						);
					} catch (error) {
						console.error("Error marking items as paid:", error);
						alert("Gagal memperbarui status.");
					} finally {
						setIsUpdatingStatus(false);
						setConfirmingPurchaser(null);
						setItemsToConfirmPaid([]);
					}
				};

				const handleBulkListingPriceChange = (keysToUpdate, newPrice) => {
					const updatedPrices = { ...listingPrices };
					keysToUpdate.forEach((key) => {
						updatedPrices[key] = newPrice;
					});
					setListingPrices(updatedPrices);

					if (writeTimeoutRef.current) clearTimeout(writeTimeoutRef.current);
					
					writeTimeoutRef.current = setTimeout(async () => {
						if (!userId || !db || keysToUpdate.size === 0) return;
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"listing_prices",
						);
						try {
							const payload = { prices: {} };
							keysToUpdate.forEach(key => {
								payload.prices[key] = newPrice;
							});

							await window.firebase.setDoc(docRef, payload, { merge: true });

						} catch (error) {
							console.error("Failed to save bulk listing prices:", error);
						}
					}, 1000);
				};

				const handleListingPriceChange = (key, value) => {
					const rawValue = parseFormattedNumber(value);
					const newPrices = { ...listingPrices, [key]: rawValue };
					setListingPrices(newPrices);

					if (writeTimeoutRef.current) clearTimeout(writeTimeoutRef.current);

					writeTimeoutRef.current = setTimeout(async () => {
						if (!userId || !db) return;
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"listing_prices",
						);
						try {
							await window.firebase.setDoc(
								docRef,
								{
									prices: {
										[key]: rawValue
									},
								},
								{ merge: true },
							);
						} catch (error) {
							console.error("Failed to save listing prices:", error);
						}
					}, 1000);
				};

				const performCopyAction = (prices) => {
					const timestamp = new Date()
						.toLocaleString("id-ID", {
							day: "2-digit",
							month: "2-digit",
							year: "numeric",
							hour: "2-digit",
							minute: "2-digit",
							hour12: false,
						})
						.replace(/\./g, ":");
					const header = `Stock Griphub Ponsel ${timestamp}\n\n`;
					const grouped = currentStateReport.unitBreakdown.reduce(
						(acc, item) => {
							const key = [item.model, item.storage, item.ram]
								.filter(Boolean)
								.join(" ");
							if (!acc[key]) acc[key] = [];
							acc[key].push({
								color: item.color,
								count: item.count,
								price: prices[item.key] || 0,
							});
							return acc;
						},
						{},
					);
					const body = Object.entries(grouped)
						.map(([model, variants]) => {
							const price =
								variants[0].price > 0 &&
								variants.every((v) => v.price === variants[0].price)
									? ` @${formatRupiahDisplay(variants[0].price).replace(/\s/g, "")}`
									: "";
							return (
								`${model}${price}\n` +
								variants
									.map(
										(v) =>
											`${v.count} ${v.color}${price ? "" : v.price > 0 ? ` @${formatRupiahDisplay(v.price).replace(/\s/g, "")}` : ""}`,
									)
									.join("\n")
							);
						})
						.join("\n\n");

					navigator.clipboard.writeText(header + body).then(
						() => setCopyStatus("Copied!"),
						() => setCopyStatus("Failed!"),
					);
					setTimeout(() => setCopyStatus("Copy"), 2000);
				};

				const handleCopy = () => {
					if (
						!currentStateReport.unitBreakdown ||
						currentStateReport.unitBreakdown.length === 0
					)
						return;

					const missing = currentStateReport.unitBreakdown.filter(
						(item) => !(listingPrices[item.key] > 0),
					);

					if (missing.length > 0) {
						setItemsMissingPrice(missing);
					} else {
						performCopyAction(listingPrices);
					}
				};

				const handleSaveMissingPricesAndCopy = (newPrices) => {
					const updatedLocalPrices = { ...listingPrices, ...newPrices };

					setListingPrices(updatedLocalPrices);

					if (writeTimeoutRef.current) clearTimeout(writeTimeoutRef.current);
					writeTimeoutRef.current = setTimeout(async () => {
						if (!userId || !db || Object.keys(newPrices).length === 0) return;
						const docRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"settings",
							"listing_prices",
						);
						try {
							const payload = {};
							Object.keys(newPrices).forEach((key) => {
								payload[`prices.${key}`] = newPrices[key];
							});
							await window.firebase.updateDoc(docRef, payload);
						} catch (error) {
							console.error("Failed to save missing prices:", error);
						}
					}, 500);

					performCopyAction(updatedLocalPrices);

					setItemsMissingPrice([]);
				};

				const formatDisplayDateRange = () => {
					if (!dateRange.start || !dateRange.end) return "Select Date Range";
					const options = { month: "short", day: "numeric", year: "numeric" };
					const start = new Date(dateRange.start).toLocaleDateString(
						"en-US",
						options,
					);
					const end = new Date(dateRange.end).toLocaleDateString(
						"en-US",
						options,
					);
					return `${start} - ${end}`;
				};
				const unpaidDeliveredDetails = Object.entries(unpaidHppStats.delivered);
				const unpaidOnDeliveryDetails = Object.entries(
					unpaidHppStats.onDelivery,
				);

				const UnpaidDetailsModal = ({ items, onClose }) => {
					const purchaserName = items.length > 0 ? items[0].purchaser : '...';
					const totalValue = useMemo(() => items.reduce((sum, item) => sum + (item.unpaidHpp !== undefined ? item.unpaidHpp : (item.hpp || 0)), 0), [items]);
					
					
					useEffect(() => {
						
						document.body.classList.add("overflow-hidden");

					
						return () => {
							document.body.classList.remove("overflow-hidden");
						};
					}, []); 


					return (
						<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10000] p-4">
							<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md max-h-[80vh] flex flex-col">
								<h3 className="text-lg font-bold mb-4 flex-shrink-0">
									Rincian "On Delivery" untuk {purchaserName}
								</h3>
								<div className="flex-grow overflow-y-auto pr-2 space-y-2 no-scrollbar">
									{items.map(item => (
										<div key={item.id} className="text-sm p-2 bg-gray-100 dark:bg-gray-700 rounded-md">
											<p className="font-semibold">{[item.phoneModel, item.storage, item.color].filter(Boolean).join(" ")}</p>
											<div className="flex justify-between items-center mt-1">
												<span className="text-xs text-gray-500 dark:text-gray-400">Order ID: {item.invoice}</span>
												<span className="font-mono font-semibold">{formatRupiahDisplay(item.unpaidHpp !== undefined ? item.unpaidHpp : (item.hpp || 0))}</span>
											</div>
										</div>
									))}
								</div>
								<div className="flex justify-between items-center font-bold text-base mt-4 pt-3 border-t border-gray-300 dark:border-gray-600 flex-shrink-0">
									<span>Total Terutang:</span>
									<span>{formatRupiahDisplay(totalValue)}</span>
								</div>
								<div className="mt-6 text-right flex-shrink-0">
									<button onClick={onClose} className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
										Tutup
									</button>
								</div>
							</div>
						</div>
					);
				};

				if (isLoadingSettings) {
					return (
						<div className="container mx-auto">
							<div className="flex justify-center items-center h-64">
								<p>Loading report settings...</p>
							</div>
						</div>
					);
				}

				return (
					<div className="container mx-auto">
						{itemsMissingPrice.length > 0 && (
							<MissingPricesModal
								items={itemsMissingPrice}
								onSave={handleSaveMissingPricesAndCopy}
								onCancel={() => setItemsMissingPrice([])}
							/>
						)}
						{unpaidDetailsModalItems && (
							<UnpaidDetailsModal items={unpaidDetailsModalItems} onClose={() => setUnpaidDetailsModalItems(null)} />
						)}

						{confirmingPurchaser && (
							<ConfirmationModal
								title="Konfirmasi Pembayaran"
								message={`Berikut adalah rincian item terutang dari "${confirmingPurchaser}" yang akan ditandai LUNAS:`}
								detailsList={itemsToConfirmPaid}
								onConfirm={handleConfirmPaidForPurchaser}
								onCancel={() => {
									setConfirmingPurchaser(null);
									setItemsToConfirmPaid([]);
								}}
								confirmText={isUpdatingStatus ? "Memproses..." : "Ya, Tandai Lunas"}
								cancelText="Batal"
								isConfirming={isUpdatingStatus}
							/>
						)}
						<div className="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
							<div className="flex items-center gap-4">
								<h2 className="text-3xl font-bold">Financial Report</h2>
								<button
									onClick={() => setHideNominals(!hideNominals)}
									className="p-2 rounded-full text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700/50 hover:bg-gray-300 dark:hover:bg-gray-700 focus:outline-none"
									title={hideNominals ? "Show values" : "Hide values"}
								>
									{hideNominals ? (
										<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
											<path fillRule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.953 9.953 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 110-4 2 2 0 010 4z" clipRule="evenodd" />
											<path d="M2 10s3.939 6 8 6 8-6 8-6-3.939-6-8-6-8 6-8 6z" />
										</svg>
									) : (
										<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
											<path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
											<path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" />
										</svg>
									)}
								</button>
							</div>

							<div className="flex flex-wrap items-center justify-center sm:justify-end gap-2 md:gap-4 w-full sm:w-auto">
								<div className="flex bg-gray-200 dark:bg-gray-700 p-1 rounded-lg border border-gray-300 dark:border-gray-600">
									<button
										onClick={() => setFilterMode("month")}
										className={`px-3 py-1 text-sm font-semibold rounded-md transition  ${filterMode === "month" ? "bg-white dark:bg-gray-900 shadow" : ""}`}
									>
										By Month
									</button>
									<button
										onClick={() => setFilterMode("range")}
										className={`px-3 py-1 text-sm font-semibold rounded-md transition ${filterMode === "range" ? "bg-white dark:bg-gray-900 shadow" : ""}`}
									>
										By Range
									</button>
								</div>
								<div className="relative">
									{filterMode === "month" ? (
										<div className="relative">
											<select
												value={selectedMonth}
												onChange={(e) => setSelectedMonth(e.target.value)}
												className="appearance-none w-full bg-gray-200 dark:bg-gray-700 p-2 pl-3 pr-8 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
											>
												{availableMonths.map((month) => (
													<option key={month} value={month}>
														{new Date(month + "-02").toLocaleString("default", {
															month: "long",
															year: "numeric",
														})}
													</option>
												))}
											</select>
											<div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
												<svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
													<path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
												</svg>
											</div>
										</div>
									) : (
										<button
											ref={datePickerButtonRef}
											onClick={() => setIsDatePickerOpen(true)}
											className="bg-gray-200 dark:bg-gray-700 p-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-semibold"
										>
											{formatDisplayDateRange()}
										</button>
									)}
									<DateRangePickerPopover
										isOpen={isDatePickerOpen}
										onClose={() => setIsDatePickerOpen(false)}
										onApply={(range) => setDateRange(range)}
										currentRange={dateRange}
										positionRef={datePickerButtonRef}
									/>
								</div>
							</div>
						</div>
						<div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
							<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
								<div className="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg">
										<h3 className="text-xl font-bold mb-4">
											Total Omzet (Filtered)
										</h3>
										<p className="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2">
											{hideNominals
												? "Rp ******"
												: formatRupiahDisplay(timeFilteredReport.totalOmzet)}
										</p>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg">
										<h3 className="text-xl font-bold mb-4">
											Total Profit (Filtered)
										</h3>
										<p
											className={`text-3xl font-bold mt-2 ${timeFilteredReport.totalProfit < 0 ? "text-red-600 dark:text-red-400" : "text-green-600 dark:text-green-400"}`}
										>
											{hideNominals
												? "Rp ******"
												: formatRupiahDisplay(timeFilteredReport.totalProfit)}
										</p>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg">
										<h3 className="text-xl font-bold mb-4">
											Total HPP (Purchased, Filtered)
										</h3>
										<p className="text-3xl font-bold text-yellow-600 dark:text-yellow-400 mt-2">
											{hideNominals
												? "Rp ******"
												: formatRupiahDisplay(timeFilteredReport.totalHpp)}
										</p>
									</div>
									
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg flex flex-col">
										{/* --- START: UPDATED UNPAID HPP CARD --- */}
										<h3 className="text-xl font-bold mb-2">Total Unpaid HPP (All Time)</h3>
										<p className="text-3xl font-bold text-red-500 dark:text-red-400">
											{hideNominals ? "Rp ******" : formatRupiahDisplay(unpaidHppStats.total)}
										</p>
										<div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 grid grid-cols-1 xl:grid-cols-2 gap-x-6 gap-y-4 flex-grow">
											<div className="flex flex-col">
												<span className="text-sm font-semibold">
													On Delivery
												</span>
												<div className="flex-grow max-h-40 overflow-y-auto pr-2 space-y-1 no-scrollbar">
													<table className="w-full text-sm">
														<tbody>
															{unpaidOnDeliveryDetails.length > 0 ? unpaidOnDeliveryDetails.map(([purchaser, amount]) => (
																<tr key={`deliv-${purchaser}`}>
																	<td className="py-0.5 pr-2 text-left">{purchaser}</td>
																	<td className="py-0.5 text-right">
																		<div className="flex items-center justify-end gap-1">
																			<span className="font-mono text-blue-600 dark:text-blue-400 whitespace-nowrap">
																				{/* MODIFICATION HERE */}
																				{hideNominals ? "***" : formatNumberInput(amount)}
																			</span>
																			<button
																				onClick={() => {
																					const details = stockData.filter(item => item.purchaser === purchaser && item.paidStatus === 'Unpaid' && item.availability === 'On Delivery');
																					setUnpaidDetailsModalItems(details);
																				}}
																				className="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-white"
																				title={`Lihat rincian untuk ${purchaser}`}
																			>
																				<svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" /></svg>
																			</button>
																		</div>
																	</td>
																</tr>
															)) : (
																<tr><td colSpan="2" className="text-center text-gray-500 text-xs py-2">Tidak ada.</td></tr>
															)}
														</tbody>
													</table>
												</div>
											</div>
											
											<div className="flex flex-col">
												<span className="text-sm font-semibold">
													Delivered
												</span>
												<div className="flex-grow max-h-40 overflow-y-auto pr-2 space-y-1 no-scrollbar">
													<table className="w-full text-sm">
														 <tbody>
															{unpaidDeliveredDetails.length > 0 ? unpaidDeliveredDetails.map(([purchaser, amount]) => (
																<tr key={`paid-${purchaser}`}>
																	<td className="py-0.5 pr-2 text-left">{purchaser}</td>
																	<td className="py-0.5 text-right">
																		<div className="flex items-center justify-end gap-1">
																			<span className="font-mono text-red-600 dark:text-red-400 whitespace-nowrap">
																				{/* MODIFICATION HERE */}
																				{hideNominals ? "***" : formatNumberInput(amount)}
																			</span>
																			<button
																				onClick={() => handleInitiatePaidConfirmation(purchaser)}
																				className="p-1 rounded-full text-green-500 hover:text-green-700 hover:bg-green-100 dark:hover:bg-green-900/50"
																				title={`Tandai semua utang untuk ${purchaser} sebagai Lunas`}
																			>
																				<svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
																			</button>
																		</div>
																	</td>
																</tr>
															)) : (
																<tr><td colSpan="2" className="text-center text-gray-500 text-xs py-2">Tidak ada.</td></tr>
															)}
														</tbody>
													</table>
												</div>
											</div>
										</div>
										{/* --- END: UPDATED UNPAID HPP CARD --- */}
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg">
										<h3 className="text-xl font-bold mb-2">
											Inventory Value (Current)
										</h3>
										<p className="text-3xl font-bold text-orange-400 dark:text-orange-300 mb-4">
											{hideNominals
												? "Rp ******"
												: formatRupiahDisplay(
														currentStateReport.inventoryValue.total,
													)}
										</p>
										<div className="border-t border-gray-200 dark:border-gray-600 pt-3 flex flex-row gap-x-8">
											<div>
												<span className="text-sm font-semibold">Available</span>
												<p className="text-green-600 dark:text-green-400">
													{hideNominals
														? "Rp ******"
														: formatRupiahDisplay(
																currentStateReport.inventoryValue.available
																	.total,
															)}
												</p>
											</div>
											<div>
												<span className="text-sm font-semibold">
													On Delivery
												</span>
												<p className="text-blue-600 dark:text-blue-400">
													{hideNominals
														? "Rp ******"
														: formatRupiahDisplay(
																currentStateReport.inventoryValue.onDelivery
																	.total,
															)}
												</p>
											</div>
										</div>
									</div>
									<div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-lg">
										<h3 className="text-xl font-bold mb-4">
											Unit Status Summary
										</h3>
										<div className="space-y-4 mt-4">
											<div className="flex justify-between items-baseline">
												<span className="font-medium">Available (Current)</span>
												<p className="text-2xl font-bold text-pink-600">
													{currentStateReport.inventoryValue.available.count}
												</p>
											</div>
											<div className="flex justify-between items-baseline">
												<span className="font-medium">
													On Delivery (Current)
												</span>
												<p className="text-2xl font-bold text-orange-500">
													{currentStateReport.inventoryValue.onDelivery.count}
												</p>
											</div>
											<div className="flex justify-between items-baseline">
												<span className="font-medium">Sold (Filtered)</span>
												<p className="text-2xl font-bold text-cyan-500">
													{timeFilteredReport.totalUnitsSold}
												</p>
											</div>
										</div>
									</div>
								</div>
								{isDesktop ? (
									<React.Fragment>
										<div className="lg:col-span-2">
											<ProfitAndInventoryChart
												title="Historical Performance"
												profitData={profitChartData}
												inventoryValueData={inventoryValueChartData}
												onPeriodChange={setMainChartPeriod}
												period={mainChartPeriod}
											/>
										</div>
										<div className="lg:col-span-1">
											<PriceMovementChart
												stockData={stockData}
												userId={userId}
											/>
										</div>
										<div className="lg:col-span-1">
											<UnitBreakdownCard
												data={currentStateReport.unitBreakdown}
												handleCopy={handleCopy}
												copyStatus={copyStatus}
												listingPrices={listingPrices}
												onPriceChange={handleListingPriceChange}
												onBulkPriceChange={handleBulkListingPriceChange}
											/>
										</div>
										<div className="lg:col-span-1">
											<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 flex flex-col h-full">
												<h3 className="text-xl font-bold mb-4">
													Average HPP (Current Stock)
												</h3>
												<div className="overflow-y-auto h-80 flex-grow no-scrollbar">
													<div className="space-y-2">
														{averageHppList.length > 0 ? (
															averageHppList.map((item) => (
																<div
																	key={item.model}
																	className="p-2 rounded-lg bg-gray-200 dark:bg-gray-600/50"
																>
																	<p className="text-sm font-bold truncate">
																		{item.model}
																	</p>
																	<div className="flex justify-between text-sm mt-1">
																		<span className="text-gray-500 dark:text-gray-400">
																			Available:
																		</span>
																		<span className="font-semibold">
																			{hideNominals
																				? "Rp ******"
																				: item.avgHppAvailable > 0
																					? formatRupiahDisplay(
																							item.avgHppAvailable,
																						)
																					: "N/A"}
																		</span>
																	</div>
																	<div className="flex justify-between text-sm mt-1">
																		<span className="text-gray-500 dark:text-gray-400">
																			+ On Delivery:
																		</span>
																		<span className="font-semibold">
																			{hideNominals
																				? "Rp ******"
																				: item.avgHppCombined > 0
																					? formatRupiahDisplay(
																							item.avgHppCombined,
																						)
																					: "N/A"}
																		</span>
																	</div>
																</div>
															))
														) : (
															<div className="p-10 text-center text-gray-500">
																No stock found.
															</div>
														)}
													</div>
												</div>
											</div>
										</div>
										<div className="lg:col-span-1">
											<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 flex flex-col h-full">
												<ModelDistributionChart
													chartData={pieChartData}
													chartType={distributionChartType}
													onChartTypeChange={setDistributionChartType}
													filter={pieChartFilter}
													onFilterChange={setPieChartFilter}
													isLegendVisible={isDistributionLegendVisible}
													onToggleLegend={handleToggleDistributionLegend}
												/>
											</div>
										</div>
									</React.Fragment>
								) : (
									<React.Fragment>
										<div className="md:col-span-1">
											<ProfitAndInventoryChart
												title="Profit & Inventory History"
												profitData={profitChartData}
												inventoryValueData={inventoryValueChartData}
												onPeriodChange={setMainChartPeriod}
												period={mainChartPeriod}
											/>
										</div>
										<div className="md:col-span-1">
											<PriceMovementChart
												stockData={stockData}
												userId={userId}
											/>
										</div>
										<div className="md:col-span-1">
											<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 flex flex-col h-full">
												<ModelDistributionChart
													chartData={pieChartData}
													chartType={distributionChartType}
													onChartTypeChange={setDistributionChartType}
													filter={pieChartFilter}
													onFilterChange={setPieChartFilter}
													isLegendVisible={isDistributionLegendVisible}
													onToggleLegend={handleToggleDistributionLegend}
												/>
											</div>
										</div>
										<div className="md:col-span-1">
											<div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 flex flex-col h-full">
												<h3 className="text-xl font-bold mb-4">
													Average HPP (Current Stock)
												</h3>
												<div className="overflow-y-auto h-80 flex-grow no-scrollbar">
													<div className="space-y-2">
														{averageHppList.length > 0 ? (
															averageHppList.map((item) => (
																<div
																	key={item.model}
																	className="p-2 rounded-lg bg-gray-200 dark:bg-gray-600/50"
																>
																	<p className="text-sm font-bold truncate">
																		{item.model}
																	</p>
																	<div className="flex justify-between text-sm mt-1">
																		<span className="text-gray-500 dark:text-gray-400">
																			Available:
																		</span>
																		<span className="font-semibold">
																			{hideNominals
																				? "Rp ******"
																				: item.avgHppAvailable > 0
																					? formatRupiahDisplay(
																							item.avgHppAvailable,
																						)
																					: "N/A"}
																		</span>
																	</div>
																	<div className="flex justify-between text-sm mt-1">
																		<span className="text-gray-500 dark:text-gray-400">
																			+ On Delivery:
																		</span>
																		<span className="font-semibold">
																			{hideNominals
																				? "Rp ******"
																				: item.avgHppCombined > 0
																					? formatRupiahDisplay(
																							item.avgHppCombined,
																						)
																					: "N/A"}
																		</span>
																	</div>
																</div>
															))
														) : (
															<div className="p-10 text-center text-gray-500">
																No stock found.
															</div>
														)}
													</div>
												</div>
											</div>
										</div>
										<div className="md:col-span-1">
											<UnitBreakdownCard
												data={currentStateReport.unitBreakdown}
												handleCopy={handleCopy}
												copyStatus={copyStatus}
												listingPrices={listingPrices}
												onPriceChange={handleListingPriceChange}
												onBulkPriceChange={handleBulkListingPriceChange}
											/>
										</div>
									</React.Fragment>
								)}
							</div>
						</div>
					</div>
				);
			}

			function MissingPricesModal({ items, onSave, onCancel }) {
				const [newPrices, setNewPrices] = useState({});

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				const handlePriceChange = (itemKey, value) => {
					const rawValue = parseFormattedNumber(value);
					setNewPrices((prev) => ({ ...prev, [itemKey]: rawValue }));
				};

				const handleSaveAndCopy = () => {
					// Filter out any empty/invalid entries before saving
					const validNewPrices = Object.entries(newPrices).reduce(
						(acc, [key, value]) => {
							if (value > 0) {
								acc[key] = value;
							}
							return acc;
						},
						{},
					);

					if (Object.keys(validNewPrices).length !== items.length) {
						alert("Please fill in a valid price for all items listed.");
						return;
					}

					onSave(validNewPrices);
				};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[10000] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
							<h3 className="text-xl font-bold mb-2">Harga Belum Diisi</h3>
							<p className="text-gray-600 dark:text-gray-300 mb-6">
								Beberapa item belum memiliki harga. Silakan isi untuk
								melanjutkan.
							</p>

							<div className="space-y-3 max-h-60 overflow-y-auto mb-6 pr-2 no-scrollbar">
								{items.map((item) => (
									<div
										key={item.key}
										className="flex flex-col sm:flex-row sm:items-center sm:gap-4 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"
									>
										<div className="flex-grow mb-2 sm:mb-0">
											<p className="font-semibold text-sm">
												{[item.model, item.storage, item.ram]
													.filter(Boolean)
													.join(" ")}
											</p>
											<p className="text-xs text-gray-500 dark:text-gray-400">
												{item.color}
											</p>
										</div>
										<input
											type="text"
											inputMode="numeric"
											placeholder="Set Harga"
											value={formatNumberInput(newPrices[item.key] || "")}
											onChange={(e) =>
												handlePriceChange(item.key, e.target.value)
											}
											className="w-full sm:w-40 p-2 text-sm bg-white dark:bg-gray-800 rounded-md border border-gray-400 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500"
											autoFocus={items.indexOf(item) === 0} // Autofocus on the first input
										/>
									</div>
								))}
							</div>

							<div className="flex justify-end space-x-4">
								<button
									onClick={onCancel}
									className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
								>
									Cancel
								</button>
								<button
									onClick={handleSaveAndCopy}
									className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition"
								>
									Save & Copy
								</button>
							</div>
						</div>
					</div>
				);
			}

			function PhoneDataManagementPage({ userId, phoneData, onOpenCsvModal }) {
				const [editingModel, setEditingModel] = useState(null);
				const [isAddModalOpen, setIsAddModalOpen] = useState(false);
				const [isCardModalOpen, setIsCardModalOpen] = useState(false);
				const handleSave = async ({
					updatedData,
					oldModelName,
					newModelKey,
					renames,
				}) => {
					const phoneDataRef = window.firebase.doc(
						db,
						"artifacts",
						appId,
						"users",
						userId,
						"phone_data",
						"master_list",
					);
					const isModelRename = oldModelName && newModelKey !== oldModelName;

					const fieldMap = {
						phoneModel: "Model",
						color: "Color",
						storage: "Storage",
						ram: "RAM",
					};

					try {
						const batch = window.firebase.writeBatch(db);
						let confirmed = true;
						const logMessages = [];

						// --- Langkah 1: Tangani penggantian nama Model (cascade update) ---
						if (isModelRename) {
							// ... (Logika ini sudah benar, jadi biarkan apa adanya) ...
							const stockCollectionRef = window.firebase.collection(
								db,
								"artifacts",
								appId,
								"users",
								userId,
								"stock",
							);
							const q = window.firebase.query(
								stockCollectionRef,
								window.firebase.where("phoneModel", "==", oldModelName),
							);
							const querySnapshot = await window.firebase.getDocs(q);
							const itemsToUpdateCount = querySnapshot.size;
							if (itemsToUpdateCount > 0) {
								confirmed = window.confirm(
									`Anda mengubah nama model dari "${oldModelName}" menjadi "${newModelKey}".\n\n` +
										`${itemsToUpdateCount} item di Stock List akan diperbarui secara otomatis.\n\n` +
										`Apakah Anda yakin ingin melanjutkan?`,
								);
								if (confirmed) {
									querySnapshot.forEach((doc) => {
										batch.update(doc.ref, { phoneModel: newModelKey });
									});
									logMessages.push(
										`Renamed model to "${newModelKey}" (${itemsToUpdateCount} items)`,
									);
								}
							}
						}
						if (!confirmed) {
							alert("Update dibatalkan.");
							return;
						}

						// --- Langkah 2: Tangani penggantian nama Atribut (cascade update) ---
						for (const field of ["color", "storage", "ram"]) {
							// ... (Logika ini juga sudah benar, biarkan apa adanya) ...
							if (renames[field] && renames[field].length > 0) {
								for (const rename of renames[field]) {
									const stockCollectionRef = window.firebase.collection(
										db,
										"artifacts",
										appId,
										"users",
										userId,
										"stock",
									);
									const q = window.firebase.query(
										stockCollectionRef,
										window.firebase.where("phoneModel", "==", newModelKey),
										window.firebase.where(field, "==", rename.from),
									);
									const querySnapshot = await window.firebase.getDocs(q);
									const itemsToUpdateCount = querySnapshot.size;

									if (itemsToUpdateCount > 0) {
										confirmed = window.confirm(
											`Anda mengubah nama ${fieldMap[field]} dari "${rename.from}" menjadi "${rename.to}" untuk model "${newModelKey}".\n\n` +
												`${itemsToUpdateCount} item di Stock List akan diperbarui secara otomatis.\n\n` +
												`Apakah Anda yakin ingin melanjutkan?`,
										);

										if (confirmed) {
											querySnapshot.forEach((doc) => {
												batch.update(doc.ref, { [field]: rename.to });
											});
											logMessages.push(
												`Renamed ${field} to "${rename.to}" for ${newModelKey} (${itemsToUpdateCount} items)`,
											);
										} else {
											alert("Update dibatalkan.");
											return;
										}
									}
								}
							}
						}

						// --- Langkah 3: Perbarui master data phone_data secara ATOMIK ---
						// ================================================================
						// !!! INI ADALAH PERUBAHAN UTAMA !!!
						// Kita tidak lagi menimpa seluruh objek, tapi hanya field yang relevan.

						const updatePayload = {};
						const newModelData = updatedData[newModelKey];

						// Tambahkan atau perbarui data model baru
						updatePayload[`models.${newModelKey}`] = newModelData;

						// Jika ini adalah aksi penggantian nama, hapus data model lama
						if (isModelRename) {
							updatePayload[`models.${oldModelName}`] =
								window.firebase.deleteField();
						}

						// Gunakan batch.update, bukan batch.set
						batch.update(phoneDataRef, updatePayload);
						// ================================================================

						await batch.commit();

						// --- Logging (Tidak ada perubahan di sini) ---
						if (logMessages.length > 0) {
							await addLog(userId, {
								message: `Phone Data Update: ${logMessages.join("; ")}.`,
								type: "EDIT_PHONE_DATA_CASCADE",
								context: {
									previousPhoneData: phoneData,
									oldModelName: oldModelName,
									newModelKey: newModelKey,
									renames: renames,
								},
							});
						} else {
							const logType = oldModelName
								? "EDIT_PHONE_DATA"
								: "CREATE_PHONE_DATA";
							await addLog(userId, {
								message: `${oldModelName ? "Updated" : "Created"} phone data for model: "${newModelKey}".`,
								type: logType,
							});
						}

						setEditingModel(null);
						setIsAddModalOpen(false);
						alert("Data berhasil disimpan!");
					} catch (error) {
						console.error(
							"Failed to save phone data and cascade updates:",
							error,
						);
						alert("Error saving data. See console for details.");
					}
				};

				const handleDelete = async (modelName) => {
					if (
						!window.confirm(
							`Anda yakin ingin menghapus model "${modelName}"? Aksi ini tidak dapat dibatalkan.`,
						)
					) {
						return;
					}

					try {
						// Periksa apakah model masih digunakan di stok
						const stockCollectionRef = window.firebase.collection(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"stock",
						);
						const q = window.firebase.query(
							stockCollectionRef,
							window.firebase.where("phoneModel", "==", modelName),
							window.firebase.limit(1),
						);
						const querySnapshot = await window.firebase.getDocs(q);

						if (!querySnapshot.empty) {
							alert(
								`Tidak dapat menghapus model "${modelName}" karena masih digunakan oleh item di Stock List. Harap perbarui atau hapus item-item tersebut terlebih dahulu.`,
							);
							return;
						}

						// Gunakan updateDoc dengan deleteField untuk menghapus key dari map
						const phoneDataRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"phone_data",
							"master_list",
						);
						// Payload ini secara spesifik menargetkan key model di dalam map 'models'
						const updatePayload = {
							[`models.${modelName}`]: window.firebase.deleteField(),
						};
						await window.firebase.updateDoc(phoneDataRef, updatePayload);

						await addLog(userId, {
							message: `Deleted phone data model: "${modelName}".`,
							type: "DELETE_PHONE_DATA",
						});
						alert(`Model "${modelName}" berhasil dihapus.`);
					} catch (error) {
						console.error("Failed to delete phone data model:", error);
						alert("Error deleting model. See console for details.");
					}
				};

				return (
					<div className="container mx-auto">
						{/* ===== PERUBAHAN DI SINI: Tombol CSV ditambahkan ===== */}
						<div className="flex flex-wrap justify-between items-center mb-6 gap-4">
							<h2 className="text-3xl font-bold">Manage Phone Data</h2>
							<div className="flex gap-4">
								<button
									onClick={onOpenCsvModal}
									className="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg"
								>
									Export Stock to CSV
								</button>
								<button
									onClick={() => setIsCardModalOpen(true)}
									className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg"
								>
									Manage Cards
								</button>
								<button
									onClick={() => setIsAddModalOpen(true)}
									className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"
								>
									Add New Model
								</button>
							</div>
						</div>
						{/* ===== AKHIR PERUBAHAN ===== */}

						{isAddModalOpen && (
							<EditPhoneDataModal
								phoneData={phoneData}
								onSave={handleSave}
								closeModal={() => setIsAddModalOpen(false)}
							/>
						)}
						{editingModel && (
							<EditPhoneDataModal
								modelName={editingModel}
								modelData={phoneData[editingModel]}
								phoneData={phoneData}
								onSave={handleSave}
								closeModal={() => setEditingModel(null)}
							/>
						)}
						{isCardModalOpen && (
							<CardManagementModal
								userId={userId}
								onClose={() => setIsCardModalOpen(false)}
							/>
						)}

						<div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
							<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
								{Object.keys(phoneData)
									.sort()
									.map((modelName) => (
										<div
											key={modelName}
											className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex flex-col"
										>
											<h3 className="font-bold text-lg mb-2">{modelName}</h3>
											<div className="text-sm text-gray-700 dark:text-gray-300 space-y-1 flex-grow">
												<p>
													<strong>Storage:</strong>{" "}
													{phoneData[modelName].storage.join(", ") || "N/A"}
												</p>
												<p>
													<strong>Colors:</strong>{" "}
													{phoneData[modelName].colors.join(", ") || "N/A"}
												</p>
												<p>
													<strong>RAM:</strong>{" "}
													{phoneData[modelName].ram.join(", ") || "N/A"}
												</p>
											</div>
											<div className="flex gap-2 mt-4">
												<button
													onClick={() => setEditingModel(modelName)}
													className="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
												>
													Edit
												</button>
												<button
													onClick={() => handleDelete(modelName)}
													className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm"
												>
													Delete
												</button>
											</div>
										</div>
									))}
							</div>
						</div>
					</div>
				);
			}

			function EditPhoneDataModal({
				modelName,
				modelData,
				phoneData,
				onSave,
				closeModal,
			}) {
				const [name, setName] = useState(modelName || "");
				const [storage, setStorage] = useState(
					modelData?.storage?.join(", ") || "",
				);
				const [colors, setColors] = useState(
					modelData?.colors?.join(", ") || "",
				);
				const [ram, setRam] = useState(modelData?.ram?.join(", ") || "");
				const [colorImages, setColorImages] = useState(
					modelData?.colorImages || {},
				);

				useEffect(() => {
					document.body.classList.add("overflow-hidden");
					return () => {
						document.body.classList.remove("overflow-hidden");
					};
				}, []);

				const handleColorImageChange = (color, url) => {
					setColorImages((prev) => {
						const newColorImages = { ...prev };
						if (url) {
							newColorImages[color] = url;
						} else {
							delete newColorImages[color]; // Hapus URL jika input kosong
						}
						return newColorImages;
					});
				};

				// Generate daftar warna dari input teks untuk ditampilkan di UI
				const parsedColors = colors
					.split(",")
					.map((c) => c.trim())
					.filter(Boolean);

				const handleSubmit = (e) => {
					e.preventDefault();
					if (!name.trim()) {
						alert("Model name cannot be empty.");
						return;
					}
					const newModelKey = name.trim();
					if (!modelName && phoneData[newModelKey]) {
						alert("A model with this name already exists.");
						return;
					}

					const updatedData = { ...phoneData };
					if (modelName && modelName !== newModelKey) {
						delete updatedData[modelName];
					}

					const oldColors = modelData?.colors || [];
					const newColors = parsedColors; // Gunakan yang sudah diparsing
					const oldStorages = modelData?.storage || [];
					const newStorages = storage
						.split(",")
						.map((s) => s.trim())
						.filter(Boolean);
					const oldRams = modelData?.ram || [];
					const newRams = ram
						.split(",")
						.map((r) => r.trim())
						.filter(Boolean);

					const findRenames = (oldArray, newArray) => {
						const renames = [];
						const oldSet = new Set(oldArray);
						const newSet = new Set(newArray);

						if (oldArray.length === newArray.length) {
							const removed = oldArray.filter((item) => !newSet.has(item));
							const added = newArray.filter((item) => !oldSet.has(item));

							if (removed.length > 0 && removed.length === added.length) {
								for (let i = 0; i < removed.length; i++) {
									renames.push({ from: removed[i], to: added[i] });
								}
							}
						}
						return renames;
					};

					const colorRenames = findRenames(oldColors, newColors);
					const storageRenames = findRenames(oldStorages, newStorages);
					const ramRenames = findRenames(oldRams, newRams);

					// Pastikan hanya URL untuk warna yang ada yang disimpan
					const finalColorImages = {};
					for (const color of newColors) {
						if (colorImages[color]) {
							finalColorImages[color] = colorImages[color];
						}
					}

					updatedData[newModelKey] = {
						storage: newStorages,
						colors: newColors,
						ram: newRams,
						colorImages: finalColorImages, // Simpan objek URL gambar
					};

					onSave({
						updatedData,
						oldModelName: modelName,
						newModelKey: newModelKey,
						renames: {
							color: colorRenames,
							storage: storageRenames,
							ram: ramRenames,
						},
					});
				};

				return (
					<div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4">
						<div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
							<h3 className="text-2xl font-bold mb-6">
								{modelName ? `Edit ${modelName}` : "Add New Phone Model"}
							</h3>
							<form onSubmit={handleSubmit} className="space-y-4">
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										Model Name
									</label>
									<input
										type="text"
										value={name}
										onChange={(e) => setName(e.target.value)}
										required
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										Storage Options (comma separated)
									</label>
									<input
										type="text"
										value={storage}
										onChange={(e) => setStorage(e.target.value)}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										Color Options (comma separated)
									</label>
									<input
										type="text"
										value={colors}
										onChange={(e) => setColors(e.target.value)}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>
								<div>
									<label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
										RAM Options (comma separated)
									</label>
									<input
										type="text"
										value={ram}
										onChange={(e) => setRam(e.target.value)}
										className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"
									/>
								</div>

								{/* Bagian Baru untuk URL Gambar */}
								{parsedColors.length > 0 && (
									<div className="mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
										<h4 className="text-md font-semibold mb-3">
											Color Image URLs (Optional)
										</h4>
										<div className="space-y-3 max-h-48 overflow-y-auto pr-2">
											{parsedColors.map((color) => (
												<div key={color} className="flex items-center gap-3">
													<label
														htmlFor={`img-url-${color}`}
														className="w-1/3 truncate font-medium text-sm text-gray-600 dark:text-gray-300"
													>
														{color}
													</label>
													<input
														id={`img-url-${color}`}
														type="text"
														placeholder="https://.../image.png"
														value={colorImages[color] || ""}
														onChange={(e) =>
															handleColorImageChange(color, e.target.value)
														}
														className="w-2/3 p-2 bg-gray-50 dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-500 text-sm"
													/>
												</div>
											))}
										</div>
									</div>
								)}

								<div className="flex justify-end space-x-4 pt-4">
									<button
										type="button"
										onClick={closeModal}
										className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition"
									>
										Cancel
									</button>
									<button
										type="submit"
										className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition"
									>
										Save
									</button>
								</div>
							</form>
						</div>
					</div>
				);
			}

			function LogPage({ userId }) {
				const [logs, setLogs] = useState([]);
				const [loading, setLoading] = useState(true);
				const [isUndoing, setIsUndoing] = useState(null);
				const LOGS_LIMIT = 100;

				const fetchLogs = useCallback(async () => {
					if (!userId || !db) return;
					setLoading(true);
					try {
						const logsCollectionRef = window.firebase.collection(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"logs",
						);
						const q = window.firebase.query(
							logsCollectionRef,
							window.firebase.orderBy("timestamp", "desc"),
							window.firebase.limit(LOGS_LIMIT),
						);
						const documentSnapshots = await window.firebase.getDocs(q);

						const fetchedLogs = documentSnapshots.docs.map((doc) => ({
							id: doc.id,
							...doc.data(),
						}));
						setLogs(fetchedLogs);
					} catch (error) {
						console.error("Error fetching logs:", error);
					} finally {
						setLoading(false);
					}
				}, [userId]);

				useEffect(() => {
					fetchLogs();
				}, [fetchLogs]);

				const handleUndo = async (log) => {
					if (isUndoing || !log.type || !log.context) return;
					setIsUndoing(log.id);
					try {
						const batch = window.firebase.writeBatch(db);
						let undoMessage = "";
						switch (log.type) {
							case "DELETE_STOCK": {
								const { docId, deletedData } = log.context;
								if (!docId || !deletedData) throw new Error("Invalid context.");
								const { id, ...dataToRestore } = deletedData;
								const docRef = window.firebase.doc(
									db,
									"artifacts",
									appId,
									"users",
									userId,
									"stock",
									docId,
								);
								batch.set(docRef, dataToRestore);
								undoMessage = `Restored deleted item: ${dataToRestore.phoneModel} (IMEI: ${dataToRestore.imei})`;
								break;
							}

							// --- PERUBAHAN 1: Tambahkan case baru di sini ---
							case "ADMIN_IMEI_UPDATE":
							case "ADMIN_DELIVERY_UPDATE": // <-- Tambahkan case ini
							case "ADMIN_COLOR_UPDATE":
							case "ADMIN_IMEI_AND_COLOR_UPDATE":
							case "EMPLOYEE_IMEI_UPDATE":
							case "EMPLOYEE_DELIVERY_UPDATE": // <-- Tambahkan case ini
							case "EMPLOYEE_COLOR_UPDATE":
							case "EMPLOYEE_IMEI_AND_COLOR_UPDATE":
							// Semua case di atas akan "fall-through" dan menjalankan logika yang sama
							case "EDIT_STOCK": {
								const { docId, previousData } = log.context;
								if (!docId || !previousData)
									throw new Error("Invalid context.");
								// Gunakan set bukan update untuk memastikan semua field kembali seperti semula
								const { id, ...dataToRestore } = previousData;
								const docRef = window.firebase.doc(
									db,
									"artifacts",
									appId,
									"users",
									userId,
									"stock",
									docId,
								);
								batch.set(docRef, dataToRestore);
								undoMessage = `Reverted edit on item: ${dataToRestore.phoneModel} (IMEI: ${dataToRestore.imei})`;
								break;
							}
							// --- AKHIR PERUBAHAN 1 ---

							case "BULK_EDIT_STOCK": {
								const { items } = log.context;
								if (!items || !Array.isArray(items))
									throw new Error("Invalid context.");
								for (const item of items) {
									const docRef = window.firebase.doc(
										db,
										"artifacts",
										appId,
										"users",
										userId,
										"stock",
										item.docId,
									);
									batch.update(docRef, item.previousData);
								}
								undoMessage = `Reverted bulk edit on ${items.length} items.`;
								break;
							}
							case "DELETE_INVOICE": {
								const { docId, deletedData } = log.context;
								if (!docId || !deletedData) throw new Error("Invalid context.");
								const { id, stockItemIds, ...dataToRestore } = deletedData;
								const invoiceRef = window.firebase.doc(
									db,
									"artifacts",
									appId,
									"users",
									userId,
									"invoices",
									docId,
								);
								batch.set(invoiceRef, dataToRestore);
								if (stockItemIds && stockItemIds.length > 0) {
									for (const stockId of stockItemIds) {
										const stockDocRef = window.firebase.doc(
											db,
											"artifacts",
											appId,
											"users",
											userId,
											"stock",
											stockId,
										);
										const originalItem = deletedData.items.find(
											(i) => i.id === stockId,
										);
										if (originalItem) {
											batch.update(stockDocRef, {
												availability: "SOLD",
												customer: deletedData.customerName,
												soldPrice: originalItem.soldPrice,
												profit: originalItem.soldPrice - originalItem.hpp,
												soldDate: deletedData.date,
											});
										}
									}
								}
								undoMessage = `Restored deleted invoice: ${deletedData.invoiceNumber}`;
								break;
							}
							case "CREATE_STOCK": {
								const { createdDocIds } = log.context;
								if (!createdDocIds || !Array.isArray(createdDocIds))
									throw new Error("Invalid context.");
								createdDocIds.forEach((docId) => {
									const docRef = window.firebase.doc(
										db,
										"artifacts",
										appId,
										"users",
										userId,
										"stock",
										docId,
									);
									batch.delete(docRef);
								});
								undoMessage = `Reverted creation of ${createdDocIds.length} stock item(s).`;
								break;
							}
							case "BULK_MARK_AS_PAID": {
								const { updatedDocIds, purchaser, count } = log.context;
								if (!updatedDocIds || !Array.isArray(updatedDocIds)) {
									throw new Error(
										"Cannot undo: Log context is missing specific item IDs.",
									);
								}
								for (const docId of updatedDocIds) {
									const docRef = window.firebase.doc(
										db,
										"artifacts",
										appId,
										"users",
										userId,
										"stock",
										docId,
									);
									batch.update(docRef, { paidStatus: "Unpaid" });
								}
								undoMessage = `Reverted bulk "Mark as Paid" for ${count} item(s) from "${purchaser}".`;
								break;
							}
							case "EDIT_PHONE_DATA_CASCADE": {
								const {
									previousPhoneData,
									oldModelName,
									newModelKey,
									renames,
								} = log.context;
								if (!previousPhoneData)
									throw new Error(
										"Invalid context for undoing phone data update.",
									);
								const phoneDataRef = window.firebase.doc(
									db,
									"artifacts",
									appId,
									"users",
									userId,
									"phone_data",
									"master_list",
								);
								batch.set(phoneDataRef, { models: previousPhoneData });
								const stockCollectionRef = window.firebase.collection(
									db,
									"artifacts",
									appId,
									"users",
									userId,
									"stock",
								);
								if (oldModelName && newModelKey !== oldModelName) {
									const q = window.firebase.query(
										stockCollectionRef,
										window.firebase.where("phoneModel", "==", newModelKey),
									);
									const snapshot = await window.firebase.getDocs(q);
									snapshot.forEach((doc) => {
										batch.update(doc.ref, { phoneModel: oldModelName });
									});
								}
								for (const field of ["color", "storage", "ram"]) {
									if (renames[field] && renames[field].length > 0) {
										for (const rename of renames[field]) {
											const q = window.firebase.query(
												stockCollectionRef,
												window.firebase.where("phoneModel", "==", oldModelName),
												window.firebase.where(field, "==", rename.to),
											);
											const snapshot = await window.firebase.getDocs(q);
											snapshot.forEach((doc) => {
												batch.update(doc.ref, { [field]: rename.from });
											});
										}
									}
								}
								undoMessage = `Reverted phone data update for model "${oldModelName || newModelKey}".`;
								break;
							}
							default:
								throw new Error("This action cannot be undone.");
						}
						const logDocRef = window.firebase.doc(
							db,
							"artifacts",
							appId,
							"users",
							userId,
							"logs",
							log.id,
						);
						batch.delete(logDocRef);
						await batch.commit();
						await addLog(userId, {
							message: undoMessage,
							type: "ACTION_UNDONE",
						});
						fetchLogs();
						alert("Action undone successfully!");
					} catch (error) {
						console.error("Error undoing action: ", error);
						alert("Failed to undo the action. " + error.message);
					} finally {
						setIsUndoing(null);
					}
				};

				// --- PERUBAHAN 2: Tambahkan tipe log baru ke daftar yang bisa di-undo ---
				const isUndoable = (log) =>
					[
						"DELETE_STOCK",
						"EDIT_STOCK",
						"BULK_EDIT_STOCK",
						"DELETE_INVOICE",
						"CREATE_STOCK",
						"EDIT_PHONE_DATA_CASCADE",
						"BULK_MARK_AS_PAID",
						"ADMIN_IMEI_UPDATE",
						"ADMIN_COLOR_UPDATE",
						"ADMIN_IMEI_AND_COLOR_UPDATE",
						"EMPLOYEE_IMEI_UPDATE",
						"EMPLOYEE_COLOR_UPDATE",
						"EMPLOYEE_IMEI_AND_COLOR_UPDATE",
						"ADMIN_DELIVERY_UPDATE",
						"EMPLOYEE_DELIVERY_UPDATE",
					].includes(log.type);

				return (
					<div className="container mx-auto">
						<h2 className="text-3xl font-bold mb-6">Activity Log</h2>
						<div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
							{loading ? (
								<div className="text-center p-10">Loading logs...</div>
							) : logs.length > 0 ? (
								<ul className="divide-y divide-gray-200 dark:divide-gray-700">
									{logs.map((log) => (
										<li key={log.id} className="py-4">
											<div className="flex items-center justify-between flex-wrap gap-2">
												<p className="text-sm text-gray-700 dark:text-gray-300 flex-grow">
													{log.message}
												</p>
												<div className="flex items-center gap-4">
													<p className="text-sm text-gray-500 dark:text-gray-500 whitespace-nowrap">
														{formatDate(log.timestamp)}
													</p>
													{isUndoable(log) && (
														<button
															onClick={() => handleUndo(log)}
															disabled={isUndoing === log.id}
															className="px-3 py-1 text-xs font-semibold rounded-md bg-yellow-600 hover:bg-yellow-700 text-white transition disabled:bg-yellow-800 disabled:cursor-wait"
														>
															{isUndoing === log.id ? "Undoing..." : "Undo"}
														</button>
													)}
												</div>
											</div>
										</li>
									))}
								</ul>
							) : (
								<div className="text-center p-10">
									No activities logged yet.
								</div>
							)}
						</div>
					</div>
				);
			}

			ReactDOM.render(<App />, document.getElementById("root"));
		</script>
	</body>
</html>
