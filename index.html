<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark theme, JS will manage this class -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Griphub Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; } /* Custom mono for better rendering */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] { -moz-appearance: textfield; }

        /* A4 Preview Styling */
        .preview-container {
            width: 100%;
            padding-top: 141.42%; /* A4 Aspect Ratio (297/210) */
            position: relative;
        }
        .preview-container .preview-a4 {
            position: absolute;
            top: 0;
            left: 0;
            transform: scale(var(--preview-scale, 1));
            transform-origin: top left;
        }
        .preview-a4 {
            width: 210mm;
            height: 297mm;
            padding: 14mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background: white;
            color: #111827;
            position: relative;
            overflow: hidden;
            box-sizing: border-box; /* Ensures padding is included in width/height */
        }
        .watermark-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: none;
        }
        .watermark {
            transform: rotate(-45deg);
            font-size: 120px;
            font-weight: bold;
            color: rgba(59, 130, 246, 0.1);
            padding: 50px 40px;
            border-radius: 10px;
            letter-spacing: 5px;
            text-align: center;
            white-space: nowrap;
        }
        @media print {
            body, html {
                background: #fff !important;
                color: #000 !important;
            }
            body > *:not(.print-area) {
                display: none;
            }
            #root, #print-root {
                 display: block !important;
            }
            .print-area, .print-area * {
                visibility: visible !importan;
            }
            .print-area {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                transform: scale(1) !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .print-area .preview-a4 {
                 box-shadow: none !important;
                 width: 210mm;
                 height: 297mm;
                 page-break-inside: avoid;
                 overflow: hidden;
            }
        }
    </style>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    mono: ['Roboto Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                },
            },
        },
      }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="root"></div>
    <div id="print-root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, setDoc, deleteDoc, where, getDocs, Timestamp, orderBy, writeBatch, getDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut,
            getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, setDoc, deleteDoc, where, getDocs, Timestamp, orderBy, writeBatch, getDoc, limit
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script type="text/babel">
        // --- React Code Starts Here ---
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            // Your Firebase config is secure and has been retained.
            apiKey: "AIzaSyADsec0BmVk5NeV5BCZIhNt7f6re9Og5hk",
            authDomain: "griphub-stock.firebaseapp.com",
            projectId: "griphub-stock",
            storageBucket: "griphub-stock.firebasestorage.app",
            messagingSenderId: "704654191502",
            appId: "1:704654191502:web:54db4f7167866ea0fa12df",
            measurementId: "G-Q5N08D310B"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;


        // --- Firebase Initialization ---
        let app, auth, db;
        if (firebaseConfig.apiKey && window.firebase) {
            app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
        } else {
            console.error("Firebase config is missing or has not been replaced.");
        }
        
        // --- Helper Functions & Constants ---
        const formatRupiahDisplay = (number) => {
            if (isNaN(number) || number === null) return 'Rp 0';
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }
        
        const formatNumberInput = (value) => {
            if (!value) return '';
            const numberValue = parseInt(value.toString().replace(/[^0-9]/g, ''), 10);
            if (isNaN(numberValue)) return '';
            return numberValue.toLocaleString('id-ID');
        };

        const parseFormattedNumber = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/[^0-9]/g, ''), 10) || 0;
        };

        const formatDate = (date, includeTime = true) => {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
             if (isNaN(d.getTime())) return 'N/A';
            const options = { month: 'short', day: '2-digit', year: 'numeric' };
            if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; options.hour12 = false; }
            return d.toLocaleString('en-US', options).replace(',', '');
        };
        
        const timestampToDateTimeLocal = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
             if (isNaN(date.getTime())) return '';
            const ten = (i) => (i < 10 ? '0' : '') + i;
            return `${date.getFullYear()}-${ten(date.getMonth() + 1)}-${ten(date.getDate())}T${ten(date.getHours())}:${ten(date.getMinutes())}`;
        };
        
        const logoBase64 = 'https://i.imgur.com/SSbdOdP.png';

        const addLog = async (userId, logData) => {
            if (!userId || !db) return;
            try {
                const logCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'logs');
                await window.firebase.addDoc(logCollectionRef, { ...logData, timestamp: window.firebase.Timestamp.fromDate(new Date()) });
            } catch (error) { console.error("Error adding log:", error); }
        };

        const INITIAL_PHONE_DATA = {
            'Samsung S25 Ultra': { storage: ['256GB', '512GB', '1TB'], colors: ['Black', 'Gray', 'Blue', 'White', 'Jetblack', 'Jadegreen', 'Pinkgold'], ram: [] },
            'Samsung S24 Ultra': { storage: ['256GB', '512GB', '1TB'], colors: ['Black', 'Gray'], ram: [] },
            'Samsung A56': { storage: ['256GB'], colors: ['Graphite', 'Lightgray', 'Pink', 'Olive'], ram: ['8GB', '12GB'] },
            'iPhone 13': { storage: ['128GB'], colors: ['Midnight', 'Starlight'], ram: [] },
            'iPhone 15': { storage: ['128GB', '256GB'], colors: ['Black', 'Blue', 'Pink', 'Green', 'Yellow'], ram: [] },
            'iPhone 16 Pro': { storage: ['256GB', '512GB', '1TB'], colors: ['Dessert', 'Black', 'White', 'Natural'], ram: [] },
            'iPhone 16 Pro Max': { storage: ['256GB', '512GB', '1TB'], colors: ['Dessert', 'Black', 'White', 'Natural'], ram: [] },
            'iPad 9': { storage: ['64GB'], colors: ['Silver', 'Gray'], ram: [] },
        };

        const InvoiceTemplate = ({ invoiceData }) => {
            const subTotal = invoiceData.subTotal ?? invoiceData.items.reduce((acc, i) => acc + (i.soldPrice || 0), 0);
            const discount = invoiceData.discount || 0;
            const otherCosts = invoiceData.otherCosts || 0;
            const total = invoiceData.total ?? (subTotal - discount + otherCosts);
            const paymentStatus = invoiceData.paymentStatus || 'Lunas';
            const costDescription = invoiceData.costDescription || 'Biaya Lainnya';
            const amountPaid = paymentStatus === 'Lunas' ? total : 0;
            const balanceDue = paymentStatus === 'Lunas' ? 0 : total;
            
            const groupedItems = useMemo(() => {
                return Object.values(invoiceData.items.reduce((acc, item) => {
                    const key = item.phoneModel ? [item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join(' ') : item.itemName;
                    if (!acc[key]) {
                        acc[key] = { phoneModel: item.phoneModel || item.itemName, storage: item.storage || '', ram: item.ram || '', color: item.color || '', soldPrice: item.soldPrice, imeis: [], quantity: 0, totalAmount: 0 };
                    }
                    if (item.imei) acc[key].imeis.push(item.imei);
                    if (item.serialNumbers) acc[key].imeis.push(...item.serialNumbers);
                    acc[key].quantity += item.quantity || 1;
                    acc[key].totalAmount += (item.soldPrice * (item.quantity || 1));
                    return acc;
                }, {}));
            }, [invoiceData.items]);
            
            return (
                <div className="preview-a4">
                    {paymentStatus && (<div className="watermark-container"><div className="watermark">{paymentStatus.toUpperCase()}</div></div>)}
                    <div className="relative z-20 flex flex-col h-full text-gray-800 text-sm">
                        <div className="flex justify-between items-start mb-4">
                            <img src={logoBase64} alt="Griphub Logo" className="h-20 w-20"/>
                            <div className="text-right"><h4 className="text-4xl font-bold mb-0">INVOICE</h4><p className="text-sm mt-1">#{invoiceData.invoiceNumber}</p></div>
                        </div>
                        <div className="flex justify-between mb-8 text-xs">
                            <div><p className="font-bold">Griphub Ponsel</p><p>NIB 2805240102495</p><p>Jl. Rawabelong Raya No.12</p><p>Palmerah, Jakarta Barat 11480</p></div>
                            <table className="text-right"><tbody>
                                <tr><td className="font-bold pr-2 text-left">Date:</td><td>{formatDate(invoiceData.date, false)}</td></tr>
                                <tr><td className="font-bold pr-2 text-left">Payment Terms:</td><td>{invoiceData.paymentTerms}</td></tr>
                                <tr><td className="font-bold pr-2 text-left">Balance Due:</td><td className="font-bold">{formatRupiahDisplay(balanceDue)}</td></tr>
                            </tbody></table>
                        </div>
                        <div className="mb-6 text-sm"><p className="font-bold">Bill To:</p><p>{invoiceData.customerName}</p><p>{invoiceData.customerPhone}</p></div>
                        <table className="w-full text-left text-xs"><thead className="bg-black text-white"><tr>
                            <th className="p-2 font-bold">Item</th><th className="p-2 font-bold text-center">Qty</th><th className="p-2 font-bold text-center">Rate</th><th className="p-2 font-bold text-center">Amount</th>
                        </tr></thead><tbody>
                            {groupedItems.map((group, idx) => (<tr key={idx} className="border-b">
                                <td className="p-2 align-top text-left">
                                    {[group.phoneModel, group.storage, group.ram, group.color].filter(Boolean).join(' ')}
                                    {group.imeis.length > 0 && (
                                        <div className="mt-1.5 grid grid-cols-4 gap-x-2 gap-y-1 text-gray-600 font-mono">
                                            {group.imeis.map((imei, i) => (
                                                <div key={i}>{imei || '-'}</div>
                                            ))}
                                        </div>
                                    )}
                                </td>
                                <td className="p-2 align-top text-center">{group.quantity}</td>
                                <td className="p-2 align-top text-center">{formatRupiahDisplay(group.soldPrice)}</td>
                                <td className="p-2 align-top text-center">{formatRupiahDisplay(group.totalAmount)}</td>
                            </tr>))}
                        </tbody></table>
                         <div className="flex justify-between pt-20 text-xs">
                            <div><p className="font-bold">Notes:</p><p>Kontak Griphub Ponsel : 08995071749</p><p className="font-bold mt-2">Warranty:</p><p>Garansi Resmi Indonesia 1 Tahun</p></div>
                            <div className="w-2/5">
                                <div className="flex justify-between"><span>Subtotal:</span><span>{formatRupiahDisplay(subTotal)}</span></div>
                                {discount > 0 && <div className="flex justify-between"><span>Discount:</span><span>- {formatRupiahDisplay(discount)}</span></div>}
                                {otherCosts > 0 && <div className="flex justify-between"><span>{costDescription}:</span><span>{formatRupiahDisplay(otherCosts)}</span></div>}
                                <div className="flex justify-between mt-1 pt-1 border-t font-bold text-sm"><span>Total:</span><span>{formatRupiahDisplay(total)}</span></div>
                                <div className="flex justify-between"><span>Amount Paid:</span><span>{formatRupiahDisplay(amountPaid)}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const generateInvoiceCanvas = (invoiceData) => {
            return new Promise((resolve, reject) => {
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                document.body.appendChild(tempContainer);

                const TempInvoiceComponent = () => <InvoiceTemplate invoiceData={invoiceData} />;
                ReactDOM.render(<TempInvoiceComponent />, tempContainer, async () => {
                    try {
                        const a4Element = tempContainer.querySelector('.preview-a4');
                        if (!a4Element) {
                            throw new Error("Could not find .preview-a4 element for canvas generation.");
                        }
                        const canvas = await html2canvas(a4Element, {
                            scale: 3,
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                        resolve(canvas);
                    } catch (error) {
                        reject(error);
                    } finally {
                        ReactDOM.unmountComponentAtNode(tempContainer);
                        document.body.removeChild(tempContainer);
                    }
                });
            });
        };
        
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'dark');

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark';
                root.classList.remove(isDark ? 'light' : 'dark');
                root.classList.add(theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = useCallback(() => {
                setTheme(prevTheme => (prevTheme === 'dark' ? 'light' : 'dark'));
            }, []);

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = window.firebase.onAuthStateChanged(auth, (currentUser) => { setUser(currentUser); setLoading(false); });
                return () => unsubscribe();
            }, []);
            
            if (loading || !auth || !db) return <div className="flex items-center justify-center h-screen"><div className="text-2xl">Initializing...</div></div>;
            if (!user) return <LoginScreen />;
            return <InventoryApp user={user} theme={theme} toggleTheme={toggleTheme} />;
        }
        
        function LoginScreen() {
            const handleGoogleLogin = async () => {
                const provider = new window.firebase.GoogleAuthProvider();
                try { await window.firebase.signInWithPopup(auth, provider); } catch (error) { console.error("Error during Google sign-in:", error); }
            };
            return (
                <div className="min-h-screen flex flex-col justify-center items-center p-4">
                    <img src={logoBase64} alt="Griphub Logo" className="h-24 w-24 mb-6"/>
                    <h1 className="text-4xl font-bold mb-2 text-center text-gray-900 dark:text-white">Griphub Inventory</h1>
                    <p className="text-lg text-gray-600 dark:text-gray-400 mb-8">Silakan login untuk melanjutkan</p>
                    <button onClick={handleGoogleLogin} className="flex items-center bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-200 transition transform hover:scale-105">
                        <svg className="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                        Masuk dengan Google
                    </button>
                </div>
            );
        }

        function ThemeToggleButton({ theme, toggleTheme }) {
            return (
                <button
                    onClick={toggleTheme}
                    className="p-2 rounded-full text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700/50 hover:bg-gray-300 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-blue-500 transition-colors"
                    aria-label="Toggle dark mode"
                >
                    {theme === 'dark' ? (
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    ) : (
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                            <path strokeLinecap="round" strokeLinejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    )}
                </button>
            );
        }

        function InventoryApp({ user, theme, toggleTheme }) {
            const [page, setPage] = useState('stock');
            const [stock, setStock] = useState([]);
            const [invoices, setInvoices] = useState([]);
            const [phoneData, setPhoneData] = useState(null);
            const [isInventoryModalOpen, setInventoryModalOpen] = useState(false);
            const [isSalesInvoiceModalOpen, setSalesInvoiceModalOpen] = useState(false);
            const [isCsvModalOpen, setIsCsvModalOpen] = useState(false);

            useEffect(() => {
                if (!user.uid || !db) return;
                const phoneDataRef = window.firebase.doc(db, 'artifacts', appId, 'users', user.uid, 'phone_data', 'master_list');
                const unsubscribe = window.firebase.onSnapshot(phoneDataRef, (docSnap) => {
                    if (docSnap.exists()) { setPhoneData(docSnap.data().models); } 
                    else { window.firebase.setDoc(phoneDataRef, { models: INITIAL_PHONE_DATA }).then(() => setPhoneData(INITIAL_PHONE_DATA)).catch(err => console.error("Error initializing phone data:", err)); }
                }, (error) => { console.error("Error fetching phone data:", error); });
                return () => unsubscribe();
            }, [user.uid]);

            useEffect(() => {
                if (!user.uid || !db) return;
                const stockCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', user.uid, 'stock');
                const q = window.firebase.query(stockCollectionRef, window.firebase.orderBy('deliveryDate', 'desc'));
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const stockData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setStock(stockData);
                }, (error) => { console.error("Error fetching stock:", error); });
                return () => unsubscribe();
            }, [user.uid]);
            
            useEffect(() => {
                if (!user.uid || !db) return;
                const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', user.uid, 'invoices');
                const q = window.firebase.query(invoicesCollectionRef, window.firebase.orderBy('date', 'desc'));
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const invoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setInvoices(invoicesData);
                }, (error) => { console.error("Error fetching invoices:", error); });
                return () => unsubscribe();
            }, [user.uid]);

            const uniqueSuggestions = useMemo(() => {
                const suggestions = { suppliers: new Set(), purchasers: new Set(), purchaseAccounts: new Set(), invoices: new Set(), customers: new Set(), paymentTerms: new Set() };
                stock.forEach(item => {
                    if (item.supplier) suggestions.suppliers.add(item.supplier);
                    if (item.purchaser) suggestions.purchasers.add(item.purchaser);
                    if (item.purchaseAccount) suggestions.purchaseAccounts.add(item.purchaseAccount);
                    if (item.invoice) suggestions.invoices.add(item.invoice);
                    if (item.customer) suggestions.customers.add(item.customer);
                });
                invoices.forEach(inv => {
                    if(inv.customerName) suggestions.customers.add(inv.customerName);
                    if(inv.paymentTerms) suggestions.paymentTerms.add(inv.paymentTerms);
                });
                return {
                    suppliers: [...suggestions.suppliers].sort(),
                    purchasers: [...suggestions.purchasers].sort(),
                    purchaseAccounts: [...suggestions.purchaseAccounts].sort(),
                    invoices: [...suggestions.invoices].sort(),
                    customers: [...suggestions.customers].sort(),
                    paymentTerms: [...suggestions.paymentTerms].sort(),
                };
            }, [stock, invoices]);
            
            if (!phoneData) {
                return <div className="flex items-center justify-center h-screen"><div className="text-2xl">Loading data...</div></div>;
            }
            
            const exportStockToCSV = (csvStartDate, csvEndDate) => {
                let dataToExport = stock;
                if (csvStartDate && csvEndDate) {
                    const start = new Date(csvStartDate).getTime();
                    const end = new Date(csvEndDate).setHours(23, 59, 59, 999);
                    dataToExport = dataToExport.filter(item => {
                        const itemDate = item.deliveryDate ? item.deliveryDate.toDate().getTime() : 0;
                        return itemDate >= start && itemDate <= end;
                    });
                }
                if (dataToExport.length === 0) { alert("No data available for the selected criteria."); return; }
                const headers = ['Phone Model', 'Storage', 'RAM', 'Color', 'IMEI', 'Delivery Date', 'Price', 'Discount', 'HPP', 'Supplier', 'Purchaser', 'Purchase Account', 'Paid Status', 'Availability', 'Sold Date', 'Sold Price', 'Profit', 'Customer', 'Notes', 'Invoice'];
                const csvRows = [headers.join(',')];
                for (const item of dataToExport) {
                    const values = [item.phoneModel, item.storage, item.ram || '', item.color, item.imei, formatDate(item.deliveryDate, true), item.price || 0, item.discount || 0, item.hpp || 0, item.supplier, item.purchaser, item.purchaseAccount, item.paidStatus, item.availability, item.soldDate ? formatDate(item.soldDate, true) : 'N/A', item.soldPrice || 0, item.profit || 0, `"${(item.customer || '').replace(/"/g, '""')}"`, `"${(item.notes || '').replace(/"/g, '""')}"`, item.invoice];
                    csvRows.push(values.join(','));
                }
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', ''); a.setAttribute('href', url); a.setAttribute('download', 'stock_export.csv');
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            return (
                <div className="min-h-screen font-sans">
                    <Header setPage={setPage} user={user} currentPage={page} />
                    <main className="p-4 sm:p-6 lg:p-8 pb-32 lg:pb-8">
                        {isInventoryModalOpen && <InventoryInputModal closeModal={() => setInventoryModalOpen(false)} userId={user.uid} phoneData={phoneData} uniqueSuggestions={uniqueSuggestions} />}
                        {isSalesInvoiceModalOpen && <SalesInvoiceModal stock={stock} closeModal={() => setSalesInvoiceModalOpen(false)} userId={user.uid} uniqueSuggestions={uniqueSuggestions} />}
                        <CsvExportModal isOpen={isCsvModalOpen} closeModal={() => setIsCsvModalOpen(false)} onExport={exportStockToCSV} />

                        {page === 'stock' && <StockListPage userId={user.uid} stockData={stock} phoneData={phoneData} theme={theme} toggleTheme={toggleTheme} uniqueSuggestions={uniqueSuggestions} />}
                        {page === 'invoices' && <InvoiceListPage userId={user.uid} />}
                        {page === 'reports' && <FinancialReportPage stockData={stock} invoicesData={invoices} />}
                        {page === 'data' && <PhoneDataManagementPage userId={user.uid} phoneData={phoneData} setPhoneData={setPhoneData} />}
                        {page === 'logs' && <LogPage userId={user.uid} />}
                    </main>
                    
                    <div className="fixed bottom-20 lg:bottom-6 right-6 flex flex-col items-center gap-4 z-40">
                         <button onClick={() => setIsCsvModalOpen(true)} className="bg-teal-600 hover:bg-teal-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" title="Export Stock to CSV">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                        </button>
                         <button onClick={() => setInventoryModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" title="Input Inventory">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        </button>
                        <button onClick={() => setSalesInvoiceModalOpen(true)} className="bg-green-600 hover:bg-green-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" title="Create Sales Invoice">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        </button>
                    </div>

                    <BottomNavBar currentPage={page} setPage={setPage} />
                </div>
            );
        }

        function Header({ setPage, user, currentPage }) {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const handleLogout = async () => { try { await window.firebase.signOut(auth); } catch (error) { console.error("Error signing out:", error); } };
            const NavButton = ({ pageName, children }) => {
                const isActive = currentPage === pageName;
                const activeClasses = 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white';
                const inactiveClasses = 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white';
                return (
                    <button 
                        onClick={() => { setPage(pageName); setIsMenuOpen(false); }} 
                        className={`w-full text-left px-3 py-2 rounded-md text-sm font-medium transition whitespace-nowrap ${isActive ? activeClasses : inactiveClasses}`}
                    >
                        {children}
                    </button>
                );
            };
            return (
                <header className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-[998]">
                    <div className="mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-20 flex-wrap">
                            <div className="flex items-center space-x-4"><img src={logoBase64} alt="Griphub Logo" className="h-12 w-12"/><h1 className="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">Griphub Inventory</h1></div>
                            <nav className="hidden lg:flex items-center space-x-2"><NavButton pageName='stock'>Stock List</NavButton><NavButton pageName='invoices'>Invoice List</NavButton><NavButton pageName='reports'>Financial Report</NavButton><NavButton pageName='data'>Manage Data</NavButton><NavButton pageName='logs'>Activity Log</NavButton></nav>
                            <div className="flex items-center gap-4">
                                <div className="hidden sm:flex items-center gap-3">
                                    <img src={user.photoURL} alt={user.displayName} className="h-10 w-10 rounded-full" />
                                    <span className="text-gray-800 dark:text-white text-sm font-medium hidden xl:block">{user.displayName}</span>
                                </div>
                                <button onClick={handleLogout} className="flex items-center bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-lg text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clipRule="evenodd" /></svg><span className="hidden sm:inline sm:ml-2">Logout</span></button>
                                <div className="lg:hidden"><button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-gray-600 dark:text-gray-300 hover:text-black dark:hover:text-white focus:outline-none"><svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">{isMenuOpen ? (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />) : (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />)}</svg></button></div>
                            </div>
                        </div>
                        {isMenuOpen && (<div className="lg:hidden absolute left-0 w-full bg-white dark:bg-gray-800 z-50 shadow-lg"><div className="px-2 pt-2 pb-3 space-y-1 sm:px-3"><NavButton pageName='stock'>Stock List</NavButton><NavButton pageName='invoices'>Invoice List</NavButton><NavButton pageName='reports'>Financial Report</NavButton><NavButton pageName='data'>Manage Data</NavButton><NavButton pageName='logs'>Activity Log</NavButton></div></div>)}
                    </div>
                </header>
            );
        }

        function BottomNavBar({ currentPage, setPage }) {
            const NavItem = ({ pageName, icon, label }) => {
                const isActive = currentPage === pageName;
                return (<button onClick={() => setPage(pageName)} className={`flex flex-col items-center justify-center w-full pt-2 pb-1 transition-colors duration-200 ${isActive ? 'text-blue-500 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white'}`}>{icon(isActive)}<span className={`text-xs mt-1 ${isActive ? 'font-bold' : 'font-normal'}`}>{label}</span></button>);
            };
            return (
                <div className="lg:hidden fixed bottom-0 left-0 right-0 h-16 bg-white dark:bg-gray-800 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] dark:shadow-[0_-2px_10px_rgba(0,0,0,0.3)] z-50 grid grid-cols-5 justify-around items-center px-1">
                    <NavItem pageName="stock" label="Stock" icon={(isActive) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>} />
                    <NavItem pageName="invoices" label="Invoices" icon={(isActive) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>} />
                    <NavItem pageName="reports" label="Reports" icon={(isActive) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>} />
                    <NavItem pageName="data" label="Data" icon={(isActive) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>} />
                    <NavItem pageName="logs" label="Logs" icon={(isActive) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>} />
                </div>
            )
        }

        function CsvExportModal({ isOpen, closeModal, onExport }) {
            const [startDate, setStartDate] = useState(''); const [endDate, setEndDate] = useState('');
            if (!isOpen) return null;
            const handleExportClick = () => { onExport(startDate, endDate); closeModal(); };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-gray-200 dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
                    <h3 className="text-2xl font-bold mb-6">Export Stock to CSV</h3><p className="text-gray-600 dark:text-gray-400 mb-4">Select a date range to export. Leave blank to export all data.</p>
                    <div className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div>
                    </div>
                    <div className="flex justify-end space-x-4 pt-6 mt-2 border-t border-gray-300 dark:border-gray-700"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button onClick={handleExportClick} className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition">Export CSV</button></div>
                </div></div>
            );
        }

        function MultiSelectDropdown({ options, selectedOptions, onSelectionChange, label }) {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            const handleToggleOption = (option) => {
                const newSelection = new Set(selectedOptions);
                if (newSelection.has(option)) {
                    newSelection.delete(option);
                } else {
                    newSelection.add(option);
                }
                onSelectionChange(newSelection);
            };
            
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [dropdownRef]);

            const getButtonLabel = () => {
                if (selectedOptions.size === 0) return label;
                if (selectedOptions.size === 1) return [...selectedOptions][0];
                return `${selectedOptions.size} selected`;
            }

            return (
                <div ref={dropdownRef} className="relative">
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-md border border-gray-300 dark:border-gray-600 flex justify-between items-center text-left h-full">
                        <span className="truncate">{getButtonLabel()}</span>
                        <svg className={`w-4 h-4 ml-2 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    {isOpen && (
                        <div className="absolute z-20 mt-1 w-full bg-white dark:bg-gray-700 shadow-lg rounded-md border border-gray-300 dark:border-gray-600 max-h-60 overflow-y-auto">
                           {options.map(option => (
                                <label key={option} className="flex items-center gap-2 px-3 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <input
                                        type="checkbox"
                                        className="form-checkbox h-4 w-4 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-blue-600 rounded focus:ring-blue-500"
                                        checked={selectedOptions.has(option)}
                                        onChange={() => handleToggleOption(option)}
                                    />
                                    <span className="text-sm">{option}</span>
                                </label>
                           ))}
                        </div>
                    )}
                </div>
            );
        }

        function StockListPage({ userId, stockData, phoneData, theme, toggleTheme, uniqueSuggestions }) {
            const [editingItem, setEditingItem] = useState(null);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [filters, setFilters] = useState({ model: new Set(), availability: new Set(), paidStatus: new Set(), searchTerm: '' });
            const [bulkEditMode, setBulkEditMode] = useState(false);
            const [isBulkEditModalOpen, setIsBulkEditModalOpen] = useState(false);
            const [selectedItemIds, setSelectedItemIds] = useState(new Set());

            const handleDelete = async () => {
                if (!itemToDelete || !userId) return;
                try {
                    const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', itemToDelete.id);
                    await window.firebase.deleteDoc(docRef);
                    const { phoneModel, storage, color, ram, imei } = itemToDelete;
                    const details = [phoneModel, storage, ram, color].filter(Boolean).join(' ');
                    await addLog(userId, { message: `Deleted stock item: ${details} (IMEI: ${imei})`, type: 'DELETE_STOCK', context: { docId: itemToDelete.id, deletedData: itemToDelete } });
                    setItemToDelete(null);
                } catch (error) { console.error("Error deleting document:", error); }
            };

            const phoneModelsInStock = useMemo(() => [...new Set(stockData.map(item => item.phoneModel))].sort(), [stockData]);
            const availabilityOptions = ['Available', 'On Delivery', 'SOLD'];
            const paidStatusOptions = ['Paid', 'Unpaid'];

            const filteredStock = useMemo(() => {
                return stockData.filter(item => {
                    const modelMatch = filters.model.size === 0 ? true : filters.model.has(item.phoneModel);
                    const availabilityMatch = filters.availability.size === 0 ? true : filters.availability.has(item.availability);
                    const paidStatusMatch = filters.paidStatus.size === 0 ? true : filters.paidStatus.has(item.paidStatus);
                    const searchMatch = filters.searchTerm ? (Object.values(item).some(val => val?.toString().toLowerCase().includes(filters.searchTerm.toLowerCase()))) : true;
                    return modelMatch && availabilityMatch && paidStatusMatch && searchMatch;
                });
            }, [stockData, filters]);
            
            const toggleBulkEditMode = () => { setBulkEditMode(!bulkEditMode); setSelectedItemIds(new Set()); };
            const handleSelectItem = (itemId) => { setSelectedItemIds(prev => { const newSet = new Set(prev); if (newSet.has(itemId)) { newSet.delete(itemId); } else { newSet.add(itemId); } return newSet; }); };
            const handleSelectAll = () => { if (selectedItemIds.size === filteredStock.length) { setSelectedItemIds(new Set()); } else { setSelectedItemIds(new Set(filteredStock.map(item => item.id))); } };
            const handleBulkMarkAsPaid = async () => {
                if (selectedItemIds.size === 0) { alert("No items selected."); return; }
                const itemsToUpdate = stockData.filter(item => selectedItemIds.has(item.id)); const previousItemsState = itemsToUpdate.map(item => ({ docId: item.id, previousData: { paidStatus: item.paidStatus } }));
                const batch = window.firebase.writeBatch(db); selectedItemIds.forEach(id => { const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', id); batch.update(docRef, { paidStatus: "Paid" }); });
                try { 
                    await batch.commit(); 
                    const imeiList = itemsToUpdate.map(item => item.imei).filter(Boolean);
                    let imeiString = imeiList.join(', ');
                    if (imeiString.length > 150) {
                        imeiString = imeiList.slice(0, 5).join(', ') + `... and ${imeiList.length - 5} more`;
                    }
                    const logMessage = `Bulk marked ${selectedItemIds.size} items as Paid${imeiList.length > 0 ? ` (IMEIs: ${imeiString})` : ''}.`;
                    await addLog(userId, { message: logMessage, type: 'BULK_EDIT_STOCK', context: { items: previousItemsState, updatedField: { paidStatus: 'Paid' } } }); 
                    alert(`${selectedItemIds.size} items marked as Paid.`); 
                    toggleBulkEditMode();
                } catch (error) { console.error("Error updating documents in batch: ", error); alert("Failed to update items."); }
            };
            const tableHeaders = ['Phone Model', 'IMEI', 'Delivery Date', 'Actions', 'Price', 'HPP', 'Discount', 'Invoice', 'Supplier', 'Purchaser', 'Purchase Account', 'Paid Status', 'Availability', 'Sold Date', 'Sold Price', 'Profit', 'Customer', 'Notes'];
            
            const getAvailabilityClass = (availability) => {
                switch(availability) {
                    case 'SOLD': return 'bg-yellow-200 text-yellow-800';
                    case 'On Delivery': return 'bg-orange-200 text-orange-800';
                    case 'Available':
                    default: return 'bg-blue-200 text-blue-800';
                }
            };
            
            return (
                <div className="pb-20">
                    <div className="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <h2 className="text-3xl font-bold">Stock List</h2>
                        <div className="flex items-center gap-4">
                           <ThemeToggleButton theme={theme} toggleTheme={toggleTheme} />
                           <button onClick={toggleBulkEditMode} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition transform hover:scale-105 w-full sm:w-auto">{bulkEditMode ? 'Cancel' : 'Bulk Edit'}</button>
                        </div>
                    </div>
                    
                    <div className="bg-white dark:bg-gray-800 p-4 rounded-lg mb-6 shadow-md">
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end">
                            <div className="lg:col-span-2">
                                <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Search</label>
                                <input type="text" placeholder="Search anything..." value={filters.searchTerm} onChange={e => setFilters(f => ({...f, searchTerm: e.target.value}))} className="bg-gray-100 dark:bg-gray-700 p-2 rounded-md border border-gray-300 dark:border-gray-600 w-full" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Model</label>
                                <MultiSelectDropdown 
                                    label="All Models"
                                    options={phoneModelsInStock}
                                    selectedOptions={filters.model}
                                    onSelectionChange={(newSelection) => setFilters(f => ({ ...f, model: newSelection }))}
                                />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Availability</label>
                                <MultiSelectDropdown 
                                    label="All Availability"
                                    options={availabilityOptions}
                                    selectedOptions={filters.availability}
                                    onSelectionChange={(newSelection) => setFilters(f => ({ ...f, availability: newSelection }))}
                                />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Payment</label>
                                <MultiSelectDropdown 
                                    label="All Status"
                                    options={paidStatusOptions}
                                    selectedOptions={filters.paidStatus}
                                    onSelectionChange={(newSelection) => setFilters(f => ({ ...f, paidStatus: newSelection }))}
                                />
                            </div>
                        </div>
                         <div className="flex justify-between items-center mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                             <button onClick={() => setFilters({ model: new Set(), availability: new Set(), paidStatus: new Set(), searchTerm: '' })} className="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">Reset Filters</button>
                            <div className="text-sm text-gray-500 dark:text-gray-400">Showing {filteredStock.length} of {stockData.length} items</div>
                         </div>
                    </div>

                    {editingItem && <EditStockModal item={editingItem} closeModal={() => setEditingItem(null)} userId={userId} phoneData={phoneData} uniqueSuggestions={uniqueSuggestions} />}
                    {itemToDelete && <ConfirmDeleteModal title="Delete Stock Item" onConfirm={handleDelete} onCancel={() => setItemToDelete(null)} item={itemToDelete} />}
                    {isBulkEditModalOpen && <BulkEditModal closeModal={() => setIsBulkEditModalOpen(false)} userId={userId} selectedItemIds={selectedItemIds} stockData={stockData} onUpdateSuccess={() => { setIsBulkEditModalOpen(false); toggleBulkEditMode(); }} />}
                    <div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-x-auto max-h-[calc(105vh-380px)] overflow-y-auto">
                        <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead className="bg-gray-100 dark:bg-gray-700 sticky top-0 z-10"><tr>
                                {bulkEditMode && <th className="px-3 py-3"><input type="checkbox" className="form-checkbox h-5 w-5 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-purple-600 rounded focus:ring-purple-500" onChange={handleSelectAll} checked={selectedItemIds.size === filteredStock.length && filteredStock.length > 0} /></th>}
                                {!bulkEditMode && <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No</th>}
                                {tableHeaders.map(h => ( <th key={h} scope="col" className="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">{h}</th> ))}
                            </tr></thead>
                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                {filteredStock.map((item, index) => (<tr key={item.id} className={`${selectedItemIds.has(item.id) ? 'bg-purple-100 dark:bg-purple-900/50' : ''} hover:bg-gray-50 dark:hover:bg-gray-700 transition`}>
                                    {bulkEditMode && <td className="px-3 py-2"><input type="checkbox" className="form-checkbox h-5 w-5 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-purple-600 rounded focus:ring-purple-500" checked={selectedItemIds.has(item.id)} onChange={() => handleSelectItem(item.id)} /></td>}
                                    {!bulkEditMode && <td className="px-3 py-2 whitespace-nowrap text-sm">{index + 1}</td>}
                                    <td className="px-3 py-2 whitespace-nowrap text-sm font-semibold">{[item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join(' ')}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm font-mono">{item.imei}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm">{formatDate(item.availability === 'On Delivery' ? null : item.deliveryDate)}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm"><div className="flex items-center gap-3"><button onClick={() => setEditingItem(item)} className="text-yellow-500 dark:text-yellow-400 hover:text-yellow-700 dark:hover:text-yellow-300" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg></button><button onClick={() => setItemToDelete(item)} className="text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button></div></td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm">{formatRupiahDisplay(item.price)}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{formatRupiahDisplay(item.hpp)}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.discount}%</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.invoice}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.supplier}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.purchaser}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.purchaseAccount}</td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.paidStatus === 'Paid' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}`}>{item.paidStatus}</span></td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getAvailabilityClass(item.availability)}`}>{item.availability}</span></td>
                                    <td className="px-3 py-2 whitespace-nowrap text-sm">{formatDate(item.soldDate)}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{formatRupiahDisplay(item.soldPrice)}</td><td className="px-3 py-2 whitespace-nowrap text-sm font-bold text-green-600 dark:text-green-400">{formatRupiahDisplay(item.profit)}</td><td className="px-3 py-2 whitespace-nowrap text-sm">{item.customer}</td><td className="px-3 py-2 whitespace-pre-wrap text-sm">{item.notes}</td>
                                </tr>))}
                            </tbody>
                        </table>
                    </div>
                    {bulkEditMode && selectedItemIds.size > 0 && (<div className="fixed bottom-16 lg:bottom-4 left-0 right-0 bg-gray-200 dark:bg-gray-700 p-4 shadow-lg z-30 flex justify-center items-center gap-4"><span className="text-gray-900 dark:text-white">{selectedItemIds.size} item(s) selected</span><button onClick={handleBulkMarkAsPaid} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Mark as Paid</button><button onClick={() => setIsBulkEditModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Update Field...</button></div>)}
                </div>
            );
        }
        
        function BulkEditModal({ closeModal, userId, selectedItemIds, stockData, onUpdateSuccess }) {
            const [fieldToUpdate, setFieldToUpdate] = useState('paidStatus');
            const [newValue, setNewValue] = useState('');
            const [displayValue, setDisplayValue] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const editableFields = {
                paidStatus: { label: 'Paid Status', type: 'select', options: ['Paid', 'Unpaid'] },
                availability: { label: 'Availability', type: 'select', options: ['Available', 'On Delivery', 'SOLD'] },
                price: { label: 'Price (IDR)', type: 'price' },
                discount: { label: 'Discount (%)', type: 'number' },
                supplier: { label: 'Supplier', type: 'text' },
                purchaser: { label: 'Purchaser', type: 'text' },
                purchaseAccount: { label: 'Purchase Account', type: 'text' },
                notes: { label: 'Notes', type: 'textarea' },
            };

            const handleValueChange = (e) => {
                const { value } = e.target;
                const fieldType = editableFields[fieldToUpdate].type;
                if (fieldType === 'price') {
                    setDisplayValue(formatNumberInput(value));
                    setNewValue(parseFormattedNumber(value));
                } else if (fieldType === 'number') {
                    setDisplayValue(value);
                    setNewValue(parseFloat(value) || 0);
                } else {
                    setNewValue(value);
                }
            };
            
            const handleFieldChange = (e) => {
                const newField = e.target.value;
                setFieldToUpdate(newField);
                const fieldInfo = editableFields[newField];
                if (fieldInfo.type === 'select') {
                    setNewValue(fieldInfo.options[0]);
                } else {
                    setNewValue('');
                    setDisplayValue('');
                }
            };
            
            useEffect(() => {
                handleFieldChange({ target: { value: 'paidStatus' } });
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isSubmitting || selectedItemIds.size === 0) return;
                const fieldInfo = editableFields[fieldToUpdate];
                if (fieldInfo.type !== 'select' && (newValue === '' || newValue === null)) {
                    alert('Value cannot be empty.'); return;
                }
                setIsSubmitting(true);
                
                const itemsToUpdate = stockData.filter(item => selectedItemIds.has(item.id));
                const previousItemsState = itemsToUpdate.map(item => ({ docId: item.id, previousData: { [fieldToUpdate]: item[fieldToUpdate], hpp: item.hpp } }));
                
                const batch = window.firebase.writeBatch(db);

                for (const item of itemsToUpdate) {
                    const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', item.id);
                    let updateData = {};

                    if (fieldToUpdate === 'price') {
                        const newPrice = newValue;
                        const discount = item.discount || 0;
                        updateData.price = newPrice;
                        updateData.hpp = newPrice - (newPrice * (discount / 100));
                    } else if (fieldToUpdate === 'discount') {
                        const newDiscount = newValue;
                        const price = item.price || 0;
                        updateData.discount = newDiscount;
                        updateData.hpp = price - (price * (newDiscount / 100));
                    } else {
                        updateData[fieldToUpdate] = newValue;
                        if (fieldToUpdate === 'availability' && newValue === 'SOLD') {
                            updateData.soldDate = window.firebase.Timestamp.fromDate(new Date());
                        } else if (fieldToUpdate === 'availability' && (newValue === 'Available' || newValue === 'On Delivery')) {
                            updateData.soldDate = null;
                        }
                    }
                    batch.update(docRef, updateData);
                }

                try {
                    await batch.commit();
                    const logMessage = `Bulk updated ${itemsToUpdate.length} items: set ${fieldToUpdate} to "${newValue}"`;
                    await addLog(userId, { message: logMessage, type: 'BULK_EDIT_STOCK', context: { items: previousItemsState, updatedField: { [fieldToUpdate]: newValue } } });
                    alert(`${itemsToUpdate.length} items updated successfully.`);
                    onUpdateSuccess();
                } catch (error) { console.error("Error during bulk update: ", error); alert("Failed to update items."); } finally { setIsSubmitting(false); }
            };

            const renderValueInput = () => {
                const field = editableFields[fieldToUpdate];
                switch(field.type) {
                    case 'select': return (<select value={newValue} onChange={(e) => setNewValue(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">{field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>);
                    case 'textarea': return (<textarea value={newValue} onChange={(e) => setNewValue(e.target.value)} placeholder="Enter new value" rows="3" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>);
                    case 'price': return (<input type="text" value={displayValue} onChange={handleValueChange} placeholder="Enter new price" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />);
                    case 'number': return (<input type="number" value={displayValue} onChange={handleValueChange} placeholder="Enter new value" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />);
                    default: return (<input type="text" value={newValue} onChange={(e) => setNewValue(e.target.value)} placeholder="Enter new value" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />);
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
                    <h3 className="text-2xl font-bold mb-6">Bulk Update Items</h3><p className="text-gray-600 dark:text-gray-400 mb-4">{selectedItemIds.size} items selected.</p>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Field to Update</label><select value={fieldToUpdate} onChange={handleFieldChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">{Object.entries(editableFields).map(([key, {label}]) => (<option key={key} value={key}>{label}</option>))}</select></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Value</label>{renderValueInput()}</div>
                        <div className="flex justify-end space-x-4 pt-4"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button type="submit" disabled={isSubmitting} className="px-6 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition disabled:bg-purple-800 disabled:cursor-not-allowed">{isSubmitting ? 'Updating...' : 'Update Selected Items'}</button></div>
                    </form>
                </div></div>
            );
        }

        function InventoryInputModal({ closeModal, userId, phoneData, uniqueSuggestions }) {
            const [formData, setFormData] = useState({ invoice: '', phoneModel: '', manualPhoneModel: '', storage: '', color: '', ram: '', price: 0, discount: 0, supplier: '', purchaser: '', purchaseAccount: '', paidStatus: 'Unpaid', notes: '' });
            const [priceDisplay, setPriceDisplay] = useState(''); const [isManual, setIsManual] = useState(false); const [isSubmitting, setIsSubmitting] = useState(false); const [isIndividualColorMode, setIsIndividualColorMode] = useState(false); const [imeiColorList, setImeiColorList] = useState([{ imei: '', color: '' }]); const [bulkImei, setBulkImei] = useState('');
            const handlePriceChange = (e) => { const displayValue = formatNumberInput(e.target.value); const rawValue = parseFormattedNumber(e.target.value); setPriceDisplay(displayValue); setFormData(prev => ({ ...prev, price: rawValue })); };
            const handleChange = (e) => { const { name, value } = e.target; if (name === 'purchaser') { setFormData(prev => ({ ...prev, purchaser: value, paidStatus: value.toUpperCase() === 'SENDIRI' ? 'Paid' : 'Unpaid' })); return; } if (name === "phoneModel" && value === "manual") { setIsManual(true); setFormData({ ...formData, phoneModel: '', manualPhoneModel: '', storage: '', color: '', ram: '' }); return; } if (name === "phoneModel" && isManual) setIsManual(false); setFormData(prev => ({ ...prev, [name]: value })); if (name === "phoneModel") { const newModel = value; const modelData = phoneData[newModel] || {}; const defaultColor = modelData.colors && modelData.colors.length > 0 ? modelData.colors[0] : ''; setFormData(prev => ({ ...prev, storage: '', color: defaultColor, ram: '' })); setImeiColorList([{ imei: '', color: defaultColor }]); } };
            const handleImeiColorChange = (index, field, value) => { const newList = [...imeiColorList]; newList[index][field] = value; setImeiColorList(newList); };
            const addImeiColorRow = () => { const modelData = phoneData[formData.phoneModel] || {}; const defaultColor = modelData.colors && modelData.colors.length > 0 ? modelData.colors[0] : ''; setImeiColorList([...imeiColorList, { imei: '', color: defaultColor }]); };
            const removeImeiColorRow = (index) => { const newList = imeiColorList.filter((_, i) => i !== index); setImeiColorList(newList); };
            const handleSubmit = async (e) => {
                e.preventDefault(); if (!db || isSubmitting) return; setIsSubmitting(true);
                const baseItem = { ...formData, phoneModel: isManual ? formData.manualPhoneModel : formData.phoneModel, price: formData.price, discount: parseFloat(formData.discount) || 0, hpp: formData.price - (formData.price * ((parseFloat(formData.discount) || 0) / 100)), customer: '', soldPrice: null, profit: null, soldDate: null }; 
                delete baseItem.manualPhoneModel;
                
                let itemsToSubmit = [];
                const currentTime = window.firebase.Timestamp.fromDate(new Date());

                if (isIndividualColorMode) {
                    itemsToSubmit = imeiColorList.map(item => {
                        const imeiValue = item.imei.trim();
                        const isDelivery = imeiValue === '' || imeiValue === '0';
                        return { ...baseItem, imei: isDelivery ? '' : imeiValue, color: item.color, availability: isDelivery ? 'On Delivery' : 'Available', deliveryDate: isDelivery ? null : currentTime };
                    });
                } else {
                    const imeisRaw = bulkImei.split('\n').map(i => i.trim()).filter(Boolean);
                    if (imeisRaw.length === 0) {
                        const model = isManual ? formData.manualPhoneModel : formData.phoneModel;
                        if (!model || !formData.storage) { alert("Please select or enter a phone model and storage before submitting."); setIsSubmitting(false); return; }
                        itemsToSubmit.push({ ...baseItem, imei: '', availability: 'On Delivery', deliveryDate: null });
                    } else {
                        itemsToSubmit = imeisRaw.map(imei => {
                            const isDelivery = imei === '0';
                            return { ...baseItem, imei: isDelivery ? '' : imei, availability: isDelivery ? 'On Delivery' : 'Available', deliveryDate: isDelivery ? null : currentTime };
                        });
                    }
                }
                if (itemsToSubmit.length === 0) { alert("No valid items to submit."); setIsSubmitting(false); return; }
                try {
                    const stockCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'stock');
                    const batch = window.firebase.writeBatch(db); const createdDocIds = []; itemsToSubmit.forEach(itemData => { const newDocRef = window.firebase.doc(stockCollectionRef); batch.set(newDocRef, itemData); createdDocIds.push(newDocRef.id); }); await batch.commit();
                    
                    let logMessage;
                    if (itemsToSubmit.length === 1) {
                        const item = itemsToSubmit[0];
                        const itemDetails = [item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join(' ');
                        logMessage = `Inputted item: ${itemDetails}${item.imei ? ` (IMEI: ${item.imei})` : ' (On Delivery)'}`;
                    } else {
                        const baseDetails = [baseItem.phoneModel, baseItem.storage, baseItem.ram].filter(Boolean).join(' ');
                        const imeiDetails = itemsToSubmit.map(i => `${i.color || ''}${i.imei ? ` (${i.imei})` : ''}`).filter(Boolean).join(', ');
                        logMessage = `Inputted ${itemsToSubmit.length} items: ${baseDetails}. Details: ${imeiDetails}`;
                        if (logMessage.length > 500) { 
                            logMessage = `Inputted ${itemsToSubmit.length} item(s): ${baseDetails}.`;
                        }
                    }
                    await addLog(userId, { message: logMessage, type: 'CREATE_STOCK', context: { createdDocIds } });
                    
                    closeModal();
                } catch (error) { console.error("Error adding documents: ", error); alert("Error submitting data. Please try again."); } finally { setIsSubmitting(false); }
            };
            const selectedModel = formData.phoneModel; const modelData = phoneData[selectedModel] || {}; const isPurchaserSendiri = formData.purchaser.toUpperCase() === 'SENDIRI';
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[9999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[calc(100vh-2rem)] flex flex-col">
                    <h3 className="text-2xl font-bold mb-6 flex-shrink-0">Add New Inventory</h3>
                    <form onSubmit={handleSubmit} className="space-y-4 overflow-y-auto flex-grow pr-2">
                        <input type="text" name="invoice" placeholder="Invoice Number" value={formData.invoice} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="invoice-suggestions" />
                        <datalist id="invoice-suggestions">{uniqueSuggestions.invoices.filter(s => s.toLowerCase().startsWith(formData.invoice.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        
                        <select name="phoneModel" onChange={handleChange} value={formData.phoneModel} required={!isManual} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Phone Model</option>{Object.keys(phoneData).sort().map(model => <option key={model} value={model}>{model}</option>)}<option value="manual">-- Manual Input --</option></select>
                        {isManual ? (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" name="manualPhoneModel" placeholder="Enter Phone Model" onChange={handleChange} value={formData.manualPhoneModel} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />
                                <input type="text" name="storage" placeholder="Storage (e.g., 256GB)" onChange={handleChange} value={formData.storage} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />
                                <input type="text" name="color" placeholder="Color" onChange={handleChange} value={formData.color} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />
                            </div>
                        ) : selectedModel && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select name="storage" onChange={handleChange} value={formData.storage} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Storage</option>{modelData.storage?.map(s => <option key={s} value={s}>{s}</option>)}</select>
                                {!isIndividualColorMode && <select name="color" onChange={handleChange} value={formData.color} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Color</option>{modelData.colors?.map(c => <option key={c} value={c}>{c}</option>)}</select>}
                            </div>
                        )}
                        {modelData.ram && modelData.ram.length > 0 && (<select name="ram" onChange={handleChange} value={formData.ram} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select RAM</option>{modelData.ram.map(r => <option key={r} value={r}>{r}</option>)}</select>)}
                        {selectedModel && !isManual && (<div className="flex items-center gap-2 text-sm"><input type="checkbox" id="individualColorMode" checked={isIndividualColorMode} onChange={() => setIsIndividualColorMode(!isIndividualColorMode)} className="form-checkbox h-4 w-4 bg-gray-200 dark:bg-gray-900 border-gray-400 dark:border-gray-600 text-blue-600 rounded focus:ring-blue-500"/><label htmlFor="individualColorMode">Input Warna per IMEI</label></div>)}
                        {isIndividualColorMode ? (<div className="space-y-3">{imeiColorList.map((item, index) => (<div key={index} className="flex items-center gap-2"><input type="text" placeholder="IMEI (or 0 for delivery)" value={item.imei} onChange={(e) => handleImeiColorChange(index, 'imei', e.target.value)} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /><select value={item.color} onChange={(e) => handleImeiColorChange(index, 'color', e.target.value)} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">{modelData.colors?.map(c => <option key={c} value={c}>{c}</option>)}</select><button type="button" onClick={() => removeImeiColorRow(index)} className="p-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">-</button></div>))}<button type="button" onClick={addImeiColorRow} className="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Tambah IMEI</button></div>) : (<textarea name="imei" placeholder="Enter IMEIs (one per line). Use 0 for 'On Delivery'." onChange={(e) => setBulkImei(e.target.value)} value={bulkImei} rows="3" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>)}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="price" placeholder="Price (IDR)" value={priceDisplay} onChange={handlePriceChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /><input type="number" name="discount" placeholder="Discount (%)" onChange={handleChange} value={formData.discount} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="supplier" placeholder="Supplier" value={formData.supplier} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="supplier-suggestions" />
                            <datalist id="supplier-suggestions">{uniqueSuggestions.suppliers.filter(s => s.toLowerCase().startsWith(formData.supplier.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                            <input type="text" name="purchaser" placeholder="Purchaser (e.g., SENDIRI)" value={formData.purchaser} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="purchaser-suggestions" />
                            <datalist id="purchaser-suggestions">{uniqueSuggestions.purchasers.filter(s => s.toLowerCase().startsWith(formData.purchaser.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="purchaseAccount" placeholder="Purchase Account (e.g., BCA)" value={formData.purchaseAccount} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="account-suggestions" />
                             <datalist id="account-suggestions">{uniqueSuggestions.purchaseAccounts.filter(s => s.toLowerCase().startsWith(formData.purchaseAccount.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                            <select name="paidStatus" onChange={handleChange} value={formData.paidStatus} disabled={isPurchaserSendiri} className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${isPurchaserSendiri && 'opacity-50 cursor-not-allowed'}`}><option value="Unpaid">Unpaid</option><option value="Paid">Paid</option></select>
                        </div>
                        <textarea name="notes" placeholder="Notes (optional)" onChange={handleChange} rows="2" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>
                        <div className="flex justify-end space-x-4 pt-4 flex-shrink-0"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button type="submit" disabled={isSubmitting} className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:bg-blue-800 disabled:cursor-not-allowed"> {isSubmitting ? 'Submitting...' : 'Add Item(s)'} </button></div>
                    </form>
                </div></div>
            );
        }

        function EditStockModal({ item, closeModal, userId, phoneData, uniqueSuggestions }) {
            const [formData, setFormData] = useState({ ...item }); const [priceDisplay, setPriceDisplay] = useState(''); const [soldPriceDisplay, setSoldPriceDisplay] = useState(''); const [isSubmitting, setIsSubmitting] = useState(false); const [isManual, setIsManual] = useState(!Object.keys(phoneData).includes(item.phoneModel)); const originalItemRef = useRef(item);
            useEffect(() => { let initialFormData = { ...item }; initialFormData.deliveryDate = timestampToDateTimeLocal(item.deliveryDate); if (isManual) { initialFormData.manualPhoneModel = item.phoneModel; initialFormData.phoneModel = 'manual'; } setFormData(initialFormData); setPriceDisplay(formatNumberInput(item.price)); setSoldPriceDisplay(formatNumberInput(item.soldPrice)); }, [item, isManual, phoneData]);
            const handleNumberInputChange = (e) => { const { name, value } = e.target; const displayValue = formatNumberInput(value); const rawValue = parseFormattedNumber(value); if (name === 'price') { setPriceDisplay(displayValue); } else if (name === 'soldPrice') { setSoldPriceDisplay(displayValue); } setFormData(prev => ({ ...prev, [name]: rawValue })); };
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                 if (name === 'purchaser') { 
                    setFormData(prev => ({ ...prev, purchaser: value, paidStatus: value.toUpperCase() === 'SENDIRI' ? 'Paid' : 'Unpaid' })); 
                    return; 
                } 
                if (name === 'phoneModel' && value === 'manual') { 
                    setIsManual(true); 
                    setFormData(prev => ({ ...prev, phoneModel: value, manualPhoneModel: '', storage: '', color: '', ram: '' })); 
                    return; 
                } 
                if (name === 'phoneModel' && isManual) { 
                    setIsManual(false); 
                } 
                setFormData(prev => ({ ...prev, [name]: value })); 
                if (name === "phoneModel" && value !== 'manual') { 
                    setFormData(prev => ({ ...prev, storage: '', color: '', ram: '' })); 
                } 
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault(); if(!db || isSubmitting) return; setIsSubmitting(true);
                let itemToUpdate = { ...formData }; 
                if (itemToUpdate.phoneModel === 'manual') { itemToUpdate.phoneModel = itemToUpdate.manualPhoneModel; } 
                delete itemToUpdate.manualPhoneModel;

                // Handle Availability and Delivery Date based on IMEI
                const imeiIsBlank = !itemToUpdate.imei || itemToUpdate.imei.trim() === '';
                if (imeiIsBlank) {
                    itemToUpdate.availability = 'On Delivery';
                    itemToUpdate.deliveryDate = null;
                } else if (originalItemRef.current.availability === 'On Delivery' && !imeiIsBlank) {
                    itemToUpdate.availability = 'Available';
                    itemToUpdate.deliveryDate = window.firebase.Timestamp.fromDate(new Date());
                } else if (itemToUpdate.deliveryDate && typeof itemToUpdate.deliveryDate === 'string') {
                    itemToUpdate.deliveryDate = window.firebase.Timestamp.fromDate(new Date(itemToUpdate.deliveryDate));
                }

                const price = parseFloat(itemToUpdate.price) || 0; 
                const discount = parseFloat(itemToUpdate.discount) || 0; 
                itemToUpdate.hpp = price - (price * (discount / 100));
                
                if (itemToUpdate.availability === 'SOLD' && itemToUpdate.soldPrice) { 
                    itemToUpdate.profit = (parseFloat(itemToUpdate.soldPrice) || 0) - itemToUpdate.hpp; 
                    if (!itemToUpdate.soldDate) { itemToUpdate.soldDate = window.firebase.Timestamp.fromDate(new Date()); } 
                } else { 
                    itemToUpdate.profit = null; 
                    itemToUpdate.soldPrice = null; 
                    itemToUpdate.customer = ''; 
                    itemToUpdate.soldDate = null; 
                }

                const { id, ...finalUpdateData } = itemToUpdate;
                try {
                    const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', item.id); await window.firebase.updateDoc(docRef, finalUpdateData);
                    const { phoneModel, storage, color, ram, imei } = finalUpdateData; const details = [phoneModel, storage, ram, color].filter(Boolean).join(' ');
                    await addLog(userId, { message: `Edited stock item: ${details} (IMEI: ${imei})`, type: 'EDIT_STOCK', context: { docId: item.id, previousData: originalItemRef.current } });
                    closeModal();
                } catch (error) { console.error("Error updating document:", error); alert("Error updating data. Please try again."); } finally { setIsSubmitting(false); }
            };
            const isPurchaserSendiri = formData.purchaser?.toUpperCase() === 'SENDIRI';
            const selectedModelData = phoneData[formData.phoneModel] || {};
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-full overflow-y-auto">
                    <h3 className="text-2xl font-bold mb-6">Edit Inventory Item</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <select name="phoneModel" onChange={handleChange} value={formData.phoneModel} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Phone Model</option>{Object.keys(phoneData).sort().map(model => <option key={model} value={model}>{model}</option>)}<option value="manual">-- Manual Input --</option></select>
                        {isManual ? (<input type="text" name="manualPhoneModel" placeholder="Enter Phone Model" onChange={handleChange} value={formData.manualPhoneModel || ''} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 mt-4" />) : null}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{isManual ? (<input type="text" name="storage" placeholder="Storage" value={formData.storage || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />) : (<select name="storage" onChange={handleChange} value={formData.storage || ''} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Storage</option>{selectedModelData.storage?.map(s => <option key={s} value={s}>{s}</option>)}</select>)}{isManual ? (<input type="text" name="color" placeholder="Color" value={formData.color || ''} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />) : (<select name="color" onChange={handleChange} value={formData.color || ''} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select Color</option>{selectedModelData.colors?.map(c => <option key={c} value={c}>{c}</option>)}</select>)}{(isManual || (selectedModelData.ram && selectedModelData.ram.length > 0)) && (isManual ? (<input type="text" name="ram" placeholder="RAM" value={formData.ram || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" />) : (<select name="ram" onChange={handleChange} value={formData.ram || ''} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="">Select RAM</option>{selectedModelData.ram.map(r => <option key={r} value={r}>{r}</option>)}</select>))}</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="imei" placeholder="IMEI" value={formData.imei || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /><input type="text" name="invoice" placeholder="Invoice Number" value={formData.invoice || ''} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="invoice-suggestions" /></div>
                        <datalist id="invoice-suggestions">{uniqueSuggestions.invoices.filter(s => s.toLowerCase().startsWith((formData.invoice || '').toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        <div><label className="text-sm text-gray-500 dark:text-gray-400">Delivery Date</label><input type="datetime-local" name="deliveryDate" value={formData.deliveryDate || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" disabled={!formData.imei || formData.imei.trim() === ''}/></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="price" placeholder="Price (IDR)" value={priceDisplay} onChange={handleNumberInputChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/><input type="number" name="discount" placeholder="Discount (%)" value={formData.discount || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="supplier" placeholder="Supplier" value={formData.supplier || ''} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="supplier-suggestions"/><input type="text" name="purchaser" placeholder="Purchaser (e.g., SENDIRI)" value={formData.purchaser || ''} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="purchaser-suggestions"/></div>
                        <datalist id="supplier-suggestions">{uniqueSuggestions.suppliers.filter(s => s.toLowerCase().startsWith((formData.supplier || '').toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        <datalist id="purchaser-suggestions">{uniqueSuggestions.purchasers.filter(s => s.toLowerCase().startsWith((formData.purchaser || '').toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="purchaseAccount" placeholder="Purchase Account (e.g., BCA)" value={formData.purchaseAccount || ''} onChange={handleChange} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="account-suggestions"/><select name="paidStatus" onChange={handleChange} value={formData.paidStatus} disabled={isPurchaserSendiri} className={`w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 ${isPurchaserSendiri && 'opacity-50 cursor-not-allowed'}`}><option value="Unpaid">Unpaid</option><option value="Paid">Paid</option></select></div>
                         <datalist id="account-suggestions">{uniqueSuggestions.purchaseAccounts.filter(s => s.toLowerCase().startsWith((formData.purchaseAccount || '').toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><select name="availability" onChange={handleChange} value={formData.availability} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="Available">Available</option><option value="On Delivery">On Delivery</option><option value="SOLD">SOLD</option></select>{formData.availability === 'SOLD' && (<input type="text" name="soldPrice" placeholder="Sold Price (IDR)" value={soldPriceDisplay} onChange={handleNumberInputChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>)}</div>
                        {formData.availability === 'SOLD' && <><input type="text" name="customer" placeholder="Customer Name" value={formData.customer || ''} onChange={handleChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="customer-suggestions" /><datalist id="customer-suggestions">{uniqueSuggestions.customers.filter(s => s.toLowerCase().startsWith((formData.customer || '').toLowerCase())).map(s => <option key={s} value={s} />)}</datalist></>}
                        <textarea name="notes" placeholder="Notes (optional)" value={formData.notes || ''} onChange={handleChange} rows="2" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"></textarea>
                        <div className="flex justify-end space-x-4 pt-4"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button type="submit" disabled={isSubmitting} className="px-6 py-2 rounded-md bg-yellow-600 hover:bg-yellow-700 text-white transition disabled:bg-yellow-800 disabled:cursor-not-allowed"> {isSubmitting ? 'Updating...' : 'Update Item'} </button></div>
                    </form>
                </div></div>
            )
        }
        
        function ConfirmDeleteModal({ onConfirm, onCancel, item, title }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
                    <h3 className="text-xl font-bold mb-4">{title}</h3><p className="text-gray-600 dark:text-gray-300 mb-2">Are you sure you want to delete this?</p>
                    <div className="bg-gray-100 dark:bg-gray-700 p-3 rounded-md mb-6">{item.phoneModel && <p className="font-semibold">{item.phoneModel} {item.storage}</p>}{item.imei && <p className="text-sm text-gray-500 dark:text-gray-400">IMEI: {item.imei}</p>}{item.invoiceNumber && <p className="font-semibold">Invoice: {item.invoiceNumber}</p>}{item.customerName && <p className="text-sm text-gray-500 dark:text-gray-400">Customer: {item.customerName}</p>}</div>
                    <div className="flex justify-end space-x-4"><button onClick={onCancel} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button onClick={onConfirm} className="px-6 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white transition">Delete</button></div>
                </div></div>
            )
        }

        function SalesInvoiceModal({ stock, closeModal, userId, uniqueSuggestions }) {
            const [customerName, setCustomerName] = useState(''); const [customerPhone, setCustomerPhone] = useState(''); const [paymentTerms, setPaymentTerms] = useState(''); const [paymentStatus, setPaymentStatus] = useState('Lunas'); const [discount, setDiscount] = useState(0); const [discountDisplay, setDiscountDisplay] = useState(''); const [otherCosts, setOtherCosts] = useState(0); const [otherCostsDisplay, setOtherCostsDisplay] = useState(''); const [costInputType, setCostInputType] = useState('dropdown'); const [costDescription, setCostDescription] = useState('Ongkos Kirim'); const [manualCostDescription, setManualCostDescription] = useState(''); const [selectedItems, setSelectedItems] = useState([]); const [manualItems, setManualItems] = useState([]); const [searchTerm, setSearchTerm] = useState(''); const [view, setView] = useState('form'); const [invoicePreviewData, setInvoicePreviewData] = useState(null); const [isGenerating, setIsGenerating] = useState(false); const previewRef = useRef(null); const [savedInvoiceId, setSavedInvoiceId] = useState(null); const PREDEFINED_COSTS = ['Ongkos Kirim', 'Biaya Admin', 'Biaya Packing'];
            
            const availableStock = useMemo(() => stock.filter(item => item.availability === 'Available' && item.imei && (searchTerm ? (item.phoneModel?.toLowerCase().includes(searchTerm.toLowerCase()) || item.imei?.toLowerCase().includes(searchTerm.toLowerCase()) || item.storage?.toLowerCase().includes(searchTerm.toLowerCase()) || item.color?.toLowerCase().includes(searchTerm.toLowerCase())) : true)), [stock, searchTerm]);
            const groupedSelectedItems = useMemo(() => selectedItems.reduce((acc, item) => { const key = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`; if (!acc[key]) { acc[key] = { details: { phoneModel: item.phoneModel, storage: item.storage, ram: item.ram, color: item.color }, items: [], soldPrice: item.soldPrice }; } acc[key].items.push(item); return acc; }, {}), [selectedItems]);

            const handleManualItemChange = (index, field, value) => {
                const newItems = [...manualItems];
                const currentItem = { ...newItems[index] };
                if (field === 'soldPrice') { currentItem.soldPrice = parseFormattedNumber(value); } 
                else if (field === 'quantity') { const qty = parseInt(value, 10); currentItem.quantity = isNaN(qty) || qty < 1 ? 1 : qty; } 
                else if (field === 'serialNumbers') { currentItem.serialNumbers = value; const serials = value.split('\n').filter(Boolean); currentItem.quantity = serials.length > 0 ? serials.length : 1; } 
                else { currentItem[field] = value; }
                newItems[index] = currentItem;
                setManualItems(newItems);
            };
            const addManualItemRow = () => { setManualItems(prev => [...prev, { key: Date.now(), itemName: '', soldPrice: 0, quantity: 1, serialNumbers: '' }]); };
            const removeManualItemRow = (index) => { setManualItems(prev => prev.filter((_, i) => i !== index)); };

            const toggleItemSelection = (item) => { setSelectedItems(prev => { const isSelected = prev.some(i => i.id === item.id); if (isSelected) { return prev.filter(i => i.id !== item.id); } else { const groupKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`; const existingGroupItems = prev.filter(i => `${i.phoneModel}-${i.storage}-${i.ram}-${i.color}` === groupKey); const price = existingGroupItems.length > 0 ? existingGroupItems[0].soldPrice : item.price; return [...prev, { ...item, soldPrice: price }]; } }); };
            const deselectOneFromGroup = (groupKey) => { setSelectedItems(prev => { const itemToRemove = prev.find(i => `${i.phoneModel}-${i.storage}-${i.ram}-${i.color}` === groupKey); if (itemToRemove) { return prev.filter(i => i.id !== itemToRemove.id); } return prev; }); };
            const handleGroupSoldPriceChange = (groupKey, newPrice) => { const rawPrice = parseFormattedNumber(newPrice); setSelectedItems(prev => prev.map(item => { const currentKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`; if (currentKey === groupKey) { return { ...item, soldPrice: rawPrice }; } return item; })); };
            const handleDiscountChange = (e) => { const displayValue = formatNumberInput(e.target.value); const rawValue = parseFormattedNumber(e.target.value); setDiscountDisplay(displayValue); setDiscount(rawValue); };
            const handleOtherCostsChange = (e) => { const displayValue = formatNumberInput(e.target.value); const rawValue = parseFormattedNumber(e.target.value); setOtherCostsDisplay(displayValue); setOtherCosts(rawValue); };

            const handlePreview = async () => {
                const validManualItems = manualItems.filter(i => i.itemName.trim() && i.soldPrice > 0);
                if (!customerName || !paymentTerms || (selectedItems.length === 0 && validManualItems.length === 0)) { alert("Silakan isi nama pelanggan, termin pembayaran, dan pilih atau tambahkan minimal satu barang."); return; }
                
                const today = new Date(); const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()); const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'invoices'); const q = window.firebase.query(invoicesCollectionRef, window.firebase.where('date', '>=', window.firebase.Timestamp.fromDate(startOfDay))); const querySnapshot = await window.firebase.getDocs(q); const todaysInvoiceCount = querySnapshot.size; const dateString = new Date().toLocaleDateString('fr-CA').replace(/-/g, '').slice(2);
                
                const subTotalFromStock = selectedItems.reduce((acc, i) => acc + i.soldPrice, 0);
                const subTotalFromManual = validManualItems.reduce((acc, i) => acc + (i.soldPrice * i.quantity), 0);
                const subTotal = subTotalFromStock + subTotalFromManual;
                const total = subTotal - discount + otherCosts;
                const finalCostDescription = costInputType === 'manual' ? manualCostDescription : costDescription;
                
                const allItems = [
                    ...selectedItems,
                    ...validManualItems.map(item => ({ ...item, serialNumbers: (item.serialNumbers || '').split('\n').filter(Boolean) }))
                ];

                const data = { invoiceNumber: `${paymentTerms.toUpperCase()}/${dateString}/${todaysInvoiceCount + 1}`, customerName, customerPhone, paymentTerms, paymentStatus, date: window.firebase.Timestamp.fromDate(new Date()), items: allItems, subTotal, discount, otherCosts, costDescription: finalCostDescription, total };
                setInvoicePreviewData(data);
                setView('preview');
            };

            const confirmAndSaveInvoice = async (dataToSave) => {
                if (savedInvoiceId) return savedInvoiceId; if(!db || !dataToSave) return null;
                try {
                    const batch = window.firebase.writeBatch(db); const saleDate = window.firebase.Timestamp.fromDate(new Date());
                    for (const item of dataToSave.items) {
                        if (item.id) { // Only update if it's a stock item with an ID
                           const stockDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', item.id);
                           batch.update(stockDocRef, { availability: 'SOLD', customer: dataToSave.customerName, soldPrice: item.soldPrice, profit: item.soldPrice - item.hpp, soldDate: saleDate });
                        }
                    }
                    const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'invoices');
                    const newInvoiceRef = window.firebase.doc(invoicesCollectionRef);
                    const stockItemIds = dataToSave.items.filter(item => item.id).map(item => item.id);
                    const sanitizedItems = dataToSave.items.map(item => {
                        if (item.id) { // Stock Item
                            const { id, phoneModel, storage, ram, color, imei, soldPrice, hpp } = item;
                            return { id, phoneModel, storage, ram, color, imei, soldPrice, hpp, quantity: 1 };
                        } else { // Manual Item
                            const { itemName, soldPrice, quantity, serialNumbers } = item;
                            return { itemName, soldPrice, quantity, serialNumbers: serialNumbers || [], hpp: 0 };
                        }
                    });
                    const finalInvoiceData = { ...dataToSave, id: newInvoiceRef.id, stockItemIds, items: sanitizedItems };
                    batch.set(newInvoiceRef, finalInvoiceData);
                    await batch.commit();
                    await addLog(userId, { message: `Created invoice ${finalInvoiceData.invoiceNumber} for ${finalInvoiceData.customerName}`, type: 'CREATE_INVOICE', context: { docId: newInvoiceRef.id, invoiceData: finalInvoiceData } });
                    setSavedInvoiceId(newInvoiceRef.id);
                    return newInvoiceRef.id;
                } catch (error) { console.error("Error creating invoice: ", error); alert('Gagal menyimpan invoice.'); return null; }
            };

            const handleActionAndClose = async (format) => { if (isGenerating || (format && !previewRef.current)) return; setIsGenerating(true); const invoiceId = await confirmAndSaveInvoice(invoicePreviewData); if (invoiceId) { 
                if (format) { 
                    const canvas = await generateInvoiceCanvas(invoicePreviewData);
                    if (format === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4'); 
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'MEDIUM');
                        pdf.save(`Invoice-${invoicePreviewData.invoiceNumber.replace(/\//g, '-')}.pdf`);
                    } else if (format === 'jpg') {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.download = `Invoice-${invoicePreviewData.invoiceNumber.replace(/\//g, '-')}.jpg`;
                        link.click();
                    }
                } 
                alert('Invoice berhasil disimpan!'); closeModal(); 
            } 
            setIsGenerating(false); };

            useEffect(() => { if (view === 'preview' && previewRef.current) { const container = previewRef.current.parentElement; const a4Element = previewRef.current.querySelector('.preview-a4'); const updateScale = () => { if (container && a4Element) { a4Element.style.setProperty('--preview-scale', container.offsetWidth / a4Element.offsetWidth); } }; updateScale(); window.addEventListener('resize', updateScale); return () => window.removeEventListener('resize', updateScale); } }, [view, invoicePreviewData]);
            
            if (view === 'preview') {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-full flex flex-col text-sm">
                        <div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-2"><h3 className="text-xl sm:text-2xl font-bold">Invoice Preview</h3><div className="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto"><button onClick={() => { setView('form'); setSavedInvoiceId(null); }} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition text-xs sm:text-sm" disabled={isGenerating}>Back to Edit</button><button onClick={() => handleActionAndClose(null)} className="px-4 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition text-xs sm:text-sm" disabled={isGenerating || savedInvoiceId}>{isGenerating ? 'Saving...' : 'Save & Close'}</button><button onClick={() => handleActionAndClose('pdf')} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>{isGenerating ? 'Generating...' : 'Generate PDF & Close'}</button><button onClick={() => handleActionAndClose('jpg')} className="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>{isGenerating ? 'Generating...' : 'Generate JPG & Close'}</button></div></div>
                        <div className="flex-grow overflow-y-auto p-2 sm:p-6 flex justify-center bg-gray-200 dark:bg-gray-900"><div className="preview-container" ref={previewRef}><InvoiceTemplate invoiceData={invoicePreviewData} /></div></div>
                    </div></div>
                );
            }
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-full flex flex-col">
                    <h3 className="text-2xl font-bold p-6 border-b border-gray-200 dark:border-gray-700">Create Sales Invoice</h3>
                    <div className="flex-grow overflow-y-auto p-6">
                        {/* Customer & Invoice Details */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" placeholder="Customer Name" value={customerName} onChange={e => setCustomerName(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="customer-suggestions" />
                            <datalist id="customer-suggestions">{uniqueSuggestions.customers.filter(s => s.toLowerCase().startsWith(customerName.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                            <input type="text" placeholder="Customer Phone" value={customerPhone} onChange={e => setCustomerPhone(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="Payment Terms (e.g., BCA, Cash)" value={paymentTerms} onChange={e => setPaymentTerms(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" list="payment-terms-suggestions"/>
                            <datalist id="payment-terms-suggestions">{uniqueSuggestions.paymentTerms.filter(s => s.toLowerCase().startsWith(paymentTerms.toLowerCase())).map(s => <option key={s} value={s} />)}</datalist>
                            <select value={paymentStatus} onChange={e => setPaymentStatus(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="Lunas">Lunas</option><option value="Belum Lunas">Belum Lunas</option></select>
                            <input type="text" placeholder="Discount (IDR)" value={discountDisplay} onChange={handleDiscountChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                        </div>
                        <div className="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4"><h4 className="text-lg font-semibold mb-2">Biaya Tambahan</h4><div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-center"><select value={costInputType} onChange={(e) => setCostInputType(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="dropdown">Pilih Jenis Biaya</option><option value="manual">Ketik Manual</option></select>{costInputType === 'dropdown' ? (<select value={costDescription} onChange={(e) => setCostDescription(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600">{PREDEFINED_COSTS.map(cost => <option key={cost} value={cost}>{cost}</option>)}</select>) : (<input type="text" placeholder="Keterangan Biaya" value={manualCostDescription} onChange={(e) => setManualCostDescription(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>)}<input type="text" placeholder="Nominal Biaya (IDR)" value={otherCostsDisplay} onChange={handleOtherCostsChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div></div>
                        
                        {/* Stock Item Selection */}
                        <h4 className="text-lg font-semibold mb-2 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">Select Items from Stock</h4>
                        <input type="text" placeholder="Search available stock by model, IMEI, storage, color..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 mb-4" />
                        <div className="overflow-y-auto border border-gray-300 dark:border-gray-700 rounded-lg p-2 mb-4 h-48">{availableStock.length > 0 ? availableStock.map(item => ( <div key={item.id} className={`p-3 rounded-lg mb-2 flex justify-between items-center cursor-pointer transition ${selectedItems.find(i => i.id === item.id) ? 'bg-green-100 dark:bg-green-800' : 'bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600'}`} onClick={() => toggleItemSelection(item)}><div><p className="font-bold">{[item.phoneModel, item.storage, item.ram, item.color].filter(Boolean).join(' ')}</p><p className="text-sm text-gray-500 dark:text-gray-400">IMEI: {item.imei} | Price: {formatRupiahDisplay(item.price)}</p></div><div className="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-300" style={{borderColor: selectedItems.find(i => i.id === item.id) ? '#10B981' : '#9CA3AF'}}>{selectedItems.find(i => i.id === item.id) && <div className="w-3 h-3 bg-green-500 rounded-full"></div>}</div></div> )) : <p className="text-gray-500 dark:text-gray-400 text-center py-4">No items available in stock.</p>}</div>
                        
                       {/* Manual Item Input */}
                        <h4 className="text-lg font-semibold mb-2 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">Manual Items</h4>
                        <div className="max-h-48 overflow-y-auto pr-2">{manualItems.map((item, index) => (
                            <div key={item.key} className="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-3 mt-3 first:mt-0 first:border-t-0 first:pt-0">
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-stretch">
                                    <input type="text" placeholder="Item Name (e.g., Service, Aksesoris)" value={item.itemName} onChange={e => handleManualItemChange(index, 'itemName', e.target.value)} className="md:col-span-5 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <input type="text" placeholder="Price (IDR)" value={formatNumberInput(item.soldPrice)} onChange={e => handleManualItemChange(index, 'soldPrice', e.target.value)} className="md:col-span-3 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <input type="number" placeholder="Qty" value={item.quantity} onChange={e => handleManualItemChange(index, 'quantity', e.target.value)} className="md:col-span-2 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <button type="button" onClick={() => removeManualItemRow(index)} className="md:col-span-2 w-full p-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Remove</button>
                                </div>
                                <div>
                                    <textarea placeholder="Serial Numbers / IMEIs (1 per line, auto-updates Qty)" value={item.serialNumbers} onChange={e => handleManualItemChange(index, 'serialNumbers', e.target.value)} rows="3" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 text-sm"/>
                                </div>
                            </div>
                        ))}</div>
                        <button type="button" onClick={addManualItemRow} className="w-full mt-2 p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Add Manual Item</button>

                        {/* Selected Items Summary */}
                        {selectedItems.length > 0 && (<div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700"><h4 className="text-lg font-semibold mb-2">Selected Stock Items</h4><div className="overflow-y-auto h-32 pr-2">{Object.entries(groupedSelectedItems).map(([key, group]) => (<div key={key} className="flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-2 rounded-md mb-2"><div><p>{[group.details.phoneModel, group.details.storage, group.details.ram, group.details.color].filter(Boolean).join(' ')}</p><div className="flex items-center gap-2"><p className="text-sm text-gray-500 dark:text-gray-400">Qty: {group.items.length}</p><button onClick={() => deselectOneFromGroup(key)} className="text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 text-xs">(Deselect One)</button></div></div><input type="text" value={formatNumberInput(group.soldPrice)} onChange={(e) => handleGroupSoldPriceChange(key, e.target.value)} className="w-40 p-2 bg-white dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-500" placeholder="Sold Price"/></div>))}</div></div>)}
                    </div>
                    <div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button onClick={handlePreview} className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition" disabled={selectedItems.length === 0 && manualItems.filter(i => i.itemName.trim() && i.soldPrice > 0).length === 0}>Preview Invoice</button></div>
                </div></div>
            );
        }

        function EditInvoiceStatusModal({ invoice, closeModal, userId }) {
            const [status, setStatus] = useState(invoice.paymentStatus || 'Lunas'); const [isSubmitting, setIsSubmitting] = useState(false); const originalStatusRef = useRef(invoice.paymentStatus || 'Lunas');
            const handleSave = async () => { if (!userId || !invoice.id || isSubmitting) return; setIsSubmitting(true); try { const invoiceDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'invoices', invoice.id); await window.firebase.updateDoc(invoiceDocRef, { paymentStatus: status }); await addLog(userId, { message: `Updated status for invoice ${invoice.invoiceNumber} to ${status}`, type: 'EDIT_INVOICE_STATUS', context: { docId: invoice.id, previousData: { paymentStatus: originalStatusRef.current }, updatedField: { paymentStatus: status } } }); closeModal(); } catch (error) { console.error("Error updating invoice status:", error); alert("Failed to update status."); } finally { setIsSubmitting(false); } };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
                    <h3 className="text-xl font-bold mb-4">Edit Payment Status</h3><p className="text-gray-600 dark:text-gray-300 mb-2">Invoice: <span className="font-semibold">{invoice.invoiceNumber}</span></p>
                    <div className="my-4"><label htmlFor="status-select" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label><select id="status-select" value={status} onChange={(e) => setStatus(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="Lunas">Lunas</option><option value="Belum Lunas">Belum Lunas</option></select></div>
                    <div className="flex justify-end space-x-4 pt-4"><button onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button onClick={handleSave} disabled={isSubmitting} className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition disabled:bg-blue-800 disabled:cursor-not-allowed">{isSubmitting ? 'Saving...' : 'Save'}</button></div>
                </div></div>
            );
        }

        function InvoiceListPage({ userId }) {
            const [invoices, setInvoices] = useState([]); const [loading, setLoading] = useState(true); const [itemToDelete, setItemToDelete] = useState(null); const [editingInvoice, setEditingInvoice] = useState(null); const [previewingInvoice, setPreviewingInvoice] = useState(null);
            const [isManualInvoiceModalOpen, setIsManualInvoiceModalOpen] = useState(false);
            const [isSharing, setIsSharing] = useState(null); 

            useEffect(() => { if (!userId || !db) return; const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'invoices'); const q = window.firebase.query(invoicesCollectionRef, window.firebase.orderBy('date', 'desc')); const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => { const invoicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); setInvoices(invoicesData); setLoading(false); }, (error) => { console.error("Error fetching invoices:", error); setLoading(false); }); return () => unsubscribe(); }, [userId]);
            const handleDeleteInvoice = async () => {
                if (!itemToDelete || !userId) return;
                try {
                    const batch = window.firebase.writeBatch(db); if (itemToDelete.stockItemIds && Array.isArray(itemToDelete.stockItemIds)) { for (const stockId of itemToDelete.stockItemIds) { const stockDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', stockId); batch.update(stockDocRef, { availability: 'Available', customer: '', soldPrice: null, profit: null, soldDate: null }); } }
                    const invoiceDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'invoices', itemToDelete.id); batch.delete(invoiceDocRef); await batch.commit();
                    await addLog(userId, { message: `Deleted invoice ${itemToDelete.invoiceNumber}`, type: 'DELETE_INVOICE', context: { docId: itemToDelete.id, deletedData: itemToDelete } });
                    setItemToDelete(null);
                } catch (error) { console.error("Error deleting invoice and updating stock:", error); alert("Error deleting invoice.")}
            };

            const handleShareToWhatsApp = async (invoice) => {
                if (!invoice.customerPhone) {
                    alert("Customer phone number is not available for this invoice.");
                    return;
                }
                setIsSharing(invoice.id);

                try {
                    const canvas = await generateInvoiceCanvas(invoice);
                    canvas.toBlob(async (blob) => {
                        const file = new File([blob], `Invoice-${invoice.invoiceNumber}.jpg`, { type: 'image/jpeg' });
                        let shareData = {
                            files: [file],
                            title: `Invoice ${invoice.invoiceNumber}`,
                            text: `Halo ${invoice.customerName},\n\nBerikut adalah invoice Anda dari Griphub Ponsel.`
                        };
                        
                        let waMessage = shareData.text; 

                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share(shareData);
                                return; 
                            } catch (err) {
                                console.log("Web Share was canceled or failed:", err);
                                if (err.name === 'AbortError') return;
                            }
                        }

                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                const clipboardItem = new ClipboardItem({ 'image/jpeg': blob });
                                await navigator.clipboard.write([clipboardItem]);
                                waMessage += `\n\n*Invoice telah disalin ke clipboard Anda, silakan tempel (paste) di chat ini.*`;
                                alert('Invoice image copied to clipboard! Ready to paste in WhatsApp.');
                            } catch (err) {
                                console.error('Could not copy image to clipboard:', err);
                                waMessage += '\n\n(Gagal menyalin gambar otomatis, silakan download dan kirim manual)';
                                alert('Failed to copy image automatically. Please use the Preview > Generate JPG button to share manually.');
                            }
                        } else {
                            waMessage += '\n\n(Browser Anda tidak mendukung share otomatis, silakan download dan kirim manual)';
                             alert("Your browser doesn't support direct sharing. Please use the Preview > Generate JPG button to share manually.");
                        }

                        let cleanPhone = invoice.customerPhone.replace(/\D/g, '');
                        if (cleanPhone.startsWith('0')) {
                            cleanPhone = '62' + cleanPhone.substring(1);
                        } else if (!cleanPhone.startsWith('62')) {
                            cleanPhone = '62' + cleanPhone;
                        }
                        const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(waMessage)}`;
                        window.open(url, '_blank');

                    }, 'image/jpeg', 0.95);

                } catch (error) {
                    console.error("Failed to generate or share invoice image:", error);
                    alert("An error occurred while preparing the invoice for sharing.");
                } finally {
                    setIsSharing(null);
                }
            };

            return (
                <div className="container mx-auto">
                    {itemToDelete && <ConfirmDeleteModal title="Delete Invoice" onConfirm={handleDeleteInvoice} onCancel={() => setItemToDelete(null)} item={itemToDelete} />}
                    {editingInvoice && <EditInvoiceStatusModal invoice={editingInvoice} closeModal={() => setEditingInvoice(null)} userId={userId} />}
                    {previewingInvoice && <InvoicePreviewModal invoice={previewingInvoice} closeModal={() => setPreviewingInvoice(null)} />}
                    {isManualInvoiceModalOpen && <ManualInvoiceModal closeModal={() => setIsManualInvoiceModalOpen(false)} userId={userId} />}
                    
                    <h2 className="text-3xl font-bold mb-6">Invoice List</h2>
                    <div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-x-auto">
                        {loading ? <div className="text-center p-10">Loading invoices...</div> : invoices.length > 0 ? (
                        <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead className="bg-gray-100 dark:bg-gray-700"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Invoice #</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Customer Name</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Amount</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Profit</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th></tr></thead>
                            <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                {invoices.map((invoice, index) => { const totalProfit = invoice.items.reduce((sum, item) => sum + ((item.soldPrice || 0) - (item.hpp || 0)), 0); return (
                                    <tr key={invoice.id} className="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                        <td className="px-6 py-3 whitespace-nowrap text-sm">{index + 1}</td><td className="px-6 py-3 whitespace-nowrap text-sm">{formatDate(invoice.date, false)}</td><td className="px-6 py-3 whitespace-nowrap text-sm">{invoice.invoiceNumber}</td><td className="px-6 py-3 whitespace-nowrap text-sm font-semibold">{invoice.customerName}</td><td className="px-6 py-3 whitespace-nowrap text-sm">{formatRupiahDisplay(invoice.total)}</td><td className="px-6 py-3 whitespace-nowrap text-sm font-bold text-green-600 dark:text-green-400">{invoice.isManual ? 'N/A' : formatRupiahDisplay(totalProfit)}</td>
                                        <td className="px-6 py-3 whitespace-nowrap text-sm"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${invoice.paymentStatus === 'Lunas' ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}`}>{invoice.paymentStatus || 'Lunas'}</span></td>
                                        <td className="px-6 py-3 whitespace-nowrap text-sm"><div className="flex items-center gap-4">
                                            <button onClick={() => setPreviewingInvoice(invoice)} className="text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300" title="Preview Invoice"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" /></svg></button>
                                            <button onClick={() => handleShareToWhatsApp(invoice)} disabled={isSharing === invoice.id} className="text-green-500 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 disabled:opacity-50 disabled:cursor-wait" title="Share Invoice to WhatsApp">
                                                {isSharing === invoice.id ? (
                                                    <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                ) : (
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" className="h-5 w-5" viewBox="0 0 16 16"> <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/> </svg>
                                                )}
                                            </button>
                                            <button onClick={() => setEditingInvoice(invoice)} className="text-yellow-500 dark:text-yellow-400 hover:text-yellow-700 dark:hover:text-yellow-300" title="Edit Status"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button>
                                            <button onClick={() => setItemToDelete(invoice)} className="text-red-600 dark:text-red-500 hover:text-red-700 dark:hover:text-red-400" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg></button>
                                        </div></td>
                                    </tr>
                                )})}
                            </tbody>
                        </table>
                        ) : <div className="text-center p-10">No invoices found.</div>}
                    </div>
                    <div className="fixed bottom-20 lg:bottom-6 right-6 flex flex-col items-center gap-4 z-40">
                         <button onClick={() => setIsManualInvoiceModalOpen(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full h-14 w-14 flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" title="Create Manual Invoice">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                    </div>
                </div>
            );
        }
        
        function InvoicePreviewModal({ invoice, closeModal }) {
            const previewRef = useRef(null); 
            const [isGenerating, setIsGenerating] = useState(false);
            
            const handleGenerate = async (format) => {
                if (isGenerating) return;
                setIsGenerating(true);
                try {
                    const canvas = await generateInvoiceCanvas(invoice);
                    if (format === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                        pdf.save(`Invoice-${invoice.invoiceNumber.replace(/\//g, '-')}.pdf`);
                    } else if (format === 'jpg') {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.download = `Invoice-${invoice.invoiceNumber.replace(/\//g, '-')}.jpg`;
                        link.click();
                    }
                } catch (error) {
                    console.error("Error generating output:", error);
                    alert("Failed to generate file.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleDirectPrint = () => { const container = document.getElementById('print-root'); if (!container) return; const PrintComponent = () => ( <div className="print-area"><InvoiceTemplate invoiceData={invoice} /></div> ); ReactDOM.render(<PrintComponent />, container, () => { window.print(); ReactDOM.unmountComponentAtNode(container); }); };
            useEffect(() => { if (previewRef.current) { const container = previewRef.current; const a4Element = previewRef.current.querySelector('.preview-a4'); const updateScale = () => { if (container && a4Element) { a4Element.style.setProperty('--preview-scale', container.offsetWidth / a4Element.offsetWidth); } }; updateScale(); window.addEventListener('resize', updateScale); return () => window.removeEventListener('resize', updateScale); } }, [invoice]);
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-full flex flex-col text-sm">
                    <div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-2"><h3 className="text-xl sm:text-2xl font-bold">Invoice Preview</h3><div className="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto"><button onClick={closeModal} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition text-xs sm:text-sm" disabled={isGenerating}>Close</button><button onClick={handleDirectPrint} className="px-4 py-2 rounded-md bg-sky-600 hover:bg-sky-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>Print Invoice</button><button onClick={() => handleGenerate('pdf')} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>{isGenerating ? 'Generating...' : 'Generate PDF'}</button><button onClick={() => handleGenerate('jpg')} className="px-4 py-2 rounded-md bg-purple-600 hover:bg-purple-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>{isGenerating ? 'Generating...' : 'Generate JPG'}</button></div></div>
                    <div className="flex-grow overflow-y-auto p-2 sm:p-6 flex justify-center bg-gray-200 dark:bg-gray-900"><div className="preview-container" ref={previewRef}><InvoiceTemplate invoiceData={invoice} /></div></div>
                </div></div>
            );
        }

        function ModelPieChart({ chartData }) {
            const chartRef = useRef(null); const chartInstanceRef = useRef(null);
            const theme = localStorage.getItem('theme') || 'dark';

            useEffect(() => { if (!chartRef.current || typeof Chart === 'undefined') return; const ctx = chartRef.current.getContext('2d'); if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } const labels = Object.keys(chartData); const data = Object.values(chartData); if (labels.length === 0) return; 
            chartInstanceRef.current = new Chart(ctx, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Unit', data: data, backgroundColor: ['#60A5FA', '#34D399', '#FBBF24', '#F87171', '#A78BFA', '#F472B6', '#4ADE80', '#2DD4BF', '#F43F5E', '#818CF8'], borderColor: theme === 'dark' ? '#374151' : '#FFFFFF', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: theme === 'dark' ? '#D1D5DB' : '#374151', font: { size: 12 }, boxWidth: 15, padding: 15 } } } } }); return () => { if (chartInstanceRef.current) { chartInstanceRef.current.destroy(); } }; }, [chartData, theme]);
            return (<div className="relative h-80 w-full"><canvas ref={chartRef}></canvas></div>);
        }
        
        function UnitBreakdownCard({ data, handleCopy, copyStatus }) {
            if (!data || data.length === 0) {
                 return (
                    <div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 h-full">
                        <h3 className="text-xl font-bold mb-4">Rincian Unit Tersedia</h3>
                        <div className="flex items-center justify-center h-full pb-10">
                            <p className="text-center text-gray-500 dark:text-gray-400">No available stock for this month.</p>
                        </div>
                    </div>
                );
            }
            return (
                <div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold mb-0">Rincian Unit Tersedia</h3>
                        <button onClick={handleCopy} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">{copyStatus}</button>
                    </div>
                    <div className="overflow-y-auto max-h-80 mt-4"><table className="min-w-full divide-y divide-gray-300 dark:divide-gray-600"><thead className="bg-gray-200 dark:bg-gray-600 sticky top-0"><tr>
                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Model & Varian</th><th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Warna</th><th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Jumlah Unit</th>
                    </tr></thead><tbody className="bg-gray-100 dark:bg-gray-700 divide-y divide-gray-300 dark:divide-gray-600">
                        {data.map((item, index) => (<tr key={index} className="hover:bg-gray-200/50 dark:hover:bg-gray-600/50 transition"><td className="px-4 py-3 whitespace-nowrap text-sm font-medium">{[item.model, item.storage, item.ram].filter(Boolean).join(' ')}</td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{item.color}</td><td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{item.count}</td></tr>))}
                    </tbody></table></div>
                </div>
            )
        }

        function FinancialReportPage({ stockData, invoicesData }) {
            const [selectedMonth, setSelectedMonth] = useState('');
            const [copyStatus, setCopyStatus] = useState('Copy');
            const [hideNominals, setHideNominals] = useState(false);
            const [chartFilter, setChartFilter] = useState('all');

            const { monthlyData, availableMonths, unitBreakdown } = useMemo(() => {
                const getMonthKey = (timestamp) => {
                    if (!timestamp) return null;
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    if (isNaN(date.getTime())) return null;
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                };

                const allMonthKeys = new Set();
                stockData.forEach(item => {
                    const deliveryDate = item.deliveryDate || item.soldDate; // Use soldDate as a fallback for deliveryMonth
                    if (deliveryDate) allMonthKeys.add(getMonthKey(deliveryDate));
                    if (item.soldDate) allMonthKeys.add(getMonthKey(item.soldDate));
                });
                invoicesData.forEach(inv => {
                    if (inv.date) allMonthKeys.add(getMonthKey(inv.date));
                });
                
                if(allMonthKeys.size === 0) {
                     const currentMonthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
                     allMonthKeys.add(currentMonthKey);
                }

                const initialMonthlyData = {};
                [...allMonthKeys].filter(Boolean).forEach(key => {
                     initialMonthlyData[key] = {
                        totalOmzet: 0, totalProfit: 0, totalHpp: 0,
                        totalAvailableInventoryValue: 0, totalOnDeliveryInventoryValue: 0,
                        totalAvailableStockCount: 0,
                        totalUnitsOnDelivery: 0, totalUnitsSold: 0, totalUnitsPurchased: 0,
                        unitBreakdown: {}, modelCountsAll: {}, modelCountsSold: {}, modelCountsAvailable: {},
                        avgHppData: {}, avgHppDataAll: {},
                    };
                });
                
                invoicesData.forEach(inv => {
                    const monthKey = getMonthKey(inv.date);
                    if (monthKey && initialMonthlyData[monthKey]) {
                        initialMonthlyData[monthKey].totalOmzet += inv.total || 0;
                        const invoiceProfit = inv.items.reduce((sum, item) => sum + ((item.soldPrice || 0) - (item.hpp || 0)), 0);
                        initialMonthlyData[monthKey].totalProfit += invoiceProfit;
                        
                        const invoiceUnitCount = inv.items.reduce((acc, item) => acc + (item.quantity || 1), 0);
                        initialMonthlyData[monthKey].totalUnitsSold += invoiceUnitCount;
                        
                        inv.items.forEach(item => {
                           const simpleModelKey = item.phoneModel || item.itemName || 'N/A';
                           if (!initialMonthlyData[monthKey].modelCountsSold[simpleModelKey]) {
                               initialMonthlyData[monthKey].modelCountsSold[simpleModelKey] = 0;
                           }
                           initialMonthlyData[monthKey].modelCountsSold[simpleModelKey] += (item.quantity || 1);
                        });
                    }
                });
                
                stockData.forEach(item => {
                    const deliveryMonthKey = getMonthKey(item.deliveryDate || item.soldDate);

                    if (deliveryMonthKey && initialMonthlyData[deliveryMonthKey]) {
                        initialMonthlyData[deliveryMonthKey].totalHpp += item.hpp || 0;
                        initialMonthlyData[deliveryMonthKey].totalUnitsPurchased += 1;
                        
                        const simpleModelKey = item.phoneModel || 'N/A';
                        if (!initialMonthlyData[deliveryMonthKey].modelCountsAll[simpleModelKey]) {
                            initialMonthlyData[deliveryMonthKey].modelCountsAll[simpleModelKey] = 0;
                        }
                        initialMonthlyData[deliveryMonthKey].modelCountsAll[simpleModelKey] += 1;
                        
                        const modelKey = [item.phoneModel || 'N/A', item.storage || '', item.ram || ''].filter(Boolean).join(' ');

                        // Calculate Average HPP for All non-sold stock
                        if (modelKey && (item.availability === 'Available' || item.availability === 'On Delivery')) {
                             if (!initialMonthlyData[deliveryMonthKey].avgHppDataAll[modelKey]) {
                                initialMonthlyData[deliveryMonthKey].avgHppDataAll[modelKey] = { totalHpp: 0, count: 0 };
                            }
                            initialMonthlyData[deliveryMonthKey].avgHppDataAll[modelKey].totalHpp += item.hpp || 0;
                            initialMonthlyData[deliveryMonthKey].avgHppDataAll[modelKey].count += 1;
                        }


                        if (item.availability === 'Available') {
                            initialMonthlyData[deliveryMonthKey].totalAvailableInventoryValue += item.hpp || 0;
                            initialMonthlyData[deliveryMonthKey].totalAvailableStockCount += 1;
                            
                            if (!initialMonthlyData[deliveryMonthKey].modelCountsAvailable[simpleModelKey]) {
                                initialMonthlyData[deliveryMonthKey].modelCountsAvailable[simpleModelKey] = 0;
                            }
                            initialMonthlyData[deliveryMonthKey].modelCountsAvailable[simpleModelKey] += 1;
                            
                            // Calculate Average HPP for available stock only
                            if (modelKey) {
                                if (!initialMonthlyData[deliveryMonthKey].avgHppData[modelKey]) {
                                    initialMonthlyData[deliveryMonthKey].avgHppData[modelKey] = { totalHpp: 0, count: 0 };
                                }
                                initialMonthlyData[deliveryMonthKey].avgHppData[modelKey].totalHpp += item.hpp || 0;
                                initialMonthlyData[deliveryMonthKey].avgHppData[modelKey].count += 1;
                            }
                            const unitKey = `${item.phoneModel}-${item.storage}-${item.ram}-${item.color}`;
                            if(!initialMonthlyData[deliveryMonthKey].unitBreakdown[unitKey]) {
                                initialMonthlyData[deliveryMonthKey].unitBreakdown[unitKey] = { model: item.phoneModel, storage: item.storage, ram: item.ram, color: item.color, count: 0 };
                            }
                            initialMonthlyData[deliveryMonthKey].unitBreakdown[unitKey].count++;
                        } else if (item.availability === 'On Delivery') {
                            initialMonthlyData[deliveryMonthKey].totalUnitsOnDelivery += 1;
                            initialMonthlyData[deliveryMonthKey].totalOnDeliveryInventoryValue += item.hpp || 0;
                        }
                    }
                });

                const availableMonths = [...allMonthKeys].filter(Boolean).sort().reverse();
                const currentMonthData = initialMonthlyData[selectedMonth] || {};
                const unitBreakdown = Object.values(currentMonthData.unitBreakdown || {}).sort((a,b) => a.model.localeCompare(b.model));

                return { monthlyData: initialMonthlyData, availableMonths, unitBreakdown };
            }, [stockData, invoicesData, selectedMonth]);

            const unpaidHppStats = useMemo(() => {
                return stockData.reduce((acc, item) => {
                    if (item.paidStatus === 'Unpaid') {
                        const hppValue = item.hpp || 0;
                        const purchaser = item.purchaser || 'Unknown';
                        acc.totalUnpaidHpp += hppValue;
                        if (!acc.unpaidHppByPurchaser[purchaser]) {
                            acc.unpaidHppByPurchaser[purchaser] = 0;
                        }
                        acc.unpaidHppByPurchaser[purchaser] += hppValue;
                    }
                    return acc;
                }, { totalUnpaidHpp: 0, unpaidHppByPurchaser: {} });
            }, [stockData]);

            useEffect(() => { if (availableMonths.length > 0 && !selectedMonth) { setSelectedMonth(availableMonths[0]); } }, [availableMonths, selectedMonth]);
            
            const currentReport = monthlyData[selectedMonth] || { totalOmzet: 0, totalProfit: 0, totalHpp: 0, totalAvailableInventoryValue: 0, totalOnDeliveryInventoryValue: 0, totalAvailableStockCount: 0, totalUnitsOnDelivery: 0, totalUnitsSold: 0, totalUnitsPurchased: 0, avgHppData: {}, avgHppDataAll: {}, modelCountsAll: {}, modelCountsSold: {}, modelCountsAvailable: {} };
            
            const combinedAverageHppList = useMemo(() => {
                const allModelKeys = new Set([...Object.keys(currentReport.avgHppData), ...Object.keys(currentReport.avgHppDataAll || {})]);
                return Array.from(allModelKeys).map(model => {
                    const dataAvailable = currentReport.avgHppData[model] || { count: 0, totalHpp: 0 };
                    const dataAll = currentReport.avgHppDataAll[model] || { count: 0, totalHpp: 0 };
                    return {
                        model,
                        avgHppAvailable: dataAvailable.count > 0 ? dataAvailable.totalHpp / dataAvailable.count : 0,
                        avgHppAll: dataAll.count > 0 ? dataAll.totalHpp / dataAll.count : 0,
                    };
                }).sort((a, b) => a.model.localeCompare(b.model));
            }, [currentReport.avgHppData, currentReport.avgHppDataAll]);

            const unpaidDetails = Object.entries(unpaidHppStats.unpaidHppByPurchaser || {});
            
            const handleCopy = () => {
                if (!unitBreakdown || unitBreakdown.length === 0) return;
                const groupedByModel = unitBreakdown.reduce((acc, item) => { const key = [item.model, item.storage, item.ram].filter(Boolean).join(' '); if (!acc[key]) { acc[key] = []; } acc[key].push({ color: item.color, count: item.count }); return acc; }, {});
                const textToCopy = Object.entries(groupedByModel).map(([modelDetails, colors]) => { const colorLines = colors.map(c => `${c.color} ${c.count} unit`).join('\n'); return `${modelDetails}\n${colorLines}`; }).join('\n\n');
                navigator.clipboard.writeText(textToCopy).then(() => { setCopyStatus('Copied!'); setTimeout(() => setCopyStatus('Copy'), 2000); }, (err) => { console.error('Could not copy text: ', err); setCopyStatus('Failed!'); setTimeout(() => setCopyStatus('Copy'), 2000); });
            };
            
            const getChartData = () => {
                switch(chartFilter) {
                    case 'sold': return currentReport.modelCountsSold || {};
                    case 'available': return currentReport.modelCountsAvailable || {};
                    case 'all': default: return currentReport.modelCountsAll || {};
                }
            };
            
            return (
                <div className="container mx-auto">
                    <div className="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <h2 className="text-3xl font-bold">Financial Report</h2>
                        <div className="flex items-center gap-4">
                            <select id="month-select" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} className="bg-gray-200 dark:bg-gray-700 p-2 rounded-md border border-gray-300 dark:border-gray-600">
                                {availableMonths.length > 0 ? (availableMonths.map(month => (<option key={month} value={month}>{new Date(month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}</option>))) : (<option value="">No data</option>)}
                            </select>
                            <button onClick={() => setHideNominals(!hideNominals)} className="p-2 rounded-full text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700/50 hover:bg-gray-300 dark:hover:bg-gray-700 focus:outline-none" title={hideNominals ? "Show values" : "Hide values"}>
                                {hideNominals ? (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-5.032 5.032m-9.056-9.056A9.953 9.953 0 013 12c0 1.605.42 3.113 1.157 4.418" /></svg>
                                ) : (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.522 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7S3.732 16.057 2.458 12z" /></svg>
                                )}
                            </button>
                        </div>
                    </div>
                    <div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                            {/* Financial Cards */}
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg"><h3 className="text-xl font-bold mb-4">Total Omzet</h3><p className="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2">{hideNominals ? 'Rp ******' : formatRupiahDisplay(currentReport.totalOmzet)}</p></div>
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg"><h3 className="text-xl font-bold mb-4">Total Profit</h3><p className="text-3xl font-bold text-green-600 dark:text-green-400 mt-2">{hideNominals ? 'Rp ******' : formatRupiahDisplay(currentReport.totalProfit)}</p></div>
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg"><h3 className="text-xl font-bold mb-4">Total HPP</h3><p className="text-3xl font-bold text-yellow-600 dark:text-yellow-400 mt-2">{hideNominals ? 'Rp ******' : formatRupiahDisplay(currentReport.totalHpp)}</p></div>
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg flex flex-col"><h3 className="text-xl font-bold mb-4">Total Unpaid HPP</h3><p className="text-3xl font-bold text-red-600 dark:text-red-400 mt-2">{hideNominals ? 'Rp ******' : formatRupiahDisplay(unpaidHppStats.totalUnpaidHpp)}</p>{unpaidDetails.length > 0 && (<div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 flex-grow"><h4 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Rincian per Purchaser:</h4><ul className="space-y-1 text-xs max-h-24 overflow-y-auto pr-2">{unpaidDetails.map(([purchaser, amount]) => (<li key={purchaser} className="flex justify-between items-center text-gray-600 dark:text-gray-300"><span>{purchaser}</span><span className="font-medium text-red-500 dark:text-red-300">{hideNominals ? 'Rp ******' : formatRupiahDisplay(amount)}</span></li>))}</ul></div>)}</div>
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg flex flex-col">
                                <h3 className="text-xl font-bold mb-4">Total Inventory Value</h3>
                                <p className="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2">{hideNominals ? 'Rp ******' : formatRupiahDisplay((currentReport.totalAvailableInventoryValue || 0) + (currentReport.totalOnDeliveryInventoryValue || 0))}</p>
                                <div className="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 flex-grow">
                                     <ul className="space-y-2 text-sm">
                                        <li className="flex justify-between items-center text-gray-600 dark:text-gray-300">
                                            <span>Available:</span>
                                            <span className="font-medium text-indigo-500 dark:text-indigo-300">
                                               {hideNominals ? 'Rp ******' : formatRupiahDisplay(currentReport.totalAvailableInventoryValue)}
                                            </span>
                                        </li>
                                        <li className="flex justify-between items-center text-gray-600 dark:text-gray-300">
                                            <span>On Delivery:</span>
                                            <span className="font-medium text-indigo-500 dark:text-indigo-300">
                                               {hideNominals ? 'Rp ******' : formatRupiahDisplay(currentReport.totalOnDeliveryInventoryValue)}
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div className="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg">
                                <h3 className="text-xl font-bold mb-4">Unit Status Summary</h3>
                                <div className="space-y-4">
                                    <div className="flex justify-between items-baseline">
                                        <span className="font-medium text-gray-700 dark:text-gray-300">Available</span>
                                        <p className="text-2xl font-bold text-pink-600 dark:text-pink-400">{currentReport.totalAvailableStockCount}</p>
                                    </div>
                                    <div className="flex justify-between items-baseline">
                                        <span className="font-medium text-gray-700 dark:text-gray-300">On Delivery</span>
                                        <p className="text-2xl font-bold text-orange-500 dark:text-orange-400">{currentReport.totalUnitsOnDelivery}</p>
                                    </div>
                                    <div className="flex justify-between items-baseline">
                                        <span className="font-medium text-gray-700 dark:text-gray-300">Sold</span>
                                        <p className="text-2xl font-bold text-cyan-500 dark:text-cyan-400">{currentReport.totalUnitsSold}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 mt-8 items-stretch">
                             <div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6 xl:col-span-1">
                                <h3 className="text-xl font-bold mb-4">Average HPP</h3>
                                <div className="overflow-y-auto max-h-80">{combinedAverageHppList.length > 0 ? (
                                    <table className="min-w-full divide-y divide-gray-300 dark:divide-gray-600">
                                        <thead className="bg-gray-200 dark:bg-gray-600 sticky top-0"><tr>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Model & Varian</th>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Avg HPP (Available)</th>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Avg HPP (All Stock)</th>
                                        </tr></thead>
                                        <tbody className="divide-y divide-gray-300 dark:divide-gray-600">{combinedAverageHppList.map((item) => (<tr key={item.model} className="hover:bg-gray-200/50 dark:hover:bg-gray-600/50 transition">
                                            <td className="px-4 py-3 whitespace-nowrap text-sm font-medium">{item.model}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{hideNominals ? 'Rp ******' : item.avgHppAvailable > 0 ? formatRupiahDisplay(item.avgHppAvailable) : 'N/A'}</td>
                                            <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">{hideNominals ? 'Rp ******' : item.avgHppAll > 0 ? formatRupiahDisplay(item.avgHppAll) : 'N/A'}</td>
                                        </tr>))}</tbody>
                                    </table>
                                    ) : (<div className="text-center p-10 text-gray-500 dark:text-gray-400">No HPP data for this month.</div>)}
                                </div>
                            </div>
                            <div className="bg-gray-100 dark:bg-gray-700 shadow-lg rounded-lg p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold mb-0">Model Distribution</h3>
                                    <select value={chartFilter} onChange={e => setChartFilter(e.target.value)} className="bg-gray-200 dark:bg-gray-600 text-sm p-1.5 rounded-md border border-gray-300 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="all">All Items</option>
                                        <option value="sold">Sold</option>
                                        <option value="available">Available</option>
                                    </select>
                                </div>
                                <div className="flex justify-center h-full pt-4">
                                    <ModelPieChart chartData={getChartData()} />
                                </div>
                            </div>
                            <UnitBreakdownCard data={unitBreakdown} handleCopy={handleCopy} copyStatus={copyStatus} />
                        </div>
                    </div>
                </div>
            );
        }

        function PhoneDataManagementPage({ userId, phoneData, setPhoneData }) {
            const [editingModel, setEditingModel] = useState(null); const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const handleSave = async (updatedData) => { const phoneDataRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'phone_data', 'master_list'); try { await window.firebase.setDoc(phoneDataRef, { models: updatedData }); setEditingModel(null); setIsAddModalOpen(false); } catch (error) { console.error("Failed to save phone data:", error); alert("Error saving data."); } };
            const handleDelete = (modelName) => { if (window.confirm(`Are you sure you want to delete the model "${modelName}"? This cannot be undone.`)) { const updatedData = { ...phoneData }; delete updatedData[modelName]; handleSave(updatedData); } };
            return (
                <div className="container mx-auto">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-3xl font-bold">Manage Phone Data</h2><button onClick={() => setIsAddModalOpen(true)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Add New Model</button></div>
                    {isAddModalOpen && <EditPhoneDataModal phoneData={phoneData} onSave={handleSave} closeModal={() => setIsAddModalOpen(false)} />}
                    {editingModel && <EditPhoneDataModal modelName={editingModel} modelData={phoneData[editingModel]} phoneData={phoneData} onSave={handleSave} closeModal={() => setEditingModel(null)} />}
                    <div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{Object.keys(phoneData).sort().map(modelName => (<div key={modelName} className="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex flex-col"><h3 className="font-bold text-lg mb-2">{modelName}</h3><div className="text-sm text-gray-700 dark:text-gray-300 space-y-1 flex-grow"><p><strong>Storage:</strong> {phoneData[modelName].storage.join(', ') || 'N/A'}</p><p><strong>Colors:</strong> {phoneData[modelName].colors.join(', ') || 'N/A'}</p><p><strong>RAM:</strong> {phoneData[modelName].ram.join(', ') || 'N/A'}</p></div><div className="flex gap-2 mt-4"><button onClick={() => setEditingModel(modelName)} className="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Edit</button><button onClick={() => handleDelete(modelName)} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Delete</button></div></div>))}</div>
                    </div>
                </div>
            )
        }
        
        function EditPhoneDataModal({ modelName, modelData, phoneData, onSave, closeModal }) {
            const [name, setName] = useState(modelName || ''); const [storage, setStorage] = useState(modelData?.storage?.join(', ') || ''); const [colors, setColors] = useState(modelData?.colors?.join(', ') || ''); const [ram, setRam] = useState(modelData?.ram?.join(', ') || '');
            const handleSubmit = (e) => {
                e.preventDefault(); if (!name.trim()) { alert("Model name cannot be empty."); return; } const newModelKey = name.trim(); if (!modelName && phoneData[newModelKey]) { alert("A model with this name already exists."); return; }
                const updatedData = { ...phoneData }; if(modelName && modelName !== newModelKey) { delete updatedData[modelName]; }
                updatedData[newModelKey] = { storage: storage.split(',').map(s => s.trim()).filter(Boolean), colors: colors.split(',').map(c => c.trim()).filter(Boolean), ram: ram.split(',').map(r => r.trim()).filter(Boolean) };
                onSave(updatedData);
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg">
                    <h3 className="text-2xl font-bold mb-6">{modelName ? `Edit ${modelName}` : "Add New Phone Model"}</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model Name</label><input type="text" value={name} onChange={e => setName(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Storage Options (comma separated)</label><input type="text" value={storage} onChange={e => setStorage(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Color Options (comma separated)</label><input type="text" value={colors} onChange={e => setColors(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /></div>
                        <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">RAM Options (comma separated)</label><input type="text" value={ram} onChange={e => setRam(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600" /></div>
                        <div className="flex justify-end space-x-4 pt-4"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button type="submit" className="px-6 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white transition">Save</button></div>
                    </form>
                </div></div>
            );
        }

        function LogPage({ userId }) {
            const [logs, setLogs] = useState([]); const [loading, setLoading] = useState(true); const [isUndoing, setIsUndoing] = useState(null);
            useEffect(() => { if (!userId || !db) return; setLoading(true); const logsCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'logs'); const q = window.firebase.query(logsCollectionRef, window.firebase.orderBy('timestamp', 'desc')); const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => { setLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, (error) => { console.error("Error fetching logs:", error); setLoading(false); }); return () => unsubscribe(); }, [userId]);
            const handleUndo = async (log) => {
                if (isUndoing || !log.type || !log.context) return; setIsUndoing(log.id);
                try {
                    const batch = window.firebase.writeBatch(db); let undoMessage = "";
                    switch(log.type) {
                        case 'DELETE_STOCK': { const { docId, deletedData } = log.context; if (!docId || !deletedData) throw new Error("Invalid context."); const { id, ...dataToRestore } = deletedData; const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', docId); batch.set(docRef, dataToRestore); undoMessage = `Restored deleted item: ${dataToRestore.phoneModel} (IMEI: ${dataToRestore.imei})`; break; }
                        case 'EDIT_STOCK': { const { docId, previousData } = log.context; if (!docId || !previousData) throw new Error("Invalid context."); const { id, ...dataToRestore } = previousData; const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', docId); batch.set(docRef, dataToRestore); undoMessage = `Reverted edit on item: ${dataToRestore.phoneModel} (IMEI: ${dataToRestore.imei})`; break; }
                        case 'BULK_EDIT_STOCK': { const { items } = log.context; if (!items || !Array.isArray(items)) throw new Error("Invalid context."); for(const item of items) { const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', item.docId); batch.update(docRef, item.previousData); } undoMessage = `Reverted bulk edit on ${items.length} items.`; break; }
                        case 'DELETE_INVOICE': { const { docId, deletedData } = log.context; if (!docId || !deletedData) throw new Error("Invalid context."); const { id, stockItemIds, ...dataToRestore } = deletedData; const invoiceRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'invoices', docId); batch.set(invoiceRef, dataToRestore); if (stockItemIds && stockItemIds.length > 0) { for(const stockId of stockItemIds) { const stockDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', stockId); const originalItem = deletedData.items.find(i => i.id === stockId); if (originalItem) { batch.update(stockDocRef, { availability: 'SOLD', customer: deletedData.customerName, soldPrice: originalItem.soldPrice, profit: originalItem.soldPrice - originalItem.hpp, soldDate: deletedData.date }); } } } undoMessage = `Restored deleted invoice: ${deletedData.invoiceNumber}`; break; }
                        case 'CREATE_STOCK': { const { createdDocIds } = log.context; if (!createdDocIds || !Array.isArray(createdDocIds)) throw new Error("Invalid context."); createdDocIds.forEach(docId => { const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'stock', docId); batch.delete(docRef); }); undoMessage = `Reverted creation of ${createdDocIds.length} stock item(s).`; break; }
                        case 'EDIT_INVOICE_STATUS': { const { docId, previousData } = log.context; if(!docId || !previousData) throw new Error("Invalid context."); const docRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'invoices', docId); batch.update(docRef, previousData); undoMessage = `Reverted status edit on an invoice.`; break; }
                        default: throw new Error("This action cannot be undone.");
                    }
                    const logDocRef = window.firebase.doc(db, 'artifacts', appId, 'users', userId, 'logs', log.id); batch.delete(logDocRef); await batch.commit();
                    await addLog(userId, { message: undoMessage, type: 'ACTION_UNDONE' }); alert("Action undone successfully!");
                } catch(error) { console.error("Error undoing action: ", error); alert("Failed to undo the action. " + error.message); } finally { setIsUndoing(null); }
            }
            const isUndoable = (log) => ['DELETE_STOCK', 'EDIT_STOCK', 'BULK_EDIT_STOCK', 'DELETE_INVOICE', 'CREATE_STOCK', 'EDIT_INVOICE_STATUS'].includes(log.type);
            return (
                <div className="container mx-auto">
                    <h2 className="text-3xl font-bold mb-6">Activity Log</h2>
                    <div className="bg-white dark:bg-gray-800 shadow-2xl rounded-lg p-6">
                        {loading ? (<div className="text-center p-10">Loading logs...</div>) : logs.length > 0 ? (
                            <ul className="divide-y divide-gray-200 dark:divide-gray-700">{logs.map(log => (<li key={log.id} className="py-4"><div className="flex items-center justify-between flex-wrap gap-2">
                                <p className="text-sm text-gray-700 dark:text-gray-300 flex-grow">{log.message}</p>
                                <div className="flex items-center gap-4"><p className="text-sm text-gray-500 dark:text-gray-500 whitespace-nowrap">{formatDate(log.timestamp)}</p>{isUndoable(log) && (<button onClick={() => handleUndo(log)} disabled={isUndoing === log.id} className="px-3 py-1 text-xs font-semibold rounded-md bg-yellow-600 hover:bg-yellow-700 text-white transition disabled:bg-yellow-800 disabled:cursor-wait">{isUndoing === log.id ? 'Undoing...' : 'Undo'}</button>)}</div>
                            </div></li>))}</ul>
                        ) : (<div className="text-center p-10">No activities logged yet.</div>)}
                    </div>
                </div>
            );
        }

        function ManualInvoiceModal({ closeModal, userId }) {
            const [customerName, setCustomerName] = useState(''); const [customerPhone, setCustomerPhone] = useState(''); const [paymentTerms, setPaymentTerms] = useState(''); const [paymentStatus, setPaymentStatus] = useState('Lunas'); const [discount, setDiscount] = useState(0); const [discountDisplay, setDiscountDisplay] = useState(''); const [otherCosts, setOtherCosts] = useState(0); const [otherCostsDisplay, setOtherCostsDisplay] = useState(''); const [costInputType, setCostInputType] = useState('dropdown'); const [costDescription, setCostDescription] = useState('Ongkos Kirim'); const [manualCostDescription, setManualCostDescription] = useState(''); const [items, setItems] = useState([{ itemName: '', soldPrice: 0, quantity: 1, serialNumbers: '' }]); const [view, setView] = useState('form'); const [invoicePreviewData, setInvoicePreviewData] = useState(null); const [isGenerating, setIsGenerating] = useState(false); const previewRef = useRef(null); const PREDEFINED_COSTS = ['Ongkos Kirim', 'Biaya Admin', 'Biaya Packing'];
            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
                if (field === 'soldPrice') { newItems[index][field] = parseFormattedNumber(value); } 
                else if (field === 'quantity') { const qty = parseInt(value) || 1; newItems[index][field] = qty; const serials = newItems[index].serialNumbers.split('\n').filter(Boolean); if (serials.length > qty) { newItems[index].serialNumbers = serials.slice(0, qty).join('\n'); } } 
                else if(field === 'serialNumbers') { newItems[index][field] = value; const qty = value.split('\n').filter(Boolean).length; if(qty > 0) newItems[index].quantity = qty; }
                else { newItems[index][field] = value; }
                setItems(newItems);
            };
            const addItemRow = () => { setItems([...items, { itemName: '', soldPrice: 0, quantity: 1, serialNumbers: '' }]); };
            const removeItemRow = (index) => { const newItems = items.filter((_, i) => i !== index); setItems(newItems); };
            const handleDiscountChange = (e) => { const displayValue = formatNumberInput(e.target.value); const rawValue = parseFormattedNumber(e.target.value); setDiscountDisplay(displayValue); setDiscount(rawValue); };
            const handleOtherCostsChange = (e) => { const displayValue = formatNumberInput(e.target.value); const rawValue = parseFormattedNumber(e.target.value); setOtherCostsDisplay(displayValue); setOtherCosts(rawValue); };
            const handlePreview = async () => {
                if (!customerName || !paymentTerms || items.length === 0 || items.some(i => !i.itemName || i.soldPrice <= 0)) { alert("Please fill customer details, payment terms, and ensure all items have a name and price."); return; }
                const today = new Date(); const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()); const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'invoices'); const q = window.firebase.query(invoicesCollectionRef, window.firebase.where('date', '>=', window.firebase.Timestamp.fromDate(startOfDay))); const querySnapshot = await window.firebase.getDocs(q); const todaysInvoiceCount = querySnapshot.size; const dateString = new Date().toLocaleDateString('fr-CA').replace(/-/g, '').slice(2);
                const finalItems = items.map(item => ({...item, serialNumbers: item.serialNumbers.split('\n').filter(Boolean)}));
                const subTotal = finalItems.reduce((acc, i) => acc + (i.soldPrice * i.quantity), 0); const total = subTotal - discount + otherCosts; const finalCostDescription = costInputType === 'manual' ? manualCostDescription : costDescription;
                const data = { invoiceNumber: `${paymentTerms.toUpperCase()}/${dateString}/${todaysInvoiceCount + 1}`, customerName, customerPhone, paymentTerms, paymentStatus, date: window.firebase.Timestamp.fromDate(new Date()), items: finalItems, subTotal, discount, otherCosts, costDescription: finalCostDescription, total, isManual: true };
                setInvoicePreviewData(data); setView('preview');
            };
            const confirmAndSaveInvoice = async (dataToSave) => {
                if(!db || !dataToSave) return null;
                try {
                    const invoicesCollectionRef = window.firebase.collection(db, 'artifacts', appId, 'users', userId, 'invoices'); const newInvoiceRef = window.firebase.doc(invoicesCollectionRef); const finalInvoiceData = { ...dataToSave, id: newInvoiceRef.id, items: dataToSave.items.map(i => ({...i, hpp: 0})) };
                    await window.firebase.setDoc(newInvoiceRef, finalInvoiceData);
                    await addLog(userId, { message: `Created manual invoice ${finalInvoiceData.invoiceNumber} for ${finalInvoiceData.customerName}`, type: 'CREATE_MANUAL_INVOICE' });
                    return newInvoiceRef.id;
                } catch (error) { console.error("Error creating manual invoice: ", error); alert('Gagal menyimpan invoice.'); return null; }
            };
            const handleActionAndClose = async (format) => {
                if (isGenerating) return; setIsGenerating(true);
                const invoiceId = await confirmAndSaveInvoice(invoicePreviewData);
                if (invoiceId) { 
                     if (format) { 
                        const canvas = await generateInvoiceCanvas(invoicePreviewData);
                         if (format === 'pdf') {
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'mm', 'a4'); 
                            pdf.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                            pdf.save(`Invoice-${invoicePreviewData.invoiceNumber.replace(/\//g, '-')}.pdf`);
                        }
                    }
                    alert('Invoice berhasil disimpan!'); 
                    closeModal(); 
                }
                setIsGenerating(false);
            };
            useEffect(() => { if (view === 'preview' && previewRef.current) { const container = previewRef.current.parentElement; const a4Element = previewRef.current.querySelector('.preview-a4'); const updateScale = () => { if (container && a4Element) { a4Element.style.setProperty('--preview-scale', container.offsetWidth / a4Element.offsetWidth); } }; updateScale(); window.addEventListener('resize', updateScale); return () => window.removeEventListener('resize', updateScale); } }, [view, invoicePreviewData]);
            if (view === 'preview') {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-full flex flex-col text-sm">
                        <div className="p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700 flex flex-wrap justify-between items-center gap-2"><h3 className="text-xl sm:text-2xl font-bold">Manual Invoice Preview</h3><div className="flex gap-2 flex-wrap justify-center sm:justify-end w-full sm:w-auto"><button onClick={() => setView('form')} className="px-4 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition text-xs sm:text-sm" disabled={isGenerating}>Back to Edit</button><button onClick={() => handleActionAndClose('pdf')} className="px-4 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition text-xs sm:text-sm" disabled={isGenerating}>{isGenerating ? 'Generating...' : 'Generate PDF & Close'}</button></div></div>
                        <div className="flex-grow overflow-y-auto p-2 sm:p-6 flex justify-center bg-gray-200 dark:bg-gray-900"><div className="preview-container" ref={previewRef}><InvoiceTemplate invoiceData={invoicePreviewData} /></div></div>
                    </div></div>
                );
            }
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-[999] p-4"><div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-full flex flex-col">
                    <h3 className="text-2xl font-bold p-6 border-b border-gray-200 dark:border-gray-700">Create Manual Invoice</h3>
                    <div className="flex-grow overflow-y-auto p-6 space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" placeholder="Customer Name" value={customerName} onChange={e => setCustomerName(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/><input type="text" placeholder="Customer Phone" value={customerPhone} onChange={e => setCustomerPhone(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" placeholder="Payment Terms" value={paymentTerms} onChange={e => setPaymentTerms(e.target.value)} required className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/><select value={paymentStatus} onChange={e => setPaymentStatus(e.target.value)} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"><option value="Lunas">Lunas</option><option value="Belum Lunas">Belum Lunas</option></select></div>
                        <h4 className="text-lg font-semibold pt-4 border-t border-gray-200 dark:border-gray-700">Items</h4>
                        <div className="max-h-60 overflow-y-auto pr-2">{items.map((item, index) => (
                            <div key={index} className="space-y-3 border-t border-gray-200 dark:border-gray-700 pt-3 mt-3 first:mt-0 first:border-t-0 first:pt-0">
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-3 items-stretch">
                                    <input type="text" placeholder="Item Name (e.g., Service Charge)" value={item.itemName} onChange={e => handleItemChange(index, 'itemName', e.target.value)} className="md:col-span-6 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <input type="text" placeholder="Price (IDR)" value={formatNumberInput(item.soldPrice)} onChange={e => handleItemChange(index, 'soldPrice', e.target.value)} className="md:col-span-3 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <input type="number" placeholder="Qty" value={item.quantity} onChange={e => handleItemChange(index, 'quantity', e.target.value)} className="md:col-span-2 w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/>
                                    <button type="button" onClick={() => removeItemRow(index)} className="md:col-span-1 w-full p-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Remove</button>
                                </div>
                                <div>
                                    <textarea placeholder="Serial Numbers (1 per line, auto-updates Qty)" value={item.serialNumbers} onChange={e => handleItemChange(index, 'serialNumbers', e.target.value)} rows="3" className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 overflow-y-auto"/>
                                </div>
                            </div>
                        ))}<button type="button" onClick={addItemRow} className="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition mt-2">Add Item</button></div>
                        <h4 className="text-lg font-semibold pt-4 border-t border-gray-200 dark:border-gray-700">Costs & Discounts</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" placeholder="Discount (IDR)" value={discountDisplay} onChange={handleDiscountChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/><input type="text" placeholder="Nominal Biaya (IDR)" value={otherCostsDisplay} onChange={handleOtherCostsChange} className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600"/></div>
                    </div>
                    <div className="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4"><button type="button" onClick={closeModal} className="px-6 py-2 rounded-md bg-gray-500 hover:bg-gray-600 text-white transition">Cancel</button><button onClick={handlePreview} className="px-6 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white transition">Preview Invoice</button></div>
                </div></div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
